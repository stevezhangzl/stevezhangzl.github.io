<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta property="og:type" content="website"><meta property="og:title" content="SteveZhang博客"><meta property="og:url" content="http://example.com/page/4/index.html"><meta property="og:site_name" content="SteveZhang博客"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="张龙"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/page/4/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>SteveZhang博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="SteveZhang博客" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">SteveZhang博客</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">40</span></a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/05/13/%E8%81%8A%E8%81%8AWebSocket%E5%8F%8AOkHttp%E5%AE%9E%E7%8E%B0WebSocket/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/05/13/%E8%81%8A%E8%81%8AWebSocket%E5%8F%8AOkHttp%E5%AE%9E%E7%8E%B0WebSocket/" class="post-title-link" itemprop="url">聊聊WebSocket及OkHttp实现WebSocket</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-05-13 18:43:51" itemprop="dateCreated datePublished" datetime="2022-05-13T18:43:51+08:00">2022-05-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-20 05:27:08" itemprop="dateModified" datetime="2022-10-20T05:27:08+08:00">2022-10-20</time></span></div></header><div class="post-body" itemprop="articleBody"><p>OkHttp应该算是Android中使用最广泛的网络库了，我们通常会利用它来实现HTTP请求，但是实际上它还可以支持WebSocket，并且使用起来还非常的便捷。那本文就来聊聊，利用OkHttp实现WebSocket的一些细节，包括对WebSocket的介绍，以及在传输如何做鉴权、长连接保活及其原理。</p><h2 id="1-WebSocket"><a href="#1-WebSocket" class="headerlink" title="1.WebSocket"></a>1.WebSocket</h2><h3 id="1-1-为什么使用WebSocket"><a href="#1-1-为什么使用WebSocket" class="headerlink" title="1.1 为什么使用WebSocket?"></a>1.1 为什么使用WebSocket?</h3><p>我们做客户端开发时，接触最多的应用层网络协议，就是HTTP协议，而今天介绍的<code>WebSocket</code>，下层和<code>HTTP</code>一样也是基于<code>TCP</code>协议，这是一种轻量级网络通信协议，也属于应用层协议。</p><p><code>WebSocket</code>与<code>HTTP2</code> 一样，其实都是为了解决<code>HTTP1.1</code>的一些缺陷而诞生的，而<code>WebSocket</code>针对的就是<code>「请求-应答」</code>这种<code>「半双工」</code>的模式的通信缺陷。</p><p><code>「请求-应答」</code>是半双工的通信模式，数据的传输必须经过一次请求应答，这个完整的通信过程，通信的同一时刻数据只能在一个方向上传递。它最大的问题在于，HTTP是一种被动的模式，服务端必须等待客户端请求才可以返回数据，无法主动向客户端发送数据。</p><p>这也导致在<code>WebSocket</code>出现之前，一些对实时性有要求的服务，通常是基于轮询这种简单的模式来实现。轮询就是由客户端定时发起请求，如果服输端有需要传递的数据，可以借助这个请求去响应数据。</p><p>轮询的缺点也非常明显，大量空闲的时间，其实是在反复发送无效的请求，这显然是一种资源的损耗。</p><p>虽然在之后的<code>HTTP2</code> <code>HTTP3</code>中针对这种半双工的缺陷新增了<code>Stream</code> <code>Server</code> <code>Push</code>等特性，但是’请求-应答’依然是<code>HTTP</code>协议请要的通信方式。</p><p><code>WebSocket</code>协议是由<code>HTML5</code>规范定义的，原本是为了浏览器而设计的，可以避免同源的限制，浏览器可以与任意服务端通信，现代浏览器基本上都已经支持<code>WebSocket</code>。</p><p>虽然WebSocket原本是被定义在<code>HTML5</code>中，但它也适用于移动端，尽管移动端也可以直接通过<code>Socket</code>与服务端通信，但借助<code>WebSocket</code>，可以利用<code>80（HTTP）</code>或<code>443（HTTPS）</code>端口通信，有效的避免一些防火墙的拦截。</p><p><code>WebSocket</code>是真正意义上的<code>全双工模式</code>，也就我们俗称的<code>‘长连接’</code>。当完成握手连接后，客户端和服务端均可以主动的发起请求，回复响应，并且两边的传输都是相互独立的。</p><h3 id="1-2-WebSocket的特点"><a href="#1-2-WebSocket的特点" class="headerlink" title="1.2 WebSocket的特点"></a>1.2 WebSocket的特点</h3><p><code>WebSocket</code>的数据传输，是基于<code>TCP</code>协议，但是在传输之前，还有一个握手的过程，双方确认过眼神，才能够正式的传输数据。</p><p><code>WebSocket</code>的握手过程，符合其<code>‘Web’</code>的特性，是利用<code>HTTP</code>本身的<code>‘协议升级’</code>来实现。</p><p>在建立连接前，客户端还需要知道服务端的地址，WebSocket并没有另辟路径，而是沿用了HTTP的URL格式，但协议标识变成了<code>‘ws’</code>或者<code>‘wss’</code>，分别表示明文加密的<code>WebSocket</code>协议，这一点和<code>HTTP</code>和<code>HTTPS</code>的关系类似。</p><p>以下是一些WebSocket的URL例子：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws://cxmydev.com/some/path</span><br><span class="line">ws://cxmydev.com:8080/some/path</span><br><span class="line">wss://cxmydev.com:443?uid=xxx</span><br></pre></td></tr></table></figure><p>而在连接建立后，<code>WebSocket</code>采用二进制帧的形式传输数据，其中常用的包括用于数据传输的数据帧<code>MESSAGE</code>以及3个<code>控制帧</code>：</p><ul><li><code>PING</code>:主动保活的PING帧</li><li><code>PONG</code>：收到PING帧后回复</li><li><code>CLOSE</code>：主动关闭WebSocket连接</li></ul><p>小结下<code>WebSocket</code>特性：</p><ol><li><code>WebSocket</code>建立在TCP协议之上，对服务端友好。</li><li>默认端口采用80或443，握手阶段采用HTTP协议，不容易被防火墙屏蔽，能够通过各种HTTP代理服务器。</li><li>传输数据相比HTTP更轻量，少了HTTP HEADER，性能开销更小，通信更高效。</li><li>通过MESSAGE帧发送数据，可以发送文本或者二进制数据，如果数据过大，会被分为多个MESSAGE帧发送。</li><li>WebSocket沿用HTTP的URL，协议标识符’ws’或‘wss’</li></ol><h3 id="1-3-WebSocket原理"><a href="#1-3-WebSocket原理" class="headerlink" title="1.3 WebSocket原理"></a>1.3 WebSocket原理</h3><p><code>WebSocket</code>在<code>TCP</code>连接建立后，还要通过<code>Http</code>进行一次握手，也就是通过<code>Http</code>发送一条<code>GET请求</code>消息给服务器，告诉服务器我要建立<code>WebSocket连接</code>了，你准备好哦，具体做法就是在头部信息中添加相关参数。然后服务器响应我知道了，并且将连接协议改成<code>WebSocket</code>，开始建立长连接。</p><p>这里贴上请求头和响应头信息，从网上找了一张图：</p><p><img src="/../images/image-20220514062147256.png" alt="image-20220514062147256"></p><p>简单说明下参数：</p><ul><li>URL一般是以<code>ws</code>或者<code>wss</code>开头，<code>ws</code>对应<code>Websocket</code>协议，<code>wss</code>对应在<code>TLS</code>之上的<code>WebSocket</code>。类似于<code>Http</code>和<code>Https</code>的关系。</li><li>请求方法为GET方法。</li><li><code>Connection:Upgrade</code>，表示客户端要连接升级，不用Http协议。</li><li><code>Upgrade:websocket</code>， 表示客户端要升级建立<code>Websocket</code>连接。</li><li><code>Sec-Websocket-Key:key</code>， 这个key是随机生成的，服务器会通过这个参数验证该请求是否有效。</li><li><code>Sec-WebSocket-Version:13</code>， websocket使用的版本，一般就是13。</li><li><code>Sec-webSocket-Extension:permessage-deflate</code>，客户端指定的一些扩展协议，比如这里<code>permessage-deflate</code>就是<code>WebSocket</code>的一种压缩协议。</li><li><code>响应码101,</code>表示响应协议升级，后续的数据交互都按照Upgradet指定的<code>WebSocket</code>协议来。</li></ul><h2 id="2-结合OkHttp使用WebSocket进行通信"><a href="#2-结合OkHttp使用WebSocket进行通信" class="headerlink" title="2.结合OkHttp使用WebSocket进行通信"></a>2.结合OkHttp使用WebSocket进行通信</h2><h3 id="2-1-添加OkHttp依赖"><a href="#2-1-添加OkHttp依赖" class="headerlink" title="2.1 添加OkHttp依赖"></a>2.1 添加OkHttp依赖</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;com.squareup.okhttp3:okhttp:4.7.2&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-2-实现代码"><a href="#2-2-实现代码" class="headerlink" title="2.2 实现代码"></a>2.2 实现代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化WebSocket</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mWbSocketUrl = <span class="string">&quot;ws://echo.websocket.org&quot;</span>;</span><br><span class="line">    mClient = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">            .pingInterval(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">            .build();</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">            .url(mWbSocketUrl)</span><br><span class="line">            .build();</span><br><span class="line">    mWebSocket = mClient.newWebSocket(request, <span class="keyword">new</span> WsListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里主要是配置了<code>OkHttp</code>的一些参数，以及<code>WebSocket</code>的连接地址。其中<code>newWebSocket</code>方法就是进行<code>WebSocket</code>的初始化和连接。</p><p>这里要注意的点是<code>pingInterval</code>方法的配置，这个方法主要是用来设置<code>WebSocket</code>连接的保活。 相信做过长连接的同学都知道，一个长连接一般要隔几秒发送一条消息告诉服务器我在线，而服务器也会回复一个消息表示收到了，这样就确认了连接正常，客户端和服务器端都在线。</p><p>如果服务器没有<code>按时收到</code>这个消息那么服务器可能就会<code>主动关闭</code>这个连接，节约资源。 客户端没有<code>正常收到</code>这个返回的消息，也会做一些类似<code>重连的操作</code>，所以这个保活消息非常重要。</p><p>我们称这个消息叫作<code>心跳包</code>，一般用<code>PING，PONG</code>表示，像乒乓球一样，一来一回。 所以这里的<code>pingInterval</code>就是设置心跳包发送的间隔时间，设置了这个方法之后，<code>OkHttp</code>就会自动帮我们发送心跳包事件，也就是<code>ping</code>包。当间隔时间到了，没有收到<code>pong</code>包的话，监听事件中的<code>onFailure</code>方法就会被调用，此时我们就可以进行断线重连。</p><p>但是由于实际业务需求不一样，以及<code>okhttp</code>中心跳包事件给予我们权限较少，所以我们也可以自己完成心跳包事件，即在<code>WebSocket</code>连接成功之后，开始定时发送<code>ping</code>包，在下一次发送<code>ping</code>包之前检查上一个<code>pong</code>包是否收到，如果没收到，就视为异常，开始断线重连。感兴趣的同学可以看看文末的相关源码。</p><p>建立连接后，我们就可以正常发送和读取消息了，也就是在上文<code>WsListener</code>监听事件中表现：</p><blockquote><p>在<code>Android</code>程序中，如果应用被系统<code>kill</code>了进程，这种我们是没办法告诉<code>Sever</code>端，结束连接的，所以心跳包是有必要的</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//监听事件，用于收消息，监听连接的状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WsListener</span> <span class="keyword">extends</span> <span class="title">WebSocketListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosed</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="keyword">int</span> code, <span class="meta">@NotNull</span> String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onClosed(webSocket, code, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosing</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="keyword">int</span> code, <span class="meta">@NotNull</span> String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onClosing(webSocket, code, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> Throwable t, <span class="meta">@Nullable</span> Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onFailure(webSocket, t, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMessage(webSocket, text);</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;客户端收到消息:&quot;</span> + text);</span><br><span class="line">        onWSDataChanged(DATE_NORMAL, text);</span><br><span class="line">       <span class="comment">//测试发消息</span></span><br><span class="line">        webSocket.send(<span class="string">&quot;我是客户端，你好啊&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> ByteString bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMessage(webSocket, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onOpen(webSocket, response);</span><br><span class="line">        Log.e(TAG,<span class="string">&quot;连接成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//发送String消息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebSocket.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送byte消息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> ByteString message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebSocket.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">//主动断开连接</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(<span class="keyword">int</span> code, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebSocket != <span class="keyword">null</span>)</span><br><span class="line">        mWebSocket.close(code, reason);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>这里要注意，回调的方法都是在子线程回调的，如果需要<code>更新UI</code>，需要切换到主线程。</p></blockquote><p>基本操作就这么多，还是很简单的吧，初始化<code>Websocket</code>——连接——连接成功——收发消息。</p><p>其中<code>WebSocket</code>类是一个操作接口，主要提供了以下<strong>几个方法</strong></p><ul><li><code>send(text: String)</code>发送一个String类型的消息</li><li><code>send(bytes: ByteString)</code> 发送一个二进制类型的消息</li><li><code>close(code: Int, reason: String?)</code>关闭WebSocket连接</li></ul><p>如果有同学想测试下<code>WebSocket</code>的功能但是又没有<strong>实际的服务器</strong>，怎么办呢？ 其实<code>OkHttp</code>官方有一个<code>MockWebSocket</code>服务，可以用来模拟服务端，下面我们一起试一下：</p><h3 id="2-3-模拟服务器"><a href="#2-3-模拟服务器" class="headerlink" title="2.3 模拟服务器"></a>2.3 模拟服务器</h3><p>首先集成<code>MockWebSocket</code>服务库：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&#x27;com.squareup.okhttp3:mockwebserver:4.7.2&#x27;</span></span><br></pre></td></tr></table></figure><p>然后就可以新建<code>MockWebServer</code>，并加入<code>MockResponse</code>作为接收消息的响应。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MockWebServer mMockWebServer = <span class="keyword">new</span> MockWebServer();</span><br><span class="line">MockResponse response = <span class="keyword">new</span> MockResponse()</span><br><span class="line">        .withWebSocketUpgrade(<span class="keyword">new</span> WebSocketListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> Response response)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onOpen(webSocket, response);</span><br><span class="line">                <span class="comment">//有客户端连接时回调</span></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;服务器收到客户端连接成功回调：&quot;</span>);</span><br><span class="line">                mWebSocket = webSocket;</span><br><span class="line">                mWebSocket.send(<span class="string">&quot;我是服务器，你好呀&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> String text)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onMessage(webSocket, text);</span><br><span class="line"></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;服务器收到消息：&quot;</span> + text);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosed</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="keyword">int</span> code, <span class="meta">@NotNull</span> String reason)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onClosed(webSocket, code, reason);</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;onClosed：&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">mMockWebServer.enqueue(response);</span><br></pre></td></tr></table></figure><p>这里服务器端在收到客户端连接成功消息后，给客户端发送了一条消息。 要注意的是这段代码要在子线程执行，因为主线程不能进行网络操作。</p><p>然后就可以去初始化<code>Websocket</code>客户端了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取连接url，初始化websocket客户端</span></span><br><span class="line">String websocketUrl = <span class="string">&quot;ws://&quot;</span> + mMockWebServer.getHostName() + <span class="string">&quot;:&quot;</span> + mMockWebServer.getPort() + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">WSManager.getInstance().init(websocketUrl);</span><br></pre></td></tr></table></figure><p>ok，运行项目</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//运行结果</span><br><span class="line">E/jimu: mWbSocketUrl=ws://localhost:38355/</span><br><span class="line">E/jimu: 服务器收到客户端连接成功回调：</span><br><span class="line">E/jimu: 连接成功！</span><br><span class="line">E/jimu: 客户端收到消息:我是服务器，你好呀</span><br><span class="line">E/jimu: 服务器收到消息：我是客户端，你好啊</span><br></pre></td></tr></table></figure><h3 id="2-4-WebSocket如何进行鉴权"><a href="#2-4-WebSocket如何进行鉴权" class="headerlink" title="2.4 WebSocket如何进行鉴权"></a>2.4 WebSocket如何进行鉴权</h3><p>接下来我们聊聊 <code>WebSocket</code> 连接的鉴权问题。</p><p>所谓鉴权，其实就是为了安全考虑，避免服务端启动 <code>WebSocket</code> 的连接服务后，任谁都可以连接，这肯定会引发一些安全问题。其次，服务端还需要将 <code>WebSocket</code> 的连接实体与一个真是的用户对应起来，否者业务无法保证了。</p><p>那么问题就回到了，<code>WebSocket</code> 通信的完整过程中，如何以及何时将一些业务数据传递给服务端？当然在 <code>WebSocket</code> 连接建立之后，立即给服务端发送一些鉴权的数据，必然是可以做到业务实现的，但是这样明显是不够优雅的。</p><p>前文提到，<code>WebSocket</code> 在握手阶段，使用的是 <code>HTTP</code> 的 “协议升级”，它本质上还是 <code>HTTP</code> 的报文头发送一些特殊的头数据，来完成协议升级。</p><p>例如在 <code>RealWebSocket</code> 中，就有构造 <code>Header</code> 的过程，如 <code>Upgrade</code>、<code>Connection</code> 等等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(OkHttpClient client)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">final</span> Request request = originalRequest.newBuilder()</span><br><span class="line">    .header(<span class="string">&quot;Upgrade&quot;</span>, <span class="string">&quot;websocket&quot;</span>)</span><br><span class="line">    .header(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;Upgrade&quot;</span>)</span><br><span class="line">    .header(<span class="string">&quot;Sec-WebSocket-Key&quot;</span>, key)</span><br><span class="line">    .header(<span class="string">&quot;Sec-WebSocket-Version&quot;</span>, <span class="string">&quot;13&quot;</span>)</span><br><span class="line">    .build();</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么实际我们在 <code>WebSocket</code> 阶段，也可以通过 <code>Header</code> 传输一些鉴权的数据，例如 <code>uid</code>、<code>token</code> 之类，具体方法就是在构造 <code>Request</code> 的时候，为其增加 <code>Header</code>，这里就不举例说明了。</p><p>另外 <code>WebSocket</code> 的 <code>URL</code> 也是可以携带参数的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wss://cxmydev.com:443?uid=xxx&amp;token=xxx</span><br></pre></td></tr></table></figure><h2 id="3-OkHttp-源码解读WebSocket连接过程及协议"><a href="#3-OkHttp-源码解读WebSocket连接过程及协议" class="headerlink" title="3.OkHttp 源码解读WebSocket连接过程及协议"></a>3.OkHttp 源码解读WebSocket连接过程及协议</h2><p><code>WebSocket</code>整个流程无非三个功能：连接，接收消息，发送消息。下面我们就从这<code>三个方面</code>分析下具体是怎么实现的。</p><h3 id="3-1-连接"><a href="#3-1-连接" class="headerlink" title="3.1 连接"></a>3.1 连接</h3><p>通过上面的代码我们得知，<code>WebSocket</code>连接是通过<code>newWebSocket</code>方法。直接点进去看这个方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newWebSocket</span><span class="params">(request: <span class="type">Request</span>, listener: <span class="type">WebSocketListener</span>)</span></span>: WebSocket &#123;</span><br><span class="line">  <span class="keyword">val</span> webSocket = RealWebSocket(</span><br><span class="line">      taskRunner = TaskRunner.INSTANCE,</span><br><span class="line">      originalRequest = request,</span><br><span class="line">      listener = listener,</span><br><span class="line">      random = Random(),</span><br><span class="line">      pingIntervalMillis = pingIntervalMillis.toLong(),</span><br><span class="line">      extensions = <span class="literal">null</span>, <span class="comment">// Always null for clients.</span></span><br><span class="line">      minimumDeflateSize = minWebSocketMessageToCompress</span><br><span class="line">  )</span><br><span class="line">  webSocket.connect(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">return</span> webSocket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里做了两件事：</p><ul><li>初始化<code>RealWebSocket</code>，主要是设置了一些参数（比如<code>pingIntervalMillis</code>心跳包时间间隔，还有监听事件之类的）</li><li><code>connect</code>方法进行<code>WebSocket</code>连接</li></ul><p>继续查看connect方法：</p><h4 id="3-1-1-connect-WebSocket连接握手"><a href="#3-1-1-connect-WebSocket连接握手" class="headerlink" title="3.1.1 connect(WebSocket连接握手)"></a>3.1.1 connect(WebSocket连接握手)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">connect</span><span class="params">(client: <span class="type">OkHttpClient</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">//***</span></span><br><span class="line">  <span class="keyword">val</span> webSocketClient = client.newBuilder()</span><br><span class="line">      .eventListener(EventListener.NONE)</span><br><span class="line">      .protocols(ONLY_HTTP1)</span><br><span class="line">      .build()</span><br><span class="line">  <span class="keyword">val</span> request = originalRequest.newBuilder()</span><br><span class="line">      .header(<span class="string">&quot;Upgrade&quot;</span>, <span class="string">&quot;websocket&quot;</span>)</span><br><span class="line">      .header(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;Upgrade&quot;</span>)</span><br><span class="line">      .header(<span class="string">&quot;Sec-WebSocket-Key&quot;</span>, key)</span><br><span class="line">      .header(<span class="string">&quot;Sec-WebSocket-Version&quot;</span>, <span class="string">&quot;13&quot;</span>)</span><br><span class="line">      .header(<span class="string">&quot;Sec-WebSocket-Extensions&quot;</span>, <span class="string">&quot;permessage-deflate&quot;</span>)</span><br><span class="line">      .build()</span><br><span class="line">  call = RealCall(webSocketClient, request, forWebSocket = <span class="literal">true</span>)</span><br><span class="line">  call!!.enqueue(<span class="keyword">object</span> : Callback &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(call: <span class="type">Call</span>, response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//得到数据流</span></span><br><span class="line">      <span class="keyword">val</span> streams: Streams</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        checkUpgradeSuccess(response, exchange)</span><br><span class="line">        streams = exchange!!.newWebSocketStreams()</span><br><span class="line">      &#125; </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//***</span></span><br><span class="line">      <span class="comment">// Process all web socket messages.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> name = <span class="string">&quot;<span class="variable">$okHttpName</span> WebSocket <span class="subst">$&#123;request.url.redact()&#125;</span>&quot;</span></span><br><span class="line">        initReaderAndWriter(name, streams)</span><br><span class="line">        listener.onOpen(<span class="keyword">this</span><span class="symbol">@RealWebSocket</span>, response)</span><br><span class="line">        loopReader()</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        failWebSocket(e, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Websocket</code>连接需要一次<code>Http</code>协议的握手，然后才能把协议升级成<code>WebSocket</code>。所以这段代码就体现出这个功能了。</p><p>首先就<code>new</code>了一个用来进行<code>Http</code>连接的<code>request</code>，其中<code>Header</code>的参数就表示我要进行<code>WebSocket</code>连接了，参数解析如下：</p><ul><li><code>Connection:Upgrade</code>，表示客户端要连接升级</li><li><code>Upgrade:websocket</code>， 表示客户端要升级建立Websocket连接</li><li><code>Sec-Websocket-Key:key</code>， 这个key是随机生成的，服务器会通过这个参数验证该请求是否有效</li><li><code>Sec-WebSocket-Version:13</code>， websocket使用的版本，一般就是13</li><li><code>Sec-webSocket-Extension:permessage-deflate</code>，客户端指定的一些扩展协议，比如这里<code>permessage-deflate</code>就是<code>WebSocket</code>的一种压缩协议。</li></ul><p><code>Header</code>设置好之后，就调用了<code>call</code>的<code>enqueue</code>方法，这个方法大家应该都很熟悉吧，<code>OkHttp</code>里面对于<code>Http</code>请求的异步请求就是这个方法。 至此，握手结束，服务器返回<code>响应码101</code>，表示协议升级。</p><p>然后我们继续看看获取服务器响应之后又做了什么？ 在发送<code>Http</code>请求成功之后，<code>onResponse</code>响应方法里面主要表现为四个处理逻辑：</p><ul><li>将<code>Http</code>流转换成<code>WebSocket</code>流，得到<code>Streams</code>对象，这个流后面会转化成输入流和输出流，也就是进行发送和读取的操作流</li><li><code>listener.onOpen(this@RealWebSocket, response)</code>，回调了接口<code>WebSocketListener</code>的<code>onOpen</code>方法，告诉用户<code>WebSocket</code>已经连接</li><li><code>initReaderAndWriter(name, streams)</code></li><li><code>loopReader()</code></li></ul><p>前两个逻辑还是比较好理解，主要是后两个方法，我们分别解析下。 首先看<code>initReaderAndWriter</code>方法。</p><h4 id="3-1-2-initReaderAndWriter（初始化输入流输出流）"><a href="#3-1-2-initReaderAndWriter（初始化输入流输出流）" class="headerlink" title="3.1.2 initReaderAndWriter（初始化输入流输出流）"></a>3.1.2 initReaderAndWriter（初始化输入流输出流）</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealWebSocket.kt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">initReaderAndWriter</span><span class="params">(name: <span class="type">String</span>, streams: <span class="type">Streams</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> extensions = <span class="keyword">this</span>.extensions!!</span><br><span class="line">  synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="comment">//***</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//写数据，发送数据的工具类</span></span><br><span class="line">    <span class="keyword">this</span>.writer = WebSocketWriter()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置心跳包事件</span></span><br><span class="line">    <span class="keyword">if</span> (pingIntervalMillis != <span class="number">0L</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> pingIntervalNanos = MILLISECONDS.toNanos(pingIntervalMillis)</span><br><span class="line">      taskQueue.schedule(<span class="string">&quot;<span class="variable">$name</span> ping&quot;</span>, pingIntervalNanos) &#123;</span><br><span class="line">        writePingFrame()</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@schedule</span> pingIntervalNanos</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//***</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//***</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//读取数据的工具类</span></span><br><span class="line">  reader = WebSocketReader(     </span><br><span class="line">    ***</span><br><span class="line">    frameCallback = <span class="keyword">this</span>,</span><br><span class="line">    ***</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">writePingFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="comment">//***</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    writer.writePing(ByteString.EMPTY)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">    failWebSocket(e, <span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个方法主要干了两件事：</p><ul><li>实例化输出流输入流工具类，也就是<code>WebSocketWriter</code>和<code>WebSocketReader</code>，用来处理数据的收发。</li><li>设置心跳包事件。如果<code>pingIntervalMillis</code>参数不为0，就通过计时器，每隔<code>pingIntervalNanos</code>发送一个<code>ping</code>消息。其中<code>writePingFrame</code>方法就是发送了<code>ping</code>帧数据。</li></ul><h3 id="3-2-接收消息处理消息"><a href="#3-2-接收消息处理消息" class="headerlink" title="3.2 接收消息处理消息"></a>3.2 接收消息处理消息</h3><h4 id="3-2-1-loopReader"><a href="#3-2-1-loopReader" class="headerlink" title="3.2.1 loopReader"></a>3.2.1 loopReader</h4><p>接着看看这个<code>loopReader</code>方法是干什么的，看这个名字我们大胆猜测下，难道这个方法就是用来循环读取数据的？去代码里找找答案：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loopReader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (receivedCloseCode == -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// This method call results in one or more onRead* methods being called on this thread.</span></span><br><span class="line">    reader!!.processNextFrame()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码很简单，一个<code>while</code>循环，循环条件是<code>receivedCloseCode == -1</code>的时候，做的事情是<code>reader!!.processNextFrame()</code>方法。继续：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WebSocketWriter.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">processNextFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">//读取头部信息</span></span><br><span class="line">  readHeader()</span><br><span class="line">  <span class="keyword">if</span> (isControlFrame) &#123;</span><br><span class="line">    <span class="comment">//如果是控制帧，读取控制帧内容</span></span><br><span class="line">    readControlFrame()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//读取普通消息内容</span></span><br><span class="line">    readMessageFrame()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取头部信息</span></span><br><span class="line"><span class="meta">@Throws(IOException::class, ProtocolException::class)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">readHeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (closed) <span class="keyword">throw</span> IOException(<span class="string">&quot;closed&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">//读取数据，获取数据帧的前8位</span></span><br><span class="line">    b0 = source.readByte() and <span class="number">0xff</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    source.timeout().timeout(timeoutBefore, TimeUnit.NANOSECONDS)</span><br><span class="line">  &#125;    </span><br><span class="line">  <span class="comment">//***</span></span><br><span class="line">  <span class="comment">//获取数据帧的opcode（数据格式）</span></span><br><span class="line">  opcode = b0 and B0_MASK_OPCODE</span><br><span class="line">  <span class="comment">//是否为最终帧</span></span><br><span class="line">  isFinalFrame = b0 and B0_FLAG_FIN != <span class="number">0</span></span><br><span class="line">  <span class="comment">//是否为控制帧（指令）</span></span><br><span class="line">  isControlFrame = b0 and OPCODE_FLAG_CONTROL != <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//判断最终帧，获取帧长度等等</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//读取控制帧（指令）</span></span><br><span class="line">  <span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">readControlFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (frameLength &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">    source.readFully(controlFrameBuffer, frameLength)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">when</span> (opcode) &#123;</span><br><span class="line">    OPCODE_CONTROL_PING -&gt; &#123;</span><br><span class="line">    <span class="comment">//ping 帧</span></span><br><span class="line">      frameCallback.onReadPing(controlFrameBuffer.readByteString())</span><br><span class="line">    &#125;</span><br><span class="line">    OPCODE_CONTROL_PONG -&gt; &#123;</span><br><span class="line">      <span class="comment">//pong 帧</span></span><br><span class="line">      frameCallback.onReadPong(controlFrameBuffer.readByteString())</span><br><span class="line">    &#125;</span><br><span class="line">    OPCODE_CONTROL_CLOSE -&gt; &#123;</span><br><span class="line">      <span class="comment">//关闭 帧</span></span><br><span class="line">      <span class="keyword">var</span> code = CLOSE_NO_STATUS_CODE</span><br><span class="line">      <span class="keyword">var</span> reason = <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="keyword">val</span> bufferSize = controlFrameBuffer.size</span><br><span class="line">      <span class="keyword">if</span> (bufferSize == <span class="number">1L</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ProtocolException(<span class="string">&quot;Malformed close payload length of 1.&quot;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufferSize != <span class="number">0L</span>) &#123;</span><br><span class="line">        code = controlFrameBuffer.readShort().toInt()</span><br><span class="line">        reason = controlFrameBuffer.readUtf8()</span><br><span class="line">        <span class="keyword">val</span> codeExceptionMessage = WebSocketProtocol.closeCodeExceptionMessage(code)</span><br><span class="line">        <span class="keyword">if</span> (codeExceptionMessage != <span class="literal">null</span>) <span class="keyword">throw</span> ProtocolException(codeExceptionMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//回调onReadClose方法</span></span><br><span class="line">      frameCallback.onReadClose(code, reason)</span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取普通消息</span></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">readMessageFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">  </span><br><span class="line">  readMessage()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (readingCompressedMessage) &#123;</span><br><span class="line">    <span class="keyword">val</span> messageInflater = <span class="keyword">this</span>.messageInflater</span><br><span class="line">        ?: MessageInflater(noContextTakeover).also &#123; <span class="keyword">this</span>.messageInflater = it &#125;</span><br><span class="line">    messageInflater.inflate(messageFrameBuffer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opcode == OPCODE_TEXT) &#123;</span><br><span class="line">    frameCallback.onReadMessage(messageFrameBuffer.readUtf8())</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    frameCallback.onReadMessage(messageFrameBuffer.readByteString())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码还是比较直观，这个<code>processNextFrame</code>其实就是读取数据用的，首先读取头部信息，获取数据帧的类型，判断是否为控制帧，再分别去读取控制帧数据或者普通消息帧数据。</p><h4 id="3-2-2-数据帧格式"><a href="#3-2-2-数据帧格式" class="headerlink" title="3.2.2 数据帧格式"></a>3.2.2 数据帧格式</h4><p>问题来了，什么是<strong>数据头部信息</strong>，什么是<strong>控制帧</strong>？ 这里就要说下<code>WebSocket</code>的数据帧了，先附上一个数据帧格式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> 0 1 2 3 4 5 6 7    0 1 2 3 4 5 6 7  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7</span><br><span class="line">+-+-+-+-+-------+  +-+-------------+ +-----------------------------+</span><br><span class="line">|F|R|R|R| OP    |  |M| LENGTH      |   Extended payload length</span><br><span class="line">|I|S|S|S| CODE  |  |A|             |  （if LENGTH=126）</span><br><span class="line">|N|V|V|V|       |  |S|             |</span><br><span class="line">| |1|2|3|       |  |K|             |</span><br><span class="line">+-+-+-+-+-------+  +-+-------------+</span><br><span class="line">|                      Extended payload length（if LENGTH=127）</span><br><span class="line">+                                  +-------------------------------</span><br><span class="line">|      Extended payload length     | Masking-key，if Mask set to 1</span><br><span class="line">+----------------------------------+-------------------------------</span><br><span class="line">|   Masking-key                    |       Data</span><br><span class="line">+----------------------------------+-------------------------------</span><br><span class="line">|                                Data</span><br><span class="line">+----------------------------------+-------------------------------</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我承认，我懵逼了。 冷静冷静，一步一步分析下吧。</p><p>首先每一行代表4个字节，一共也就是32位数，哦，那也就是几个字节而已嘛，每个字节有他自己的代表意义呗，这样想是不是就很简单了，下面来具体看看每个字节。</p><p><strong>第1个字节：</strong></p><ul><li>第一位是<code>FIN码</code>，其实就是一个标示位，因为数据可能多帧操作嘛，所以多帧情况下，只有最后一帧的<code>FIN</code>设置成1，标示结束帧，前面所有帧设置为0。</li><li>第二位到第四位是<code>RSV码</code>，一般通信两端没有设置自定义协议，就默认为0。</li><li>后四位是<code>opcode</code>，我们叫它操作码。这个就是判断这个数据帧的类型了，一般有以下几个被定义好的类型：</li></ul><p>1） <code>0x0</code> 表示附加数据帧<br>2） <code>0x1</code> 表示文本数据帧<br>3） <code>0x2</code> 表示二进制数据帧<br>4） <code>0x3-7</code> 保留用于未来的非控制帧<br>5） <code>0x8</code> 表示连接关闭<br>6） <code>0x9</code> 表示ping<br>7） <code>0xA</code> 表示pong<br>8） <code>0xB-F</code> 保留用于未来的非控制帧</p><p>是不是发现了些什么，这不就对应了我们应用中的几种格式吗？<code>2和3</code>对应的是普通消息帧，包括了文本和二进制数据。<code>567</code>对应的就是控制帧格式，包括了<code>close，ping，pong</code>。</p><p><strong>第2个字节：</strong></p><ul><li>第一位是<code>Mask</code>掩码，其实就是标识数据是否加密混淆，1代表数据经过掩码的，0是没有经过掩码的，如果是1的话，后续就会有4个字节代表<code>掩码key</code>，也就是数据帧中<code>Masking-key</code>所处的位置。</li><li>后7位是<code>LENGTH</code>，用来标示数据长度。因为只有7位，所以最大只能储存1111111对应的十进制数<code>127长度</code>的数据，如果需要更大的数据，这个储存长度肯定就不够了。 <strong>所以规定来了</strong>，1) <code>小于126长度</code>则数据用这七位表示实际长度。2) 如果长度<code>设置为126</code>，也就是二进制1111110，就代表取<code>额外2个字节</code>表示数据长度，共是16位表示数据长度。3) 如果长度<code>设置为127</code>，也就是二进制1111111，就代表取<code>额外8个字节</code>，共是64位表示数据长度。</li></ul><blockquote><p>需要注意的是LENGHT的三种情况在一个数据帧里面只会出现一种情况，不共存，所以在图中是用<strong>if</strong>表示。同样的，Masking-key也是当Mask为1的时候才存在。</p></blockquote><p>所以也就有了数据帧里面的<code>Extended payload length（LENGTH=126）</code>所处的2个字节，以及<code>Extended payload length（LENGTH=127）</code>所处的8个字节。</p><p>最后的字节部分自然就是<code>掩码key</code>（Mask为1的时候才存在）和具体的<code>传输数据</code>了。<br>还是有点晕吧😷，来张图总结下： <img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/13/173476f65b9b0001~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.image" alt="数据帧格式.jpeg"></p><p>好了，了解了<strong>数据帧格式</strong>后，我们再来读源码就清晰多了。 先看看怎么读的<code>头部信息</code>并解析的：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取数据帧前8位数据</span></span><br><span class="line">b0 = source.readByte() and <span class="number">0xff</span></span><br><span class="line"><span class="comment">//获取数据帧的opcode（数据格式）</span></span><br><span class="line">opcode = b0 and B0_MASK_OPCODE（<span class="number">15</span>）</span><br><span class="line"><span class="comment">//是否为最终帧</span></span><br><span class="line">isFinalFrame = b0 and B0_FLAG_FIN（<span class="number">128</span>） != <span class="number">0</span></span><br><span class="line"><span class="comment">//是否为控制帧（指令）</span></span><br><span class="line">isControlFrame = b0 and OPCODE_FLAG_CONTROL（<span class="number">8</span>） != <span class="number">0</span>  </span><br></pre></td></tr></table></figure><ul><li>第一句获取头信息，<code>and</code>是按位与计算，<code>and 0xff</code>意思就是按位与11111111，所以头部信息其实就是取了数据帧的<code>前8位数据</code>，一个字节。</li><li>第二句获取<code>opcode</code>，<code>and 15</code>也就是按位与00001111，其实也就是取了后四位数据，刚好对应上<code>opcode</code>的位置，第一个字节的后四位。</li><li>第三句获取是否为<code>最终帧</code>，刚才数据帧格式中说过，第一位<code>FIN</code>标识了是否为最后一帧数据，1代表结束帧，所以这里<code>and 128</code>也就是按位与10000000，也就是取的第一位数。</li><li>第四句获取是否为控制帧，<code>and 8</code>也就是按位与00001000，取得是第五位，也就是<code>opcode</code>的第一位，这是什么意思呢？我们看看刚才的数据帧格式，发现从<code>0x8</code>开始就是所谓的控制帧了。<code>0x8</code>对应的二进制是1000，<code>0x7</code>对应的二进制是0111。发现了吧，如果为控制帧的时候，<code>opcode</code>第一位肯定是为1的，所以这里就判断的第五位。</li></ul><p>后面还有读取第二个字节的代码，大家可以自己沿着这个思路自己看看，包括了读取<code>MASK</code>，读取数据长度的三种长度等。</p><p>所以这个<code>processNextFrame</code>方法主要做了三件事：</p><ul><li><code>readHeader</code>方法中，判断了是否为控制帧，是否为<code>结束帧</code>，然后获取了<code>Mask</code>标识，帧长度等参数</li><li><code>readControlFrame</code>方法中，主要处理了该帧数据为<code>ping，pong，close</code>三种情况，并且在收到<code>close关闭帧</code>的情况下，回调了<code>onReadClose</code>方法，这个待会要细看下。</li><li><code>readMessageFrame</code>方法中，主要是读取了消息后，回调了onReadMessage方法。</li></ul><p>至此可以发现，其实<code>WebSocket</code>传输数据并不是一个简单的事，只是<code>OkHttp</code>都帮我们封装好了，我们只需要直接传输数据即可，感谢这些三方库为我们开发作出的贡献，不知道什么时候我也能做出点贡献呢🤔。</p><p>对了，刚才说回调也很重要，接着看看。<code>onReadClose</code>和<code>onReadMessage</code>回调到哪了呢？还记得上文初始化<code>WebSocketWriter</code>的时候设置了回调接口吗。所以就是回调给<code>RealWebSocket</code>了：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealWebSocket.kt</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReadClose</span><span class="params">(code: <span class="type">Int</span>, reason: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">  require(code != -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> toClose: Streams? = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">var</span> readerToClose: WebSocketReader? = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">var</span> writerToClose: WebSocketWriter? = <span class="literal">null</span></span><br><span class="line">  synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">    check(receivedCloseCode == -<span class="number">1</span>) &#123; <span class="string">&quot;already closed&quot;</span> &#125;</span><br><span class="line">    receivedCloseCode = code</span><br><span class="line">    receivedCloseReason = reason </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    listener.onClosing(<span class="keyword">this</span>, code, reason)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (toClose != <span class="literal">null</span>) &#123;</span><br><span class="line">      listener.onClosed(<span class="keyword">this</span>, code, reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    toClose?.closeQuietly()</span><br><span class="line">    readerToClose?.closeQuietly()</span><br><span class="line">    writerToClose?.closeQuietly()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReadMessage</span><span class="params">(text: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">  listener.onMessage(<span class="keyword">this</span>, text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReadMessage</span><span class="params">(bytes: <span class="type">ByteString</span>)</span></span> &#123;</span><br><span class="line">  listener.onMessage(<span class="keyword">this</span>, bytes)</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>onReadClose</code>回调方法里面有个关键的参数，<code>receivedCloseCode</code>。还记得这个参数吗？上文中解析消息的循环条件就是<code>receivedCloseCode == -1</code>，所以当收到关闭帧的时候，<code>receivedCloseCode</code>就不再等于-1（规定大于1000），也就不再去读取解析消息了。这样整个流程就结束了。</p><p>其中还有一些<code>WebSocketListener</code>的回调，比如<code>onClosing，onClosed，onMessage</code>等，就直接回调给用户使用了。至此，接收消息处理消息说完了。</p><h3 id="3-3-发消息"><a href="#3-3-发消息" class="headerlink" title="3.3 发消息"></a>3.3 发消息</h3><p>好了。接着说发送，看看<code>send</code>方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Synchronized</span> <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">send</span><span class="params">(<span class="keyword">data</span>: <span class="type">ByteString</span>, formatOpcode: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  <span class="comment">// ***</span></span><br><span class="line">  <span class="comment">// Enqueue the message frame.</span></span><br><span class="line">  queueSize += <span class="keyword">data</span>.size.toLong()</span><br><span class="line">  messageAndCloseQueue.add(Message(formatOpcode, <span class="keyword">data</span>))</span><br><span class="line">  runWriter()</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先，把要发送的<code>data</code>封装成<code>Message</code>对象，然后入队列<code>messageAndCloseQueue</code>。最后执行<code>runWriter</code>方法。这都不用猜了，<code>runWriter</code>肯定就要开始发送消息了，继续看：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealWebSocket.kt</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">runWriter</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.assertThreadHoldsLock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> writerTask = writerTask</span><br><span class="line">  <span class="keyword">if</span> (writerTask != <span class="literal">null</span>) &#123;</span><br><span class="line">    taskQueue.schedule(writerTask)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">WriterTask</span> : <span class="type">Task</span></span>(<span class="string">&quot;<span class="variable">$name</span> writer&quot;</span>) &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">runOnce</span><span class="params">()</span></span>: <span class="built_in">Long</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (writeOneFrame()) <span class="keyword">return</span> <span class="number">0L</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">      failWebSocket(e, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1L</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是schedule方法转到WriterTask的runOnce方法过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//TaskQueue.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">schedule</span><span class="params">(task: <span class="type">Task</span>, delayNanos: <span class="type">Long</span> = <span class="number">0</span>L)</span></span> &#123;</span><br><span class="line">  synchronized(taskRunner) &#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduleAndDecide(task, delayNanos, recurrence = <span class="literal">false</span>)) &#123;</span><br><span class="line">      taskRunner.kickCoordinator(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">scheduleAndDecide</span><span class="params">(task: <span class="type">Task</span>, delayNanos: <span class="type">Long</span>, recurrence: <span class="type">Boolean</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  <span class="comment">//***</span></span><br><span class="line">  <span class="keyword">if</span> (insertAt == -<span class="number">1</span>) insertAt = futureTasks.size</span><br><span class="line">  futureTasks.add(insertAt, task)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Impact the coordinator if we inserted at the front.</span></span><br><span class="line">  <span class="keyword">return</span> insertAt == <span class="number">0</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//TaskRunner.kt</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">kickCoordinator</span><span class="params">(taskQueue: <span class="type">TaskQueue</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.assertThreadHoldsLock()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (taskQueue.activeTask == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (taskQueue.futureTasks.isNotEmpty()) &#123;</span><br><span class="line">      readyQueues.addIfAbsent(taskQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      readyQueues.remove(taskQueue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (coordinatorWaiting) &#123;</span><br><span class="line">    backend.coordinatorNotify(<span class="keyword">this</span><span class="symbol">@TaskRunner</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    backend.execute(runnable)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> runnable: Runnable = <span class="keyword">object</span> : Runnable &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> task = synchronized(<span class="keyword">this</span><span class="symbol">@TaskRunner</span>) &#123;</span><br><span class="line">        awaitTaskToRun()</span><br><span class="line">      &#125; ?: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      logElapsed(task, task.queue!!) &#123;</span><br><span class="line">        <span class="keyword">var</span> completedNormally = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          runTask(task)</span><br><span class="line">          completedNormally = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// If the task is crashing start another thread to service the queues.</span></span><br><span class="line">          <span class="keyword">if</span> (!completedNormally) &#123;</span><br><span class="line">            backend.execute(<span class="keyword">this</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">runTask</span><span class="params">(task: <span class="type">Task</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    delayNanos = task.runOnce()</span><br><span class="line">  &#125; </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码有点长，这里是从<code>runWriter</code>开始跟的几个方法，拿到<code>writerTask</code>实例后，存到<code>TaskQueue</code>的<code>futureTasks列表</code>里，然后到<code>runnable</code>这里可以看到是一个<code>while</code>死循环，不断的从<code>futureTasks</code>中取出<code>Task</code>并执行<code>runTask</code>方法，直到<code>Task</code>为空，循环停止。</p><p>其中涉及到两个新的类：</p><ul><li><code>TaskQueue类</code>主要就是管理消息任务列表，保证按顺序执行</li><li><code>TaskRunner类</code>主要就是做一些任务的具体操作，比如线程池里执行任务，记录消息任务的状态（准备发送的任务队列<code>readyQueues</code>，正在执行的任务队列<code>busyQueues</code>等等）</li></ul><p>而每一个Task最后都是执行到了<code>WriterTask</code>的<code>runOnce</code>方法，也就是<code>writeOneFrame</code>方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeOneFrame</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  synchronized(<span class="keyword">this</span><span class="symbol">@RealWebSocket</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (failed) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// Failed web socket.</span></span><br><span class="line">    &#125;</span><br><span class="line">    writer = <span class="keyword">this</span>.writer</span><br><span class="line">    pong = pongQueue.poll()</span><br><span class="line">    <span class="keyword">if</span> (pong == <span class="literal">null</span>) &#123;</span><br><span class="line">      messageOrClose = messageAndCloseQueue.poll()</span><br><span class="line">      <span class="keyword">if</span> (messageOrClose <span class="keyword">is</span> Close) &#123;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageOrClose == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// The queue is exhausted.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//发送消息逻辑，包括`pong`消息，普通消息，关闭消息</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pong != <span class="literal">null</span>) &#123;</span><br><span class="line">      writer!!.writePong(pong)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageOrClose <span class="keyword">is</span> Message) &#123;</span><br><span class="line">      <span class="keyword">val</span> message = messageOrClose <span class="keyword">as</span> Message</span><br><span class="line">      writer!!.writeMessageFrame(message.formatOpcode, message.<span class="keyword">data</span>)</span><br><span class="line">      synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">        queueSize -= message.<span class="keyword">data</span>.size.toLong()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageOrClose <span class="keyword">is</span> Close) &#123;</span><br><span class="line">      <span class="keyword">val</span> close = messageOrClose <span class="keyword">as</span> Close</span><br><span class="line">      writer!!.writeClose(close.code, close.reason)</span><br><span class="line">      <span class="comment">// We closed the writer: now both reader and writer are closed.</span></span><br><span class="line">      <span class="keyword">if</span> (streamsToClose != <span class="literal">null</span>) &#123;</span><br><span class="line">        listener.onClosed(<span class="keyword">this</span>, receivedCloseCode, receivedCloseReason!!)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    streamsToClose?.closeQuietly()</span><br><span class="line">    readerToClose?.closeQuietly()</span><br><span class="line">    writerToClose?.closeQuietly()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里就会执行发送消息的逻辑了，主要有三种消息情况处理：</p><ul><li><code>pong消息</code>，这个主要是为服务器端准备的，发送给客户端回应心跳包。</li><li><code>普通消息</code>，就会把数据类型<code>Opcode</code>和具体数据发送过去</li><li><code>关闭消息</code>，其实当用户执行<code>close</code>方法关闭<code>WebSocket</code>的时候，也是发送了一条<code>Close控制帧</code>消息给服务器告知这个关闭需求，并带上<code>code状态码</code>和<code>reason关闭原因</code>，然后服务器端就会关闭当前连接。</li></ul><p>好了。最后一步了，就是把这些数据组装成<code>WebSocket</code>数据帧并写入流，分成<code>控制帧</code>数据和<code>普通消息数据帧</code>：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//写入（发送）控制帧</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeControlFrame</span><span class="params">(opcode: <span class="type">Int</span>, payload: <span class="type">ByteString</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (writerClosed) <span class="keyword">throw</span> IOException(<span class="string">&quot;closed&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">val</span> length = payload.size</span><br><span class="line">  require(length &lt;= PAYLOAD_BYTE_MAX) &#123;</span><br><span class="line">    <span class="string">&quot;Payload size must be less than or equal to <span class="variable">$PAYLOAD_BYTE_MAX</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> b0 = B0_FLAG_FIN or opcode</span><br><span class="line">  sinkBuffer.writeByte(b0)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> b1 = length</span><br><span class="line">  <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">    b1 = b1 or B1_FLAG_MASK</span><br><span class="line">    sinkBuffer.writeByte(b1)</span><br><span class="line">    random.nextBytes(maskKey!!)</span><br><span class="line">    sinkBuffer.write(maskKey)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> payloadStart = sinkBuffer.size</span><br><span class="line">      sinkBuffer.write(payload)</span><br><span class="line">      sinkBuffer.readAndWriteUnsafe(maskCursor!!)</span><br><span class="line">      maskCursor.seek(payloadStart)</span><br><span class="line">      toggleMask(maskCursor, maskKey)</span><br><span class="line">      maskCursor.close()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sinkBuffer.writeByte(b1)</span><br><span class="line">    sinkBuffer.write(payload)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sink.flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//写入（发送）普通消息数据帧</span></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">writeMessageFrame</span><span class="params">(formatOpcode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">ByteString</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (writerClosed) <span class="keyword">throw</span> IOException(<span class="string">&quot;closed&quot;</span>)</span><br><span class="line"></span><br><span class="line">  messageBuffer.write(<span class="keyword">data</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> b0 = formatOpcode or B0_FLAG_FIN</span><br><span class="line">  <span class="keyword">val</span> dataSize = messageBuffer.size</span><br><span class="line">  sinkBuffer.writeByte(b0)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> b1 = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">    b1 = b1 or B1_FLAG_MASK</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">when</span> &#123;</span><br><span class="line">    dataSize &lt;= PAYLOAD_BYTE_MAX -&gt; &#123;</span><br><span class="line">      b1 = b1 or dataSize.toInt()</span><br><span class="line">      sinkBuffer.writeByte(b1)</span><br><span class="line">    &#125;</span><br><span class="line">    dataSize &lt;= PAYLOAD_SHORT_MAX -&gt; &#123;</span><br><span class="line">      b1 = b1 or PAYLOAD_SHORT</span><br><span class="line">      sinkBuffer.writeByte(b1)</span><br><span class="line">      sinkBuffer.writeShort(dataSize.toInt())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">      b1 = b1 or PAYLOAD_LONG</span><br><span class="line">      sinkBuffer.writeByte(b1)</span><br><span class="line">      sinkBuffer.writeLong(dataSize)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">    random.nextBytes(maskKey!!)</span><br><span class="line">    sinkBuffer.write(maskKey)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataSize &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">      messageBuffer.readAndWriteUnsafe(maskCursor!!)</span><br><span class="line">      maskCursor.seek(<span class="number">0L</span>)</span><br><span class="line">      toggleMask(maskCursor, maskKey)</span><br><span class="line">      maskCursor.close()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sinkBuffer.write(messageBuffer, dataSize)</span><br><span class="line">  sink.emit()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>大家应该都能看懂了吧，其实就是组装数据帧，包括<code>Opcode，mask，数据长度</code>等等。两个方法的不同就在于普通数据需要判断数据长度的三种情况，再组装数据帧。最后都会通过<code>sinkBuffer</code>写入到输出数据流。</p><p>终于，基本的流程说的差不多了。其中还有很多细节，同学们可以自己花时间看看琢磨琢磨，比如<code>Okio</code>部分。还是那句话，希望大家有空自己也读一读相关源码，这样理解才能深刻，而且你肯定会发现很多我没说到的细节，欢迎大家讨论。我也会继续努力，最后大家给我加个油点个赞吧，感谢感谢。</p><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/13/173476f65e6e3ed4~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.image" alt="OkHttp-WebSocket源码.jpg"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/05/13/HTTPS-%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/05/13/HTTPS-%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">HTTPS 学习整理</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-05-13 08:23:15" itemprop="dateCreated datePublished" datetime="2022-05-13T08:23:15+08:00">2022-05-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-20 05:27:07" itemprop="dateModified" datetime="2022-10-20T05:27:07+08:00">2022-10-20</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="HTTPS-学习整理"><a href="#HTTPS-学习整理" class="headerlink" title="HTTPS 学习整理"></a>HTTPS 学习整理</h2><h3 id="1-HTTPS-连接及握手过程"><a href="#1-HTTPS-连接及握手过程" class="headerlink" title="1.HTTPS 连接及握手过程"></a>1.HTTPS 连接及握手过程</h3><p><strong>第一步</strong>，客户端发送给服务器Client Hello，叫做Client Hello 其实是一个一字节的数据</p><p><img src="/../images/image-20220513082622256.png" alt="image-20220513082622256"></p><p>发送Client Hello 还会附加一些信息</p><ol><li>可选的TLS版本</li><li>可选的加密套件<ul><li>可选的对称加密算法</li><li>可选的非对称加密算法</li><li>可选的hash算法</li></ul></li><li>客户端随机数（这个随机数随后会用到，等于是第一个随机数客户端和服务器都会使用到）</li></ol><p><img src="/../images/image-20220513082816474.png" alt="image-20220513082816474"></p><p><strong>第二步</strong>，服务端返回Server Hello 也是一个单字节数据，并把Client Hello 附加信息的确认值返回给客户端，同时生成服务端的随机数，返回给客户端</p><p><img src="/../images/image-20220513083321789.png" alt="image-20220513083321789"></p><p><strong>第三步</strong>，服务端下发证书，然后客户端这里会做证书的较验，这里的过程比较麻烦和复杂</p><p><img src="/../images/image-20220513083443606.png" alt="image-20220513083443606"></p><p>如图所示，证书中包含</p><ul><li>服务器公钥</li><li>服务器主机名</li><li>服务器公钥的签名</li><li>证书签发机构的公钥</li><li>证书签发机构的公角的签名</li><li>….</li></ul><p>较验的顺序也是如此，链式去使用签名去较验公钥是否准确，防止公钥被修改，一层层直到找到根证书，根证书一般都安装在pc或者手机里，然后逐层去较验公钥的正确性，最后证明服务器的公钥确实是真的，而不是假的</p><p><img src="/../images/image-20220513134035609.png" alt="image-20220513134035609"></p><p>如图所示，访问hencoder.com 然后证书链中的三级证书，客户端验证服务器证书的真实性，还通过主机名确认对方的身份，确实是我要访问的服务器，而不是其他在ca公签的服务器</p><p><img src="/../images/image-20220513134238446.png" alt="image-20220513134238446"></p><p><strong>第四步</strong>，客户端拿到服务器公钥后，和服务器一起通过公钥生成加密的Pre-master secret ，双方就公同持有了三个东西</p><ul><li>客户端随机数</li><li>服务器随机数</li><li>Pre-master secret</li></ul><p>通过这三个东西会各自独立的生成master secret 所以注意啦，<strong>最终的对称密钥并不是客户端生成后发给服务器的，而是由前面交互的随机数，及加密后的公钥独立生成的</strong></p><p><img src="/../images/image-20220513134634905.png" alt="image-20220513134634905"></p><p><strong>而且，生成的对称加密的密钥并不是简单的一个密码</strong></p><p><img src="/../images/image-20220513134726832.png" alt="image-20220513134726832"></p><p>那么有人可能会有疑问，为什么要很麻烦的生成客户端的加密密钥，服务端的加密密钥？用一个不行么？</p><p><img src="/../images/image-20220513134838968.png" alt="image-20220513134838968"></p><p><strong>第五步，客户端告诉服务器，我将使用加密通信，还有把前面几步合一起加密发给服务器，生送Finished 同样服务器也返回客户端：将使用加密通信，同时Finished握手</strong></p><p><img src="/../images/image-20220513135059793.png" alt="image-20220513135059793"></p><p>服务端返回</p><p><img src="/../images/image-20220513135117684.png" alt="image-20220513135117684"></p><p><img src="/../images/image-20220513135132604.png" alt="image-20220513135132604"></p><h3 id="2-在Android中合理使用HTTPS"><a href="#2-在Android中合理使用HTTPS" class="headerlink" title="2.在Android中合理使用HTTPS"></a>2.在Android中合理使用HTTPS</h3><p>CA公签的就不讨论了，使用很方便，根据所使用的网络框架，可以自行百度，非常简单方便。这里说下如何较验主机名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an HostnameVerifier that hardwires the expected hostname.</span></span><br><span class="line"><span class="comment">// Note that is different than the URL&#x27;s hostname:</span></span><br><span class="line"><span class="comment">// example.com versus example.org</span></span><br><span class="line">HostnameVerifier hostnameVerifier = <span class="keyword">new</span> HostnameVerifier() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(String hostname, SSLSession session)</span> </span>&#123;</span><br><span class="line">        HostnameVerifier hv =</span><br><span class="line">            HttpsURLConnection.getDefaultHostnameVerifier();</span><br><span class="line">        <span class="keyword">return</span> hv.verify(<span class="string">&quot;example.com&quot;</span>, session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the URLConnection to use our HostnameVerifier</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">&quot;https://example.org/&quot;</span>);</span><br><span class="line">HttpsURLConnection urlConnection =</span><br><span class="line">    (HttpsURLConnection)url.openConnection();</span><br><span class="line">urlConnection.setHostnameVerifier(hostnameVerifier);</span><br><span class="line">InputStream in = urlConnection.getInputStream();</span><br><span class="line">copyInputStreamToOutputStream(in, System.out);</span><br></pre></td></tr></table></figure><p>还有一种情况，有一些公司使用自签名证书，或者非知名机构颁发的证书，如果不做处理，会报https的网络异常，那么这时候上网上查的话，很多都是告诉不做较验，放开所有的证书，当然这样可以走的通，但是同时也失去了使用HTTPS的作用，是不认真负责的。</p><p>我们看官网上对这一过程的描述，之所以之前我们记不住，也是因为我们对HTTPS的握手和证书较验过程不够理解，现在看这段话</p><blockquote><p>在这种情况下，由于您的 CA 不受系统信任，将发生 SSLHandshakeException。原因可能是您有一个由 Android 尚不信任的新 CA 颁发的证书，或您的应用在没有 CA 的较旧版本上运行。CA 未知的原因通常是因为它不是公共 CA，而是由政府、公司或教育机构等组织颁发的仅供其自己使用的私有 CA。</p><p>幸运的是，您可以指示 HttpsURLConnection 信任特定的 CA 集。这个过程可能有点复杂，下面的示例展示了这个过程：从 InputStream 获取一个特定的 CA，用该 CA 创建 KeyStore，然后用后者创建和初始化 TrustManager。TrustManager 是系统用于验证来自服务器的证书的工具，可以通过包含一个或多个 CA 的 KeyStore 创建，而创建的 TrustManager 将仅信任这些 CA。</p><p>由于 TrustManager 是新建的，此示例将启动一个新的 SSLContext，它会提供一个 SSLSocketFactory，可用于替换来自 HttpsURLConnection 的默认 SSLSocketFactory。这样一来，连接将使用您的 CA 来验证证书。</p></blockquote><p>这下你知道，为啥Android客户会有一个证书文件了吧</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// Load CAs from an InputStream</span></span><br><span class="line"><span class="comment">// (could be from a resource or ByteArrayInputStream or ...)</span></span><br><span class="line">CertificateFactory cf = CertificateFactory.getInstance(<span class="string">&quot;X.509&quot;</span>);</span><br><span class="line"><span class="comment">// From https://www.washington.edu/itconnect/security/ca/load-der.crt</span></span><br><span class="line">InputStream caInput = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;load-der.crt&quot;</span>));</span><br><span class="line">Certificate ca;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ca = cf.generateCertificate(caInput);</span><br><span class="line">    System.out.println(<span class="string">&quot;ca=&quot;</span> + ((X509Certificate) ca).getSubjectDN());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    caInput.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a KeyStore containing our trusted CAs</span></span><br><span class="line">String keyStoreType = KeyStore.getDefaultType();</span><br><span class="line">KeyStore keyStore = KeyStore.getInstance(keyStoreType);</span><br><span class="line">keyStore.load(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">keyStore.setCertificateEntry(<span class="string">&quot;ca&quot;</span>, ca);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a TrustManager that trusts the CAs in our KeyStore</span></span><br><span class="line">String tmfAlgorithm = TrustManagerFactory.getDefaultAlgorithm();</span><br><span class="line">TrustManagerFactory tmf = TrustManagerFactory.getInstance(tmfAlgorithm);</span><br><span class="line">tmf.init(keyStore);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an SSLContext that uses our TrustManager</span></span><br><span class="line">SSLContext context = SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);</span><br><span class="line">context.init(<span class="keyword">null</span>, tmf.getTrustManagers(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the URLConnection to use a SocketFactory from our SSLContext</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">&quot;https://certs.cac.washington.edu/CAtest/&quot;</span>);</span><br><span class="line">HttpsURLConnection urlConnection =</span><br><span class="line">    (HttpsURLConnection)url.openConnection();</span><br><span class="line">urlConnection.setSSLSocketFactory(context.getSocketFactory());</span><br><span class="line">InputStream in = urlConnection.getInputStream();</span><br><span class="line">copyInputStreamToOutputStream(in, System.out);</span><br></pre></td></tr></table></figure><p>这个SSLContext很关键，由得到的SSLContextFactory是我们很多网络框架可以进行替换和设置，这样就可以通过自签名的ca集来检验较验证书的合法性了。</p><p>之所以说SSLContext很关键，因为不光HTTP可以使用SSL较验，很多上层加密都使用了SSL层的加密特性，比如我们可能会遇到的WSS Websocket的加密协议，怎么处理，一样的道理。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/05/08/Jetpack%E7%B3%BB%E5%88%97%E2%80%94%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/05/08/Jetpack%E7%B3%BB%E5%88%97%E2%80%94%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Jetpack系列—底部导航路由BottomNavigationView原理</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-05-08 06:35:47" itemprop="dateCreated datePublished" datetime="2022-05-08T06:35:47+08:00">2022-05-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-20 05:27:07" itemprop="dateModified" datetime="2022-10-20T05:27:07+08:00">2022-10-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Jetpack%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Jetpack系列</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>主要介绍BottomNavigationView及其实现原理</p><div class="post-button"><a class="btn" href="/2022/05/08/Jetpack%E7%B3%BB%E5%88%97%E2%80%94%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/04/16/Gradle%E5%9F%BA%E7%A1%80/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/04/16/Gradle%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">Gradle基础</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-04-16 06:35:47" itemprop="dateCreated datePublished" datetime="2022-04-16T06:35:47+08:00">2022-04-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-20 05:27:07" itemprop="dateModified" datetime="2022-10-20T05:27:07+08:00">2022-10-20</time></span></div></header><div class="post-body" itemprop="articleBody"><p>讲解Gradle基础知识，语法及生命周期</p><div class="post-button"><a class="btn" href="/2022/04/16/Gradle%E5%9F%BA%E7%A1%80/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/03/20/Jetpack%E7%B3%BB%E5%88%97%E2%80%94LiveData/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/20/Jetpack%E7%B3%BB%E5%88%97%E2%80%94LiveData/" class="post-title-link" itemprop="url">Jetpack系列—LiveData原理解析</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-20 18:43:51" itemprop="dateCreated datePublished" datetime="2022-03-20T18:43:51+08:00">2022-03-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-20 05:27:07" itemprop="dateModified" datetime="2022-10-20T05:27:07+08:00">2022-10-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Jetpack%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Jetpack系列</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><ul><li>什么是<code>LiveData</code></li><li><code>LiveData</code>几种衍生类</li><li><code>LiveData</code>核心方法</li><li><code>LiveData</code>实现原理</li></ul><h2 id="1-什么是LiveData"><a href="#1-什么是LiveData" class="headerlink" title="1.什么是LiveData"></a>1.什么是LiveData</h2><ul><li><code>LiveData</code>组件是<code>Jetpack</code>新推出的基于观察者的消息订阅&#x2F;分发组件，具有宿主(<code>Activity</code>&#x2F;<code>Fragment</code>)生命周期感知能力，这种感知能力可确保<code>LiveData</code>仅分发消息给处于<code>活跃状态</code>的观察者，即只有处于<code>活跃状态</code>的观察者才能收到消息</li><li><code>LiveData</code>的消息分发机制，是以往的<code>Handler</code>，<code>EventBus</code>，<code>RxJavaBus</code>无法比拟的，它们不会顾及当前页面是否可见，一股脑的有消息就转发。导致即便应用在后台，页面不可见，还在做一些无用的绘制，计算(细心的同学可以发现微信消息列表是在可见状态时才会更新列表最新信息的)</li></ul><blockquote><p>活跃状态：<code>Observer</code>所在宿主处于<code>started</code>,<code>resumed</code>状态</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppcompactActivity</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span></span>&#123;</span><br><span class="line">    <span class="meta">@Ovderride</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span></span>&#123;</span><br><span class="line">      <span class="comment">//无论页面可见不可见，都会去执行页面刷新,IO。更有甚者弹出对话框</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//1.无论当前页面是否可见，这条消息都会被分发。——消耗资源</span></span><br><span class="line">  <span class="comment">//2.无论前宿主是否还存活，这条消息都会被分发。——内存泄漏</span></span><br><span class="line">  handler.sendMessage(msg);</span><br><span class="line"></span><br><span class="line">  liveData.observer(<span class="keyword">this</span>,<span class="keyword">new</span> Observer&lt;User&gt;)&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//1.减少资源占用 —— 页面不可见时不会派发消息</span></span><br><span class="line">  <span class="comment">//2.确保页面始终保持最新状态——页面可见时，会立刻派发新新的一条消息给所有观察者——保证页面最新状态</span></span><br><span class="line">  <span class="comment">//3.不再需要手动处理生命周期——避免NPE</span></span><br><span class="line">  <span class="comment">//4.livedata默认是不能跨页面使用的，但是我们有办法，可以打造一款不用反注册，不会内存泄漏的消息总线——取代eventbus</span></span><br><span class="line">	liveData.postValue(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-LiveData的几种用法"><a href="#2-LiveData的几种用法" class="headerlink" title="2.LiveData的几种用法"></a>2.LiveData的几种用法</h2><h3 id="2-1-MutableLiveData"><a href="#2-1-MutableLiveData" class="headerlink" title="2.1 MutableLiveData"></a>2.1 MutableLiveData</h3><p>我们在使用LiveData在做消息分发的时候，需要使用这个子类。之所以这么设计，是考虑到单一开闭原则，只有拿到MutableLiveData对象才可以发送消息，LiveData对象只能接收消息，避免拿到LiveData对象时既能发消息也能收到消息的混乱使用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.postValue(value);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.setValue(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-MediatorLiveData"><a href="#2-2-MediatorLiveData" class="headerlink" title="2.2 MediatorLiveData"></a>2.2 MediatorLiveData</h3><ul><li>可以统一观察多个LiveData的发射的数据进行统一的处理</li><li>同时也可以做为一个LiveData，被其他Observer观察。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建两个长的差不多的LiveData对象</span></span><br><span class="line">LiveData&lt;Integer&gt; liveData1 = <span class="keyword">new</span> MutableLiveData();</span><br><span class="line">LiveData&lt;Integer&gt; liveData2 = <span class="keyword">new</span> MutableLiveData();</span><br><span class="line"></span><br><span class="line"><span class="comment">//再创建一个聚合类MediatorLiveData</span></span><br><span class="line">MediatorLiveData&lt;Integer&gt; liveDataMerger = <span class="keyword">new</span> MediatorLiveData();</span><br><span class="line"><span class="comment">//分别把上面创建的LiveData添加进来</span></span><br><span class="line">liveDataMerger.addSource(liveData1,observer);</span><br><span class="line">liveDataMerger.addSource(liveData2,observer);</span><br><span class="line"></span><br><span class="line">Observer observer = <span class="keyword">new</span> Observer&lt;Integer&gt;&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(<span class="meta">@Nullable</span> Integer s)</span></span>&#123;</span><br><span class="line">    titleTextView.setText(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//一旦liveData1或者liveData2发送了新的数据，observer便能观察到，以便统一处理更新UI</span></span><br></pre></td></tr></table></figure><h3 id="2-3-Transformations-map-操作符"><a href="#2-3-Transformations-map-操作符" class="headerlink" title="2.3 Transformations.map 操作符"></a>2.3 Transformations.map 操作符</h3><p>可以对liveData进行变化，并且返回一个新的livedata对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MutableLiveData&lt;Integer&gt; data = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据转换</span></span><br><span class="line">LiveData&lt;String&gt; transformData = Transformations.map(data,input -&gt; String.valueOf(input));</span><br><span class="line"><span class="comment">//使用转换后生成的transformData去观察数据</span></span><br><span class="line">transformData.observe(<span class="keyword">this</span>,output -&gt; &#123;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用原始的livedata发送数据</span></span><br><span class="line">data.setValue(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h2 id="3-LiveData核心方法"><a href="#3-LiveData核心方法" class="headerlink" title="3.LiveData核心方法"></a>3.LiveData核心方法</h2><table><thead><tr><th>方法名</th><th>作用</th></tr></thead><tbody><tr><td>observe(LifecycleOwner owner,Observer observer)</td><td>注册和宿主生命周期关联的观察者</td></tr><tr><td>observeForever(Observer observer)</td><td>注册观察者，不会反注册，需要自行维护</td></tr><tr><td>setValue(T data)</td><td>发送数据，没有活跃的观察者时不会分发。只能在主线程。</td></tr><tr><td>postValue(T data)</td><td>和setValue一样。不受线程环境限制。</td></tr><tr><td>onActive</td><td>当且仅当有一个活跃的观察者时会触发</td></tr><tr><td>inActive</td><td>不存在活跃的观察者时会触发</td></tr></tbody></table><h2 id="4-LiveData实现原理"><a href="#4-LiveData实现原理" class="headerlink" title="4.LiveData实现原理"></a>4.LiveData实现原理</h2><p><img src="/../images/image-20220514110449881.png" alt="image-20220514110449881"></p><p><img src="/../images/image-20220514111210613.png" alt="image-20220514111210613"></p><p><code>LiveData</code>使用的有很多好处</p><ul><li>确保<code>UI</code>符合数据状态</li><li>不需要手动处理生命周期</li><li>始终保持最新的数据</li><li>事件总线<code>LiveDataBus</code></li></ul><p><strong>确保UI符合数据状态</strong></p><p>因为<code>livedata</code>实现了观察者模式 它里面的数据发生变化的时候，会向注册的<code>Observer</code>观察者发送通知，这时可以在观察者的<code>onChanged</code>里面更改UI 以保持数据的最新化</p><p><strong>不需要手动处理生命周期</strong></p><p>在注册<code>observe</code>的时候，会将当前宿主的生命周期进行绑定，当宿主被销毁时，就自动的进行销毁</p><p><strong>始终保持最新的数据</strong></p><p>可以这么理解，当宿主的生命周期变为非活跃状态的时候，那么它将在再次变为活跃状态的时候，接收到最新的数据，比如<code>activity</code> 从前台返回到后台，再从后台返回前台。再比如<code>actvity</code>和<code>fragment</code>由于配置的更改，而重新创建，也是能够接收到最新可用的数据，来保持最新的数据和UI</p><p>事件总线<code>LiveDataBus</code></p><p>使用<code>livedata</code>来实现消息总线，替代使用<code>eventbus</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//有参数构造 mVersion = 0  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LiveData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    mData = value;</span><br><span class="line">    mVersion = START_VERSION + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//无参数构造，mVersion = -1  mData = NOT_SET</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LiveData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mData = NOT_SET;</span><br><span class="line">    mVersion = START_VERSION;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么为什么<code>livedata</code>需要一个<code>version</code>呢？</p><p>因为<code>livedata</code>通过<code>version</code>来控制数据分发，通过<code>mVersion</code>来进行数据的比对，本次是否需要进行数据的分发，因为不能<code>livedata</code>发送一次数据，而observable能接收到2，3次数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//把宿主和observer进行绑定</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;observe&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//把lifecycle 和 observer包装成了一个LifecycleBoundObserver，也就是一个有边界的的observer</span></span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">  <span class="comment">//包装完后，把wrapper放入一个hashmap里</span></span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//注意这里传入的是包装后的wrapper  lifecycleboundobserver</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过observe可以向livedata注册一个观察者对象</p><p>owner.getLifecycle().addObserver(wrapper) 进入 会进行到实现</p><p>LifecycleRegistry.addObserver(observer)方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>);</span><br><span class="line">  <span class="comment">//判断当前宿主的生命周期状态</span></span><br><span class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">  <span class="comment">//判断完后，会把当前宿主的生命周期和观察者进行包装</span></span><br><span class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">  <span class="comment">//包装完成后也会存储到hashmap里</span></span><br><span class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//为什么要再进行这么包装呢？主要是为了分发当前宿主的生命周期状态给每个observer</span></span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</span><br><span class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// it is null we should be destroyed. Fallback quickly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</span><br><span class="line">    State targetState = calculateTargetState(observer);</span><br><span class="line">    mAddingObserverCounter++;</span><br><span class="line">    <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">        pushParentState(statefulObserver.mState);</span><br><span class="line">        <span class="keyword">final</span> Event event = Event.upFrom(statefulObserver.mState);</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;no event up from &quot;</span> + statefulObserver.mState);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//分发宿主的生命周期状态 给observer</span></span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">        popParentState();</span><br><span class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">        targetState = calculateTargetState(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">    State newState = event.getTargetState();</span><br><span class="line">    mState = min(mState, newState);</span><br><span class="line">  <span class="comment">//这个lifecycleobserver就是我们传递进来的lifecyclebounderobserver</span></span><br><span class="line">    mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">    mState = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个接口是 LifecycleEventObserver的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleEventObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">		<span class="comment">//这个回调的是宿主生命周期的变化  有两个参数，一个是宿主 一个是Event</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source, <span class="meta">@NonNull</span> Lifecycle.Event event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onCreate event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_CREATE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onStart event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_START,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onResume event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_RESUME,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onPause event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_PAUSE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onStop event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_STOP,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onDestroy event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_DESTROY,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An &#123;<span class="doctag">@link</span> Event Event&#125; constant that can be used to match all events.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_ANY;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>宿主的每个生命周期的改变都会回调到onStateChanged</p><p>我们看下它的实现 LifecycleBoundObserver 实现了LifecycleEventObserver</p><p>LifecycleBoundObserver.onStateChanged</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    Lifecycle.State currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">  <span class="comment">//如果当前状态是destroyed</span></span><br><span class="line">    <span class="keyword">if</span> (currentState == DESTROYED) &#123;</span><br><span class="line">      <span class="comment">//自行移除，自行反注册这个observer</span></span><br><span class="line">        removeObserver(mObserver);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Lifecycle.State prevState = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (prevState != currentState) &#123;</span><br><span class="line">        prevState = currentState;</span><br><span class="line">      	<span class="comment">//否则就执行活跃状态的变更 看shouldBeActive方法</span></span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">        currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里判断了只有宿主的生命周期大于start的时候  才代表宿主是活跃的</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续看activeStateChanged</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    mActive = newActive;</span><br><span class="line">    changeActiveCounter(mActive ? <span class="number">1</span> : -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">        dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">changeActiveCounter</span><span class="params">(<span class="keyword">int</span> change)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> previousActiveCount = mActiveCount;</span><br><span class="line">    mActiveCount += change;</span><br><span class="line">    <span class="keyword">if</span> (mChangingActiveState) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mChangingActiveState = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (previousActiveCount != mActiveCount) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> needToCallActive = previousActiveCount == <span class="number">0</span> &amp;&amp; mActiveCount &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">boolean</span> needToCallInactive = previousActiveCount &gt; <span class="number">0</span> &amp;&amp; mActiveCount == <span class="number">0</span>;</span><br><span class="line">            previousActiveCount = mActiveCount;</span><br><span class="line">            <span class="keyword">if</span> (needToCallActive) &#123;<span class="comment">//首次注册会执行onActive </span></span><br><span class="line">                onActive();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (needToCallInactive) &#123;<span class="comment">//当最后一个观察者被移除时，会执行onInactive</span></span><br><span class="line">                onInactive();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mChangingActiveState = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//可以初始化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//可以反注册，释放资源，清理   paging就利用了这里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看 传入true 执行dispatchingValue 把当前的observer传入进去</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">    dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">//不为空，走到considerNotify 里，见considerNotify</span></span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//如果 observer是不活跃的，也是不进行分发的</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//再判断宿主的生命周期是否大于start状态</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">      <span class="comment">//如果不活跃，就把actvityStateChanged状态转为false</span></span><br><span class="line">        observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//mVersion是在livedata的构造里创建的 只有当observer.mLastVersion 小于mVersion的时候才会进行分发</span></span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//这里是分发后，要把mLastVersion 和mVersion进行同步赋值</span></span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">  <span class="comment">//这里才是真正的分发回调onChaned 把livedata里的泛型数据传入进去</span></span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>livedata中还有一个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(<span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;observeForever&quot;</span>);</span><br><span class="line">    AlwaysActiveObserver wrapper = <span class="keyword">new</span> AlwaysActiveObserver(observer);</span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing <span class="keyword">instanceof</span> LiveData.LifecycleBoundObserver) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    wrapper.activeStateChanged(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果注册了这个方法，在宿主被销毁时，livedata是不会帮我们反注册的，需要我们自行去调用removeObserver</p><p>接着来看postValue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> postTask;</span><br><span class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">        postTask = mPendingData == NOT_SET;</span><br><span class="line">        mPendingData = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果当前在子线程中，则必须调用postvalue 不能调用 setvalue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;setValue&quot;</span>);</span><br><span class="line">  <span class="comment">//新的数据需要进行分发，这里mLastVersion就小于mVersion了，可以进行分发，如果调用了onChanged的，消费了这个事件和数据，mLastVersion就同步了</span></span><br><span class="line">    mVersion++;</span><br><span class="line">    mData = value;</span><br><span class="line">    dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatchingValue 传了null值 这个要区别于上面activeStateChanged中的dispatchingValue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//这里传了null 所以，走下面的这个逻辑  遍历这个observers </span></span><br><span class="line">          <span class="comment">//这个observers就是我们之前addObserver添加进去的</span></span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">              <span class="comment">//遍历之后，就会调用considerNoity进行数据的分发，调用onChanged</span></span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>livedata 这个方法，判断是否有活跃的观察者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasActiveObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mActiveCount &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看下livedata的子类，实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MutableLiveData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MutableLiveData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.postValue(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个类好像什么都没做，只是复写了postvalue和setvalue并把方法改成了public而已，那么原因是什么？</p><blockquote><p>因为livedata作为数据发送组件，必定是一方发送一方接收，不能既发送又接收，所以MutableLiveData 是为了规避这个问题才存在的，只有拿到的对象是MutableLiveData它才能进行一个数据的发送</p></blockquote></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/03/18/[%E8%BD%AC]%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/18/%5B%E8%BD%AC%5D%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">提升海量用户极致体验的Hybrid架构设计[转]</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-18 04:23:47" itemprop="dateCreated datePublished" datetime="2022-03-18T04:23:47+08:00">2022-03-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-09 08:04:29" itemprop="dateModified" datetime="2022-10-09T08:04:29+08:00">2022-10-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/hybrid/" itemprop="url" rel="index"><span itemprop="name">hybrid</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/5DHTP6xjkMbNmo49Rd2x">原文链接</a></p><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>上一篇原理篇，我们已经详细地阐述了 Hybrid App 的基础原理，了解了 Native 端 和 H5 端 是如何通信的，还有 bridge 的设计和接入。而本篇文章将开始把这些原因进一步实践，用代码真正地去实现一套完整且稳定的 Hybrid 方案。如果对原理还有疑问的小伙伴，请移步提升海量用户极致体验的 Hybrid 架构设计（原理篇），只有在理解了理论的基础上，进一步与实践相结合，才能真正地去深入一项技术。</p><h3 id="摩天大楼"><a href="#摩天大楼" class="headerlink" title="摩天大楼"></a>摩天大楼</h3><p>说了那么一大堆理论知识，可能有小伙伴会说：“ 你是不是吹流弊啊。”那就先来简单介绍下我们已经使用这套方案落地的项目之一。</p><p><img src="https://static001.infoq.cn/resource/image/62/55/62ed934a1336363916dc24cd6cd3c555.jpg" alt="img"></p><p>这是一个完全内置在 App 里的 Hybrid 模块，由 Native 与 H5 深度协作完成，总共有 4 个页面，其中首页和制作页由 H5 制作，而相机页和保存页是复用 Native 页面。</p><p>项目上线一年累积使用次数已经超过 10 亿次。这套方案经受住了考验，并在过程中仍然在不断的优化和拓展。</p><p>使用这套实现方案是基于以下几点考虑：</p><ul><li>整个模块的风格多变，整体 UI 是与妆容所搭配的，而整个模块一直都在持续不断的迭代之中；</li><li>项目逻辑流程的可变性大，需要 H5 强大的热更新能力，及时应对数据的变化，快速的试错和纠正；</li><li>拍摄页与保存页是客户端已经有的模块，可以略微定制后直接复用；</li><li>需要由客户端协助接入多套 SDK，例如使用算法 SDK 进行复杂的图像处理。</li><li>简单看完项目，我们接下来开始 bridge.js 的构建。由于本系列文章主要面向前端童鞋，因此我们主要展开 H5 的部分，即会注入到每个页面头部的 bridge.js 的实现，客户端中的 SDK 部分就不详细解构了，只会提到一些细节。</li></ul><h3 id="搭建地基-—-bridge-js-架构"><a href="#搭建地基-—-bridge-js-架构" class="headerlink" title="搭建地基 — bridge.js 架构"></a>搭建地基 — bridge.js 架构</h3><p>基于上篇文章阐述的结构，我们进一步去完善细节部分，先整理成下面这样的流程结构图，大家先看下图，有个大致的概念：</p><p><img src="https://static001.infoq.cn/resource/image/f5/59/f54a2b8dfe8d21480d5ac35082ed1059.jpg" alt="img"></p><p>接下来我们会细看里面各个部分的代码实现。</p><h4 id="一-业务方使用姿势"><a href="#一-业务方使用姿势" class="headerlink" title="(一) 业务方使用姿势"></a>(一) 业务方使用姿势</h4><p>首先，我们先看下在这套方案中，业务方是如何使用的，下面以获取网络状态为例：</p><p><img src="https://static001.infoq.cn/resource/image/ad/04/adafcb982014f1ad2becf711d66edc04.jpg" alt="img"></p><h4 id="二-H5-–-gt-Native"><a href="#二-H5-–-gt-Native" class="headerlink" title="(二) H5 –&gt; Native"></a>(二) H5 –&gt; Native</h4><p>接下来直接来看 nativeCall 的内部实现：</p><p><img src="https://static001.infoq.cn/resource/image/d8/d9/d8aaff5b8f7901c9c3bb0a5d4c2370d9.jpg" alt="img"></p><p>里面可以解构成下面 4 个步骤:</p><p>1.生成唯一 handler 标识，从 0 开始累加；</p><p>2.将参数按 handler 值的规则存入参数池(_paramsStore)中；</p><p>3.以 handler 注册自定义事件，绑定 callback，并将 callback 也存入 _callbackStore 中，addEvent()，储存的目的主要是为了事件解绑时使用；</p><p>4.以 iframe 的形式发送协议，并携带唯一标识 handler，send()；</p><p><img src="https://static001.infoq.cn/resource/image/34/fb/3451bc822f66561a8634c459bee34bfb.jpg" alt="img"></p><p>Native:</p><ul><li>客户端接收到请求后，会使用 handler 调用 getParam 从参数池中获取对应的参数。</li><li><img src="https://static001.infoq.cn/resource/image/ff/65/ff4c092674a99fcd263c57e9a3099565.jpg" alt="img"></li><li>执行协议对应的功能；</li><li>这样即走通了 H5 –&gt; Native 的这个流程，在客户端完成了对应的功能后，既开始回传执行结果。</li></ul><h4 id="三-Native-–-gt-H5"><a href="#三-Native-–-gt-H5" class="headerlink" title="(三) Native –&gt; H5"></a>(三) Native –&gt; H5</h4><p>Native：</p><p>Native 完成功能后，直接调用 Bridge.postMessage(handler, data)，将 执行结果 和 之前 nativeCall 传过来的 标识 回传给 H5；</p><p><img src="https://static001.infoq.cn/resource/image/0b/ca/0be7c175fc4ab0140a8db81bc2898aca.jpg" alt="img"></p><p>H5：</p><ul><li>H5 在接收到唯一标识后初始化对应的自定义事件，挂载数据后触发，这里涉及的就是 fireEvent 这个函数:</li><li><img src="https://static001.infoq.cn/resource/image/0b/ca/0be7c175fc4ab0140a8db81bc2898aca.jpg" alt="img"></li><li>这样，我们就已经完成了双端之间的双向交互机制了，梳理出了整个 bridge.js 的核心代码了，包含了：</li><li>最重要的开放 API: nativeCall 与 postMessage ；</li><li>客户端获取参数函数: getParam ；</li><li>事件回调系统中的 addEvent 和 fireEvent ；</li><li>用于发送协议的 send。</li></ul><h3 id="安卓兼容性"><a href="#安卓兼容性" class="headerlink" title="安卓兼容性"></a>安卓兼容性</h3><p>如果看过上一篇提升海量用户极致体验的 Hybrid 架构设计（原理篇）的童鞋，这时可能会有个疑问：在 Android 4.4 以下时，使用的 loadUrl 进行 js 函数的调用，而此时是无法获取函数的返回值的，也就是说 4.4- 时，安卓并无法通过 getParam 这个函数来获取到协议的参数，这里需要做兼容性的处理，而我们这里可以使用一个曲线救国的骚操作，使用到的原理就是上一篇文章中有提到的另一种 H5 -&gt; Native 的方案：WebView 中的 prompt 拦截</p><p>方案如下:</p><ul><li>当安卓接受到协议，并拿到 handler 值；</li><li>使用无兼容性问题的 loadUrl 执行 js：Bridge.getParam(handler) ，直接将返回值直接通过 js 中的 prompt 发出：</li><li><img src="https://static001.infoq.cn/resource/image/7d/56/7d4aa27dd4ac6036993d7255a3d25756.jpg" alt="img"></li><li>通过重写 onJsPrompt 这个方法，拦截上一步发出的 prompt 的内容，并解析出相应的参数；</li><li><img src="https://static001.infoq.cn/resource/image/d1/85/d1c4904ff723ce0f0de5d2408d289685.jpg" alt="img"></li></ul><p>通过这样的方式，安卓全平台都可以完成参数的获取，并且方式统一，不需要分平台兼容，这就非常的 skrskr 啦。</p><p>现在看下来，是不是觉得炒鸡简单？。分分钟能写 100 个。没错！其实核心的原理就是这么的简单，但这只是一个最基础的地基而已，而基于地基之上，我们就可以开始一层一层建造我们的大楼了！</p><h3 id="建造大楼-—-协议的定制"><a href="#建造大楼-—-协议的定制" class="headerlink" title="建造大楼 — 协议的定制"></a>建造大楼 — 协议的定制</h3><p>在完成最基础的架构后，我们就可以开始来进一步完成一些上层建筑了，制定一系列真正开放给业务方使用的协议 API，完善整套方案。</p><p>首先我们可以将这些协议分成 功能协议 和 业务协议。</p><h3 id="功能协议"><a href="#功能协议" class="headerlink" title="功能协议"></a>功能协议</h3><p>这类协议是指用于完善整套方案的基础功能的一些通用协议，以 command:&#x2F;&#x2F;作为通用头，封装在 SDK 之中，可以在全线 App、全线 WebView 中使用：</p><h4 id="1-初始化机制"><a href="#1-初始化机制" class="headerlink" title="1.初始化机制"></a>1.初始化机制</h4><p>上篇文章有提到由于 bridge.js 注入的异步性，我们需要由客户端在注入完成后通知 H5。</p><p>这里我们可以约定一个通用的初始化事件，这里我们约定为 <em>init</em>，因此前端就可以进行入口的监听, 类似于我们常用的 DOMContentLoaded:</p><p><img src="https://static001.infoq.cn/resource/image/e6/b5/e61a71943ab3bbbb8d21a0dc27fa09b5.jpg" alt="img"></p><p>大家可以看到，这里用了个标记位用于避免事件被重复触发，这是由于客户端中是通过监听 WebView 的生命周期钩子来触发的，而 iframe 之类的操作会导致这些钩子的多次触发，因此需要双方各做一层防御性措施。</p><p>接下来，我们可以通过该事件，直接初始化传给 H5 一些环境参数和系统信息等，下面是我们使用到的：</p><p><img src="https://static001.infoq.cn/resource/image/cf/1f/cf5b40ef0c8355b766288e53967d9a1f.jpg" alt="img"></p><p>同样的，我们可以约定更多的页面生命周期事件，例如因为 App 很经常性的隐藏到后台，因此在被激活时，我们可以设置个生命周期: <em>resume</em>，可以用于告知 H5 页面被激活。</p><p>Tips:</p><p>这里就能体现出我们通过事件机制来作为回调系统的优势了，我们可以以最习惯的方式进行事件的监听，而客户端可以直接使用 bridge.fireEvent(‘<em>init</em>’, data)触发事件，这样便可以优雅地实现 Native -&gt; H5 的单方向交互。</p><h4 id="2-打包机制"><a href="#2-打包机制" class="headerlink" title="2.打包机制"></a>2.打包机制</h4><p>Hybrid 模块 的其中一种方式是将前端代码打包后内置于 App 本地，以便拥有最快的启动性能和离线访问能力。而这种方式最大的麻烦点，就是代码的更新，我们不可能每次有修改时就手动重新打包给客户端童鞋替换，而且这样也失去了我们的热更新机制。</p><p>因此这里就需要一套新的热更新机制，这套机制需要由客户端&#x2F;前端&#x2F;服务端 三端的童鞋提供对应的资源，共同协作完成整套流程。</p><p>资源：</p><ul><li>H5: 每个代码包都有一个唯一且递增的版本号；</li><li>Native: 提供包下载且解压到对应目录的服务，前端可以由下面这个协议来调用该功能。</li><li><img src="https://static001.infoq.cn/resource/image/b2/24/b2c03548947c032a4ee194a8ddf78424.jpg" alt="img"></li><li>服务端: 提供一个接口，可以获取线上最新代码包的版本号和下载地址。</li><li>流程：</li><li>前端更新代码打包后按版本号上传至指定的服务器上；</li><li>每次打开页面时，H5 请求接口获取线上最新代码包版本号，并与本地包进行版本号比对，当线上的版本号 大于 本地包版本号时，发起包下载协议：</li><li>客户端接受到协议后，直接去线上地址下载最新的代码包，并解压替换到当前目录文件。</li><li>拥有这样的机制后，H5 在开发后，就可以直接打包将包上传到对应的服务器上，这样在 App 中打开页面后，即可以实时的热更新。</li></ul><h4 id="3-环境系统-和-多语言系统"><a href="#3-环境系统-和-多语言系统" class="headerlink" title="3.环境系统 和 多语言系统"></a>3.环境系统 和 多语言系统</h4><p>通常，我们会将项目分成多个不同的环境，相互隔离。而由于 Hybrid 模块是置于 App 中的，因此环境需要与 App 进行匹配，这里就可以直接使用上面第一点提到的，通过 <em>init</em> 中携带的数据 data.env 来匹配：</p><blockquote><p>env: 0 - 正式环境； 1 - 测试环境； 2 - 开发环境；</p><p>同理， 多语言也可以直接使用 e.data.language 直接进行匹配；</p><p>Tips：</p><p>环境机制我们通常主要用于匹配后端的环境，正式环境和测试环境对应不同的接口。而这里还有一点特别的，就是需要注意代码包的更新，上述的包更新条件要包含三个方面: 版本号、环境和 App 版本，在不同环境不同 App 版本下，也应该更新到相应的最新代码包。</p></blockquote><h4 id="4-事件中转站"><a href="#4-事件中转站" class="headerlink" title="4. 事件中转站"></a>4. 事件中转站</h4><p>由于页面是 H5 开发，而 Native 可能需要控制 H5 页面，例如最常用的场景:</p><p>当页面中有弹窗或者 SPA 切换页面时，安卓的返回实体键应该能完成对应的回退，而不是因为 WebView 没有 history 就直接关闭。</p><p>类似于这类需求，这里就可以定制一个事件中心(<em>eventListeners</em> )，用于监听客户端的实体返回键：</p><p><img src="https://static001.infoq.cn/resource/image/74/23/74c741285607493320ac9a37fa8dc423.jpg" alt="img"></p><h4 id="5-数据传递机制"><a href="#5-数据传递机制" class="headerlink" title="5. 数据传递机制"></a>5. 数据传递机制</h4><p>在业务中，很多场景需要做到 Native 与 H5 保持数据的同步，此时就可以使用类似上面的原理，制定一套数据传递协议:</p><p><img src="https://static001.infoq.cn/resource/image/97/0e/97900a687b94670ed17acd2e4bc5070e.jpg" alt="img"></p><p>Tips：</p><p>Hybrid 模块通常需要从对应的入口进入，因此这里有一种可以优化的方式：</p><p>由 App 在启动时先去获取线上数据，在进入 WebView 后直接通过 <em>init</em> 或者触发 getData 直接发送给 H5，这样能减少请求数量，优化用户体验。</p><h4 id="6-代理请求"><a href="#6-代理请求" class="headerlink" title="6. 代理请求"></a>6. 代理请求</h4><p>H5 中最常用的就是请求，通常我们可以直接使用 ajax，但是这里有几个问题比较棘手:</p><ul><li>最常见的请求跨域；</li><li>数据算法加密；</li><li>用户登录校验；</li><li>而客户端的请求便不会出现这些问题，因此我们可以由客户端代理我们发出的请求，可以定制 4 个协议: getProxy，postProxy， getProxyLogined，postProxyLogined，其中带有 Logined 的协议代表着在请求时会自动携带已登录用户的 token 和 uid 等参数，使用在一些需要登录信息的接口上。这样做的好处是：</li><li>H5 方就无需处理繁多的各项复杂信息，不需要进行跨端传输；</li><li>能够对 H5 与 Native 的请求出口进行统一，方便加工处理。</li><li><img src="https://static001.infoq.cn/resource/image/50/4a/50e6a9e84ffb25172b124337555d404a.jpg" alt="img"></li></ul><h4 id="7-更多"><a href="#7-更多" class="headerlink" title="7.更多"></a>7.更多</h4><p>除了这些重要的功能外，我们还可以非常自由地定制很多协议，让 H5 拥有更多更强大的功能，下面是我们所定制的一些功能：</p><ul><li>getNetwork：获取网络状态；</li><li>openApp：唤起其它 App；</li><li>setShareInfo 与 callShare：分享内容到第三方平台；</li><li>link：使用新的 WebView 打开页面；</li><li>closeWebview：关闭 WebView；</li><li>setStorage 与 getStorage：设置与获取缓存数据；</li><li>loading：调用客户端通用 Loading；</li><li>setWebviewTitle：设置 WebView 标题；</li><li>saveImage：保存图片到本地；</li><li>…</li><li>这里可以定义更多的通用性协议，这里有个原则可以遵守，即这部分协议应该是基础性功能，应该是纯净的，适用于所有的业务方。根据上篇文章提到的理念，这部分是当成通用 SDK 进行维护与升级的，因此不应该耦合业务层的任何逻辑。</li><li>而有时我们会遇到需要定制一些业务上的逻辑，例如上面提到的项目中，我们要将用户图片通过算法处理成卡通画。这样的需求就是非常的业务化，不适用于其它项目，因此我们应该定制成业务协议。</li></ul><h3 id="业务协议"><a href="#业务协议" class="headerlink" title="业务协议"></a>业务协议</h3><p>这类协议区别于功能协议，它们会杂合一定程度的业务逻辑，而这些逻辑只是针对于特定的项目。其实对于 H5 的使用上，差别并不大，只是使用对应特殊的协议头用于区分，例如:</p><p><img src="https://static001.infoq.cn/resource/image/25/f1/259b6e0441914c490f268d415f0b6ef1.jpg" alt="img"></p><p>这类协议通常不包含在 SDK 中，因此需要由客户端的童鞋针对项目的 WebView 进行定制，使用 bridge.js 提供的基础功能实现对应的复杂功能。而在其它的项目入口中，就无法使用这些协议。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>看到总结两个字，有没有长舒了一口气。通过这两篇文章，我们终于将 Hybrid 方案的前端部分完全的解构清楚了，是不是有种神清气爽的感觉，完全可以马上开启你们的 Hybrid 之旅了。鼓掌鼓掌！</p><p>但这也远非终点，或者说这永无终点。~大楼建成后，离真正的摩天大楼还是差着一步 — 内部装修，其实接下来我们还需要做很多的优化措施，来解决一些仍然存在的问题，这部分其实我们也一直还在努力的阶段。</p><p>受篇幅所限，有时间会将这部分再写一篇优化篇，主要来与大家探讨下我们所能想到的一些优化方案，非常期待大佬们也能给我们提供更多的建议和解决办法。感恩~~😇</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/03/17/[%E8%BD%AC]%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/17/%5B%E8%BD%AC%5D%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/" class="post-title-link" itemprop="url">提升海量用户极致体验的Hybrid架构设计（原理篇）[转]</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-17 04:23:47" itemprop="dateCreated datePublished" datetime="2022-03-17T04:23:47+08:00">2022-03-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-09 08:04:40" itemprop="dateModified" datetime="2022-10-09T08:04:40+08:00">2022-10-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/hybrid/" itemprop="url" rel="index"><span itemprop="name">hybrid</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/wC28rP1xA47vI9dlSm3z">原文链接</a></p><h3 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h3><p>随着 Web 技术和移动设备的快速发展，Hybrid 技术已经成为一种最主流最常见的方案。一套好的 Hybrid 架构方案能让 App 既能拥有极致的体验和性能，同时也能拥有 Web 技术灵活的开发模式、跨平台能力以及热更新机制，想想是不是都鸡冻不已…本系列文章是美图公司在这方面实践的一个总结，包含了原理解析、方案选型与实现、实践优化等方面。</p><p>大家可以到 github (<a target="_blank" rel="noopener" href="https://github.com/xd-tayde/blog/blob/master/hybrid-1.md)%E4%B8%8A%E5%92%8C%E4%BD%9C%E8%80%85%E8%BF%9B%E8%A1%8C%E8%AE%A8%E8%AE%BA%E5%93%88%EF%BC%81">https://github.com/xd-tayde/blog/blob/master/hybrid-1.md)上和作者进行讨论哈！</a></p><h3 id="二、现有混合方案"><a href="#二、现有混合方案" class="headerlink" title="二、现有混合方案"></a>二、现有混合方案</h3><p>Hybrid App，俗称混合应用，即混合了 Native 技术 与 Web 技术进行开发的移动应用。现在比较流行的混合方案主要有三种，主要是在 UI 渲染机制上的不同：</p><p>1.基于 WebView UI 的基础方案，市面上大部分主流 App 都有采用，例如微信 JS-SDK ，通过 JSBridge 完成 H5 与 Native 的双向通讯，从而赋予 H5 一定程度的原生能力。</p><p>2.基于 Native UI 的方案，例如 React-Native、Weex。在赋予 H5 原生 API 能力的基础上，进一步通过 JSBridge 将 js 解析成的虚拟节点树( Virtual DOM )传递到 Native 并使用原生渲染。</p><p>3.另外还有近期比较流行的小程序方案，也是通过更加定制化的 JSBridge，并使用双 WebView 双线程的模式隔离了 JS 逻辑与 UI 渲染，形成了特殊的开发模式，加强了 H5 与 Native 混合程度，提高了页面性能及开发体验。</p><p>以上的三种方案，其实同样都是基于 JSBridge 完成的通讯层，第二三种方案，其实可以看做是在方案一的基础上，继续通过不同的新技术进一步提高了应用的混合程度。因此，JSBridge 也是整个混合应用最关键的部分，例如我们在设置微信分享时用到的 JS-SDK，wx 对象便是我们最常见的 JSBridge:</p><p><img src="https://static001.infoq.cn/resource/image/8c/2a/8cf4664c3861d72213ed9e1a47f3da2a.jpg" alt="img"></p><h3 id="三、方案选型"><a href="#三、方案选型" class="headerlink" title="三、方案选型"></a>三、方案选型</h3><p>任何技术方案的选型，其实都应该基于使用场景和现有条件。基于公司现有情况的几点考虑，在方案一上进一步优化，更加适合我们的需求。</p><ul><li>需求 Web 技术 快速迭代、灵活开发的特点和线上热更新的机制。</li><li>产品的核心能力是强大的拍照与底层图片处理能力，因此单纯的 H5 技术能做的事非常有限，不能满足需求，通过 Hybrid 技术来强化 H5 ，便是一种必需。</li><li>公司业务上，并没有非常复杂的 UI 渲染需求，而且 App 中的一系列原生 UI 组件 已经非常成熟，因此我们并不强需类似 RN 这样的方案。</li></ul><p>因此，如何既能利用 H5 强大的开发和迭代能力，又能赋予 H5 强大的底层能力和用户体验，同时能复用现有的成熟 Native 组件，便成为了我们最大的需求点 – 一套完整又强大的 Hybrid 技术架构方案。</p><h3 id="四、Hybrid-技术原理"><a href="#四、Hybrid-技术原理" class="headerlink" title="四、Hybrid 技术原理"></a>四、Hybrid 技术原理</h3><p>Hybrid App 的本质，其实是在原生的 App 中，使用 WebView 作为容器直接承载 Web 页面。因此，最核心的点就是 Native 端与 H5 端之间的双向通讯层，其实这里也可以理解为我们需要一套跨语言通讯方案，来完成 Native(Java&#x2F;Objective-c&#x2F;…) 与 JavaScript 的通讯。这个方案就是我们所说的 JSBridge，而实现的关键便是作为容器的 WebView，一切的原理都是基于 WebView 的机制。</p><p><img src="https://static001.infoq.cn/resource/image/d2/65/d241622ca2f60b9c8d28ba1953ddc265.jpg" alt="img"></p><h4 id="4-1-JavaScript-通知-Native"><a href="#4-1-JavaScript-通知-Native" class="headerlink" title="4.1 JavaScript 通知 Native"></a>4.1 JavaScript 通知 Native</h4><p>基于 WebView 的机制和开放的 API , 实现这个功能有三种常见的方案：</p><ul><li>API 注入，原理其实就是 Native 获取 JavaScript 环境上下文，并直接在上面挂载对象或者方法，使 js 可以直接调用，Android 与 IOS 分别拥有对应的挂载方式。</li><li>WebView 中的 prompt&#x2F;console&#x2F;alert 拦截，通常使用 prompt ，因为这个方法在前端中使用频率低，比较不会出现冲突；</li><li>WebView URL Scheme 跳转拦截；</li></ul><p>第二三种机制的原理是类似的，都是通过对 WebView 信息冒泡传递的拦截，从而达到通讯的，接下来我们主要从 原理-定制协议-拦截协议-参数传递-回调机制 5 个方面详细阐述下第三种方案 – URL 拦截方案。</p><h5 id="4-1-1-实现原理"><a href="#4-1-1-实现原理" class="headerlink" title="4.1.1 实现原理"></a>4.1.1 实现原理</h5><p>在 WebView 中发出的网络请求，客户端都能进行监听和捕获</p><h5 id="4-1-2-协议的定制"><a href="#4-1-2-协议的定制" class="headerlink" title="4.1.2 协议的定制"></a>4.1.2 协议的定制</h5><p>我们需要制定一套 URL Scheme 规则，通常我们的请求会带有对应的协议开头，例如常见的 <a target="_blank" rel="noopener" href="https://xxx.com/">https://xxx.com</a> 或者 file:&#x2F;&#x2F;1.jpg ，代表着不同的含义。我们这里可以将协议类型的请求定制为:</p><blockquote><p>xxcommand:&#x2F;&#x2F;xxxx?param1&#x3D;1&amp;param2&#x3D;2</p></blockquote><p>这里有几个需要注意点的是:</p><p>(1) xxcommand:&#x2F;&#x2F; 只是一种规则，可以根据业务进行制定，使其具有含义，例如我们定义 xxcommand:&#x2F;&#x2F; 为公司所有 App 系通用，为通用工具协议：</p><blockquote><p>xxcommand:&#x2F;&#x2F;getProxy?h&#x3D;1</p><p>而定义 xxapp:&#x2F;&#x2F; 为每个 App 单独的业务协议。</p><p>xxapp:&#x2F;&#x2F;openCamera?h&#x3D;2</p><p>不同的协议头代表着不同的含义，这样便能清楚知道每个协议的适用范围。</p></blockquote><p>(2) 这里不要使用 location.href 发送，因为其自身机制有个问题是同时并发多次请求会被合并成为一次，导致协议被忽略，而并发协议其实是非常常见的功能。我们会使用创建 iframe 发送请求的方式。</p><p>(3) 通常考虑到安全性，需要在客户端中设置域名白名单或者限制，避免公司内部业务协议被第三方直接调用。</p><h5 id="4-1-3-协议的拦截"><a href="#4-1-3-协议的拦截" class="headerlink" title="4.1.3 协议的拦截"></a>4.1.3 协议的拦截</h5><p>客户端可以通过 API 对 WebView 发出的请求进行拦截：</p><ul><li>IOS 上: shouldStartLoadWithRequest</li><li>Android: shouldOverrideUrlLoading</li></ul><p>当解析到请求 URL 头为制定的协议时，便不发起对应的资源请求，而是解析参数，并进行相关功能或者方法的调用，完成协议功能的映射。</p><h5 id="4-1-4-协议回调"><a href="#4-1-4-协议回调" class="headerlink" title="4.1.4 协议回调"></a>4.1.4 协议回调</h5><p>由于协议的本质其实是发送请求，这属于一个异步的过程，因此我们便需要处理对应的回调机制。这里我们采用的方式是 JS 的事件系统，这里我们会用到 window.addEventListener 和 window.dispatchEvent 这两个基础 API；</p><ul><li>1.发送协议时，通过协议的唯一标识注册自定义事件，并将回调绑定到对应的事件上。</li><li>2.客户端完成对应的功能后，调用 Bridge 的 dispatch API ，直接携带 data 触发该协议的自定义事件。</li><li><img src="https://static001.infoq.cn/resource/image/16/75/160be3b376cb8f959673cb98ecd72375.jpg" alt="img"></li><li>通过事件的机制，会让开发更符合我们前端的习惯，例如当你需要监听客户端的通知时，同样只需要在通过 addEventListener 进行监听即可。</li><li>Tips: 这里有一点需要注意的是，应该避免事件的多次重复绑定，因此当唯一标识重置时，需要 removeEventListener 对应的事件。</li></ul><h5 id="4-1-5-参数传递方式"><a href="#4-1-5-参数传递方式" class="headerlink" title="4.1.5 参数传递方式"></a>4.1.5 参数传递方式</h5><p>由于 WebView 对 URL 会有长度的限制，因此常规的通过 search 参数 进行传递的方式便具有一个问题，既 当需要传递的参数过长时，可能会导致被截断，例如传递 base64 或者传递大量数据时。</p><p>因此我们需要制定新的参数传递规则，我们使用的是函数调用的方式。这里的原理主要是基于:Native 可以直接调用 JS 方法并直接获取函数的返回值。</p><p>我们只需要对每条协议标记一个唯一标识，并把参数存入参数池中，到时客户端再通过该唯一标识从参数池中获取对应的参数即可。</p><h4 id="4-2-Native-通知-Javascript"><a href="#4-2-Native-通知-Javascript" class="headerlink" title="4.2 Native 通知 Javascript"></a>4.2 Native 通知 Javascript</h4><p>由于 Native 可以算作 H5 的宿主，因此拥有更大的权限，上面也提到了 Native 可以通过 WebView API 直接执行 Js 代码。这样的权限也就让这个方向的通讯变得十分的便捷。</p><ul><li>IOS: stringByEvaluatingJavaScriptFromString</li><li><img src="https://static001.infoq.cn/resource/image/30/ae/3082eaf8243d968b859843d1bddc67ae.jpg" alt="img"></li><li>Android: loadUrl (4.4-)</li><li><img src="https://static001.infoq.cn/resource/image/aa/d4/aa57c6161123ab1bf5a719d856864ad4.jpg" alt="img"></li><li>Tips: 当系统低于 4.4 时，evaluateJavascript 是无法使用的，因此单纯的使用 loadUrl 无法获取 JS 返回值，这时我们需要使用前面提到的 prompt 的方法进行兼容，让 H5 端 通过 prompt 进行数据的发送，客户端进行拦截并获取数据。</li><li>Android: evaluateJavascript (4.4+)</li><li><img src="https://static001.infoq.cn/resource/image/e2/41/e2f1f329be5db895309621d4e3770a41.jpg" alt="img"></li><li>基于上面的原理，我们已经明白 JSBridge 最基础的原理，并且能实现 Native &lt;&#x3D;&gt; H5 的双向通讯机制了。</li><li><img src="https://static001.infoq.cn/resource/image/47/b6/479d60fe2cb3fab82279f1d2135b48b6.jpg" alt="img"></li></ul><h4 id="4-3-JSBridge-的接入"><a href="#4-3-JSBridge-的接入" class="headerlink" title="4.3 JSBridge 的接入"></a>4.3 JSBridge 的接入</h4><p>接下来，我们来理下代码上需要的资源。实现这套方案，从上图可以看出，其实可以分为两个部分:</p><ul><li>JS 部分(bridge): 在 JS 环境中注入 bridge 的实现代码，包含了协议的拼装&#x2F;发送&#x2F;参数池&#x2F;回调池等一些基础功能。</li><li>Native 部分(SDK): 在客户端中 bridge 的功能映射代码，实现了 URL 拦截与解析&#x2F;环境信息的注入&#x2F;通用功能映射等功能。</li></ul><p>我们这里的做法是，将这两部分一起封装成一个 Native SDK，由客户端统一引入。客户端在初始化一个 WebView 打开页面时，如果页面地址在白名单中，会直接在 HTML 的头部注入对应的 bridge.js。这样的做法有以下的好处：</p><ul><li>双方的代码统一维护，避免出现版本分裂的情况。有更新时，只要由客户端更新 SDK 即可，不会出现版本兼容的问题；</li><li>App 的接入十分方便，只需要按文档接入最新版本的 SDK ，即可直接运行整套 Hybrid 方案，便于在多个 App 中快速的落地；</li><li>H5 端无需关注，这样有利于将 bridge 开放给第三方页面使用。</li></ul><p>这里有一点需要注意的是，协议的调用，一定是需要确保执行在 bridge.js 成功注入后。由于客户端的注入行为属于一个附加的异步行为，从 H5 方很难去捕捉准确的完成时机，因此这里需要通过客户端监听页面完成后，基于上面的事件回调机制通知 H5 端，页面中即可通过 window.addEventListener(‘bridgeReady’, e &#x3D;&gt; {})进行初始化。</p><h4 id="4-4-App-中-H5-的接入方式"><a href="#4-4-App-中-H5-的接入方式" class="headerlink" title="4.4 App 中 H5 的接入方式"></a>4.4 App 中 H5 的接入方式</h4><p>将 H5 接入 App 中通常有两种方式：在线 H5 和内置包 H5。</p><p>(1) 在线 H5，这是最常见的一种方式。我们只需要将 H5 代码部署到服务器上，只要把对应的 URL 地址 给到客户端，用 WebView 打开该 URL，即可嵌入。该方式的好处在于:</p><ul><li>独立性强，有非常独立的开发&#x2F;调试&#x2F;更新&#x2F;上线能力；</li><li>资源放在服务器上，完全不会影响客户端的包体积；</li><li>接入成本很低，完全的热更新机制。</li></ul><p>但相对的，这种方式也有对应的缺点:</p><ul><li>完全的网络依赖，在离线的情况下无法打开页面；</li><li>首屏加载速度依赖于网络，网络较慢时，首屏加载也较慢；</li></ul><p>通常，这种方式更适用在一些比较轻量级的页面上，例如一些帮助页、提示页、使用攻略等页面。这些页面的特点是功能性不强，不太需要复杂的功能协议，且不需要离线使用。在一些第三方页面接入上，也会使用这种方式，例如我们的页面调用微信 JS-SDK 。</p><p>(2) 内置包 H5，这是一种本地化的嵌入方式，我们需要将代码进行打包后下发到客户端，并由客户端直接解压到本地储存中。通常我们运用在一些比较大和比较重要的模块上。其优点是:</p><ul><li>由于其本地化，首屏加载速度快，用户体验更为接近原生；</li><li>可以不依赖网络，离线运行；</li></ul><p>但同时，它的劣势也十分明显:</p><ul><li>开发流程&#x2F;更新机制复杂化，需要客户端，甚至服务端的共同协作；</li><li>会相应的增加 App 包体积；</li></ul><p>这两种接入方式均有自己的优缺点，应该根据不同场景进行选择。</p><h3 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h3><p>本文主要解析了现在 Hybrid App 的发展现状和其基础原理，包含了</p><ul><li>JavaScript 通知 Native</li><li>Native 通知 Javascript</li><li>JSBridge 的接入</li><li>H5 的接入</li></ul><p>只有在了解了其最本质的实现原理后，才能对这套方案进行实现以及进一步的优化。接下来，我们将基于上面的理论，继续探讨如何把这套方案的真正代码实现以及方案优化方案，欢迎大家一起讨论！</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/03/15/Android%20%E5%AE%9E%E7%8E%B0%E6%B0%B4%E5%8D%B0%E8%83%8C%E6%99%AF%E6%95%88%E6%9E%9C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/03/15/Android%20%E5%AE%9E%E7%8E%B0%E6%B0%B4%E5%8D%B0%E8%83%8C%E6%99%AF%E6%95%88%E6%9E%9C/" class="post-title-link" itemprop="url">Android 实现水印背景效果[转]</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-15 04:23:47" itemprop="dateCreated datePublished" datetime="2022-03-15T04:23:47+08:00">2022-03-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-05-13 08:19:38" itemprop="dateModified" datetime="2022-05-13T08:19:38+08:00">2022-05-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UI/" itemprop="url" rel="index"><span itemprop="name">UI</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="转-Android-实现水印背景效果"><a href="#转-Android-实现水印背景效果" class="headerlink" title="[转]Android 实现水印背景效果"></a>[转]Android 实现水印背景效果</h1><p>项目中有需要加水印的需求，实现完效果图是这样的</p><p><img src="https://img-blog.csdnimg.cn/2020112014501365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NoYW95ZXpoYW5nbGl3ZWk=,size_16,color_FFFFFF,t_70" alt="img"></p><p>什么看不清…<img src="https://img-blog.csdnimg.cn/20201120145255473.jpg" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20201120145321286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NoYW95ZXpoYW5nbGl3ZWk=,size_16,color_FFFFFF,t_70" alt="img"></p><p>为了让大家看清效果，字体改了一下，正常应该是文章最上面那个的效果。话不多说，直接上代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.TypedArray;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Typeface;</span><br><span class="line"><span class="keyword">import</span> android.text.TextPaint;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.view.MotionEvent;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.hkdc.commonlib.R;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SEPARATOR = <span class="string">&quot;///&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> TextPaint mTextPaint = <span class="keyword">new</span> TextPaint();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String[] mText;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDegrees;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextSize=<span class="number">35</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mTextBold;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDx;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDy;</span><br><span class="line">    <span class="keyword">private</span> Paint.Align mAlign;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mSync;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textWidth, textHeight;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMarkView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMarkView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        TypedArray typedArray = context.obtainStyledAttributes(attrs, R.styleable.WaterMarkView);</span><br><span class="line">        mDegrees = typedArray.getInt(R.styleable.WaterMarkView_water_mark_degree, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getDegrees() : -<span class="number">30</span>);</span><br><span class="line">        String text = typedArray.getString(R.styleable.WaterMarkView_water_mark_text);</span><br><span class="line">        <span class="keyword">if</span> (text != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mText = text.split(DEFAULT_SEPARATOR);</span><br><span class="line">        &#125;</span><br><span class="line">        mTextColor = typedArray.getColor(R.styleable.WaterMarkView_water_mark_textColor, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getTextColor() : Color.parseColor(<span class="string">&quot;#33000000&quot;</span>));</span><br><span class="line">        mTextSize = typedArray.getDimensionPixelSize(R.styleable.WaterMarkView_water_mark_textSize, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getTextSize() : <span class="number">42</span>);</span><br><span class="line">        mTextBold = typedArray.getBoolean(R.styleable.WaterMarkView_water_mark_textBold, WaterMarkManager.INFO != <span class="keyword">null</span> &amp;&amp; WaterMarkManager.INFO.isTextBold());</span><br><span class="line">        mDx = typedArray.getDimensionPixelSize(R.styleable.WaterMarkView_water_mark_dx, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getDx() : <span class="number">100</span>);</span><br><span class="line">        mDy = typedArray.getDimensionPixelSize(R.styleable.WaterMarkView_water_mark_dy, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getDy() : <span class="number">240</span>);</span><br><span class="line">        <span class="keyword">int</span> align = typedArray.getInt(R.styleable.WaterMarkView_water_mark_align, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getAlignInt() : <span class="number">1</span>);</span><br><span class="line">        mAlign = align == <span class="number">0</span> ? Paint.Align.LEFT : align == <span class="number">2</span> ? Paint.Align.RIGHT : Paint.Align.CENTER;</span><br><span class="line">        mSync = typedArray.getBoolean(R.styleable.WaterMarkView_water_mark_sync, <span class="keyword">true</span>);</span><br><span class="line">        typedArray.recycle();</span><br><span class="line"> </span><br><span class="line">        setBackgroundColor(Color.TRANSPARENT);</span><br><span class="line">        mTextPaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">        mTextPaint.setFlags(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        mTextPaint.setColor(mTextColor);</span><br><span class="line">        mTextPaint.setTextSize(mTextSize);</span><br><span class="line">        mTextPaint.setTypeface(mTextBold ? Typeface.DEFAULT_BOLD : Typeface.DEFAULT);</span><br><span class="line">        mTextPaint.setTextAlign(mAlign);</span><br><span class="line"> </span><br><span class="line">        mText = mText == <span class="keyword">null</span> &amp;&amp; mSync ? WaterMarkManager.CONTENT : mText;</span><br><span class="line"> </span><br><span class="line">        textWidth = <span class="number">0</span>;</span><br><span class="line">        textHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mText != <span class="keyword">null</span> &amp;&amp; mText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String s : mText) &#123;</span><br><span class="line">                Rect tvRect = <span class="keyword">new</span> Rect();</span><br><span class="line">                mTextPaint.getTextBounds(s, <span class="number">0</span>, s.length(), tvRect);</span><br><span class="line">                textWidth = textWidth &gt; tvRect.width() ? textWidth : tvRect.width();</span><br><span class="line">                textHeight += (tvRect.height() + <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            WaterMarkManager.LIST.add(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (mText != <span class="keyword">null</span> &amp;&amp; mText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> measuredWidth = getMeasuredWidth();</span><br><span class="line">            <span class="keyword">int</span> measuredHeight = getMeasuredHeight();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (measuredWidth == <span class="number">0</span> || measuredHeight == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">int</span> canvasLength = measuredWidth &gt; measuredHeight ? measuredWidth : measuredHeight;</span><br><span class="line"> </span><br><span class="line">            canvas.save();</span><br><span class="line">            canvas.rotate(mDegrees, measuredWidth / <span class="number">2</span>, measuredHeight / <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">            canvas.save();</span><br><span class="line">            <span class="keyword">int</span> y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">boolean</span> odd = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (y &lt; canvasLength + textHeight) &#123;</span><br><span class="line">                <span class="keyword">int</span> x = odd ? <span class="number">0</span> : -(textWidth + mDx) / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">while</span> (x &lt; canvasLength + textWidth) &#123;</span><br><span class="line">                    drawTexts(mText, mTextPaint, canvas, x, y);</span><br><span class="line">                    x = x + textWidth + mDx;</span><br><span class="line">                &#125;</span><br><span class="line">                y = y + textHeight + mDy;</span><br><span class="line">                odd = !odd;</span><br><span class="line">            &#125;</span><br><span class="line">            canvas.restore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawTexts</span><span class="params">(String[] ss, Paint paint, Canvas canvas, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        Paint.FontMetrics fontMetrics = paint.getFontMetrics();</span><br><span class="line">        <span class="keyword">float</span> top = fontMetrics.top;</span><br><span class="line">        <span class="keyword">float</span> bottom = fontMetrics.bottom;</span><br><span class="line">        <span class="keyword">int</span> length = ss.length;</span><br><span class="line">        <span class="keyword">float</span> total = (length - <span class="number">1</span>) * (bottom - top) + (fontMetrics.descent - fontMetrics.ascent);</span><br><span class="line">        <span class="keyword">float</span> offset = total / <span class="number">2</span> - bottom;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> yAxis = -(length - i - <span class="number">1</span>) * (bottom - top) + offset;</span><br><span class="line">            canvas.drawText(ss[i], x, y + yAxis + <span class="number">10</span>, paint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印文字内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text 文字内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String... text)</span> </span>&#123;</span><br><span class="line">        mText = text;</span><br><span class="line"> </span><br><span class="line">        textWidth = <span class="number">0</span>;</span><br><span class="line">        textHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mText != <span class="keyword">null</span> &amp;&amp; mText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String s : mText) &#123;</span><br><span class="line">                Rect tvRect = <span class="keyword">new</span> Rect();</span><br><span class="line">                mTextPaint.getTextBounds(s, <span class="number">0</span>, s.length(), tvRect);</span><br><span class="line">                textWidth = textWidth &gt; tvRect.width() ? textWidth : tvRect.width();</span><br><span class="line">                textHeight += (tvRect.height() + <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印文字内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text 文字内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncText</span><span class="params">(String... text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setText(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印倾斜角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degrees 倾斜角度(默认:-30)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        mDegrees = degrees;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印倾斜角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degrees 倾斜角度(默认:-30)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setDegrees(degrees);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印字体颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textColor 字体颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        mTextColor = textColor;</span><br><span class="line">        mTextPaint.setColor(mTextColor);</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印字体颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textColor 字体颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setTextColor(textColor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印字体大小（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textSize 字体大小(默认:42px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        mTextSize = textSize;</span><br><span class="line">        mTextPaint.setTextSize(<span class="number">30</span>);</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印字体大小（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textSize 字体大小(默认:42px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setTextSize(<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印字体是否粗体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textBold 是否粗体(默认:false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        mTextBold = textBold;</span><br><span class="line">        mTextPaint.setTypeface(mTextBold ? Typeface.DEFAULT_BOLD : Typeface.DEFAULT);</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印字体是否粗体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textBold 是否粗体(默认:false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setTextBold(textBold);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印X轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dx X轴偏移量(默认:100px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mDx = dx;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印X轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dx X轴偏移量(默认:100px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setDx(dx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印Y轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dy Y轴偏移量(默认:240px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mDy = dy;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印Y轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dy Y轴偏移量(默认:240px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSignDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setDy(dy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印对齐方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mAlign = align;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印对齐方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSignAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setAlign(align);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 销毁相关页面时调用（切记）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            WaterMarkManager.LIST.remove(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@SuppressLint(&quot;ClickableViewAccessibility&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">&quot;WaterMarkView&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_degree&quot;</span> <span class="attr">format</span>=<span class="string">&quot;integer|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_text&quot;</span> <span class="attr">format</span>=<span class="string">&quot;string|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_textColor&quot;</span> <span class="attr">format</span>=<span class="string">&quot;color|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_textSize&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_textBold&quot;</span> <span class="attr">format</span>=<span class="string">&quot;boolean&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_dx&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_dy&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_align&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;LEFT&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;CENTER&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;RIGHT&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">attr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_sync&quot;</span> <span class="attr">format</span>=<span class="string">&quot;boolean&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hkdc.commonlib.warkmark;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.hkdc.commonlib.R;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Leon (wshk729@163.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/24</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkManager</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> WaterMarkInfo INFO = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> String[] CONTENT = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> List&lt;WaterMarkView&gt; LIST = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印全局配置信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> info 配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setInfo</span><span class="params">(WaterMarkInfo info)</span> </span>&#123;</span><br><span class="line">        INFO = info;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取一个满屏水印View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activity activity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;InflateParams&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WaterMarkView <span class="title">getView</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (WaterMarkView) LayoutInflater.from(activity).inflate(R.layout.view_water_mark, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WaterMarkInfo初始化判断</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assertInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INFO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            INFO = WaterMarkInfo.create().generate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印文字信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 文字信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String... content)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        CONTENT = content;</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncText(content);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印倾斜角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degrees 倾斜角度(默认:-30)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setDegrees(degrees);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncDegrees(degrees);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印字体颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textColor 字体颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setTextColor(textColor);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncTextColor(textColor);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印字体大小（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textSize 字体大小(默认:42px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setTextSize(textSize);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncTextSize(textSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印字体是否粗体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textBold 是否粗体(默认:false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setTextBold(textBold);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncTextBold(textBold);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印X轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dx X轴偏移量(默认:100px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setDx(dx);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncDx(dx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印Y轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dy Y轴偏移量(默认:240px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setDy(dy);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSignDy(dy);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印对齐方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setAlign(align);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSignAlign(align);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>view_water_mark.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">com.commonlib.WaterMarkView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Leon (wshk729@163.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/24</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkInfo</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDegrees;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mTextBold;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDx;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDy;</span><br><span class="line">    <span class="keyword">private</span> Paint.Align mAlign;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WaterMarkInfo</span><span class="params">(<span class="keyword">int</span> degrees, <span class="keyword">int</span> textColor, <span class="keyword">int</span> textSize, <span class="keyword">boolean</span> textBold, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, Paint.Align align)</span> </span>&#123;</span><br><span class="line">        mDegrees = degrees;</span><br><span class="line">        mTextColor = textColor;</span><br><span class="line">        mTextSize = textSize;</span><br><span class="line">        mTextBold = textBold;</span><br><span class="line">        mDx = dx;</span><br><span class="line">        mDy = dy;</span><br><span class="line">        mAlign = align;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDegrees</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDegrees;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTextColor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextColor;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTextSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDx;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDy;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> Paint.<span class="function">Align <span class="title">getAlign</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAlign;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAlignInt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (mAlign) &#123;</span><br><span class="line">            <span class="keyword">case</span> LEFT:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> RIGHT:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTextBold</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextBold;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        mDegrees = degrees;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        mTextColor = textColor;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        mTextSize = textSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        mTextBold = textBold;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        mDx = dx;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        mDy = dy;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mAlign = align;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Builder();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mDegrees;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mTextSize;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mTextBold;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mDx;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mDy;</span><br><span class="line">        <span class="keyword">private</span> Paint.Align mAlign;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mDegrees = -<span class="number">30</span>;</span><br><span class="line">            mTextColor = Color.parseColor(<span class="string">&quot;#33000000&quot;</span>);</span><br><span class="line">            mTextSize = <span class="number">35</span>;</span><br><span class="line">            mTextBold = <span class="keyword">false</span>;</span><br><span class="line">            mDx = <span class="number">100</span>;</span><br><span class="line">            mDy = <span class="number">240</span>;</span><br><span class="line">            mAlign = Paint.Align.CENTER;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字倾斜度</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> degrees 文字倾斜度(默认:-30)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">            mDegrees = degrees;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字颜色</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> textColor 文字颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">            mTextColor = textColor;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字大小（单位：px）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> textSize 文字大小(默认:42px)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">            mTextSize = textSize;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字是否加粗</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> textBold 文字加粗(默认:false)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">            mTextBold = textBold;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字X轴间距（单位：px）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> dx 文字X轴间距(默认:100px)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">            mDx = dx;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字Y轴间距（单位：px）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> dy 文字Y轴间距(默认:240px)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">            mDy = dy;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字对齐方式</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">            mAlign = align;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 生成水印全局配置信息</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 配置信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> WaterMarkInfo <span class="title">generate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WaterMarkInfo(mDegrees, mTextColor, mTextSize, mTextBold, mDx, mDy, mAlign);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.ColorFilter;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.PixelFormat;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.IntRange;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkBg</span> <span class="keyword">extends</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Paint paint = <span class="keyword">new</span> Paint();</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; labels;</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> degress;<span class="comment">//角度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fontSize;<span class="comment">//字体大小 单位sp</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化构造</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> labels 水印文字列表 多行显示支持</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degress 水印角度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fontSize 水印文字大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMarkBg</span><span class="params">(Context context, List&lt;String&gt; labels, <span class="keyword">int</span> degress, <span class="keyword">int</span> fontSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.labels = labels;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        <span class="keyword">this</span>.degress = degress;</span><br><span class="line">        <span class="keyword">this</span>.fontSize = fontSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="meta">@NonNull</span> Canvas canvas)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">int</span> width = getBounds().right;</span><br><span class="line">        <span class="keyword">int</span> height = getBounds().bottom;</span><br><span class="line"> </span><br><span class="line">        canvas.drawColor(Color.parseColor(<span class="string">&quot;#40F3F5F9&quot;</span>));</span><br><span class="line">        paint.setColor(Color.parseColor(<span class="string">&quot;#50AEAEAE&quot;</span>));</span><br><span class="line"> </span><br><span class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">        paint.setTextSize(sp2px(context,fontSize));</span><br><span class="line">        canvas.save();</span><br><span class="line">        canvas.rotate(degress);</span><br><span class="line">        <span class="keyword">float</span> textWidth = paint.measureText(labels.get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> positionY = height / <span class="number">10</span>; positionY &lt;= height; positionY += height / <span class="number">10</span>+<span class="number">80</span>) &#123;</span><br><span class="line">            <span class="keyword">float</span> fromX = -width + (index++ % <span class="number">2</span>) * textWidth;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">float</span> positionX = fromX; positionX &lt; width; positionX += textWidth * <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> spacing  = <span class="number">0</span>;<span class="comment">//间距</span></span><br><span class="line">                <span class="keyword">for</span>(String label:labels)&#123;</span><br><span class="line">                    canvas.drawText(label, positionX, positionY+spacing, paint);</span><br><span class="line">                    spacing = spacing+<span class="number">50</span>;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="meta">@IntRange(from = 0, to = 255)</span> <span class="keyword">int</span> alpha)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColorFilter</span><span class="params">(<span class="meta">@Nullable</span> ColorFilter colorFilter)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOpacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PixelFormat.UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sp2px</span><span class="params">(Context context, <span class="keyword">float</span> spValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> fontScale = context.getResources().getDisplayMetrics().scaledDensity;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (spValue * fontScale + <span class="number">0.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xml中 引用</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.commonlib.WaterMarkView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:singleLine</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/wm&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_align</span>=<span class="string">&quot;CENTER&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_degree</span>=<span class="string">&quot;-30&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_dx</span>=<span class="string">&quot;100px&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_dy</span>=<span class="string">&quot;240px&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_sync</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_text</span>=<span class="string">&quot;再见孙悟空&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_textBold</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_textColor</span>=<span class="string">&quot;@color/black&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_textSize</span>=<span class="string">&quot;30px&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>activity中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> WaterMarkView wm;</span><br><span class="line"> </span><br><span class="line">wm = (WaterMarkView) findViewById(R.id.wm);</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">water</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SharedPreferences jobcede = getSharedPreferences(<span class="string">&quot;jobcede&quot;</span>, MODE_PRIVATE);</span><br><span class="line">    String userName = jobcede.getString(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    String name = jobcede.getString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    wm.setText(name,userName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>————————————————<br>版权声明：本文为CSDN博主「再见孙悟空_」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/shaoyezhangliwei/article/details/109849305">https://blog.csdn.net/shaoyezhangliwei/article/details/109849305</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/02/25/Jetpack%E7%B3%BB%E5%88%97%E2%80%94paging%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/02/25/Jetpack%E7%B3%BB%E5%88%97%E2%80%94paging%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Jetpack系列—paging框架使用和原理(基于paging-runtime-2.1.0版本)</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-02-25 04:23:47" itemprop="dateCreated datePublished" datetime="2022-02-25T04:23:47+08:00">2022-02-25</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-10-20 05:27:07" itemprop="dateModified" datetime="2022-10-20T05:27:07+08:00">2022-10-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Jetpack%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Jetpack系列</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>Jetpack系列—paging框架使用和原理(基于paging-runtime-2.1.0版本)</p><p>基于paging-runtime-2.1.0版本</p><p>先看下pageing的基本使用</p><p>1.构造一个pageData对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LiveData&lt;PagedList&lt;T&gt;&gt; pageData = <span class="keyword">new</span> LivePagedListBuilder(factory, config)</span><br><span class="line">  				<span class="comment">//加载初始化数据时需要传递的参数，首页就给传个0就行了，如果是多个参数，需要把多个参数组装成一个						javabean对象</span></span><br><span class="line">        .setInitialLoadKey(<span class="number">0</span>)</span><br><span class="line">        <span class="comment">//.setFetchExecutor()</span></span><br><span class="line">  			<span class="comment">//这个callback可以知道pagelist加载数据的状态，可以判定界面上有没有数据等异常的状态,看名字就知道，是边界情况回调，但 不是每一次分页 都会回调这里</span></span><br><span class="line">        .setBoundaryCallback(callback)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p>2.先看更新数据接收和更新的地方</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//触发页面初始化数据加载的逻辑</span></span><br><span class="line">mViewModel.getPageData().observe(<span class="keyword">this</span>, pagedList -&gt; submitList(pagedList));</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听分页时有无更多数据,以决定是否关闭上拉加载的动画</span></span><br><span class="line">mViewModel.getBoundaryPageData().observe(<span class="keyword">this</span>, hasData -&gt; finishRefresh(hasData));</span><br></pre></td></tr></table></figure><p>本质通过这个pageData去observe进行数据的分发事件通知，进而刷新页面数据，本质上是使用了livedata的能力。</p><p>3.看具体构造pageData对象时还需要一个factory config callback这些都是什么</p><p>config</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PagedList.Config config = <span class="keyword">new</span> PagedList.Config.Builder()</span><br><span class="line">        <span class="comment">//一页加载多少条数据</span></span><br><span class="line">        .setPageSize(<span class="number">10</span>)</span><br><span class="line">        <span class="comment">//设置默认加载多少条数据</span></span><br><span class="line">        .setInitialLoadSizeHint(<span class="number">12</span>)</span><br><span class="line">        <span class="comment">//知道列表一共多少条数据</span></span><br><span class="line">        <span class="comment">//.setMaxSize(100)</span></span><br><span class="line">        <span class="comment">//还有多少条的时候的预加载，默认是pageSize 如果不想有这个功能，就让setInitialLoadSizeHint 大于pageSize</span></span><br><span class="line">        <span class="comment">//要不一开始它加载了10条，它马上就执行loadMore了</span></span><br><span class="line">        <span class="comment">//.setPrefetchDistance(4)</span></span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p>factory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataSource.Factory factory = <span class="keyword">new</span> DataSource.Factory() &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span> || dataSource.isInvalid()) &#123;</span><br><span class="line">            dataSource = createDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>callback 边界</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PagedList.BoundaryCallback&lt;T&gt; callback = <span class="keyword">new</span> PagedList.BoundaryCallback&lt;T&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onZeroItemsLoaded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//新提交的PagedList中没有数据</span></span><br><span class="line">        boundaryPageData.postValue(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemAtFrontLoaded</span><span class="params">(<span class="meta">@NonNull</span> T itemAtFront)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//新提交的PagedList中第一条数据被加载到列表上</span></span><br><span class="line">        boundaryPageData.postValue(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemAtEndLoaded</span><span class="params">(<span class="meta">@NonNull</span> T itemAtEnd)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//新提交的PagedList中最后一条数据被加载到列表上</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>看到了吧，在第一次时没有数据，在onZeroItemsLoaded会发送一条boundaryPageData.postValue(false) 这也是livedata.postValue 所以触发第一次加载时页面更新，后续加载更多</p><p>那么具体的实现逻辑，看下原代码 基于paging-runtime-2.1.0版本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LiveData&lt;PagedList&lt;Value&gt;&gt; build() &#123;</span><br><span class="line">    <span class="keyword">return</span> create(mInitialLoadKey, mConfig, mBoundaryCallback, mDataSourceFactory,</span><br><span class="line">            ArchTaskExecutor.getMainThreadExecutor(), mFetchExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mInitialLoadKey——第一次加载数据时的入参</p><p>mConfig——配置了maxsize pagesize PrefetchDistance 等等参数</p><p>mBoundaryCallback——数据加载边界的回调</p><p>mDataSourceFactory——提供数据源</p><p>ArchTaskExecutor.getMainThreadExecutor()——主线程</p><p>mFetchExecutor——异步线程</p><p>静态方法create</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;Key, Value&gt; LiveData&lt;PagedList&lt;Value&gt;&gt; create(</span><br><span class="line">        <span class="meta">@Nullable</span> <span class="keyword">final</span> Key initialLoadKey,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> PagedList.Config config,</span><br><span class="line">        <span class="meta">@Nullable</span> <span class="keyword">final</span> PagedList.BoundaryCallback boundaryCallback,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> DataSource.Factory&lt;Key, Value&gt; dataSourceFactory,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> Executor notifyExecutor,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> Executor fetchExecutor) &#123;</span><br><span class="line">  <span class="comment">//实际上return的是ComputableLiveData.getLiveData</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ComputableLiveData&lt;PagedList&lt;Value&gt;&gt;(fetchExecutor) &#123;</span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> PagedList&lt;Value&gt; mList;</span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> DataSource&lt;Key, Value&gt; mDataSource;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DataSource.InvalidatedCallback mCallback =</span><br><span class="line">                <span class="keyword">new</span> DataSource.InvalidatedCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        invalidate();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="comment">// for casting getLastKey to Key</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> PagedList&lt;Value&gt; <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="meta">@Nullable</span> Key initializeKey = initialLoadKey;</span><br><span class="line">            <span class="keyword">if</span> (mList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                initializeKey = (Key) mList.getLastKey();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mDataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mDataSource.removeInvalidatedCallback(mCallback);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mDataSource = dataSourceFactory.create();</span><br><span class="line">                mDataSource.addInvalidatedCallback(mCallback);</span><br><span class="line"></span><br><span class="line">                mList = <span class="keyword">new</span> PagedList.Builder&lt;&gt;(mDataSource, config)</span><br><span class="line">                        .setNotifyExecutor(notifyExecutor)</span><br><span class="line">                        .setFetchExecutor(fetchExecutor)</span><br><span class="line">                        .setBoundaryCallback(boundaryCallback)</span><br><span class="line">                        .setInitialKey(initializeKey)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125; <span class="keyword">while</span> (mList.isDetached());</span><br><span class="line">            <span class="keyword">return</span> mList;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.getLiveData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看ComputableLiveData里都做了啥</p><p>构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ComputableLiveData</span><span class="params">(<span class="meta">@NonNull</span> Executor executor)</span> </span>&#123;</span><br><span class="line">    mExecutor = executor;</span><br><span class="line">  <span class="comment">//new了livedata 并且复写了onActive方法</span></span><br><span class="line">    mLiveData = <span class="keyword">new</span> LiveData&lt;T&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">//onActive方法执行时机？当且仅当第一个活跃的observer被注册到livedata里的时候就会触发activie</span></span><br><span class="line">            mExecutor.execute(mRefreshRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说，只要用调用了pageData.observe(Observer) 就会立马触发 ComputableLiveData里的livedata的onActive的回调</p><p>看下mRefreshRunnable 里做了什么，刷新了数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> computed;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            computed = <span class="keyword">false</span>;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">if</span> (mComputing.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// as long as it is invalid, keep computing.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    T value = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> (mInvalid.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                        computed = <span class="keyword">true</span>;</span><br><span class="line">                        value = compute();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (computed) &#123;</span><br><span class="line">                        mLiveData.postValue(value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// release compute lock</span></span><br><span class="line">                    mComputing.set(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (computed &amp;&amp; mInvalid.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function">T <span class="title">compute</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>是一个抽象，具体实现在ComputeLiveData的匿名实现里</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PagedList&lt;Value&gt; <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Key initializeKey = initialLoadKey;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        initializeKey = <span class="keyword">this</span>.mList.getLastKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.mDataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mDataSource.removeInvalidatedCallback(<span class="keyword">this</span>.mCallback);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//通过create方法，生成了一个datasource对象 是一个抽象方法，由用户在上层实现</span></span><br><span class="line">        <span class="keyword">this</span>.mDataSource = dataSourceFactory.create();</span><br><span class="line">        <span class="keyword">this</span>.mDataSource.addInvalidatedCallback(<span class="keyword">this</span>.mCallback);</span><br><span class="line">        <span class="keyword">this</span>.mList = (<span class="keyword">new</span> androidx.paging.PagedList.Builder(<span class="keyword">this</span>.mDataSource, config)).setNotifyExecutor(notifyExecutor).setFetchExecutor(fetchExecutor).setBoundaryCallback(boundaryCallback).setInitialKey(initializeKey).build();</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="keyword">this</span>.mList.isDetached());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.mList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由用户在上层实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> DataSource&lt;Key, Value&gt; <span class="title">create</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>我们在viewmodel中的实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataSource.Factory factory = <span class="keyword">new</span> DataSource.Factory() &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span> || dataSource.isInvalid()) &#123;</span><br><span class="line">            dataSource = createDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>进而由每个具体的viewmodel中的new的datasource对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedDataSource</span> <span class="keyword">extends</span> <span class="title">ItemKeyedDataSource</span>&lt;<span class="title">Integer</span>, <span class="title">Feed</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInitial</span><span class="params">(<span class="meta">@NonNull</span> LoadInitialParams&lt;Integer&gt; params, <span class="meta">@NonNull</span> LoadInitialCallback&lt;Feed&gt; callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//加载初始化数据的</span></span><br><span class="line">        Log.e(<span class="string">&quot;homeviewmodel&quot;</span>, <span class="string">&quot;loadInitial: &quot;</span>);</span><br><span class="line">        loadData(<span class="number">0</span>, params.requestedLoadSize, callback);</span><br><span class="line">        witchCache = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAfter</span><span class="params">(<span class="meta">@NonNull</span> LoadParams&lt;Integer&gt; params, <span class="meta">@NonNull</span> LoadCallback&lt;Feed&gt; callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//向后加载分页数据的</span></span><br><span class="line">        Log.e(<span class="string">&quot;homeviewmodel&quot;</span>, <span class="string">&quot;loadAfter: &quot;</span>);</span><br><span class="line">        loadData(params.key, params.requestedLoadSize, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBefore</span><span class="params">(<span class="meta">@NonNull</span> LoadParams&lt;Integer&gt; params, <span class="meta">@NonNull</span> LoadCallback&lt;Feed&gt; callback)</span> </span>&#123;</span><br><span class="line">        callback.onResult(Collections.emptyList());</span><br><span class="line">        <span class="comment">//能够向前加载数据的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getKey</span><span class="params">(<span class="meta">@NonNull</span> Feed item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item.id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着往下看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.mDataSource.addInvalidatedCallback(<span class="keyword">this</span>.mCallback);</span><br></pre></td></tr></table></figure><p>为什么要给datasource注册一个callback呢？先往下看，这个callback干了什么</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//通过原子的方式，把mInvalide标志位设为true</span></span><br><span class="line">    <span class="keyword">if</span> (mInvalid.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (InvalidatedCallback callback : mOnInvalidatedCallbacks) &#123;</span><br><span class="line">            callback.onInvalidated();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这就会走到</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> InvalidatedCallback mCallback = <span class="keyword">new</span> InvalidatedCallback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>走到 ComputableLivedata.invalidate()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ArchTaskExecutor.getInstance().executeOnMainThread(mInvalidationRunnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mInvalidationRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isActive = mLiveData.hasActiveObservers();</span><br><span class="line">        <span class="keyword">if</span> (mInvalid.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isActive) &#123;</span><br><span class="line">                mExecutor.execute(mRefreshRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个mRefreshRunnable同样在onActive方法中被执行过</p><p>如何通过下拉刷新去触发 执行mRefreshRunnable呢？</p><p>上层执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mViewModel.getDataSource().invalidate();</span><br></pre></td></tr></table></figure><p>就会再次触发我们创建的ComputableLiveData中的mCallback中的onInvalidated方法进而实现invalidate的调用，并执行里面的mRefreshRunnable去刷新数据，所以</p><p>我们第一次创建时会刷新一次，后面就可以通这个注册的callback 上层调用 去主动刷新数据</p><p>再看mRefreshRunnable的后面</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> computed;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            computed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// compute can happen only in 1 thread but no reason to lock others.</span></span><br><span class="line">            <span class="keyword">if</span> (mComputing.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// as long as it is invalid, keep computing.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    T value = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> (mInvalid.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                        computed = <span class="keyword">true</span>;</span><br><span class="line">                      <span class="comment">//拿到value pagedlist</span></span><br><span class="line">                        value = compute();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (computed) &#123;</span><br><span class="line">                      <span class="comment">//通过livedata发送pagelist分发数据，这样注册的地方就可以接收到数据了</span></span><br><span class="line">                        mLiveData.postValue(value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// release compute lock</span></span><br><span class="line">                    mComputing.set(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (computed &amp;&amp; mInvalid.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/02/16/Android%20-%20%E5%9C%A8Fragment%E4%B8%AD%E8%A7%82%E5%AF%9FLiveData%E6%97%B6%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8viewLifecycleOwner/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="张龙"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SteveZhang博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2022/02/16/Android%20-%20%E5%9C%A8Fragment%E4%B8%AD%E8%A7%82%E5%AF%9FLiveData%E6%97%B6%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8viewLifecycleOwner/" class="post-title-link" itemprop="url">Android - 在Fragment中观察LiveData时，为什么要使用viewLifecycleOwner[转]</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-02-16 10:37:54" itemprop="dateCreated datePublished" datetime="2022-02-16T10:37:54+08:00">2022-02-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-05-12 15:32:47" itemprop="dateModified" datetime="2022-05-12T15:32:47+08:00">2022-05-12</time></span></div></header><div class="post-body" itemprop="articleBody"><p>使用LiveData 在调用observe时传入this会报提醒，要求使用viewLifecycleOwner原因是什么？</p><div class="post-button"><a class="btn" href="/2022/02/16/Android%20-%20%E5%9C%A8Fragment%E4%B8%AD%E8%A7%82%E5%AF%9FLiveData%E6%97%B6%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8viewLifecycleOwner/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span></nav></div><script>window.addEventListener("tabs:register",()=>{let e=CONFIG.comments["activeClass"];if(CONFIG.comments.storage&&(e=localStorage.getItem("comments_active")||e),e){let t=document.querySelector(`a[href="#comment-${e}"]`);t&&t.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">张龙</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">张龙</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script></body></html>