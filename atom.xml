<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>SteveZhang博客</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2022-06-18T11:39:13.000Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>张龙</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>JNI 如何实现数据传递?</title>
    <link href="http://example.com/2022/06/05/JNI-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92/"/>
    <id>http://example.com/2022/06/05/JNI-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92/</id>
    <published>2022-06-05T08:45:53.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/../images/image-20220605164700518.png" alt="image-20220605164700518"></p><p><img src="/../images/image-20220605164745282.png" alt="image-20220605164745282"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/../images/image-20220605164700518.png&quot; alt=&quot;image-20220605164700518&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/../images/image-20220605164745282.png&quot;</summary>
      
    
    
    
    <category term="NDK" scheme="http://example.com/categories/NDK/"/>
    
    
  </entry>
  
  <entry>
    <title>Java Native 方法与 Native 函数是怎么绑定的</title>
    <link href="http://example.com/2022/06/05/Java-Native-%E6%96%B9%E6%B3%95%E4%B8%8E-Native-%E5%87%BD%E6%95%B0%E6%98%AF%E6%80%8E%E4%B9%88%E7%BB%91%E5%AE%9A%E7%9A%84/"/>
    <id>http://example.com/2022/06/05/Java-Native-%E6%96%B9%E6%B3%95%E4%B8%8E-Native-%E5%87%BD%E6%95%B0%E6%98%AF%E6%80%8E%E4%B9%88%E7%BB%91%E5%AE%9A%E7%9A%84/</id>
    <published>2022-06-05T08:28:04.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>静态绑定：通过命名规则映射</li><li>动态绑定：通过JNI函数的注册</li></ul><p><img src="/../images/image-20220605162943139.png" alt="image-20220605162943139"></p><h2 id="静态绑定"><a href="#静态绑定" class="headerlink" title="静态绑定"></a>静态绑定</h2><p><img src="/../images/image-20220605163312911.png" alt="image-20220605163312911"></p><p>包名——类名——方法名  一一对应</p><p><img src="/../images/image-20220605163533987.png" alt="image-20220605163533987"></p><p>extern “C” 告诉编译器，以c的方式去保留这一名称，这个是要在符号表中直接保留原名，而不是写了什么就是什么，必须在符号表中有对应关系</p><h2 id="动态绑定"><a href="#动态绑定" class="headerlink" title="动态绑定"></a>动态绑定</h2><p><img src="/../images/image-20220605163933044.png" alt="image-20220605163933044"></p><ul><li>一般动态绑定在JNi_onLoad里触发</li><li>动态绑定可以在任何时刻触发</li><li>动态绑定之前根据静态规则查找Native函数</li><li>动态绑定可以在绑定后的任意时刻取消</li></ul><h2 id="动态绑定与静态绑定对比"><a href="#动态绑定与静态绑定对比" class="headerlink" title="动态绑定与静态绑定对比"></a>动态绑定与静态绑定对比</h2><p><img src="/../images/image-20220605164152912.png" alt="image-20220605164152912"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;静态绑定：通过命名规则映射&lt;/li&gt;
&lt;li&gt;动态绑定：通过JNI函数的注册&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/../images/image-20220605162943139.png&quot; alt=&quot;image-20220605162943139</summary>
      
    
    
    
    <category term="NDK" scheme="http://example.com/categories/NDK/"/>
    
    
  </entry>
  
  <entry>
    <title>CPU架构适配需要注意哪些问题</title>
    <link href="http://example.com/2022/06/05/CPU%E6%9E%B6%E6%9E%84%E9%80%82%E9%85%8D%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E5%93%AA%E4%BA%9B%E9%97%AE%E9%A2%98/"/>
    <id>http://example.com/2022/06/05/CPU%E6%9E%B6%E6%9E%84%E9%80%82%E9%85%8D%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E5%93%AA%E4%BA%9B%E9%97%AE%E9%A2%98/</id>
    <published>2022-06-05T08:04:16.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="常见的CPU的架构都有哪些"><a href="#常见的CPU的架构都有哪些" class="headerlink" title="常见的CPU的架构都有哪些"></a>常见的CPU的架构都有哪些</h2><ul><li><p>mips64</p></li><li><p>mips</p></li><li><p>x86_64</p></li><li><p>x86</p></li><li><p>arm64-v8a</p></li><li><p>armeabi-v7a</p></li><li><p>armeabi</p></li></ul><p><img src="/../images/image-20220605160541265.png" alt="image-20220605160541265"></p><p>其中mips64 mips不常见，已经被废弃，最常见的就是arm64-v8a、armeabi-v7a、armeabi 这三种</p><h2 id="CPU的架构的兼容性"><a href="#CPU的架构的兼容性" class="headerlink" title="CPU的架构的兼容性"></a>CPU的架构的兼容性</h2><p><img src="/../images/image-20220605160804095.png" alt="image-20220605160804095"></p><p>这个图的意思是armeabi 可以在armeabi-v7a 和 arm64-v8a上的机器上跑，它的兼容性最好，同时armeabi也可以在x86及x86_64的机器上跑，</p><p>而armeabi-v7a可以在arm64-v8a的机器上跑。</p><h2 id="Native库加载"><a href="#Native库加载" class="headerlink" title="Native库加载"></a>Native库加载</h2><p>一个arm64-v8a的机器上加载so库怎么加载，优先去自己的arm64-v8a上加载</p><p><img src="/../images/image-20220605161132759.png" alt="image-20220605161132759"></p><p>如果没有libui.so 而只有libmath.so 会发生什么呢？</p><p>它还是会去arm64-v8a下面找，没找到会报错，没错，是报错，而不是去它兼容的上一级去找，所以提供so的时候一定是一套，而不能缺少，要不就一个都不提供，那它才会去对应的次一级平台文件中建找</p><p><img src="/../images/image-20220605161347483.png" alt="image-20220605161347483"></p><p><img src="/../images/image-20220605161421666.png" alt="image-20220605161421666"></p><blockquote><p>可以动态的根据平台去加载某个库是v8a 而把它们全放在v7a的目录下，这样有一些库性能不敏感可以只加载v7a的，如果性能敏感就加载v8a的，微信就是这么干的</p></blockquote><p><img src="/../images/image-20220605161924758.png" alt="image-20220605161924758"></p><h2 id="动态加载Native库"><a href="#动态加载Native库" class="headerlink" title="动态加载Native库"></a>动态加载Native库</h2><p>非启动的加载库可云端下发</p><p><img src="/../images/image-20220605162116235.png" alt="image-20220605162116235"></p><h2 id="优化so体积"><a href="#优化so体积" class="headerlink" title="优化so体积"></a>优化so体积</h2><p><img src="/../images/image-20220605162231427.png" alt="image-20220605162231427"></p><h2 id="构建时分包"><a href="#构建时分包" class="headerlink" title="构建时分包"></a>构建时分包</h2><p><img src="/../images/image-20220605162318324.png" alt="image-20220605162318324"></p><h2 id="sdk开发者注意什么"><a href="#sdk开发者注意什么" class="headerlink" title="sdk开发者注意什么"></a>sdk开发者注意什么</h2><p><img src="/../images/image-20220605162434326.png" alt="image-20220605162434326"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/../images/image-20220605162706767.png" alt="image-20220605162706767"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;常见的CPU的架构都有哪些&quot;&gt;&lt;a href=&quot;#常见的CPU的架构都有哪些&quot; class=&quot;headerlink&quot; title=&quot;常见的CPU的架构都有哪些&quot;&gt;&lt;/a&gt;常见的CPU的架构都有哪些&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;mips64&lt;/p&gt;
&lt;/li&gt;
</summary>
      
    
    
    
    <category term="NDK" scheme="http://example.com/categories/NDK/"/>
    
    
  </entry>
  
  <entry>
    <title>基于RecyclerViewDiffUtilsDatabinding-Starter应用，学习DiffUtils和Databinding的使用</title>
    <link href="http://example.com/2022/05/25/%E5%9F%BA%E4%BA%8ERecyclerViewDiffUtilsDatabinding-Starter%E5%BA%94%E7%94%A8%EF%BC%8C%E5%AD%A6%E4%B9%A0DiffUtils%E5%92%8CDatabinding%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://example.com/2022/05/25/%E5%9F%BA%E4%BA%8ERecyclerViewDiffUtilsDatabinding-Starter%E5%BA%94%E7%94%A8%EF%BC%8C%E5%AD%A6%E4%B9%A0DiffUtils%E5%92%8CDatabinding%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2022-05-25T05:24:47.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="开始学习"><a href="#开始学习" class="headerlink" title="开始学习"></a>开始学习</h2><p>看下<code>SleepNightAdapter.kt</code>文件</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SleepNightAdapter</span>: <span class="type">RecyclerView.Adapter</span>&lt;<span class="type">SleepNightAdapter.ViewHolder</span>&gt;</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">data</span> =  listOf&lt;SleepNight&gt;()</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">            notifyDataSetChanged()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemCount</span><span class="params">()</span></span> = <span class="keyword">data</span>.size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> item = <span class="keyword">data</span>[position]</span><br><span class="line">        holder.bind(item)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: ViewHolder &#123;</span><br><span class="line">        <span class="keyword">return</span> ViewHolder.from(parent)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">private</span> <span class="keyword">constructor</span></span>(itemView: View) : RecyclerView.ViewHolder(itemView)&#123;</span><br><span class="line">        <span class="keyword">val</span> sleepLength: TextView = itemView.findViewById(R.id.sleep_length)</span><br><span class="line">        <span class="keyword">val</span> quality: TextView = itemView.findViewById(R.id.quality_string)</span><br><span class="line">        <span class="keyword">val</span> qualityImage: ImageView = itemView.findViewById(R.id.quality_image)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">bind</span><span class="params">(item: <span class="type">SleepNight</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> res = itemView.context.resources</span><br><span class="line">            sleepLength.text = convertDurationToFormatted(item.startTimeMilli, item.endTimeMilli, res)</span><br><span class="line">            quality.text = convertNumericQualityToString(item.sleepQuality, res)</span><br><span class="line">            qualityImage.setImageResource(<span class="keyword">when</span> (item.sleepQuality) &#123;</span><br><span class="line">                <span class="number">0</span> -&gt; R.drawable.ic_sleep_0</span><br><span class="line">                <span class="number">1</span> -&gt; R.drawable.ic_sleep_1</span><br><span class="line">                <span class="number">2</span> -&gt; R.drawable.ic_sleep_2</span><br><span class="line">                <span class="number">3</span> -&gt; R.drawable.ic_sleep_3</span><br><span class="line">                <span class="number">4</span> -&gt; R.drawable.ic_sleep_4</span><br><span class="line">                <span class="number">5</span> -&gt; R.drawable.ic_sleep_5</span><br><span class="line">                <span class="keyword">else</span> -&gt; R.drawable.ic_sleep_active</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">            <span class="function"><span class="keyword">fun</span> <span class="title">from</span><span class="params">(parent: <span class="type">ViewGroup</span>)</span></span>: ViewHolder &#123;</span><br><span class="line">                <span class="keyword">val</span> layoutInflater = LayoutInflater.from(parent.context)</span><br><span class="line">                <span class="keyword">val</span> view = layoutInflater</span><br><span class="line">                        .inflate(R.layout.list_item_sleep_night, parent, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ViewHolder(view)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../images/image-20220525132631228.png" alt="image-20220525132631228"></p><ul><li>应用根据用户输入创建 <code>SleepNight</code> 对象列表。每个 <code>SleepNight</code> 对象表示一个夜晚以及用户该晚睡眠的时长和质量。</li><li><code>SleepNightAdapter</code> 会将 <code>SleepNight</code> 对象的列表调整为 <code>RecyclerView</code> 可以使用和显示的内容。</li><li><code>SleepNightAdapter</code> 适配器会生成 <code>ViewHolders</code>，其中包含 RecyclerView 用于显示数据的视图、数据和元数据信息。</li><li><code>RecyclerView</code> 使用 <code>SleepNightAdapter</code> 来确定要显示的项数 (<code>getItemCount()</code>)。<code>RecyclerView</code> 使用 <code>onCreateViewHolder()</code> 和 <code>onBindViewHolder()</code> 获取与要显示的数据绑定的 ViewHolder。</li></ul><h3 id="notifyDataSetChanged-方法效率低下"><a href="#notifyDataSetChanged-方法效率低下" class="headerlink" title="notifyDataSetChanged() 方法效率低下"></a>notifyDataSetChanged() 方法效率低下</h3><p>为了告知 <code>RecyclerView</code> 列表中的某个项已更改且需要更新，当前代码会在 <code>SleepNightAdapter</code> 中调用 <a href="https://developer.android.com/reference/android/widget/BaseAdapter"><code>notifyDataSetChanged()</code></a>，如下所示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">data</span> =  listOf&lt;SleepNight&gt;()</span><br><span class="line">   <span class="keyword">set</span>(value) &#123;</span><br><span class="line">       field = value</span><br><span class="line">       notifyDataSetChanged()</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>但是，<code>notifyDataSetChanged()</code> 会告知 <code>RecyclerView</code> 整个列表可能无效。因此，<code>RecyclerView</code> 会重新绑定并重新绘制列表中的每个项，<strong>包括屏幕上看不到的项</strong>。这是一项既繁重又不必要的工作。对于较大或复杂的列表，这个过程可能需要较长时间，<strong>以至于在用户滚动浏览列表时，屏幕会闪烁或卡顿。</strong></p><p>要解决此问题，您可以确切地告诉 <code>RecyclerView</code> 发生了什么更改。然后，<code>RecyclerView</code> 便可仅更新屏幕上已经发生更改的视图。</p><p><code>RecyclerView</code> 拥有一个用于更新单个元素的功能丰富的 API。您可以使用 <a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.Adapter#notifyitemchanged"><code>notifyItemChanged()</code></a> 告知 <code>RecyclerView</code> 某个项发生了更改，并且您可以对添加、移除或移动的项使用类似的函数。您可以全部手动完成，但这样任务就会很繁重，并且可能需要使用大量代码。</p><p>幸运的是，我们有一个更好的办法。</p><h3 id="DiffUtil-很高效并可为您完成繁重工作"><a href="#DiffUtil-很高效并可为您完成繁重工作" class="headerlink" title="DiffUtil 很高效并可为您完成繁重工作"></a>DiffUtil 很高效并可为您完成繁重工作</h3><p><code>RecyclerView</code> 有一个名为 <code>DiffUtil</code> 的类，用于计算两个列表之间的差异。<code>DiffUtil</code> 会接受一个旧列表和一个新列表，并确定二者有何不同。它会查找已添加、移除或更改的项。然后，它会使用一种算法（名为 <a href="https://en.wikipedia.org/wiki/Diff">Eugene W. Myers 差分算法</a>），来确定要生成新列表，需要对旧列表做出的最小更改量。</p><p>在 <code>DiffUtil</code> 确定了更改内容后，<code>RecyclerView</code> 可以根据这些信息仅更新已更改、添加、移除或移动的项，这比重做整个列表要高效得多。</p><h2 id="使用DiffUtil刷新列表内容"><a href="#使用DiffUtil刷新列表内容" class="headerlink" title="使用DiffUtil刷新列表内容"></a>使用DiffUtil刷新列表内容</h2><h3 id="第-1-步：实现-SleepNightDiffCallback"><a href="#第-1-步：实现-SleepNightDiffCallback" class="headerlink" title="第 1 步：实现 SleepNightDiffCallback"></a>第 1 步：实现 SleepNightDiffCallback</h3><p>为了使用 <code>DiffUtil</code> 类的功能，请扩展 <code>DiffUtil.ItemCallback</code>。</p><p>1.打开 <code>SleepNightAdapter.kt</code>。</p><p>2.在 <code>SleepNightAdapter</code> 的完整类定义下方，创建一个名为 <code>SleepNightDiffCallback</code> 的新顶级类，用于扩展 <code>DiffUtil.ItemCallback</code>。以通用参数的形式传递 <code>SleepNight</code>。</p><p>3.将光标放在 <code>SleepNightDiffCallback</code> 类名称上。</p><p>4.<code>Alt+Enter</code>（在 Mac 上，按 <code>Option+Enter</code>）并选择 <strong>Implement Members</strong>。</p><p>5.在打开的对话框中，按住 Shift 键并点击鼠标左键以选择 <code>areItemsTheSame()</code> 和 <code>areContentsTheSame()</code> 方法，然后点击 <strong>OK</strong>。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SleepNightDiffCallback</span> : <span class="type">DiffUtil.ItemCallback</span>&lt;<span class="type">SleepNight</span>&gt;</span>() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此操作会针对这两个方法在 <code>SleepNightDiffCallback</code> 中生成桩，如下所示。<code>DiffUtil</code> 使用这两种方法来确定列表和项的具体更改。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    TODO(<span class="string">&quot;not implemented&quot;</span>) <span class="comment">//To change body of created functions use File | Settings | File Templates.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">areContentsTheSame</span><span class="params">(oldItem: <span class="type">SleepNight</span>, newItem: <span class="type">SleepNight</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    TODO(<span class="string">&quot;not implemented&quot;</span>) <span class="comment">//To change body of created functions use File | Settings | File Templates.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>6.在 <code>areItemsTheSame()</code> 中，将 <code>TODO</code> 替换为用于测试两个传入 <code>SleepNight</code> 项 <code>oldItem</code> 和 <code>newItem</code> 是否相同的代码。如果这两个项具有相同的 <code>nightId</code>，则表明它们是相同的，因此返回 <code>true</code>。否则返回 <code>false</code>。<code>DiffUtil</code> 使用此测试来帮助发现是否已添加、移除或移动某个项。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">areItemsTheSame</span><span class="params">(oldItem: <span class="type">SleepNight</span>, newItem: <span class="type">SleepNight</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> oldItem.nightId == newItem.nightId</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>7.在 <code>areContentsTheSame()</code> 中，检查 <code>oldItem</code> 和 <code>newItem</code> 是否包含相同的数据；即判断它们是否相等。由于 <code>SleepNight</code> 是一个数据类，<strong>此相等性检查将检查所有字段</strong>。<code>Data</code> 类会自动为您定义 <code>equals</code> 和一些其他方法。如果 <code>oldItem</code> 和 <code>newItem</code> 之间存在差异，此代码会告知 <code>DiffUtil</code> 相应项已更新。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">areContentsTheSame</span><span class="params">(oldItem: <span class="type">SleepNight</span>, newItem: <span class="type">SleepNight</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> oldItem == newItem</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用ListAdapter管理列表"><a href="#使用ListAdapter管理列表" class="headerlink" title="使用ListAdapter管理列表"></a>使用ListAdapter管理列表</h2><p>通常使用 <code>RecyclerView</code> 来显示会发生变化的列表。<code>RecyclerView</code> 提供适配器类 <code>ListAdapter</code>，可帮助您构建由列表支持的 <code>RecyclerView</code> 适配器。</p><p><code>ListAdapter</code> 会为您跟踪列表，并在列表更新时通知适配器。</p><p>1.在 <code>SleepNightAdapter.kt</code> 文件中，更改 <code>SleepNightAdapter</code> 的类签名以扩展 <code>ListAdapter</code>。</p><p>2.如果出现提示，请导入 <code>androidx.recyclerview.widget.ListAdapter</code>。</p><p>3.将 <code>SleepNight</code> 作为第一个参数添加到 <code>ListAdapter</code> 中 <code>SleepNightAdapter.ViewHolder</code> 之前。</p><p>4.将 <code>SleepNightDiffCallback()</code> 作为参数添加到构造函数中。<code>ListAdapter</code> 将利用此参数确定列表中的更改内容。完成后的 <code>SleepNightAdapter</code> 类签名应如下所示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SleepNightAdapter</span> : <span class="type">ListAdapter</span>&lt;<span class="type">SleepNight, SleepNightAdapter.ViewHolder</span>&gt;</span>(SleepNightDiffCallback()) &#123;</span><br></pre></td></tr></table></figure><p>5.在 <code>SleepNightAdapter</code> 类中，删除 <code>data</code> 字段，包括 setter。您已不再需要它，因为 <code>ListAdapter</code> 会为您跟踪列表。</p><p>6.删除 <code>getItemCount()</code> 的替换方法，因为 <code>ListAdapter</code> 为您实现了此方法。</p><p>7.如需消除 <code>onBindViewHolder()</code> 中的错误，请更改 <code>item</code> 变量。调用 <code>ListAdapter</code> 提供的 <code>getItem(position)</code> 方法，而不要使用 <code>data</code> 来获取 <code>item</code>。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> item = getItem(position)</span><br></pre></td></tr></table></figure><h3 id="第-2-步：使用-submitList-及时更新列表"><a href="#第-2-步：使用-submitList-及时更新列表" class="headerlink" title="第 2 步：使用 submitList() 及时更新列表"></a>第 2 步：使用 submitList() 及时更新列表</h3><p>在有已更改的列表时，您的代码需要告知 <code>ListAdapter</code>。<code>ListAdapter</code> 提供了一个名为 <code>submitList()</code> 的方法，用于告知 <code>ListAdapter</code> 列表有新版本。调用此方法时，<code>ListAdapter</code> 会将新列表与旧列表进行差异比较，并检测已添加、移除、移动或更改的项。然后，<code>ListAdapter</code> 会更新 <code>RecyclerView</code> 所显示的项。</p><p>1.打开 <code>SleepTrackerFragment.kt</code>。</p><p>2.在 <code>sleepTrackerViewModel</code> 内的观察器上，在 <code>onCreateView()</code> 中找到引用您已删除的 <code>data</code> 变量的错误。</p><p>3.将 <code>adapter.data = it</code> 替换为对 <code>adapter.submitList(it)</code> 的调用。更新后的代码如下所示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sleepTrackerViewModel.nights.observe(viewLifecycleOwner, Observer &#123;</span><br><span class="line">   it?.let &#123;</span><br><span class="line">       adapter.submitList(it)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>4.运行您的应用。您可能需要导入 findNavController。您可能会注意到，您的应用运行速度变快了，然而如果列表太小，这个变化可能不明显。</p><h2 id="将DataBinding与RecyclerView搭配使用"><a href="#将DataBinding与RecyclerView搭配使用" class="headerlink" title="将DataBinding与RecyclerView搭配使用"></a>将DataBinding与RecyclerView搭配使用</h2><p>在此任务中，您需要使用与之前 Codelab 相同的方法来设置数据绑定，并消除对 <code>findViewById()</code> 的调用。</p><h3 id="第-1-步：向布局文件添加数据绑定"><a href="#第-1-步：向布局文件添加数据绑定" class="headerlink" title="第 1 步：向布局文件添加数据绑定"></a>第 1 步：向布局文件添加数据绑定</h3><p>1.在 <strong>Code</strong> 标签页中打开 <code>list_item_sleep_night.xml</code> 布局文件。</p><p>2.将光标放在 <code>ConstraintLayout</code> 标签上，然后按 <code>Alt+Enter</code>（在 Mac 上，按 <code>Option+Enter</code>）。系统随即会打开 intent 菜单（“quick fix”菜单）。</p><p>3.选择 <strong>Convert to data binding layout</strong>。这会将布局封装到 <code>&lt;layout&gt;</code> 中，并在其中添加 <code>&lt;data&gt;</code> 标签。</p><p>4.根据需要滚动回顶部，并在 <code>&lt;data&gt;</code> 标签内声明一个名为 <code>sleep</code> 的变量。</p><p>5.将其 <code>type</code> 设为 <code>SleepNight</code> 的完全限定名称 <code>com.example.android.trackmysleepquality.database.SleepNight</code>。完成后的 <code>&lt;data&gt;</code> 标签应如下所示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">data</span>&gt;</span><br><span class="line">     &lt;variable</span><br><span class="line">         name=<span class="string">&quot;sleep&quot;</span></span><br><span class="line">         type=<span class="string">&quot;com.example.android.trackmysleepquality.database.SleepNight&quot;</span>/&gt;</span><br><span class="line"> &lt;/<span class="keyword">data</span>&gt;</span><br></pre></td></tr></table></figure><p>6.如需强制创建 <code>Binding</code> 对象，请依次选择 <strong>Build &gt; Clean Project</strong>，然后依次选择 <strong>Build &gt; Rebuild Project</strong>。（如果仍然存在问题，请依次选择 <strong>File &gt; Invalidate Caches &#x2F; Restart</strong>。）<code>ListItemSleepNightBinding</code> 绑定对象以及相关代码会添加到项目生成的文件中。</p><h3 id="第-2-步：使用数据绑定膨胀项布局"><a href="#第-2-步：使用数据绑定膨胀项布局" class="headerlink" title="第 2 步：使用数据绑定膨胀项布局"></a>第 2 步：使用数据绑定膨胀项布局</h3><p>1.打开 <code>SleepNightAdapter.kt</code>。</p><p>2.在 <code>companion object</code> 中，找到 <code>from(parent: ViewGroup)</code> 函数。</p><p>3.删除 <code>view</code> 变量的声明。</p><p>要<strong>删除</strong>的代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> view = layoutInflater</span><br><span class="line">       .inflate(R.layout.list_item_sleep_night, parent, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><p>4.在 <code>view</code> 变量所在的位置，定义一个名为 <code>binding</code> 的新变量，以膨胀 <code>ListItemSleepNightBinding</code> 绑定对象，如下所示。根据需要导入绑定对象。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> binding =</span><br><span class="line">ListItemSleepNightBinding.inflate(layoutInflater, parent, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><p>5.在函数结尾，不要返回 <code>view</code>，而应返回 <code>binding</code>。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ViewHolder(binding)</span><br></pre></td></tr></table></figure><p>6.要消除 <code>binding</code> 上的错误，请将光标放在 <code>binding</code> 一词上。按 <code>Alt+Enter</code>（在 Mac 上，按 <code>Option+Enter</code>）打开 intent 菜单。</p><p>7.选择 **Change parameter ‘itemView’ type of primary constructor of class ‘ViewHolder’ to ‘ListItemSleepNightBinding’**。这将更新 <code>ViewHolder</code> 类的参数类型。</p><p><img src="/../images/image-20220525135714938.png" alt="image-20220525135714938"></p><p>8.向上滚动到 <code>ViewHolder</code> 的类定义，以查看签名中的更改。您会看到 <code>itemView</code> 的错误，因为您在 <code>from()</code> 方法中将 <code>itemView</code> 更改为了 <code>binding</code>。</p><p>在 <code>ViewHolder</code> 类定义中，右键点击 <code>itemView</code> 的一个发生实例，然后依次选择 <strong>Refactor</strong> &gt; <strong>Rename</strong>。将名称更改为 <code>binding</code>。</p><p>9.为构造函数参数 <code>binding</code> 添加 <code>val</code> 前缀，使其成为属性。</p><p>10.在对父类 <code>RecyclerView.ViewHolder</code> 的调用中，将参数从 <code>binding</code> 更改为 <code>binding.root</code>。您需要传递 <code>View</code>，并且将 <code>binding.root</code> 作为项布局中的根 <code>ConstraintLayout</code>。</p><p>11.完成后的类声明应如以下代码所示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">private</span> <span class="keyword">constructor</span></span>(<span class="keyword">val</span> binding: ListItemSleepNightBinding) : RecyclerView.ViewHolder(binding.root)&#123;</span><br></pre></td></tr></table></figure><p>您还会看到对 <code>findViewById().</code> 的调用的错误。您将在下一部分中修复这些错误。</p><h3 id="第-3-步：替换-findViewById"><a href="#第-3-步：替换-findViewById" class="headerlink" title="第 3 步：替换 findViewById()"></a>第 3 步：替换 findViewById()</h3><p>您现在可以更新 <code>sleepLength</code>、<code>quality</code> 和 <code>qualityImage</code> 属性，以使用 <code>binding</code> 对象代替 <code>findViewById()</code>。</p><p>1.将 <code>sleepLength</code>、<code>qualityString</code> 和 <code>qualityImage</code> 的初始化更改为使用 <code>binding</code> 对象的视图，如下所示。此后，您的代码应该不会再显示任何错误。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sleepLength: TextView = binding.sleepLength</span><br><span class="line"><span class="keyword">val</span> quality: TextView = binding.qualityString</span><br><span class="line"><span class="keyword">val</span> qualityImage: ImageView = binding.qualityImage</span><br></pre></td></tr></table></figure><p>绑定对象就位后，您根本不需要定义 <code>sleepLength</code>、<code>quality</code> 和 <code>qualityImage</code> 属性。<code>DataBinding</code> 将缓存查询，因此无需声明这些属性。</p><p>2.右键点击 <code>sleepLength</code>、<code>quality</code> 和 <code>qualityImage</code> 属性名称。对于每个属性，依次选择 <strong>Refactor &gt; Inline</strong>，或按 <code>Ctrl+Alt+N</code>（在 Mac 上按 <code>Option+Command+N</code>）。</p><p><img src="/../images/image-20220525135903462.png" alt="image-20220525135903462"></p><p>3.运行您的应用。（如果项目出现错误，您可能需要<strong>清理</strong>并<strong>重建</strong>项目。）</p><h2 id="创建绑定适配器"><a href="#创建绑定适配器" class="headerlink" title="创建绑定适配器"></a>创建绑定适配器</h2><p>在此任务中，您需要升级应用，将数据绑定与绑定适配器结合使用，在视图中设置数据。</p><p>在上一个 Codelab 中，您使用了 <a href="https://developer.android.com/reference/android/arch/lifecycle/Transformations"><code>Transformations</code></a> 类来获取 <code>LiveData</code> 并生成要在文本视图中显示的格式化字符串。但是，如果您需要绑定不同类型或复杂类型的数据，您可以提供绑定适配器来帮助数据绑定功能使用这些类型。绑定适配器会获取您的数据，并将其调整为可供数据绑定功能用于绑定视图（例如文本或图片）的内容。</p><p>您需要实现三个绑定适配器，一个用于高质量图片，另外两个分别用于一个文本字段。总而言之，如需声明绑定适配器，您需要定义一种获取项和视图的方法，并用 <code>@BindingAdapter</code> 进行注解。在该方法的正文中，您可以实现转换。在 Kotlin 中，您可以在接收数据的视图类上将绑定适配器编写为扩展函数。</p><h3 id="第-1-步：创建绑定适配器"><a href="#第-1-步：创建绑定适配器" class="headerlink" title="第 1 步：创建绑定适配器"></a>第 1 步：创建绑定适配器</h3><p>请注意，您必须在此步骤中导入很多类。</p><p>1.打开 <code>SleepNightAdapter.kt</code>。</p><p>2.在 <code>ViewHolder</code> 类中，找到 <code>bind()</code> 方法并注意该方法的用途。您需要获取用于计算 <code>binding.sleepLength</code>、<code>binding.quality</code> 和 <code>binding.qualityImage</code> 的值的代码，并在适配器中改用该代码。（目前不要更改代码，您需要在后续步骤中移动代码。）</p><p>3.在 <code>sleeptracker</code> 软件包中，创建一个名为 <code>BindingUtils.kt</code> 的新文件并打开此文件。</p><p>4.删除 <code>BindingUtils</code> 类中的所有内容，因为您接下来要创建静态函数。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingUtils</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>5.在 <code>TextView</code> 上声明一个名为 <code>setSleepDurationFormatted</code> 的扩展函数，并传入 <code>SleepNight</code>。此函数将作为适配器，用于计算和格式化睡眠时长。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> TextView.<span class="title">setSleepDurationFormatted</span><span class="params">(item: <span class="type">SleepNight</span>)</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>6.在 <code>setSleepDurationFormatted</code> 的正文中，将数据绑定到视图，如在 <code>ViewHolder.bind()</code> 中一样。调用 <code>convertDurationToFormatted()</code>，然后将 <code>TextView</code> 的 <code>text</code> 设置为格式化文本。（由于这是 <code>TextView</code> 上的扩展函数，您可以直接访问 <code>text</code> 属性。）</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text = convertDurationToFormatted(item.startTimeMilli, item.endTimeMilli, context.resources)</span><br></pre></td></tr></table></figure><p>7.如需向数据绑定功能告知此绑定适配器，请使用 <code>@BindingAdapter</code> 为该函数添加注解。</p><p>8.此函数是用于 <code>sleepDurationFormatted</code> 属性的适配器，因此请将 <code>sleepDurationFormatted</code> 作为参数传递给 <code>@BindingAdapter</code>。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;sleepDurationFormatted&quot;</span>)</span></span><br></pre></td></tr></table></figure><p>9.第二个适配器根据 <code>SleepNight</code> 对象中的值设置睡眠质量。在 <code>TextView</code> 上再创建一个名为 <code>setSleepQualityString()</code> 的扩展函数，并传入 <code>SleepNight</code>。</p><p>10.在正文中，将数据绑定到视图，如在 <code>ViewHolder.bind()</code> 中一样。调用 <code>convertNumericQualityToString</code> 并设置 <code>text</code>。</p><p>11.使用 <code>@BindingAdapter(&quot;sleepQualityString&quot;)</code> 为该函数添加注解。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;sleepQualityString&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> TextView.<span class="title">setSleepQualityString</span><span class="params">(item: <span class="type">SleepNight</span>)</span></span> &#123;</span><br><span class="line">   text = convertNumericQualityToString(item.sleepQuality, context.resources)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>12.我们需要第三个绑定适配器，用于在图片视图上设置图片。在 <code>ImageView</code> 上创建第三个扩展函数，调用 <code>setSleepImage</code>，并使用 <code>ViewHolder.bind()</code> 中的代码，如下所示。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;sleepImage&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> ImageView.<span class="title">setSleepImage</span><span class="params">(item: <span class="type">SleepNight</span>)</span></span> &#123;</span><br><span class="line">   setImageResource(<span class="keyword">when</span> (item.sleepQuality) &#123;</span><br><span class="line">       <span class="number">0</span> -&gt; R.drawable.ic_sleep_0</span><br><span class="line">       <span class="number">1</span> -&gt; R.drawable.ic_sleep_1</span><br><span class="line">       <span class="number">2</span> -&gt; R.drawable.ic_sleep_2</span><br><span class="line">       <span class="number">3</span> -&gt; R.drawable.ic_sleep_3</span><br><span class="line">       <span class="number">4</span> -&gt; R.drawable.ic_sleep_4</span><br><span class="line">       <span class="number">5</span> -&gt; R.drawable.ic_sleep_5</span><br><span class="line">       <span class="keyword">else</span> -&gt; R.drawable.ic_sleep_active</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>您可能需要导入 convertDurationToFormatted 和 convertNumericQualityToString。</p><h3 id="第-2-步：更新-SleepNightAdapter"><a href="#第-2-步：更新-SleepNightAdapter" class="headerlink" title="第 2 步：更新 SleepNightAdapter"></a>第 2 步：更新 SleepNightAdapter</h3><p>1.打开 <code>SleepNightAdapter.kt</code>。</p><p>2.删除 <code>bind()</code> 方法中的所有内容，因为您现在可以使用数据绑定和新的适配器来为您执行这项操作。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">bind</span><span class="params">(item: <span class="type">SleepNight</span>)</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.在 <code>bind()</code> 中，为 <code>item</code> 分配 sleep，因为您需要告知绑定对象您的新 <code>SleepNight</code>。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binding.sleep = item</span><br></pre></td></tr></table></figure><p>4.在该行的下方，添加 <code>binding.executePendingBindings()</code>。此调用是一种优化，用于要求数据绑定功能立即执行任何待处理的绑定。当您在 <code>RecyclerView</code> 中使用绑定适配器时，最好调用 <code>executePendingBindings()</code>，因为它可以略微加快调整视图大小的过程。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binding.executePendingBindings()</span><br></pre></td></tr></table></figure><h2 id="第-3-步：向-XML-布局添加绑定"><a href="#第-3-步：向-XML-布局添加绑定" class="headerlink" title="第 3 步：向 XML 布局添加绑定"></a>第 3 步：向 XML 布局添加绑定</h2><p>1.打开 <code>list_item_sleep_night.xml</code>。</p><p>2.在 <code>ImageView</code> 中，添加与设置图片的绑定适配器同名的 <code>app</code> 属性。传入 <code>sleep</code> 变量，如下所示。</p><p>此属性通过适配器建立视图与绑定对象之间的连接。每当引用 <code>sleepImage</code> 时，适配器都会调整 <code>SleepNight</code> 中的数据。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app:sleepImage=<span class="string">&quot;@&#123;sleep&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>3.现在，为 <code>sleep_length</code> 和 <code>quality_string</code> 文本视图添加类似的应用属性。每当引用 <code>sleepDurationFormatted</code> 或 <code>sleepQualityString</code> 时，适配器都会调整来自 <code>SleepNight</code> 中的数据。请务必将每个属性分别放入其各自的 <code>TextView.</code> 中</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app:sleepDurationFormatted=<span class="string">&quot;@&#123;sleep&#125;&quot;</span></span><br><span class="line">app:sleepQualityString=<span class="string">&quot;@&#123;sleep&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>4.运行您的应用，其运行情况与之前完全一样。绑定适配器负责处理随着数据变化而格式化和更新视图的所有工作，从而简化 <code>ViewHolder</code> 并为代码提供比之前更好的结构。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;开始学习&quot;&gt;&lt;a href=&quot;#开始学习&quot; class=&quot;headerlink&quot; title=&quot;开始学习&quot;&gt;&lt;/a&gt;开始学习&lt;/h2&gt;&lt;p&gt;看下&lt;code&gt;SleepNightAdapter.kt&lt;/code&gt;文件&lt;/p&gt;
&lt;figure class=&quot;highl</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Lifecycle 官方文档[转](更新中)</title>
    <link href="http://example.com/2022/05/20/Lifecycle-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3-%E8%BD%AC-%E6%9B%B4%E6%96%B0%E4%B8%AD/"/>
    <id>http://example.com/2022/05/20/Lifecycle-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3-%E8%BD%AC-%E6%9B%B4%E6%96%B0%E4%B8%AD/</id>
    <published>2022-05-19T21:56:29.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用生命周期感知型组件处理生命周期"><a href="#使用生命周期感知型组件处理生命周期" class="headerlink" title="使用生命周期感知型组件处理生命周期"></a>使用生命周期感知型组件处理生命周期</h2><p>生命周期感知型组件可执行操作来响应另一个组件（如 <code>Activity</code> 和 <code>Fragment</code>）的生命周期状态的变化。这些组件有助于您编写出更有条理且往往更精简的代码，此类代码更易于维护。</p><p>一种常见的模式是在 Activity 和 Fragment 的生命周期方法中实现依赖组件的操作。但是，这种模式会导致代码条理性很差而且会扩散错误。通过使用生命周期感知型组件，您可以将依赖组件的代码从生命周期方法移入组件本身中。</p><p><a href="https://developer.android.com/reference/androidx/lifecycle/package-summary?hl=zh-cn"><code>androidx.lifecycle</code></a> 软件包提供了可用于构建生命周期感知型组件的类和接口 - 这些组件可以根据 Activity 或 Fragment 的当前生命周期状态自动调整其行为。</p><blockquote><p><strong>注意</strong>：如需将 <a href="https://developer.android.com/reference/androidx/lifecycle/package-summary?hl=zh-cn"><code>androidx.lifecycle</code></a>导入 Android 项目，请参阅 <a href="https://developer.android.com/jetpack/androidx/releases/lifecycle?hl=zh-cn#declaring_dependencies">Lifecycle 版本说明</a>中关于声明依赖项的说明。</p></blockquote><p>在 Android 框架中定义的大多数应用组件都存在生命周期。生命周期由操作系统或进程中运行的框架代码管理。它们是 Android 工作原理的核心，应用必须遵循它们。如果不这样做，可能会引发内存泄漏甚至应用崩溃。</p><p>假设我们有一个在屏幕上显示设备位置的 Activity。常见的实现可能如下所示：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocationListener</span></span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> context: Context,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> callback: (Location) -&gt; <span class="built_in">Unit</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// connect to system location service</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// disconnect from system location service</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> myLocationListener: MyLocationListener</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">        myLocationListener = MyLocationListener(<span class="keyword">this</span>) &#123; location -&gt;</span><br><span class="line">            <span class="comment">// update UI</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart()</span><br><span class="line">        myLocationListener.start()</span><br><span class="line">        <span class="comment">// manage other components that need to respond</span></span><br><span class="line">        <span class="comment">// to the activity lifecycle</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop()</span><br><span class="line">        myLocationListener.stop()</span><br><span class="line">        <span class="comment">// manage other components that need to respond</span></span><br><span class="line">        <span class="comment">// to the activity lifecycle</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h2><p><a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle?hl=zh-cn"><code>Lifecycle</code></a> 是一个类，用于存储有关组件（如 Activity 或 Fragment）的生命周期状态的信息，并允许其他对象观察此状态。</p><p><a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle?hl=zh-cn"><code>Lifecycle</code></a> 使用两种主要枚举跟踪其关联组件的生命周期状态：</p><ul><li><p>事件</p><p>从框架和 <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle?hl=zh-cn"><code>Lifecycle</code></a> 类分派的生命周期事件。这些事件映射到 Activity 和 Fragment 中的回调事件。</p></li><li><p>状态</p><p>由 <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle?hl=zh-cn"><code>Lifecycle</code></a> 对象跟踪的组件的当前状态。</p></li></ul><p><img src="/../images/image-20220520060137800.png" alt="image-20220520060137800"></p><p>您可以将状态看作图中的节点，将事件看作这些节点之间的边。</p><p>类可以通过实现 <a href="https://developer.android.com/reference/androidx/lifecycle/DefaultLifecycleObserver?hl=zh-cn"><code>DefaultLifecycleObserver</code></a> 并替换相应的方法（如 <code>onCreate</code> 和 <code>onStart</code> 等）来监控组件的生命周期状态。然后，您可以通过调用 <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle?hl=zh-cn"><code>Lifecycle</code></a> 类的 <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle?hl=zh-cn#addObserver(androidx.lifecycle.LifecycleObserver)"><code>addObserver()</code></a> 方法并传递观察器的实例来添加观察器，如下例所示：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObserver</span> : <span class="type">DefaultLifecycleObserver &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        connect()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        disconnect()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myLifecycleOwner.getLifecycle().addObserver(MyObserver())</span><br></pre></td></tr></table></figure><p>在上面的示例中，<code>myLifecycleOwner</code> 对象实现了 <a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn"><code>LifecycleOwner</code></a> 接口，我们将在接下来的部分中对该接口进行说明。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;使用生命周期感知型组件处理生命周期&quot;&gt;&lt;a href=&quot;#使用生命周期感知型组件处理生命周期&quot; class=&quot;headerlink&quot; title=&quot;使用生命周期感知型组件处理生命周期&quot;&gt;&lt;/a&gt;使用生命周期感知型组件处理生命周期&lt;/h2&gt;&lt;p&gt;生命周期感知型组件可</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Android8.0以上系统应用如何保活[转]</title>
    <link href="http://example.com/2022/05/17/Android8-0%E4%BB%A5%E4%B8%8A%E7%B3%BB%E7%BB%9F%E5%BA%94%E7%94%A8%E5%A6%82%E4%BD%95%E4%BF%9D%E6%B4%BB-%E8%BD%AC/"/>
    <id>http://example.com/2022/05/17/Android8-0%E4%BB%A5%E4%B8%8A%E7%B3%BB%E7%BB%9F%E5%BA%94%E7%94%A8%E5%A6%82%E4%BD%95%E4%BF%9D%E6%B4%BB-%E8%BD%AC/</id>
    <published>2022-05-17T04:59:09.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Android-8-0以上系统应用如何保活"><a href="#Android-8-0以上系统应用如何保活" class="headerlink" title="Android 8.0以上系统应用如何保活"></a><a href="https://segmentfault.com/a/1190000020159573">Android 8.0以上系统应用如何保活</a></h1><p>最近在做一个埋点的sdk，由于埋点是分批上传的，不是每次都上传，所以会有个进程保活的机制，这也是自研推送的实现技术之一：如何保证Android进程的存活。</p><p>对于Android来说，保活主要有以下一些方法：</p><ul><li>开启前台Service（效果好，推荐）</li><li>Service中循环播放一段无声音频（效果较好，但耗电量高，谨慎使用）</li><li>双进程守护（Android 5.0前有效）</li><li>JobScheduler（Android 5.0后引入，8.0后失效）</li><li>1 像素activity保活方案（不推荐）</li><li>广播锁屏、自定义锁屏（不推荐）</li><li>第三方推送SDK唤醒（效果好，缺点是第三方接入）</li></ul><p>下面是具体的实现方案：</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Android-8-0以上系统应用如何保活&quot;&gt;&lt;a href=&quot;#Android-8-0以上系统应用如何保活&quot; class=&quot;headerlink&quot; title=&quot;Android 8.0以上系统应用如何保活&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://segmen</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>WorkManager相关(更新中)</title>
    <link href="http://example.com/2022/05/17/WorkManager%E7%9B%B8%E5%85%B3-%E6%9B%B4%E6%96%B0%E4%B8%AD/"/>
    <id>http://example.com/2022/05/17/WorkManager%E7%9B%B8%E5%85%B3-%E6%9B%B4%E6%96%B0%E4%B8%AD/</id>
    <published>2022-05-17T04:08:53.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><ul><li><p>WorkManager</p><ul><li>WorkManager可以自动维护后台任务的执行时机，执行顺序，执行状态。</li><li>执行时机：我们创建一个任务可以指定它在什么时机执行，比如立刻执行，还是必须要等到设备空闲的时候执行，还是要等到设备的充电量必须要满足的时候执行，还是必须在wifi下才能执行，还是设备必须在存储空间足够的情况下执行。</li><li>执行顺序：指任务在执行过程中，是允许有依赖的关系，比如a执行完成才能执行任务b，任务b完成才能执行任务c,允许他们之间有相互的依赖关系。</li><li>执行状态：指任务执行的每个状态都会回调给我们，比如队列任务执行中，取消，成功，失败，结束等等。</li></ul><p>相比于后台任务service,intentservice workmanager更加的轻量，更加的省电，理论上service能做的东西，workmaanager都能做。但是workmanager可以用于支持异步场景。</p></li><li><p>依赖添加</p><ul><li>implementation ‘androidx.work:work-runtime:2.2.0’</li></ul></li></ul><h2 id="使用WorkManager来构建任务"><a href="#使用WorkManager来构建任务" class="headerlink" title="使用WorkManager来构建任务"></a>使用WorkManager来构建任务</h2><p><img src="/../images/image-20220517121757299.png" alt="image-20220517121757299"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WorkContinuation left,right;</span><br><span class="line">left = workManager.beginWith(A).then(B);</span><br><span class="line">right = workManager.beginWith(C).then(D);</span><br><span class="line">WorkContinuatioin.combine(Arrays.asList(left,right)).then(E).Enqueue();</span><br></pre></td></tr></table></figure><ul><li>任务A执行完才能执行B</li><li>任务C执行完才能执行任务D</li><li>BD都执行完才能执行E</li></ul><p>之前使用service还要做线程间的同步，我们看workmanager怎么实现相同的效果？</p><ul><li>beginWith(A).then(B) 指任务A执行完，才执行任务B，beginWith就可以使得两个任务串行依赖</li><li>WorkContinuation left right 分别创建出左侧的任务队列，右侧的任务队列</li><li>WorkContinuation 就是可以支持任务之间相互的串联，相互的依赖的对象</li><li>combine后，调用Enqueu()加入任务队列</li></ul><h2 id="WorkManager（状态通知）"><a href="#WorkManager（状态通知）" class="headerlink" title="WorkManager（状态通知）"></a>WorkManager（状态通知）</h2><p><img src="/../images/image-20220517122315734.png" alt="image-20220517122315734"></p><h2 id="WorkManager（任务控制）"><a href="#WorkManager（任务控制）" class="headerlink" title="WorkManager（任务控制）"></a>WorkManager（任务控制）</h2><p><img src="/../images/image-20220517122359574.png" alt="image-20220517122359574"></p><p>UUID是我们创建work的时候返回的</p><p>我们创建任务的时候，可以给任务打上一组标签tag</p><h2 id="WorkManager-类关系"><a href="#WorkManager-类关系" class="headerlink" title="WorkManager(类关系)"></a>WorkManager(类关系)</h2><p><img src="/../images/image-20220517122546929.png" alt="image-20220517122546929"></p><p>OneTimeWorkRequest 一次性</p><p>PeriodicWorkRequest 定时执行任务 ，定时任务最小的周期是15分钟，所以保活就不行了</p><h2 id="WorkManager的使用"><a href="#WorkManager的使用" class="headerlink" title="WorkManager的使用"></a>WorkManager的使用</h2><p>1.创建任务 2.输入参数 3.创建workRequest 4.加入队列 5.监听结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.编写一个UploadFileWorker.class 继承自Worker</span></span><br><span class="line"><span class="comment">//2.创建输入参数</span></span><br><span class="line">Data inputData = <span class="keyword">new</span> Data.Builder()</span><br><span class="line">  .putString(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>)</span><br><span class="line">  .putBoolean(<span class="string">&quot;key1&quot;</span>,<span class="keyword">false</span>)</span><br><span class="line">  .putStringArray(<span class="string">&quot;key2&quot;</span>,<span class="keyword">new</span> String[]&#123;&#125;)</span><br><span class="line">  .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.创建workrequest  构建任务</span></span><br><span class="line">OneTimeWorkRequest request = <span class="keyword">new</span> OneTimeWorkRequest.Builder(UploadFileWorker.class)</span><br><span class="line">  <span class="comment">//传入参</span></span><br><span class="line">  .setInputData(inputData)</span><br><span class="line">  <span class="comment">//...其他许许多多约束</span></span><br><span class="line">  .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//4.加入队列</span></span><br><span class="line">WorkContinuation continuation = WorkManager.getInstance().beginWith(list).enqueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">//5.观察执行状态及结果</span></span><br><span class="line">continuation.getWorkInfosLiveData().observe(<span class="keyword">this</span>,<span class="keyword">new</span> Observer&lt;List&lt;WorkInfo&gt;&gt;()&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(List&lt;WorkInfo&gt; workInfos)</span></span>&#123;</span><br><span class="line">    <span class="comment">//监听任务执行的结果</span></span><br><span class="line">    <span class="comment">//所以我们在创建work的时候需要work的UUID,用于观察这里是哪个work执行完成了</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基本介绍&quot;&gt;&lt;a href=&quot;#基本介绍&quot; class=&quot;headerlink&quot; title=&quot;基本介绍&quot;&gt;&lt;/a&gt;基本介绍&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;WorkManager&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WorkManager可以自动维护后台任务的执行时机，执</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>MVVM及Databinding使用及原理解析</title>
    <link href="http://example.com/2022/05/16/MVVM%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <id>http://example.com/2022/05/16/MVVM%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</id>
    <published>2022-05-15T22:35:47.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是MVVM"><a href="#什么是MVVM" class="headerlink" title="什么是MVVM"></a>什么是MVVM</h2><ul><li>双向绑定。数据变更<code>UI</code>会自动刷新，<code>UI</code>变化了数据也会自动同步到最新的值</li><li>数据驱动UI：比如<code>User</code>中的字段，数据变化了，可以做到自动刷新UI。</li><li>UI同步数据：比如<code>EditText</code>、<code>CheckBox</code>、<code>ToggleButton</code>具有状态的<code>View</code>，当状态变化后，数据模型中与之关联的字段的值也会自动同步最新状态</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启databinding</span></span><br><span class="line">android&#123;</span><br><span class="line">dataBinding&#123;</span><br><span class="line">enable = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="传统的MVVM"><a href="#传统的MVVM" class="headerlink" title="传统的MVVM"></a>传统的MVVM</h3><p><img src="/../images/image-20220516064045932.png" alt="image-20220516064045932"></p><ul><li><p>此时<code>view</code>层的定义比较广泛，可以指<code>Activity/Fragment/xml</code>实例化出来的<code>view</code>对象或者自定义<code>view</code>对象</p></li><li><p><code>VM</code>就是这里的<code>viewmodel</code>,但是这并不是<code>Jetpack</code>组件里的<code>viewmodel</code>,18年，<code>livedata</code>和<code>viewmodel</code>没有出来前，这里的<code>viewmodel</code>只是一个普通的类，用于从<code>model</code>中获取数据，从<code>Model</code>中获取数据成功后会通过<code>callback</code>回传给<code>viewmodel</code>，而<code>viewmodel</code>中的数据更新后，并不是通过<code>view</code>接口(区别于<code>MVP</code>)回传给<code>view</code>更新的，而是通过<code>Databinding</code>，利用它观察者的特性，实现<code>UI</code>的更新</p></li></ul><p>定义<code>ViewModel</code>用于处理数据相关的业务逻辑。并通过<code>ObserverableField</code> 观察者把结果回传出去</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ObservableField&lt;User&gt; userField = <span class="keyword">new</span> ObservableField&lt;&gt;();</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryUserInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.nickName = <span class="string">&quot;nickName&quot;</span>;</span><br><span class="line">        user.address = <span class="string">&quot;address&quot;</span>;</span><br><span class="line">        <span class="comment">//自动通知与之关联的观察者</span></span><br><span class="line">        userField.set(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><blockquote><p>注意一定要给<code>userField.set(user)</code> 把对象set给<code>userField</code> 这步不调用，是无法从<code>userField</code>中取数据的，会报NPE</p></blockquote><p>基于<code>DataBinding</code>在xml中进行数据绑定，可以实现数据&amp;UI双向绑定&#x3D;&gt;数据变更ui自动刷新，UI变动自动同步数据</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;viewModel&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.steve.mvvmdemo.test.HomeViewModel&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--单向绑定@--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/nick_name&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.userField.nickName&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--双向绑定@=--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/edit_address&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@=&#123;viewModel.userField.address&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>只要<code>userField</code>中的<code>nickName</code>发生变化，UI会刷新，这是单向的</p><p>编写完<code>xml</code>后<code>rebuild</code>一个项目</p><p><code>Activity</code>控制数据的获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> <span class="meta">@org</span>.jetbrains.annotations.Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      </span><br><span class="line">        ActivityHomeBinding binding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_home);</span><br><span class="line"></span><br><span class="line">        HomeViewModel vm = <span class="keyword">new</span> HomeViewModel();</span><br><span class="line">        binding.setViewModel(vm);</span><br><span class="line">      </span><br><span class="line">      model.queryUserInfo();</span><br><span class="line"></span><br><span class="line">        binding.editAddress.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">              <span class="comment">//当输入框文本变更后，userField的address数据会自动更新，变成输入框输入的内容</span></span><br><span class="line">                Log.e(<span class="string">&quot;zzl&quot;</span>,<span class="string">&quot;after:&quot;</span> + vm.userField.get().address);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>通过<code>DataBindingUtil.setContentView</code>完成<code>Activity</code>和xml布局文件的绑定工作，返回一个<code>Databinding</code>对象，这个<code>databinding</code>对象是根据xml的名称在编译阶段生成的，我们可以直接拿来使用。</li><li>把vm通过<code>setViewModel</code>设置给<code>databinding</code></li><li>然后在<code>Activity</code>中调用 <code>model.queryUserInfo()</code>去获取数据，可能是网络上的数据，然后<code>activity</code>就不管数据获取后UI的更新了</li></ul><p>这就是传统的MVVM，它着重利用了<code>Databinding</code>的能力，大部分的数据都是在xml中进行绑定，当然也会根据场景，具体问题具体分析。如果需要用户交互复杂的逻辑控制，可能还是需要在<code>activity</code>中进行控制更为方便。</p><p>但是这种写法已经过时了，后面出现了<code>Jetpack</code>，在<code>Jetpack</code>模式下，我们通常会利用<code>VieModel + LiveData</code>的组件结合。</p><p>这样做的目的是既能保证数据不会无缘无故丢失，还能<strong>自动关联宿主的生命周期</strong>，避免空指针的问题。<code>Activity</code>，<code>Fragment UI</code>逻辑和用户交互控制就可以了。数据的绑定可以交给<code>Databindging</code></p><h3 id="Jetpack-Viewmodel-livedata使用"><a href="#Jetpack-Viewmodel-livedata使用" class="headerlink" title="Jetpack Viewmodel + livedata使用"></a>Jetpack Viewmodel + livedata使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LiveData <span class="title">getUserInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        MutableLiveData&lt;User&gt; liveData = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.nickName = <span class="string">&quot;zzl&quot;</span>;</span><br><span class="line">        user.address = <span class="string">&quot;changchun&quot;</span>;</span><br><span class="line"></span><br><span class="line">        liveData.postValue(user);</span><br><span class="line">        <span class="keyword">return</span> liveData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><ul><li>注意这里既不是使用观察者<code>ObservableField</code>包裹对象，也不是使用<code>view</code>的接口回调<code>callback</code>去回传数据，而是使用了<code>livedata</code>，通过<code>liveData.postValue(user)</code>并返回<code>liveData</code>，去通知观察者</li></ul><p>下面看下xml文件的变化</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;user&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.steve.mvvmdemo.test.User&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--单向绑定@--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/nick_name&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;user.nickName&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--双向绑定@=--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/edit_address&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@=&#123;user.address&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>这里注意绑定的对象不再是<code>viewmodel</code>而直接是<code>user</code>对象</li><li>直接使用<code>user.nickName</code>  <code>user.address</code>访问对象的值</li></ul><p>看下<code>Activity</code>里的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeActivity3</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> <span class="meta">@org</span>.jetbrains.annotations.Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ActivityHome2Binding binding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_home2);</span><br><span class="line">        ViewModelProvider provider = <span class="keyword">new</span> ViewModelProvider(<span class="keyword">this</span>,<span class="keyword">new</span> ViewModelProvider.NewInstanceFactory());</span><br><span class="line">        HomeViewModel vm = provider.get(HomeViewModel.class);</span><br><span class="line"></span><br><span class="line">        vm.getUserInfo().observe(<span class="keyword">this</span>, (Observer&lt;User&gt;) user -&gt; &#123;</span><br><span class="line">            binding.setUser(user);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Jetpack里的api使用会有一点点不同</p><ul><li><code>DataBindingUtil.setContentView</code>把xml和<code>activity</code>进行绑定，生成<code>databinding</code></li><li>通过<code>ViewModelProvider</code>获取具体的<code>HomeViewModel</code>对象</li><li>通过vm获取发送数据的<code>liveData</code>，注册观察者，在回调里进行<code>binding.setUser(user);</code>绑定</li></ul><h2 id="DataBinding的高频用法及注意事项"><a href="#DataBinding的高频用法及注意事项" class="headerlink" title="DataBinding的高频用法及注意事项"></a>DataBinding的高频用法及注意事项</h2><h3 id="什么是dataBinding"><a href="#什么是dataBinding" class="headerlink" title="什么是dataBinding?"></a>什么是dataBinding?</h3><ul><li>可以理解为<code>dataBinding</code>只是一种工具，它解决了view和数据之间的双向绑定</li></ul><h3 id="dataBinding的优势？"><a href="#dataBinding的优势？" class="headerlink" title="dataBinding的优势？"></a>dataBinding的优势？</h3><ul><li>双向数据绑定 数据发生改变后，自动通知刷新UI页面，不再需要人工绑定最新数据到view上。UI改变后也能同步给数据。</li><li>减少模板代码 有了dataBinding，从此不用再写<code>findViewById</code>,<code>setOnClickListener</code>等枯燥生硬的代码，大大提高工作效率。从此<code>Butterknife</code>靠边站。</li><li>释放<code>Activitty/Fragment</code>压力 我们可以直接在xml布局文件中完成数据，事件绑定工作。<code>Activity</code>,<code>Fragment</code>让它更加只关注核心业务。</li><li>数据绑定空安全 在xml中绑定数据它是空安全的，因为<code>dataBinding</code>在数据绑定上会自动装箱和空判断，所以大大减少了数据绑定带来的<code>NPE</code>问题</li></ul><h3 id="dataBinding如何使用？"><a href="#dataBinding如何使用？" class="headerlink" title="dataBinding如何使用？"></a>dataBinding如何使用？</h3><ul><li>在布局文件中，选中根布局的标签，按住 <code>alt + 回车</code> ，点击<code>convert to data binding layout</code> 即可转换成<code>dataBinding</code>布局。</li><li>转换后的布局，最外层变成了<code>layout</code>标签，里面包裹了<code>data</code>标签和常规的布局元素。data元素用来声明在此布局使用到的变量和变量类型，以及类引用。最不是所有的属性都能用<code>dataBinding</code>来绑定呢？当然不是！如果一个属性<code>xxx</code>，在该类中有<code>setXXX</code>方法，我们才能使用<code>dataBinding</code>来绑定。比如<code>android:layout_width</code>，<code>android_height</code>就不能使用<code>dataBinding</code>来绑定值，而<code>android:paddingLeft</code>，<code>android:textSize</code>都是可以的。</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;user&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.steve.mvvmdemo.test.User&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;com.steve.mvvmdemo.test.UserManager&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">import</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/tvName&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;200dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>  //不能使用<span class="attr">dataBinding</span>动态绑定</span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;user.name&#125;&quot;</span> //单向绑定数据变更自动通知<span class="attr">UI</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">&quot;@&#123;@dimen/16sp&#125;&quot;</span> //资源引用</span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;user.nickName + @string/suffix&#125;&quot;</span> //字符串拼接需要引用资源</span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;UserManager.getUserName()&#125;&quot;</span> //调用静态方法，类必须先导入</span></span><br><span class="line"><span class="tag">            <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;()-&gt;UserManager.login()&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>android:text=&quot;@&#123;user.name&#125;&quot;</code>等价于<code>tvName.text = user.name</code>这样就将数据和<code>view</code>相关联了。那么如何实现<code>view</code>和数据的双向绑定呢？我们除了上面提到的让<code>ObservableField</code>持有外，还可以让实体类<code>User</code>继承<code>BaseObservable</code>。当user中字段发生变更，只需要调用<code>user.notifyPropertyChanged</code>就可以让<code>UI刷新</code>。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseObservable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当使用name字段发生变更后，若想UI自动刷新，我们需要给它写个get方法并且标记为Bindable注解</span></span><br><span class="line">    <span class="comment">//最后调用 notifyPropertyChanged方法即可</span></span><br><span class="line">    <span class="meta">@Bindable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        notifyPropertyChanged(BR.user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>dataBinding</code> 也支持在布局文件中使用<code>数组、List、Set和Map</code>，且在布局文件中都可以通过<code>list[index]</code>的形式来获取元素，因为xml的特性，在声明<code>List&lt;String&gt;</code>之类的类型时，需要使用尖括号的<code>转义字符</code>，如下</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;java.util.List&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;java.util.Set&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;java.util.Map&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">&quot;android.util.SparseArray&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;array&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;String[]&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--List&lt;String&gt; 需要转义--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;list&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;List<span class="symbol">&amp;lt;</span>String<span class="symbol">&amp;gt;</span>&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Map&lt;String&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;map&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;Map<span class="symbol">&amp;lt;</span>String,String<span class="symbol">&amp;gt;</span>&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Set&lt;Strin&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;set&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;Set<span class="symbol">&amp;lt;</span>String<span class="symbol">&amp;gt;</span>&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SparseArray&lt;String&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;sparse&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;SparseArray<span class="symbol">&amp;lt;</span>String<span class="symbol">&amp;gt;</span>&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;index&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;key&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;String&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;array[1]&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;sparse[index]&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;list[index]&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;map[key]&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&#x27;@&#123;map[&quot;移动端架构师&quot;]&#125;&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&#x27;@&#123;set.contains(&quot;xxx&quot;)?&quot;移动端架构师&quot;:key&#125;&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>dataBinding</code>在xml中数据绑定支持的语法表达式也是非常丰富的，支持在布局文件中使用以下运算符、表达式和关键字</li></ul><p><img src="/../images/image-20220516091030481.png" alt="image-20220516091030481"></p><p><img src="/../images/image-20220516091050642.png" alt="image-20220516091050642"></p><ul><li>dataBinding 拓展view属性</li></ul><p>我们知道，以前想要给ImageView增加几个属性，必须要写个自定义的ImageView在构造函数中一顿解析。那看看使用dataBinding如何拓展view属性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiImageView</span> <span class="keyword">extends</span> <span class="title">ImageView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BindingAdapter(value = &#123;&quot;image_url&quot;,&quot;isCircle&quot;,&quot;radius&quot;&#125;,requireAll = false)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImageUrl</span><span class="params">(ImageView view,String imageUrl,<span class="keyword">boolean</span> isCircle,<span class="keyword">int</span> radius)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>需要定义成<code>public static</code> 使用<code>BindingAdapter</code>注解并标记</li><li><code>value</code>中的字段随意添加和方法参数一一对应即可。</li><li>requirAll &#x3D; false代表是否以下三个属性在xml中同时使用才会调用该方法，为<code>flase</code>的话，只要有一个属性被使用就能调用到该方法</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.steve.mvvmdemo.jetpackmvvm.HiImageView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:image_url</span>=<span class="string">&quot;@&#123;user.avatar&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:radius</span>=<span class="string">&quot;@&#123;50&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在布局文件中如下使用，便能实现图片圆角和资源url绑定的功能</li></ul><h3 id="dataBinding使用建议"><a href="#dataBinding使用建议" class="headerlink" title="dataBinding使用建议"></a>dataBinding使用建议</h3><ul><li>不建议在列表中乱用，因为dataBinding数据绑定是延迟一帧的，如果列表中的ItemView的宽高需要计算后才能正确展示，或者显隐控制，不建议使用databinding操作，否则会看到列表itemview有可能撑开的动画，体验不好。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">requestRebind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContainingBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mContainingBinding.requestRebind();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> LifecycleOwner owner = <span class="keyword">this</span>.mLifecycleOwner;</span><br><span class="line">        <span class="keyword">if</span> (owner != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Lifecycle.State state = owner.getLifecycle().getCurrentState();</span><br><span class="line">            <span class="keyword">if</span> (!state.isAtLeast(Lifecycle.State.STARTED)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// wait until lifecycle owner is started</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingRebind) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingRebind = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//这里下一次屏幕绘制才会进行绑定</span></span><br><span class="line">        <span class="keyword">if</span> (USE_CHOREOGRAPHER) &#123;</span><br><span class="line">            mChoreographer.postFrameCallback(mFrameCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mUIThreadHandler.post(mRebindRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>SDK_INT&gt;&#x3D;16 都会执行这里，在下一次绘制时，才会重新绑定数据</p></blockquote><ul><li>如fragment_layout_my.xml布局，在编译时会生成FragmentLayoutMyImpl.class我们可以搜索这种类debug跟进解决问题。</li></ul><p>build&#x2F;intermediates&#x2F;javac&#x2F;debug&#x2F;clasees&#x2F;org&#x2F;…&#x2F;databinding&#x2F;FragmentLayoutMyImpl.class</p><h2 id="dataBinding与ViewBinding的区别"><a href="#dataBinding与ViewBinding的区别" class="headerlink" title="dataBinding与ViewBinding的区别"></a>dataBinding与ViewBinding的区别</h2><ul><li>viewbinding可以看做是一个databinding的一部分功能 最主要的表现就是可以通过绑定后不用findviewbyid了，但不能进行双向绑定</li><li>相对来说databinding的功能更强大一些，不只是可以直接获取控件对象，并且可以通过数据绑定的形式实时更新页面UI</li><li>从编译效率来讲viewBinding的效率更快一些，databinding的效率要慢一些</li><li>viewbinding优点也是明显的不需要对原有的xml文件进行侵入</li></ul><h2 id="DataBinding原理与编译时绑定布局对象"><a href="#DataBinding原理与编译时绑定布局对象" class="headerlink" title="DataBinding原理与编译时绑定布局对象"></a>DataBinding原理与编译时绑定布局对象</h2><p><img src="/../images/image-20220516120558811.png" alt="image-20220516120558811"></p><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><ul><li>1.通过源码我们要知道<code>databinding</code>如何实现<code>M-V V-M</code>的<code>双向刷新机制</code></li><li>2.<code>databinding</code>内存开销过大的原因是什么？</li></ul><p>1.<code>rebuild</code>后，生成两个<code>xml</code>文件</p><p><img src="/../images/image-20220516122044224.png" alt="image-20220516122044224"></p><p>这两个xml文件分别有各自的用处 <code>xxx-layout</code> 用于Databinding处理，正常的xml文件中也会有tag</p><p><code>activity_home-layout.xml</code>文件的路径是</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app<span class="regexp">/build/i</span>ntermediates<span class="regexp">/data_binding_layout_info_type_merge/</span>debug<span class="regexp">/out/</span>activity_home-layout.xml</span><br></pre></td></tr></table></figure><p><code>activity_home.xml</code>文件的路径是</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app<span class="regexp">/build/i</span>ntermediates<span class="regexp">/incremental/m</span>ergeDebugResources<span class="regexp">/stripped.dir/</span>layout/activity_home.xml</span><br></pre></td></tr></table></figure><p>我们看下<code>acitivty_home-layout.xml</code>文件的内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Layout</span> <span class="attr">directory</span>=<span class="string">&quot;layout&quot;</span> <span class="attr">filePath</span>=<span class="string">&quot;app/src/main/res/layout/activity_home.xml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">isBindingData</span>=<span class="string">&quot;true&quot;</span> <span class="attr">isMerge</span>=<span class="string">&quot;false&quot;</span> <span class="attr">layout</span>=<span class="string">&quot;activity_home&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">modulePackage</span>=<span class="string">&quot;com.steve.mvvmdemo&quot;</span> <span class="attr">rootNodeType</span>=<span class="string">&quot;android.widget.LinearLayout&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Targets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Target</span> <span class="attr">tag</span>=<span class="string">&quot;layout/activity_home_0&quot;</span> <span class="attr">view</span>=<span class="string">&quot;LinearLayout&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Expressions</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">location</span> <span class="attr">endLine</span>=<span class="string">&quot;30&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;18&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;10&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;4&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Target</span> <span class="attr">id</span>=<span class="string">&quot;@+id/nick_name&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;binding_1&quot;</span> <span class="attr">view</span>=<span class="string">&quot;TextView&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Expressions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Expression</span> <span class="attr">attribute</span>=<span class="string">&quot;android:text&quot;</span> <span class="attr">text</span>=<span class="string">&quot;viewModel.userField.nickName&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Location</span> <span class="attr">endLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;57&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;12&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">TwoWay</span>&gt;</span>false<span class="tag">&lt;/<span class="name">TwoWay</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ValueLocation</span> <span class="attr">endLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;55&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;28&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Expression</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Expressions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">location</span> <span class="attr">endLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;59&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;16&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Target</span> <span class="attr">id</span>=<span class="string">&quot;@+id/edit_address&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;binding_2&quot;</span> <span class="attr">view</span>=<span class="string">&quot;EditText&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Expressions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Expression</span> <span class="attr">attribute</span>=<span class="string">&quot;android:text&quot;</span> <span class="attr">text</span>=<span class="string">&quot;viewModel.userField.address&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Location</span> <span class="attr">endLine</span>=<span class="string">&quot;27&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;57&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;27&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;12&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">TwoWay</span>&gt;</span>true<span class="tag">&lt;/<span class="name">TwoWay</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ValueLocation</span> <span class="attr">endLine</span>=<span class="string">&quot;27&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;55&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;27&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;29&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Expression</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Expressions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">location</span> <span class="attr">endLine</span>=<span class="string">&quot;28&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;13&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;23&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Targets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Variables</span> <span class="attr">name</span>=<span class="string">&quot;viewModel&quot;</span> <span class="attr">declared</span>=<span class="string">&quot;true&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.steve.mvvmdemo.test.HomeViewModel&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span> <span class="attr">endLine</span>=<span class="string">&quot;6&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;58&quot;</span> <span class="attr">startLine</span>=<span class="string">&quot;4&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Variables</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Layout</span>&gt;</span></span><br></pre></td></tr></table></figure><p>再看下<code>activity_home.xml</code>文件的内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line">                                                                   </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">                 </span><br><span class="line">                            </span><br><span class="line">                                                           </span><br><span class="line"></span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span> <span class="attr">android:tag</span>=<span class="string">&quot;layout/activity_home_0&quot;</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--单向绑定@--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/nick_name&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:tag</span>=<span class="string">&quot;binding_1&quot;</span>                       /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--双向绑定@=--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/edit_address&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:tag</span>=<span class="string">&quot;binding_2&quot;</span>                       </span></span><br><span class="line"><span class="tag">            /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line">         </span><br></pre></td></tr></table></figure><ul><li>它会把<code>layout</code>标签去掉，然后在每个标签下打上<code>tag</code></li></ul><p><code>rebuild</code>后发生了啥</p><p><img src="/../images/image-20220516122508848.png" alt="image-20220516122508848"></p><p>2.从<code>setContentView</code>开始看源码</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.必须先ReBuilder 2.书写代码绑定</span></span><br><span class="line"><span class="keyword">val</span> contentView = DataBindingUtil.setContentView&lt;ActivityLoginBinding&gt;(<span class="keyword">this</span>, R.layout.activity_login)</span><br></pre></td></tr></table></figure><p><code>Databinding</code>为什么还要去<code>setContentView</code></p><p><img src="file://../images/image-20220516122354494.png?lastModify=1652754461" alt="image-20220516122354494"></p><p>因为需要<code>activity</code>去获取根布局<code>root</code> 这样<code>binding</code>才能去更改布局刷新</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">setContentView</span><span class="params">(<span class="meta">@NonNull</span> Activity activity,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> layoutId, <span class="meta">@Nullable</span> DataBindingComponent bindingComponent)</span> </span>&#123;</span><br><span class="line">    activity.setContentView(layoutId);</span><br><span class="line">    View decorView = activity.getWindow().getDecorView();</span><br><span class="line">    ViewGroup contentView = (ViewGroup) decorView.findViewById(android.R.id.content);</span><br><span class="line">    <span class="keyword">return</span> bindToAddedViews(bindingComponent, contentView, <span class="number">0</span>, layoutId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>activity.getWindow().getDecorView()</code> 获取根布局<code>view</code> 由<code>decorView</code> 获取<code>contentView</code> 然后发生<code>bind</code>绑定，执行<code>bindToAddedViews</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">bindToAddedViews</span><span class="params">(DataBindingComponent component,</span></span></span><br><span class="line"><span class="params"><span class="function">        ViewGroup parent, <span class="keyword">int</span> startChildren, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endChildren = parent.getChildCount();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childrenAdded = endChildren - startChildren;</span><br><span class="line">    <span class="keyword">if</span> (childrenAdded == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> View childView = parent.getChildAt(endChildren - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> bind(component, childView, layoutId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> View[] children = <span class="keyword">new</span> View[childrenAdded];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenAdded; i++) &#123;</span><br><span class="line">            children[i] = parent.getChildAt(i + startChildren);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bind(component, children, layoutId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>所有的<code>view</code>子<code>view</code>都会执行<code>bind</code>函数</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">bind</span><span class="params">(DataBindingComponent bindingComponent, View[] roots,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) sMapper.getDataBinder(bindingComponent, roots, layoutId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getDataBinder</code> 是一个抽象方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinderMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent bindingComponent, View view,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> layoutId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent bindingComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">            View[] view, <span class="keyword">int</span> layoutId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看它具体的实现类<code>DataBinderMapperImpl</code> 注意要找自己包名下的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinderMapperImpl</span> <span class="keyword">extends</span> <span class="title">DataBinderMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent component, View view, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> localizedLayoutId = INTERNAL_LAYOUT_ID_LOOKUP.get(layoutId);</span><br><span class="line">    <span class="keyword">if</span>(localizedLayoutId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> Object tag = view.getTag();</span><br><span class="line">      <span class="keyword">if</span>(tag == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;view must have a tag&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">switch</span>(localizedLayoutId) &#123;</span><br><span class="line">        <span class="keyword">case</span>  LAYOUT_ACTIVITYHOME: &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="string">&quot;layout/activity_home_0&quot;</span>.equals(tag)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ActivityHomeBindingImpl(component, view);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;The tag for activity_home is invalid. Received: &quot;</span> + tag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span>  LAYOUT_ACTIVITYLOGIN: &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="string">&quot;layout/activity_login_0&quot;</span>.equals(tag)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ActivityLoginBindingImpl(component, view);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;The tag for activity_login is invalid. Received: &quot;</span> + tag);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>之前说把所有的<code>view</code>都打上了<code>tag</code> 这里通过获取<code>tag</code> 开始匹配不同的<code>bindingimpl</code>，<code>layout/activity_home_0</code> 和之前的<code>xml</code>中的<code>LineanerLayout</code>标签的<code>tag</code>对应上了，走<code>ActivityHomeBindingImpl</code>的构造方法的逻辑</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityHomeBindingImpl</span><span class="params">(<span class="meta">@Nullable</span> androidx.databinding.DataBindingComponent bindingComponent, <span class="meta">@NonNull</span> View root)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(bindingComponent, root, mapBindings(bindingComponent, root, <span class="number">3</span>, sIncludes, sViewsWithIds));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ActivityHomeBindingImpl</span><span class="params">(androidx.databinding.DataBindingComponent bindingComponent, View root, Object[] bindings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(bindingComponent, root, <span class="number">1</span></span><br><span class="line">        , (android.widget.EditText) bindings[<span class="number">2</span>]</span><br><span class="line">        , (android.widget.TextView) bindings[<span class="number">1</span>]</span><br><span class="line">        );</span><br><span class="line">    <span class="keyword">this</span>.editAddress.setTag(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.mboundView0 = (android.widget.LinearLayout) bindings[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">this</span>.mboundView0.setTag(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.nickName.setTag(<span class="keyword">null</span>);</span><br><span class="line">    setRootTag(root);</span><br><span class="line">    <span class="comment">// listeners</span></span><br><span class="line">    invalidateAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>第一个内存占用过高的原因来了</code>，注意看</p></li><li><p><code>Object[]</code> 这个对象数组缓存了控件，这块内存是额外的，通过执行<code>mapBindings</code>方法传入，我们看<code>mapBindings</code>怎么填充的这个对象数组</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mapBindings</span><span class="params">(DataBindingComponent bindingComponent, View view,</span></span></span><br><span class="line"><span class="params"><span class="function">        Object[] bindings, IncludedLayouts includes, SparseIntArray viewsWithIds,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">boolean</span> isRoot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> indexInIncludes;</span><br><span class="line">    <span class="keyword">final</span> ViewDataBinding existingBinding = getBinding(view);</span><br><span class="line">    <span class="keyword">if</span> (existingBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Object objTag = view.getTag();</span><br><span class="line">    <span class="keyword">final</span> String tag = (objTag <span class="keyword">instanceof</span> String) ? (String) objTag : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isBound = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isRoot &amp;&amp; tag != <span class="keyword">null</span> &amp;&amp; tag.startsWith(<span class="string">&quot;layout&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> underscoreIndex = tag.lastIndexOf(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (underscoreIndex &gt; <span class="number">0</span> &amp;&amp; isNumeric(tag, underscoreIndex + <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> index = parseTagInt(tag, underscoreIndex + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (bindings[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bindings[index] = view;</span><br><span class="line">            &#125;</span><br><span class="line">            indexInIncludes = includes == <span class="keyword">null</span> ? -<span class="number">1</span> : index;</span><br><span class="line">            isBound = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            indexInIncludes = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag != <span class="keyword">null</span> &amp;&amp; tag.startsWith(BINDING_TAG_PREFIX)) &#123;</span><br><span class="line">        <span class="keyword">int</span> tagIndex = parseTagInt(tag, BINDING_NUMBER_START);</span><br><span class="line">        <span class="keyword">if</span> (bindings[tagIndex] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bindings[tagIndex] = view;</span><br><span class="line">        &#125;</span><br><span class="line">        isBound = <span class="keyword">true</span>;</span><br><span class="line">        indexInIncludes = includes == <span class="keyword">null</span> ? -<span class="number">1</span> : tagIndex;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Not a bound view</span></span><br><span class="line">        indexInIncludes = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isBound) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> id = view.getId();</span><br><span class="line">        <span class="keyword">if</span> (id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index;</span><br><span class="line">            <span class="keyword">if</span> (viewsWithIds != <span class="keyword">null</span> &amp;&amp; (index = viewsWithIds.get(id, -<span class="number">1</span>)) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    bindings[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bindings[index] = view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (view <span class="keyword">instanceof</span>  ViewGroup) &#123;</span><br><span class="line">        <span class="keyword">final</span> ViewGroup viewGroup = (ViewGroup) view;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = viewGroup.getChildCount();</span><br><span class="line">        <span class="keyword">int</span> minInclude = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> View child = viewGroup.getChildAt(i);</span><br><span class="line">            <span class="keyword">boolean</span> isInclude = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (indexInIncludes &gt;= <span class="number">0</span> &amp;&amp; child.getTag() <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                String childTag = (String) child.getTag();</span><br><span class="line">                <span class="keyword">if</span> (childTag.endsWith(<span class="string">&quot;_0&quot;</span>) &amp;&amp;</span><br><span class="line">                        childTag.startsWith(<span class="string">&quot;layout&quot;</span>) &amp;&amp; childTag.indexOf(<span class="string">&#x27;/&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// This *could* be an include. Test against the expected includes.</span></span><br><span class="line">                    <span class="keyword">int</span> includeIndex = findIncludeIndex(childTag, minInclude,</span><br><span class="line">                            includes, indexInIncludes);</span><br><span class="line">                    <span class="keyword">if</span> (includeIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        isInclude = <span class="keyword">true</span>;</span><br><span class="line">                        minInclude = includeIndex + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> index = includes.indexes[indexInIncludes][includeIndex];</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> layoutId = includes.layoutIds[indexInIncludes][includeIndex];</span><br><span class="line">                        <span class="keyword">int</span> lastMatchingIndex = findLastMatching(viewGroup, i);</span><br><span class="line">                        <span class="keyword">if</span> (lastMatchingIndex == i) &#123;</span><br><span class="line">                            bindings[index] = DataBindingUtil.bind(bindingComponent, child,</span><br><span class="line">                                    layoutId);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> includeCount =  lastMatchingIndex - i + <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">final</span> View[] included = <span class="keyword">new</span> View[includeCount];</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; includeCount; j++) &#123;</span><br><span class="line">                                included[j] = viewGroup.getChildAt(i + j);</span><br><span class="line">                            &#125;</span><br><span class="line">                            bindings[index] = DataBindingUtil.bind(bindingComponent, included,</span><br><span class="line">                                    layoutId);</span><br><span class="line">                            i += includeCount - <span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!isInclude) &#123;</span><br><span class="line">                mapBindings(bindingComponent, child, bindings, includes, viewsWithIds, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>对标签进行了解析，以<code>layout</code>开头的，以<code>binding</code>开头的 把<code>view</code>填充到<code>object[]</code>数组里</p></li><li><p>这样内存中就了<code>textview</code> <code>edittext</code>的副本，这是内存的额外开销</p></li></ul><p><code>这是第一个为什么内存大的原因</code></p><p><strong>我们来看看M-V V-M更新的机制</strong></p><p><code>ActivityHomeBinding</code>继承自<code>ViewDataBinding</code> ，看下<code>ViewDataBinding</code>的<code>static</code>静态代码块初始都做了啥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (VERSION.SDK_INT &lt; VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        ROOT_REATTACHED_LISTENER = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ROOT_REATTACHED_LISTENER = <span class="keyword">new</span> OnAttachStateChangeListener() &#123;</span><br><span class="line">            <span class="meta">@TargetApi(VERSION_CODES.KITKAT)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewAttachedToWindow</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// execute the pending bindings.</span></span><br><span class="line">                <span class="keyword">final</span> ViewDataBinding binding = getBinding(v);</span><br><span class="line">                binding.mRebindRunnable.run();</span><br><span class="line">                v.removeOnAttachStateChangeListener(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewDetachedFromWindow</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一开始就注册了一个对view attachtowindow的监听</p><p><code>binding.mRebindRunnable</code>是个的Runnable</p><p>这是第二个为什么占内存的原因，因为每一个使用了<code>databinding</code>的界面都会生成一个这个<code>Runnable</code>，同时数据的双向绑定也是在这里完成的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable mRebindRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            mPendingRebind = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        processReferenceQueue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (VERSION.SDK_INT &gt;= VERSION_CODES.KITKAT) &#123;</span><br><span class="line">            <span class="comment">// Nested so that we don&#x27;t get a lint warning in IntelliJ</span></span><br><span class="line">            <span class="keyword">if</span> (!mRoot.isAttachedToWindow()) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t execute the pending bindings until the View</span></span><br><span class="line">                <span class="comment">// is attached again.</span></span><br><span class="line">                mRoot.removeOnAttachStateChangeListener(ROOT_REATTACHED_LISTENER);</span><br><span class="line">                mRoot.addOnAttachStateChangeListener(ROOT_REATTACHED_LISTENER);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        executePendingBindings();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>看下<code>executePendingBindings</code>最后会执行到<code>protected abstract void executeBindings()</code> 这是一个抽象类，我们看它在<code>ActivityHomeBindingImpl</code>的实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeBindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    <span class="comment">// batch finished</span></span><br><span class="line">    <span class="keyword">if</span> ((dirtyFlags &amp; <span class="number">0x7L</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// api target 1</span></span><br><span class="line"></span><br><span class="line">        androidx.databinding.adapters.TextViewBindingAdapter.setText(<span class="keyword">this</span>.editAddress, viewModelUserFieldAddress);</span><br><span class="line">        androidx.databinding.adapters.TextViewBindingAdapter.setText(<span class="keyword">this</span>.nickName, viewModelUserFieldNickName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((dirtyFlags &amp; <span class="number">0x4L</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// api target 1</span></span><br><span class="line"></span><br><span class="line">        androidx.databinding.adapters.TextViewBindingAdapter.setTextWatcher(<span class="keyword">this</span>.editAddress, (androidx.databinding.adapters.TextViewBindingAdapter.BeforeTextChanged)<span class="keyword">null</span>, (androidx.databinding.adapters.TextViewBindingAdapter.OnTextChanged)<span class="keyword">null</span>, (androidx.databinding.adapters.TextViewBindingAdapter.AfterTextChanged)<span class="keyword">null</span>, editAddressandroidTextAttrChanged);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>看到这里应该就明白了，<code>UI和data是怎么双向绑定的</code></li></ul><p>那么还有一个内存过大的原因，我们看<code>ActivityHomeBindingImpl</code>的构造中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ActivityHomeBindingImpl</span><span class="params">(androidx.databinding.DataBindingComponent bindingComponent, View root, Object[] bindings)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">// listeners</span></span><br><span class="line">    invalidateAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这个<code>invalidateAll</code>会执行<code>requestRebind</code>函数</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">requestRebind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContainingBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mContainingBinding.requestRebind();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> LifecycleOwner owner = <span class="keyword">this</span>.mLifecycleOwner;</span><br><span class="line">        <span class="keyword">if</span> (owner != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Lifecycle.State state = owner.getLifecycle().getCurrentState();</span><br><span class="line">            <span class="keyword">if</span> (!state.isAtLeast(Lifecycle.State.STARTED)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// wait until lifecycle owner is started</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingRebind) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingRebind = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (USE_CHOREOGRAPHER) &#123;</span><br><span class="line">            mChoreographer.postFrameCallback(mFrameCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mUIThreadHandler.post(mRebindRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后这里给主线程发送消息,这也是内存开销之一</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;什么是MVVM&quot;&gt;&lt;a href=&quot;#什么是MVVM&quot; class=&quot;headerlink&quot; title=&quot;什么是MVVM&quot;&gt;&lt;/a&gt;什么是MVVM&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;双向绑定。数据变更&lt;code&gt;UI&lt;/code&gt;会自动刷新，&lt;code&gt;UI&lt;/code</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>竟然如此简单，DataBinding 和 ViewBinding[转]</title>
    <link href="http://example.com/2022/05/16/%E7%AB%9F%E7%84%B6%E5%A6%82%E6%AD%A4%E7%AE%80%E5%8D%95%EF%BC%8CDataBinding-%E5%92%8C-ViewBinding-%E8%BD%AC/"/>
    <id>http://example.com/2022/05/16/%E7%AB%9F%E7%84%B6%E5%A6%82%E6%AD%A4%E7%AE%80%E5%8D%95%EF%BC%8CDataBinding-%E5%92%8C-ViewBinding-%E8%BD%AC/</id>
    <published>2022-05-15T20:27:52.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://juejin.cn/post/6913723416671420430">原文链接：竟然如此简单，DataBinding 和 ViewBinding</a></p><p>在之前的文章 <a href="https://juejin.cn/post/6905942568467759111">Kotlin 插件的落幕，ViewBinding 的崛起</a> 中介绍了 Google 为什么不建议在项目中使用  Kotlin 合成方法（Synthetic 视图）， Google 建议使用 ViewBinding 替换 Kotlin 合成方法，那么 ViewBinding 和 DataBinding 都有什么区别。</p><p><strong>ViewBinding：</strong></p><ul><li>仅仅支持绑定 View</li><li>不需要在布局文件中添加 layout 标签</li><li>需要在模块级 <code>build.gradle</code> 文件中添加 <code>viewBinding = true</code> 即可使用</li><li>效率高于 DataBinding，因为避免了与数据绑定相关的开销和性能问题</li><li>相比于 <code>kotlin-android-extensions</code> 插件避免了空异常</li></ul><p><strong>DataBinding：</strong></p><ul><li>包含了 ViewBinding 所有的功能</li><li>需要在模块级 <code>build.gradle</code> 文件内添加 <code>dataBinding = true</code> 并且需要在布局文件中添加 layout 标签才可以使用</li><li>支持 data 和 view 双向绑定</li><li>效率低于 ViewBinding，因为注释处理器会影响数据绑定的构建时间。</li></ul><p>ViewBinding 可以实现的， DataBinding 都可以实现，但是 DataBinding 的性能低于 ViewBinding，DataBinding 和 ViewBinding 会为每个 XML 文件生成绑定类。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">R</span>.</span></span>layout.activity_main -&gt; ActivityMainBinding</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">R</span>.</span></span>layout.fragment_main -&gt; FragmentMainBinding</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">R</span>.</span></span>layout.dialog_app -&gt; DialogAppBinding</span><br></pre></td></tr></table></figure><p>在 <a href="https://juejin.cn/post/6905942568467759111">Kotlin 插件的落幕，ViewBinding 的崛起</a> 文章中同时也分析了 Kotlin 合成方法所带来的问题。即使 Kotlin 合成方法有很多问题，但是还有小伙伴愿意使用。</p><p>ViewBinding 和 DataBinding 为我们解决了这么多问题，但是为什么很多小伙伴们不愿意使用 ViewBinding 和 DataBinding，今天我们从使用的角度来分析。</p><h2 id="ViewBinding-和-DataBinding"><a href="#ViewBinding-和-DataBinding" class="headerlink" title="ViewBinding 和 DataBinding"></a>ViewBinding 和 DataBinding</h2><p>我大概汇总了 ViewBinding 和 DataBinding 在不同场景的所有用法，我们来看一下在项目中如何使用。</p><p><strong>基本配置</strong></p><p>从 <code>Android Studio 3.6</code> 版本开始，就内置在 Gradle 插件中了，不需要添加任何额外的库来使用它们，但是在 <code>Android Studio 3.6</code> 和 <code>Android Studio 4.0</code> 中使用方式不一样。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Android Studio 3.6</span></span><br><span class="line">android &#123;</span><br><span class="line">    viewBinding &#123;</span><br><span class="line">        enabled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    dataBinding&#123;</span><br><span class="line">        enabled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android Studio 4.0</span></span><br><span class="line">android &#123;</span><br><span class="line">    buildFeatures &#123;</span><br><span class="line">        dataBinding = <span class="literal">true</span></span><br><span class="line">        viewBinding = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ViewBinding-的使用"><a href="#ViewBinding-的使用" class="headerlink" title="ViewBinding 的使用"></a>ViewBinding 的使用</h3><p>因为涉及到的场景比较多，为了减少篇幅，我只列出来核心部分，如果之前从来没有用过，这里只需要知道 ViewBinding 的门槛比 Kotlin 合成方法要高即可。</p><p><strong>不想为某个布局生成 binding 类，将下面属性添加到布局文件的根视图中</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">tools:viewBindingIgnore</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>在 Activity 中使用</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    <span class="keyword">val</span> binding: ActivityMainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">    setContentView(binding.root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>在 Fragment 中使用</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?, savedInstanceState: <span class="type">Bundle</span>?)</span></span>: View &#123;</span><br><span class="line">    <span class="keyword">val</span> binding = FragmentViewBindBinding.inflate(inflater,container,<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">return</span> binding.root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在 Adapter 中的使用</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: RecyclerView.ViewHolder &#123;</span><br><span class="line">    RecycleItemProductBinding.inflate(LayoutInflater.from(parent.context), parent, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在 Dialog 中使用</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    binding = DialogAppBinding.inflate(layoutInflater)</span><br><span class="line">    setContentView(binding.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>include 标签的使用</strong></p><p><code>include</code> 标签不带 <code>merge</code> 标签，需要给 <code>include</code> 标签添加 id, 直接使用 id 即可，用法如下所示。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">include</span></span><br><span class="line">    android:id=<span class="string">&quot;@+id/include&quot;</span></span><br><span class="line">    layout=<span class="string">&quot;@layout/layout_include_item&quot;</span> /&gt;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">val</span> binding: ActivityMainBinding = <span class="module-access"><span class="module"><span class="identifier">ActivityMainBinding</span>.</span></span>inflate(layoutInflater)</span><br><span class="line">binding.<span class="keyword">include</span>.includeTvTitle.set<span class="constructor">Text(<span class="string">&quot;使用 include 布局中的控件, 不包含 merge&quot;</span>)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>作者：DHL<br>链接：<a href="https://juejin.cn/post/6913723416671420430">https://juejin.cn/post/6913723416671420430</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p>作者：DHL<br>链接：<a href="https://juejin.cn/post/6913723416671420430">https://juejin.cn/post/6913723416671420430</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p>作者：DHL<br>链接：<a href="https://juejin.cn/post/6913723416671420430">https://juejin.cn/post/6913723416671420430</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://juejin.cn/post/6913723416671420430&quot;&gt;原文链接：竟然如此简单，DataBinding 和 ViewBinding&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在之前的文章 &lt;a href=&quot;https://juejin.cn/p</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Jetpack系列—Lifecycle构架组件原理解析(更新中)</title>
    <link href="http://example.com/2022/05/14/Jetpack%E7%B3%BB%E5%88%97%E2%80%94Lifecycle%E6%9E%84%E6%9E%B6%E7%BB%84%E4%BB%B6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <id>http://example.com/2022/05/14/Jetpack%E7%B3%BB%E5%88%97%E2%80%94Lifecycle%E6%9E%84%E6%9E%B6%E7%BB%84%E4%BB%B6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</id>
    <published>2022-05-14T03:14:51.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>什么是Lifecycle</li><li>如何使用Lifecycle观察宿主状态</li><li>Fragment是如何实现Lifecycle的</li><li>Activity是如何实现Lifecycle的</li><li>Lifecycle是如何分发宿主状态的</li></ul><h2 id="什么是Lifecycle"><a href="#什么是Lifecycle" class="headerlink" title="什么是Lifecycle"></a>什么是Lifecycle</h2><ul><li>具备宿主生命周期感知能力的组件。它能持有组件(如Activty或Fragment)生命周期状态的信息，并且允许其他观察者监听宿主的状态</li></ul><h2 id="Lifecycle怎么使用"><a href="#Lifecycle怎么使用" class="headerlink" title="Lifecycle怎么使用"></a>Lifecycle怎么使用</h2><h3 id="自定义LifecycleObserver观察者"><a href="#自定义LifecycleObserver观察者" class="headerlink" title="自定义LifecycleObserver观察者"></a>自定义LifecycleObserver观察者</h3><ul><li>这种写法是为了避免在Activity或者Fragment中去覆写大量的生命周期函数回调，如onCreate onStart等，可以在自己的生命周期回调里去写逻辑，避免宿主太乱</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.自定义的LifecycleObserver观察者，用注解声明每个方法观察的宿主的状态，想感知哪个，就在哪个上加注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocationObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//开启定位</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_STOP)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//停止定位</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2.注册观察者，观察宿主生命周期状态变化</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> <span class="meta">@org</span>.jetbrains.annotations.Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.注册观察者，观察宿主生命周期状态变化</span></span><br><span class="line">        getLifecycle().addObserver(<span class="keyword">new</span> LocationObserver());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Fragment和Activity是如何进行消息派发的？"><a href="#Fragment和Activity是如何进行消息派发的？" class="headerlink" title="Fragment和Activity是如何进行消息派发的？"></a>Fragment和Activity是如何进行消息派发的？</h2><h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><ol><li>实现LifecycleOwner接口，返回LifecycleRegistry</li><li>通过LifecycleRegistry在各生命周期进行派发</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">ComponentCallbacks</span>, <span class="title">OnCreateContextMenuListener</span>, <span class="title">LifecycleOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ViewModelStoreOwner</span>, <span class="title">HasDefaultViewModelProviderFactory</span>, <span class="title">SavedStateRegistryOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ActivityResultCaller</span> </span>&#123;</span><br><span class="line">          </span><br><span class="line">    LifecycleRegistry mLifecycleRegistry;</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">    &#125;</span><br><span class="line">          </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">performStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">        mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><ol><li>实现LifecycleOwner接口，实现getLifecycle方法，返回mLifecycleRegistry</li><li>并没有直接使用mLifecycleRegistry在各生命周期函数中进行派发，而是借助了一个透明的ReportFragment进行的</li><li>执行ReportFragment.injectIfNeededIn(this)，把自己挂载到Activity上</li><li>然后在对应的生命周期进行派出事件</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">androidx</span>.<span class="title">core</span>.<span class="title">app</span>.<span class="title">ComponentActivity</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">ContextAware</span>,</span></span><br><span class="line"><span class="class">        <span class="title">LifecycleOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ViewModelStoreOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">HasDefaultViewModelProviderFactory</span>,</span></span><br><span class="line"><span class="class">        <span class="title">SavedStateRegistryOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">OnBackPressedDispatcherOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ActivityResultRegistryOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ActivityResultCaller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">    &#125;</span><br><span class="line">          </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ReportFragment.injectIfNeededIn(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mContentLayoutId != <span class="number">0</span>) &#123;</span><br><span class="line">            setContentView(mContentLayoutId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Fragment</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//把自己添加到Activity上</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">            <span class="comment">// On API 29+, we can register for the correct Lifecycle callbacks directly</span></span><br><span class="line">            LifecycleCallbacks.registerIn(activity);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Prior to API 29 and to maintain compatibility with older versions of</span></span><br><span class="line">        <span class="comment">// ProcessLifecycleOwner (which may not be updated when lifecycle-runtime is updated and</span></span><br><span class="line">        <span class="comment">// need to support activities that don&#x27;t extend from FragmentActivity from support lib),</span></span><br><span class="line">        <span class="comment">// use a framework fragment to get the correct timing of Lifecycle events</span></span><br><span class="line">        android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">            <span class="comment">// Hopefully, we are the first to make a transaction.</span></span><br><span class="line">            manager.executePendingTransactions();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatchStart(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">29</span>) &#123;</span><br><span class="line">            <span class="comment">// Only dispatch events from ReportFragment on API levels prior</span></span><br><span class="line">            <span class="comment">// to API 29. On API 29+, this is handled by the ActivityLifecycleCallbacks</span></span><br><span class="line">            <span class="comment">// added in ReportFragment.injectIfNeededIn</span></span><br><span class="line">            dispatch(getActivity(), event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//真正派发的地方法 获取所在activity的LifecycleRegistry 这就是为什么ComponentActivity要实现LifecycleOnwer接口</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Activity activity, <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>为什么要这么做？</p><p>这是一种切面的方式，为了兼容不是继承AppcompactActivity的Activity,而是直接继承Activity这个类的，在LifecycleDispatcher这个类里，通过注册Ativity的生命周期回调，实现DispatchActivityCallback，然后在回调的onActivityCreated方法内执行ReportFragment.injectIfNeededIn(this); 这样每个继承自Activity的也同样可以进行生命周期事件的派发了</p></blockquote><h3 id="LifecycleOwner、Lifecycle、LifecycleRegistry的关系"><a href="#LifecycleOwner、Lifecycle、LifecycleRegistry的关系" class="headerlink" title="LifecycleOwner、Lifecycle、LifecycleRegistry的关系"></a>LifecycleOwner、Lifecycle、LifecycleRegistry的关系</h3><p><img src="/../images/image-20220514122303160.png" alt="image-20220514122303160"></p><h2 id="LifecycleRestry事件分发的源码"><a href="#LifecycleRestry事件分发的源码" class="headerlink" title="LifecycleRestry事件分发的源码"></a>LifecycleRestry事件分发的源码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleRegistry</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">        enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>);</span><br><span class="line">      <span class="comment">//宿主的状态，和宿主的生命周期不是一个概念</span></span><br><span class="line">      <span class="comment">//切换到后台后，会执行onPause()但是状态是started状态，因为State这个枚举中并没有Paused的状态，只到started状态后面是Resumed状态</span></span><br><span class="line">        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">        ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行addObserver方法的可能在onCreate在onStart在onResume都可以，只要不是在onDestroy，都把宿主状态初始为INTIALIZED状态</p><p>把initialState包装成ObserverWithState即为带有状态的观察者</p><p><strong>宿主的生命周期和宿主状态模型图</strong></p><ul><li><p>前进状态：执行onCreate方法变为CREATED状态，执行onStart方法后，变为STARTED状态，执行onResume方法后，变为RESUMED状态，这是前进状态</p></li><li><p>倒退状态：执行onPause方法后，由RESUMED状态倒退到STARTED状态，执行onSop方法后，由STARTED状态倒退到CREATED状态，这是倒退的状态</p></li></ul><p><img src="/../images/image-20220515112325695.png" alt="image-20220515112325695"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>);</span><br><span class="line">...</span><br><span class="line">    State targetState = calculateTargetState(observer);</span><br><span class="line">    mAddingObserverCounter++;</span><br><span class="line">    <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">        pushParentState(statefulObserver.mState);</span><br><span class="line">        <span class="keyword">final</span> Event event = Event.upFrom(statefulObserver.mState);</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;no event up from &quot;</span> + statefulObserver.mState);</span><br><span class="line">        &#125;</span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">        popParentState();</span><br><span class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">        targetState = calculateTargetState(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Event <span class="title">upFrom</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">    <span class="keyword">case</span> INITIALIZED:</span><br><span class="line">      <span class="keyword">return</span> ON_CREATE;</span><br><span class="line">    <span class="keyword">case</span> CREATED:</span><br><span class="line">      <span class="keyword">return</span> ON_START;</span><br><span class="line">    <span class="keyword">case</span> STARTED:</span><br><span class="line">      <span class="keyword">return</span> ON_RESUME;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">  State newState = event.getTargetState();</span><br><span class="line">  mState = min(mState, newState);</span><br><span class="line">  mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">  mState = newState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> State <span class="title">getTargetState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">    <span class="keyword">case</span> ON_STOP:</span><br><span class="line">      <span class="keyword">return</span> State.CREATED;</span><br><span class="line">    <span class="keyword">case</span> ON_START:</span><br><span class="line">    <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">      <span class="keyword">return</span> State.STARTED;</span><br><span class="line">    <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">      <span class="keyword">return</span> State.RESUMED;</span><br><span class="line">    <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">      <span class="keyword">return</span> State.DESTROYED;</span><br><span class="line">    <span class="keyword">case</span> ON_ANY:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="keyword">this</span> + <span class="string">&quot; has no target state&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个while循环很重要，这个循环会把宿主由初始状态INITIALIZED 前进到当前宿主应有的生命周期状态可能是STARTED也可能是RESUMED的</p><ol><li>先通过calculateTargetState(observer)拿到宿主的当前状态，比如宿主在onResume中注册的addObserver方法，那它当前<strong>应该</strong>的状态是RESUMED</li><li>通过比较当前状态和当前应该处于的状态statefulObserver.mState.compareTo(targetState)小于0代表状态还没有前进到，比如第一次状态肯定是INITIALIZED而宿主应该处于是RESUMED，所以执行while循环</li><li>final Event event &#x3D; Event.upFrom(statefulObserver.mState)由当前状态获取应该执行的生周期事件，得知要执行的事件是ON_CREATE</li><li>执行 statefulObserver.dispatchEvent(lifecycleOwner, event) </li><li>先由event.getTargetState() 事件获取newState，比如当前是ON_CREATE 得到CREATED</li><li>mState &#x3D; newState赋值当前状态为新的状态，这样再去while中比较</li></ol><p>这样就会把当前RESUMED之前的事件都派发给宿主，而不是在于它在哪里进行了注册，宿主会收到一个完整的生命周期事件，进行注册等操作</p><p><img src="/../images/image-20220515114041728.png" alt="image-20220515114041728"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;什么是Lifecycle&lt;/li&gt;
&lt;li&gt;如何使用Lifecycle观察宿主状态&lt;/li&gt;
&lt;li&gt;Fragment是如何实现Lifecycle的&lt;/li&gt;
&lt;li&gt;Activity是如何实现Lifecycle的&lt;/li&gt;
&lt;li&gt;Lifecycle是如何分发</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>聊聊WebSocket及OkHttp实现WebSocket</title>
    <link href="http://example.com/2022/05/13/%E8%81%8A%E8%81%8AWebSocket%E5%8F%8AOkHttp%E5%AE%9E%E7%8E%B0WebSocket/"/>
    <id>http://example.com/2022/05/13/%E8%81%8A%E8%81%8AWebSocket%E5%8F%8AOkHttp%E5%AE%9E%E7%8E%B0WebSocket/</id>
    <published>2022-05-13T10:43:51.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>OkHttp应该算是Android中使用最广泛的网络库了，我们通常会利用它来实现HTTP请求，但是实际上它还可以支持WebSocket，并且使用起来还非常的便捷。那本文就来聊聊，利用OkHttp实现WebSocket的一些细节，包括对WebSocket的介绍，以及在传输如何做鉴权、长连接保活及其原理。</p><h2 id="1-WebSocket"><a href="#1-WebSocket" class="headerlink" title="1.WebSocket"></a>1.WebSocket</h2><h3 id="1-1-为什么使用WebSocket"><a href="#1-1-为什么使用WebSocket" class="headerlink" title="1.1 为什么使用WebSocket?"></a>1.1 为什么使用WebSocket?</h3><p>我们做客户端开发时，接触最多的应用层网络协议，就是HTTP协议，而今天介绍的<code>WebSocket</code>，下层和<code>HTTP</code>一样也是基于<code>TCP</code>协议，这是一种轻量级网络通信协议，也属于应用层协议。</p><p><code>WebSocket</code>与<code>HTTP2</code> 一样，其实都是为了解决<code>HTTP1.1</code>的一些缺陷而诞生的，而<code>WebSocket</code>针对的就是<code>「请求-应答」</code>这种<code>「半双工」</code>的模式的通信缺陷。</p><p><code>「请求-应答」</code>是半双工的通信模式，数据的传输必须经过一次请求应答，这个完整的通信过程，通信的同一时刻数据只能在一个方向上传递。它最大的问题在于，HTTP是一种被动的模式，服务端必须等待客户端请求才可以返回数据，无法主动向客户端发送数据。</p><p>这也导致在<code>WebSocket</code>出现之前，一些对实时性有要求的服务，通常是基于轮询这种简单的模式来实现。轮询就是由客户端定时发起请求，如果服输端有需要传递的数据，可以借助这个请求去响应数据。</p><p>轮询的缺点也非常明显，大量空闲的时间，其实是在反复发送无效的请求，这显然是一种资源的损耗。</p><p>虽然在之后的<code>HTTP2</code> <code>HTTP3</code>中针对这种半双工的缺陷新增了<code>Stream</code> <code>Server</code> <code>Push</code>等特性，但是’请求-应答’依然是<code>HTTP</code>协议请要的通信方式。</p><p><code>WebSocket</code>协议是由<code>HTML5</code>规范定义的，原本是为了浏览器而设计的，可以避免同源的限制，浏览器可以与任意服务端通信，现代浏览器基本上都已经支持<code>WebSocket</code>。</p><p>虽然WebSocket原本是被定义在<code>HTML5</code>中，但它也适用于移动端，尽管移动端也可以直接通过<code>Socket</code>与服务端通信，但借助<code>WebSocket</code>，可以利用<code>80（HTTP）</code>或<code>443（HTTPS）</code>端口通信，有效的避免一些防火墙的拦截。</p><p><code>WebSocket</code>是真正意义上的<code>全双工模式</code>，也就我们俗称的<code>‘长连接’</code>。当完成握手连接后，客户端和服务端均可以主动的发起请求，回复响应，并且两边的传输都是相互独立的。</p><h3 id="1-2-WebSocket的特点"><a href="#1-2-WebSocket的特点" class="headerlink" title="1.2 WebSocket的特点"></a>1.2 WebSocket的特点</h3><p><code>WebSocket</code>的数据传输，是基于<code>TCP</code>协议，但是在传输之前，还有一个握手的过程，双方确认过眼神，才能够正式的传输数据。</p><p><code>WebSocket</code>的握手过程，符合其<code>‘Web’</code>的特性，是利用<code>HTTP</code>本身的<code>‘协议升级’</code>来实现。</p><p>在建立连接前，客户端还需要知道服务端的地址，WebSocket并没有另辟路径，而是沿用了HTTP的URL格式，但协议标识变成了<code>‘ws’</code>或者<code>‘wss’</code>，分别表示明文加密的<code>WebSocket</code>协议，这一点和<code>HTTP</code>和<code>HTTPS</code>的关系类似。</p><p>以下是一些WebSocket的URL例子：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws://cxmydev.com/some/path</span><br><span class="line">ws://cxmydev.com:8080/some/path</span><br><span class="line">wss://cxmydev.com:443?uid=xxx</span><br></pre></td></tr></table></figure><p>而在连接建立后，<code>WebSocket</code>采用二进制帧的形式传输数据，其中常用的包括用于数据传输的数据帧<code>MESSAGE</code>以及3个<code>控制帧</code>：</p><ul><li><code>PING</code>:主动保活的PING帧</li><li><code>PONG</code>：收到PING帧后回复</li><li><code>CLOSE</code>：主动关闭WebSocket连接</li></ul><p>小结下<code>WebSocket</code>特性：</p><ol><li><code>WebSocket</code>建立在TCP协议之上，对服务端友好。</li><li>默认端口采用80或443，握手阶段采用HTTP协议，不容易被防火墙屏蔽，能够通过各种HTTP代理服务器。</li><li>传输数据相比HTTP更轻量，少了HTTP HEADER，性能开销更小，通信更高效。</li><li>通过MESSAGE帧发送数据，可以发送文本或者二进制数据，如果数据过大，会被分为多个MESSAGE帧发送。</li><li>WebSocket沿用HTTP的URL，协议标识符’ws’或‘wss’</li></ol><h3 id="1-3-WebSocket原理"><a href="#1-3-WebSocket原理" class="headerlink" title="1.3 WebSocket原理"></a>1.3 WebSocket原理</h3><p><code>WebSocket</code>在<code>TCP</code>连接建立后，还要通过<code>Http</code>进行一次握手，也就是通过<code>Http</code>发送一条<code>GET请求</code>消息给服务器，告诉服务器我要建立<code>WebSocket连接</code>了，你准备好哦，具体做法就是在头部信息中添加相关参数。然后服务器响应我知道了，并且将连接协议改成<code>WebSocket</code>，开始建立长连接。</p><p>这里贴上请求头和响应头信息，从网上找了一张图：</p><p><img src="/../images/image-20220514062147256.png" alt="image-20220514062147256"></p><p>简单说明下参数：</p><ul><li>URL一般是以<code>ws</code>或者<code>wss</code>开头，<code>ws</code>对应<code>Websocket</code>协议，<code>wss</code>对应在<code>TLS</code>之上的<code>WebSocket</code>。类似于<code>Http</code>和<code>Https</code>的关系。</li><li>请求方法为GET方法。</li><li><code>Connection:Upgrade</code>，表示客户端要连接升级，不用Http协议。</li><li><code>Upgrade:websocket</code>， 表示客户端要升级建立<code>Websocket</code>连接。</li><li><code>Sec-Websocket-Key:key</code>， 这个key是随机生成的，服务器会通过这个参数验证该请求是否有效。</li><li><code>Sec-WebSocket-Version:13</code>， websocket使用的版本，一般就是13。</li><li><code>Sec-webSocket-Extension:permessage-deflate</code>，客户端指定的一些扩展协议，比如这里<code>permessage-deflate</code>就是<code>WebSocket</code>的一种压缩协议。</li><li><code>响应码101,</code>表示响应协议升级，后续的数据交互都按照Upgradet指定的<code>WebSocket</code>协议来。</li></ul><h2 id="2-结合OkHttp使用WebSocket进行通信"><a href="#2-结合OkHttp使用WebSocket进行通信" class="headerlink" title="2.结合OkHttp使用WebSocket进行通信"></a>2.结合OkHttp使用WebSocket进行通信</h2><h3 id="2-1-添加OkHttp依赖"><a href="#2-1-添加OkHttp依赖" class="headerlink" title="2.1 添加OkHttp依赖"></a>2.1 添加OkHttp依赖</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;com.squareup.okhttp3:okhttp:4.7.2&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-2-实现代码"><a href="#2-2-实现代码" class="headerlink" title="2.2 实现代码"></a>2.2 实现代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化WebSocket</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mWbSocketUrl = <span class="string">&quot;ws://echo.websocket.org&quot;</span>;</span><br><span class="line">    mClient = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">            .pingInterval(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">            .build();</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">            .url(mWbSocketUrl)</span><br><span class="line">            .build();</span><br><span class="line">    mWebSocket = mClient.newWebSocket(request, <span class="keyword">new</span> WsListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里主要是配置了<code>OkHttp</code>的一些参数，以及<code>WebSocket</code>的连接地址。其中<code>newWebSocket</code>方法就是进行<code>WebSocket</code>的初始化和连接。</p><p>这里要注意的点是<code>pingInterval</code>方法的配置，这个方法主要是用来设置<code>WebSocket</code>连接的保活。 相信做过长连接的同学都知道，一个长连接一般要隔几秒发送一条消息告诉服务器我在线，而服务器也会回复一个消息表示收到了，这样就确认了连接正常，客户端和服务器端都在线。</p><p>如果服务器没有<code>按时收到</code>这个消息那么服务器可能就会<code>主动关闭</code>这个连接，节约资源。 客户端没有<code>正常收到</code>这个返回的消息，也会做一些类似<code>重连的操作</code>，所以这个保活消息非常重要。</p><p>我们称这个消息叫作<code>心跳包</code>，一般用<code>PING，PONG</code>表示，像乒乓球一样，一来一回。 所以这里的<code>pingInterval</code>就是设置心跳包发送的间隔时间，设置了这个方法之后，<code>OkHttp</code>就会自动帮我们发送心跳包事件，也就是<code>ping</code>包。当间隔时间到了，没有收到<code>pong</code>包的话，监听事件中的<code>onFailure</code>方法就会被调用，此时我们就可以进行断线重连。</p><p>但是由于实际业务需求不一样，以及<code>okhttp</code>中心跳包事件给予我们权限较少，所以我们也可以自己完成心跳包事件，即在<code>WebSocket</code>连接成功之后，开始定时发送<code>ping</code>包，在下一次发送<code>ping</code>包之前检查上一个<code>pong</code>包是否收到，如果没收到，就视为异常，开始断线重连。感兴趣的同学可以看看文末的相关源码。</p><p>建立连接后，我们就可以正常发送和读取消息了，也就是在上文<code>WsListener</code>监听事件中表现：</p><blockquote><p>在<code>Android</code>程序中，如果应用被系统<code>kill</code>了进程，这种我们是没办法告诉<code>Sever</code>端，结束连接的，所以心跳包是有必要的</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//监听事件，用于收消息，监听连接的状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WsListener</span> <span class="keyword">extends</span> <span class="title">WebSocketListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosed</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="keyword">int</span> code, <span class="meta">@NotNull</span> String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onClosed(webSocket, code, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosing</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="keyword">int</span> code, <span class="meta">@NotNull</span> String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onClosing(webSocket, code, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> Throwable t, <span class="meta">@Nullable</span> Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onFailure(webSocket, t, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMessage(webSocket, text);</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;客户端收到消息:&quot;</span> + text);</span><br><span class="line">        onWSDataChanged(DATE_NORMAL, text);</span><br><span class="line">       <span class="comment">//测试发消息</span></span><br><span class="line">        webSocket.send(<span class="string">&quot;我是客户端，你好啊&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> ByteString bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMessage(webSocket, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onOpen(webSocket, response);</span><br><span class="line">        Log.e(TAG,<span class="string">&quot;连接成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//发送String消息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebSocket.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送byte消息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> ByteString message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebSocket.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">//主动断开连接</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(<span class="keyword">int</span> code, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebSocket != <span class="keyword">null</span>)</span><br><span class="line">        mWebSocket.close(code, reason);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>这里要注意，回调的方法都是在子线程回调的，如果需要<code>更新UI</code>，需要切换到主线程。</p></blockquote><p>基本操作就这么多，还是很简单的吧，初始化<code>Websocket</code>——连接——连接成功——收发消息。</p><p>其中<code>WebSocket</code>类是一个操作接口，主要提供了以下<strong>几个方法</strong></p><ul><li><code>send(text: String)</code>发送一个String类型的消息</li><li><code>send(bytes: ByteString)</code> 发送一个二进制类型的消息</li><li><code>close(code: Int, reason: String?)</code>关闭WebSocket连接</li></ul><p>如果有同学想测试下<code>WebSocket</code>的功能但是又没有<strong>实际的服务器</strong>，怎么办呢？ 其实<code>OkHttp</code>官方有一个<code>MockWebSocket</code>服务，可以用来模拟服务端，下面我们一起试一下：</p><h3 id="2-3-模拟服务器"><a href="#2-3-模拟服务器" class="headerlink" title="2.3 模拟服务器"></a>2.3 模拟服务器</h3><p>首先集成<code>MockWebSocket</code>服务库：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&#x27;com.squareup.okhttp3:mockwebserver:4.7.2&#x27;</span></span><br></pre></td></tr></table></figure><p>然后就可以新建<code>MockWebServer</code>，并加入<code>MockResponse</code>作为接收消息的响应。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MockWebServer mMockWebServer = <span class="keyword">new</span> MockWebServer();</span><br><span class="line">MockResponse response = <span class="keyword">new</span> MockResponse()</span><br><span class="line">        .withWebSocketUpgrade(<span class="keyword">new</span> WebSocketListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> Response response)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onOpen(webSocket, response);</span><br><span class="line">                <span class="comment">//有客户端连接时回调</span></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;服务器收到客户端连接成功回调：&quot;</span>);</span><br><span class="line">                mWebSocket = webSocket;</span><br><span class="line">                mWebSocket.send(<span class="string">&quot;我是服务器，你好呀&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="meta">@NotNull</span> String text)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onMessage(webSocket, text);</span><br><span class="line"></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;服务器收到消息：&quot;</span> + text);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosed</span><span class="params">(<span class="meta">@NotNull</span> WebSocket webSocket, <span class="keyword">int</span> code, <span class="meta">@NotNull</span> String reason)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.onClosed(webSocket, code, reason);</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;onClosed：&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">mMockWebServer.enqueue(response);</span><br></pre></td></tr></table></figure><p>这里服务器端在收到客户端连接成功消息后，给客户端发送了一条消息。 要注意的是这段代码要在子线程执行，因为主线程不能进行网络操作。</p><p>然后就可以去初始化<code>Websocket</code>客户端了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取连接url，初始化websocket客户端</span></span><br><span class="line">String websocketUrl = <span class="string">&quot;ws://&quot;</span> + mMockWebServer.getHostName() + <span class="string">&quot;:&quot;</span> + mMockWebServer.getPort() + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">WSManager.getInstance().init(websocketUrl);</span><br></pre></td></tr></table></figure><p>ok，运行项目</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//运行结果</span><br><span class="line">E/jimu: mWbSocketUrl=ws://localhost:38355/</span><br><span class="line">E/jimu: 服务器收到客户端连接成功回调：</span><br><span class="line">E/jimu: 连接成功！</span><br><span class="line">E/jimu: 客户端收到消息:我是服务器，你好呀</span><br><span class="line">E/jimu: 服务器收到消息：我是客户端，你好啊</span><br></pre></td></tr></table></figure><h3 id="2-4-WebSocket如何进行鉴权"><a href="#2-4-WebSocket如何进行鉴权" class="headerlink" title="2.4 WebSocket如何进行鉴权"></a>2.4 WebSocket如何进行鉴权</h3><p>接下来我们聊聊 <code>WebSocket</code> 连接的鉴权问题。</p><p>所谓鉴权，其实就是为了安全考虑，避免服务端启动 <code>WebSocket</code> 的连接服务后，任谁都可以连接，这肯定会引发一些安全问题。其次，服务端还需要将 <code>WebSocket</code> 的连接实体与一个真是的用户对应起来，否者业务无法保证了。</p><p>那么问题就回到了，<code>WebSocket</code> 通信的完整过程中，如何以及何时将一些业务数据传递给服务端？当然在 <code>WebSocket</code> 连接建立之后，立即给服务端发送一些鉴权的数据，必然是可以做到业务实现的，但是这样明显是不够优雅的。</p><p>前文提到，<code>WebSocket</code> 在握手阶段，使用的是 <code>HTTP</code> 的 “协议升级”，它本质上还是 <code>HTTP</code> 的报文头发送一些特殊的头数据，来完成协议升级。</p><p>例如在 <code>RealWebSocket</code> 中，就有构造 <code>Header</code> 的过程，如 <code>Upgrade</code>、<code>Connection</code> 等等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(OkHttpClient client)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">final</span> Request request = originalRequest.newBuilder()</span><br><span class="line">    .header(<span class="string">&quot;Upgrade&quot;</span>, <span class="string">&quot;websocket&quot;</span>)</span><br><span class="line">    .header(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;Upgrade&quot;</span>)</span><br><span class="line">    .header(<span class="string">&quot;Sec-WebSocket-Key&quot;</span>, key)</span><br><span class="line">    .header(<span class="string">&quot;Sec-WebSocket-Version&quot;</span>, <span class="string">&quot;13&quot;</span>)</span><br><span class="line">    .build();</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么实际我们在 <code>WebSocket</code> 阶段，也可以通过 <code>Header</code> 传输一些鉴权的数据，例如 <code>uid</code>、<code>token</code> 之类，具体方法就是在构造 <code>Request</code> 的时候，为其增加 <code>Header</code>，这里就不举例说明了。</p><p>另外 <code>WebSocket</code> 的 <code>URL</code> 也是可以携带参数的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wss://cxmydev.com:443?uid=xxx&amp;token=xxx</span><br></pre></td></tr></table></figure><h2 id="3-OkHttp-源码解读WebSocket连接过程及协议"><a href="#3-OkHttp-源码解读WebSocket连接过程及协议" class="headerlink" title="3.OkHttp 源码解读WebSocket连接过程及协议"></a>3.OkHttp 源码解读WebSocket连接过程及协议</h2><p><code>WebSocket</code>整个流程无非三个功能：连接，接收消息，发送消息。下面我们就从这<code>三个方面</code>分析下具体是怎么实现的。</p><h3 id="3-1-连接"><a href="#3-1-连接" class="headerlink" title="3.1 连接"></a>3.1 连接</h3><p>通过上面的代码我们得知，<code>WebSocket</code>连接是通过<code>newWebSocket</code>方法。直接点进去看这个方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newWebSocket</span><span class="params">(request: <span class="type">Request</span>, listener: <span class="type">WebSocketListener</span>)</span></span>: WebSocket &#123;</span><br><span class="line">  <span class="keyword">val</span> webSocket = RealWebSocket(</span><br><span class="line">      taskRunner = TaskRunner.INSTANCE,</span><br><span class="line">      originalRequest = request,</span><br><span class="line">      listener = listener,</span><br><span class="line">      random = Random(),</span><br><span class="line">      pingIntervalMillis = pingIntervalMillis.toLong(),</span><br><span class="line">      extensions = <span class="literal">null</span>, <span class="comment">// Always null for clients.</span></span><br><span class="line">      minimumDeflateSize = minWebSocketMessageToCompress</span><br><span class="line">  )</span><br><span class="line">  webSocket.connect(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">return</span> webSocket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里做了两件事：</p><ul><li>初始化<code>RealWebSocket</code>，主要是设置了一些参数（比如<code>pingIntervalMillis</code>心跳包时间间隔，还有监听事件之类的）</li><li><code>connect</code>方法进行<code>WebSocket</code>连接</li></ul><p>继续查看connect方法：</p><h4 id="3-1-1-connect-WebSocket连接握手"><a href="#3-1-1-connect-WebSocket连接握手" class="headerlink" title="3.1.1 connect(WebSocket连接握手)"></a>3.1.1 connect(WebSocket连接握手)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">connect</span><span class="params">(client: <span class="type">OkHttpClient</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">//***</span></span><br><span class="line">  <span class="keyword">val</span> webSocketClient = client.newBuilder()</span><br><span class="line">      .eventListener(EventListener.NONE)</span><br><span class="line">      .protocols(ONLY_HTTP1)</span><br><span class="line">      .build()</span><br><span class="line">  <span class="keyword">val</span> request = originalRequest.newBuilder()</span><br><span class="line">      .header(<span class="string">&quot;Upgrade&quot;</span>, <span class="string">&quot;websocket&quot;</span>)</span><br><span class="line">      .header(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;Upgrade&quot;</span>)</span><br><span class="line">      .header(<span class="string">&quot;Sec-WebSocket-Key&quot;</span>, key)</span><br><span class="line">      .header(<span class="string">&quot;Sec-WebSocket-Version&quot;</span>, <span class="string">&quot;13&quot;</span>)</span><br><span class="line">      .header(<span class="string">&quot;Sec-WebSocket-Extensions&quot;</span>, <span class="string">&quot;permessage-deflate&quot;</span>)</span><br><span class="line">      .build()</span><br><span class="line">  call = RealCall(webSocketClient, request, forWebSocket = <span class="literal">true</span>)</span><br><span class="line">  call!!.enqueue(<span class="keyword">object</span> : Callback &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(call: <span class="type">Call</span>, response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//得到数据流</span></span><br><span class="line">      <span class="keyword">val</span> streams: Streams</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        checkUpgradeSuccess(response, exchange)</span><br><span class="line">        streams = exchange!!.newWebSocketStreams()</span><br><span class="line">      &#125; </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//***</span></span><br><span class="line">      <span class="comment">// Process all web socket messages.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> name = <span class="string">&quot;<span class="variable">$okHttpName</span> WebSocket <span class="subst">$&#123;request.url.redact()&#125;</span>&quot;</span></span><br><span class="line">        initReaderAndWriter(name, streams)</span><br><span class="line">        listener.onOpen(<span class="keyword">this</span><span class="symbol">@RealWebSocket</span>, response)</span><br><span class="line">        loopReader()</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        failWebSocket(e, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Websocket</code>连接需要一次<code>Http</code>协议的握手，然后才能把协议升级成<code>WebSocket</code>。所以这段代码就体现出这个功能了。</p><p>首先就<code>new</code>了一个用来进行<code>Http</code>连接的<code>request</code>，其中<code>Header</code>的参数就表示我要进行<code>WebSocket</code>连接了，参数解析如下：</p><ul><li><code>Connection:Upgrade</code>，表示客户端要连接升级</li><li><code>Upgrade:websocket</code>， 表示客户端要升级建立Websocket连接</li><li><code>Sec-Websocket-Key:key</code>， 这个key是随机生成的，服务器会通过这个参数验证该请求是否有效</li><li><code>Sec-WebSocket-Version:13</code>， websocket使用的版本，一般就是13</li><li><code>Sec-webSocket-Extension:permessage-deflate</code>，客户端指定的一些扩展协议，比如这里<code>permessage-deflate</code>就是<code>WebSocket</code>的一种压缩协议。</li></ul><p><code>Header</code>设置好之后，就调用了<code>call</code>的<code>enqueue</code>方法，这个方法大家应该都很熟悉吧，<code>OkHttp</code>里面对于<code>Http</code>请求的异步请求就是这个方法。 至此，握手结束，服务器返回<code>响应码101</code>，表示协议升级。</p><p>然后我们继续看看获取服务器响应之后又做了什么？ 在发送<code>Http</code>请求成功之后，<code>onResponse</code>响应方法里面主要表现为四个处理逻辑：</p><ul><li>将<code>Http</code>流转换成<code>WebSocket</code>流，得到<code>Streams</code>对象，这个流后面会转化成输入流和输出流，也就是进行发送和读取的操作流</li><li><code>listener.onOpen(this@RealWebSocket, response)</code>，回调了接口<code>WebSocketListener</code>的<code>onOpen</code>方法，告诉用户<code>WebSocket</code>已经连接</li><li><code>initReaderAndWriter(name, streams)</code></li><li><code>loopReader()</code></li></ul><p>前两个逻辑还是比较好理解，主要是后两个方法，我们分别解析下。 首先看<code>initReaderAndWriter</code>方法。</p><h4 id="3-1-2-initReaderAndWriter（初始化输入流输出流）"><a href="#3-1-2-initReaderAndWriter（初始化输入流输出流）" class="headerlink" title="3.1.2 initReaderAndWriter（初始化输入流输出流）"></a>3.1.2 initReaderAndWriter（初始化输入流输出流）</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealWebSocket.kt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">initReaderAndWriter</span><span class="params">(name: <span class="type">String</span>, streams: <span class="type">Streams</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> extensions = <span class="keyword">this</span>.extensions!!</span><br><span class="line">  synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="comment">//***</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//写数据，发送数据的工具类</span></span><br><span class="line">    <span class="keyword">this</span>.writer = WebSocketWriter()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置心跳包事件</span></span><br><span class="line">    <span class="keyword">if</span> (pingIntervalMillis != <span class="number">0L</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> pingIntervalNanos = MILLISECONDS.toNanos(pingIntervalMillis)</span><br><span class="line">      taskQueue.schedule(<span class="string">&quot;<span class="variable">$name</span> ping&quot;</span>, pingIntervalNanos) &#123;</span><br><span class="line">        writePingFrame()</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@schedule</span> pingIntervalNanos</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//***</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//***</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//读取数据的工具类</span></span><br><span class="line">  reader = WebSocketReader(     </span><br><span class="line">    ***</span><br><span class="line">    frameCallback = <span class="keyword">this</span>,</span><br><span class="line">    ***</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">writePingFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="comment">//***</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    writer.writePing(ByteString.EMPTY)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">    failWebSocket(e, <span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个方法主要干了两件事：</p><ul><li>实例化输出流输入流工具类，也就是<code>WebSocketWriter</code>和<code>WebSocketReader</code>，用来处理数据的收发。</li><li>设置心跳包事件。如果<code>pingIntervalMillis</code>参数不为0，就通过计时器，每隔<code>pingIntervalNanos</code>发送一个<code>ping</code>消息。其中<code>writePingFrame</code>方法就是发送了<code>ping</code>帧数据。</li></ul><h3 id="3-2-接收消息处理消息"><a href="#3-2-接收消息处理消息" class="headerlink" title="3.2 接收消息处理消息"></a>3.2 接收消息处理消息</h3><h4 id="3-2-1-loopReader"><a href="#3-2-1-loopReader" class="headerlink" title="3.2.1 loopReader"></a>3.2.1 loopReader</h4><p>接着看看这个<code>loopReader</code>方法是干什么的，看这个名字我们大胆猜测下，难道这个方法就是用来循环读取数据的？去代码里找找答案：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loopReader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (receivedCloseCode == -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// This method call results in one or more onRead* methods being called on this thread.</span></span><br><span class="line">    reader!!.processNextFrame()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码很简单，一个<code>while</code>循环，循环条件是<code>receivedCloseCode == -1</code>的时候，做的事情是<code>reader!!.processNextFrame()</code>方法。继续：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WebSocketWriter.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">processNextFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">//读取头部信息</span></span><br><span class="line">  readHeader()</span><br><span class="line">  <span class="keyword">if</span> (isControlFrame) &#123;</span><br><span class="line">    <span class="comment">//如果是控制帧，读取控制帧内容</span></span><br><span class="line">    readControlFrame()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//读取普通消息内容</span></span><br><span class="line">    readMessageFrame()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取头部信息</span></span><br><span class="line"><span class="meta">@Throws(IOException::class, ProtocolException::class)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">readHeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (closed) <span class="keyword">throw</span> IOException(<span class="string">&quot;closed&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">//读取数据，获取数据帧的前8位</span></span><br><span class="line">    b0 = source.readByte() and <span class="number">0xff</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    source.timeout().timeout(timeoutBefore, TimeUnit.NANOSECONDS)</span><br><span class="line">  &#125;    </span><br><span class="line">  <span class="comment">//***</span></span><br><span class="line">  <span class="comment">//获取数据帧的opcode（数据格式）</span></span><br><span class="line">  opcode = b0 and B0_MASK_OPCODE</span><br><span class="line">  <span class="comment">//是否为最终帧</span></span><br><span class="line">  isFinalFrame = b0 and B0_FLAG_FIN != <span class="number">0</span></span><br><span class="line">  <span class="comment">//是否为控制帧（指令）</span></span><br><span class="line">  isControlFrame = b0 and OPCODE_FLAG_CONTROL != <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//判断最终帧，获取帧长度等等</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//读取控制帧（指令）</span></span><br><span class="line">  <span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">readControlFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (frameLength &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">    source.readFully(controlFrameBuffer, frameLength)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">when</span> (opcode) &#123;</span><br><span class="line">    OPCODE_CONTROL_PING -&gt; &#123;</span><br><span class="line">    <span class="comment">//ping 帧</span></span><br><span class="line">      frameCallback.onReadPing(controlFrameBuffer.readByteString())</span><br><span class="line">    &#125;</span><br><span class="line">    OPCODE_CONTROL_PONG -&gt; &#123;</span><br><span class="line">      <span class="comment">//pong 帧</span></span><br><span class="line">      frameCallback.onReadPong(controlFrameBuffer.readByteString())</span><br><span class="line">    &#125;</span><br><span class="line">    OPCODE_CONTROL_CLOSE -&gt; &#123;</span><br><span class="line">      <span class="comment">//关闭 帧</span></span><br><span class="line">      <span class="keyword">var</span> code = CLOSE_NO_STATUS_CODE</span><br><span class="line">      <span class="keyword">var</span> reason = <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="keyword">val</span> bufferSize = controlFrameBuffer.size</span><br><span class="line">      <span class="keyword">if</span> (bufferSize == <span class="number">1L</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ProtocolException(<span class="string">&quot;Malformed close payload length of 1.&quot;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufferSize != <span class="number">0L</span>) &#123;</span><br><span class="line">        code = controlFrameBuffer.readShort().toInt()</span><br><span class="line">        reason = controlFrameBuffer.readUtf8()</span><br><span class="line">        <span class="keyword">val</span> codeExceptionMessage = WebSocketProtocol.closeCodeExceptionMessage(code)</span><br><span class="line">        <span class="keyword">if</span> (codeExceptionMessage != <span class="literal">null</span>) <span class="keyword">throw</span> ProtocolException(codeExceptionMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//回调onReadClose方法</span></span><br><span class="line">      frameCallback.onReadClose(code, reason)</span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取普通消息</span></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">readMessageFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">  </span><br><span class="line">  readMessage()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (readingCompressedMessage) &#123;</span><br><span class="line">    <span class="keyword">val</span> messageInflater = <span class="keyword">this</span>.messageInflater</span><br><span class="line">        ?: MessageInflater(noContextTakeover).also &#123; <span class="keyword">this</span>.messageInflater = it &#125;</span><br><span class="line">    messageInflater.inflate(messageFrameBuffer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opcode == OPCODE_TEXT) &#123;</span><br><span class="line">    frameCallback.onReadMessage(messageFrameBuffer.readUtf8())</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    frameCallback.onReadMessage(messageFrameBuffer.readByteString())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码还是比较直观，这个<code>processNextFrame</code>其实就是读取数据用的，首先读取头部信息，获取数据帧的类型，判断是否为控制帧，再分别去读取控制帧数据或者普通消息帧数据。</p><h4 id="3-2-2-数据帧格式"><a href="#3-2-2-数据帧格式" class="headerlink" title="3.2.2 数据帧格式"></a>3.2.2 数据帧格式</h4><p>问题来了，什么是<strong>数据头部信息</strong>，什么是<strong>控制帧</strong>？ 这里就要说下<code>WebSocket</code>的数据帧了，先附上一个数据帧格式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> 0 1 2 3 4 5 6 7    0 1 2 3 4 5 6 7  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7</span><br><span class="line">+-+-+-+-+-------+  +-+-------------+ +-----------------------------+</span><br><span class="line">|F|R|R|R| OP    |  |M| LENGTH      |   Extended payload length</span><br><span class="line">|I|S|S|S| CODE  |  |A|             |  （if LENGTH=126）</span><br><span class="line">|N|V|V|V|       |  |S|             |</span><br><span class="line">| |1|2|3|       |  |K|             |</span><br><span class="line">+-+-+-+-+-------+  +-+-------------+</span><br><span class="line">|                      Extended payload length（if LENGTH=127）</span><br><span class="line">+                                  +-------------------------------</span><br><span class="line">|      Extended payload length     | Masking-key，if Mask set to 1</span><br><span class="line">+----------------------------------+-------------------------------</span><br><span class="line">|   Masking-key                    |       Data</span><br><span class="line">+----------------------------------+-------------------------------</span><br><span class="line">|                                Data</span><br><span class="line">+----------------------------------+-------------------------------</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我承认，我懵逼了。 冷静冷静，一步一步分析下吧。</p><p>首先每一行代表4个字节，一共也就是32位数，哦，那也就是几个字节而已嘛，每个字节有他自己的代表意义呗，这样想是不是就很简单了，下面来具体看看每个字节。</p><p><strong>第1个字节：</strong></p><ul><li>第一位是<code>FIN码</code>，其实就是一个标示位，因为数据可能多帧操作嘛，所以多帧情况下，只有最后一帧的<code>FIN</code>设置成1，标示结束帧，前面所有帧设置为0。</li><li>第二位到第四位是<code>RSV码</code>，一般通信两端没有设置自定义协议，就默认为0。</li><li>后四位是<code>opcode</code>，我们叫它操作码。这个就是判断这个数据帧的类型了，一般有以下几个被定义好的类型：</li></ul><p>1） <code>0x0</code> 表示附加数据帧<br>2） <code>0x1</code> 表示文本数据帧<br>3） <code>0x2</code> 表示二进制数据帧<br>4） <code>0x3-7</code> 保留用于未来的非控制帧<br>5） <code>0x8</code> 表示连接关闭<br>6） <code>0x9</code> 表示ping<br>7） <code>0xA</code> 表示pong<br>8） <code>0xB-F</code> 保留用于未来的非控制帧</p><p>是不是发现了些什么，这不就对应了我们应用中的几种格式吗？<code>2和3</code>对应的是普通消息帧，包括了文本和二进制数据。<code>567</code>对应的就是控制帧格式，包括了<code>close，ping，pong</code>。</p><p><strong>第2个字节：</strong></p><ul><li>第一位是<code>Mask</code>掩码，其实就是标识数据是否加密混淆，1代表数据经过掩码的，0是没有经过掩码的，如果是1的话，后续就会有4个字节代表<code>掩码key</code>，也就是数据帧中<code>Masking-key</code>所处的位置。</li><li>后7位是<code>LENGTH</code>，用来标示数据长度。因为只有7位，所以最大只能储存1111111对应的十进制数<code>127长度</code>的数据，如果需要更大的数据，这个储存长度肯定就不够了。 <strong>所以规定来了</strong>，1) <code>小于126长度</code>则数据用这七位表示实际长度。2) 如果长度<code>设置为126</code>，也就是二进制1111110，就代表取<code>额外2个字节</code>表示数据长度，共是16位表示数据长度。3) 如果长度<code>设置为127</code>，也就是二进制1111111，就代表取<code>额外8个字节</code>，共是64位表示数据长度。</li></ul><blockquote><p>需要注意的是LENGHT的三种情况在一个数据帧里面只会出现一种情况，不共存，所以在图中是用<strong>if</strong>表示。同样的，Masking-key也是当Mask为1的时候才存在。</p></blockquote><p>所以也就有了数据帧里面的<code>Extended payload length（LENGTH=126）</code>所处的2个字节，以及<code>Extended payload length（LENGTH=127）</code>所处的8个字节。</p><p>最后的字节部分自然就是<code>掩码key</code>（Mask为1的时候才存在）和具体的<code>传输数据</code>了。<br>还是有点晕吧😷，来张图总结下： <img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/13/173476f65b9b0001~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.image" alt="数据帧格式.jpeg"></p><p>好了，了解了<strong>数据帧格式</strong>后，我们再来读源码就清晰多了。 先看看怎么读的<code>头部信息</code>并解析的：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取数据帧前8位数据</span></span><br><span class="line">b0 = source.readByte() and <span class="number">0xff</span></span><br><span class="line"><span class="comment">//获取数据帧的opcode（数据格式）</span></span><br><span class="line">opcode = b0 and B0_MASK_OPCODE（<span class="number">15</span>）</span><br><span class="line"><span class="comment">//是否为最终帧</span></span><br><span class="line">isFinalFrame = b0 and B0_FLAG_FIN（<span class="number">128</span>） != <span class="number">0</span></span><br><span class="line"><span class="comment">//是否为控制帧（指令）</span></span><br><span class="line">isControlFrame = b0 and OPCODE_FLAG_CONTROL（<span class="number">8</span>） != <span class="number">0</span>  </span><br></pre></td></tr></table></figure><ul><li>第一句获取头信息，<code>and</code>是按位与计算，<code>and 0xff</code>意思就是按位与11111111，所以头部信息其实就是取了数据帧的<code>前8位数据</code>，一个字节。</li><li>第二句获取<code>opcode</code>，<code>and 15</code>也就是按位与00001111，其实也就是取了后四位数据，刚好对应上<code>opcode</code>的位置，第一个字节的后四位。</li><li>第三句获取是否为<code>最终帧</code>，刚才数据帧格式中说过，第一位<code>FIN</code>标识了是否为最后一帧数据，1代表结束帧，所以这里<code>and 128</code>也就是按位与10000000，也就是取的第一位数。</li><li>第四句获取是否为控制帧，<code>and 8</code>也就是按位与00001000，取得是第五位，也就是<code>opcode</code>的第一位，这是什么意思呢？我们看看刚才的数据帧格式，发现从<code>0x8</code>开始就是所谓的控制帧了。<code>0x8</code>对应的二进制是1000，<code>0x7</code>对应的二进制是0111。发现了吧，如果为控制帧的时候，<code>opcode</code>第一位肯定是为1的，所以这里就判断的第五位。</li></ul><p>后面还有读取第二个字节的代码，大家可以自己沿着这个思路自己看看，包括了读取<code>MASK</code>，读取数据长度的三种长度等。</p><p>所以这个<code>processNextFrame</code>方法主要做了三件事：</p><ul><li><code>readHeader</code>方法中，判断了是否为控制帧，是否为<code>结束帧</code>，然后获取了<code>Mask</code>标识，帧长度等参数</li><li><code>readControlFrame</code>方法中，主要处理了该帧数据为<code>ping，pong，close</code>三种情况，并且在收到<code>close关闭帧</code>的情况下，回调了<code>onReadClose</code>方法，这个待会要细看下。</li><li><code>readMessageFrame</code>方法中，主要是读取了消息后，回调了onReadMessage方法。</li></ul><p>至此可以发现，其实<code>WebSocket</code>传输数据并不是一个简单的事，只是<code>OkHttp</code>都帮我们封装好了，我们只需要直接传输数据即可，感谢这些三方库为我们开发作出的贡献，不知道什么时候我也能做出点贡献呢🤔。</p><p>对了，刚才说回调也很重要，接着看看。<code>onReadClose</code>和<code>onReadMessage</code>回调到哪了呢？还记得上文初始化<code>WebSocketWriter</code>的时候设置了回调接口吗。所以就是回调给<code>RealWebSocket</code>了：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealWebSocket.kt</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReadClose</span><span class="params">(code: <span class="type">Int</span>, reason: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">  require(code != -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> toClose: Streams? = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">var</span> readerToClose: WebSocketReader? = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">var</span> writerToClose: WebSocketWriter? = <span class="literal">null</span></span><br><span class="line">  synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">    check(receivedCloseCode == -<span class="number">1</span>) &#123; <span class="string">&quot;already closed&quot;</span> &#125;</span><br><span class="line">    receivedCloseCode = code</span><br><span class="line">    receivedCloseReason = reason </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    listener.onClosing(<span class="keyword">this</span>, code, reason)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (toClose != <span class="literal">null</span>) &#123;</span><br><span class="line">      listener.onClosed(<span class="keyword">this</span>, code, reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    toClose?.closeQuietly()</span><br><span class="line">    readerToClose?.closeQuietly()</span><br><span class="line">    writerToClose?.closeQuietly()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReadMessage</span><span class="params">(text: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">  listener.onMessage(<span class="keyword">this</span>, text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReadMessage</span><span class="params">(bytes: <span class="type">ByteString</span>)</span></span> &#123;</span><br><span class="line">  listener.onMessage(<span class="keyword">this</span>, bytes)</span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>onReadClose</code>回调方法里面有个关键的参数，<code>receivedCloseCode</code>。还记得这个参数吗？上文中解析消息的循环条件就是<code>receivedCloseCode == -1</code>，所以当收到关闭帧的时候，<code>receivedCloseCode</code>就不再等于-1（规定大于1000），也就不再去读取解析消息了。这样整个流程就结束了。</p><p>其中还有一些<code>WebSocketListener</code>的回调，比如<code>onClosing，onClosed，onMessage</code>等，就直接回调给用户使用了。至此，接收消息处理消息说完了。</p><h3 id="3-3-发消息"><a href="#3-3-发消息" class="headerlink" title="3.3 发消息"></a>3.3 发消息</h3><p>好了。接着说发送，看看<code>send</code>方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Synchronized</span> <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">send</span><span class="params">(<span class="keyword">data</span>: <span class="type">ByteString</span>, formatOpcode: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  <span class="comment">// ***</span></span><br><span class="line">  <span class="comment">// Enqueue the message frame.</span></span><br><span class="line">  queueSize += <span class="keyword">data</span>.size.toLong()</span><br><span class="line">  messageAndCloseQueue.add(Message(formatOpcode, <span class="keyword">data</span>))</span><br><span class="line">  runWriter()</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先，把要发送的<code>data</code>封装成<code>Message</code>对象，然后入队列<code>messageAndCloseQueue</code>。最后执行<code>runWriter</code>方法。这都不用猜了，<code>runWriter</code>肯定就要开始发送消息了，继续看：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealWebSocket.kt</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">runWriter</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.assertThreadHoldsLock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> writerTask = writerTask</span><br><span class="line">  <span class="keyword">if</span> (writerTask != <span class="literal">null</span>) &#123;</span><br><span class="line">    taskQueue.schedule(writerTask)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">WriterTask</span> : <span class="type">Task</span></span>(<span class="string">&quot;<span class="variable">$name</span> writer&quot;</span>) &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">runOnce</span><span class="params">()</span></span>: <span class="built_in">Long</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (writeOneFrame()) <span class="keyword">return</span> <span class="number">0L</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">      failWebSocket(e, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1L</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//以下是schedule方法转到WriterTask的runOnce方法过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//TaskQueue.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">schedule</span><span class="params">(task: <span class="type">Task</span>, delayNanos: <span class="type">Long</span> = <span class="number">0</span>L)</span></span> &#123;</span><br><span class="line">  synchronized(taskRunner) &#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduleAndDecide(task, delayNanos, recurrence = <span class="literal">false</span>)) &#123;</span><br><span class="line">      taskRunner.kickCoordinator(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">scheduleAndDecide</span><span class="params">(task: <span class="type">Task</span>, delayNanos: <span class="type">Long</span>, recurrence: <span class="type">Boolean</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  <span class="comment">//***</span></span><br><span class="line">  <span class="keyword">if</span> (insertAt == -<span class="number">1</span>) insertAt = futureTasks.size</span><br><span class="line">  futureTasks.add(insertAt, task)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Impact the coordinator if we inserted at the front.</span></span><br><span class="line">  <span class="keyword">return</span> insertAt == <span class="number">0</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//TaskRunner.kt</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">kickCoordinator</span><span class="params">(taskQueue: <span class="type">TaskQueue</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.assertThreadHoldsLock()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (taskQueue.activeTask == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (taskQueue.futureTasks.isNotEmpty()) &#123;</span><br><span class="line">      readyQueues.addIfAbsent(taskQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      readyQueues.remove(taskQueue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (coordinatorWaiting) &#123;</span><br><span class="line">    backend.coordinatorNotify(<span class="keyword">this</span><span class="symbol">@TaskRunner</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    backend.execute(runnable)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> runnable: Runnable = <span class="keyword">object</span> : Runnable &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> task = synchronized(<span class="keyword">this</span><span class="symbol">@TaskRunner</span>) &#123;</span><br><span class="line">        awaitTaskToRun()</span><br><span class="line">      &#125; ?: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      logElapsed(task, task.queue!!) &#123;</span><br><span class="line">        <span class="keyword">var</span> completedNormally = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          runTask(task)</span><br><span class="line">          completedNormally = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// If the task is crashing start another thread to service the queues.</span></span><br><span class="line">          <span class="keyword">if</span> (!completedNormally) &#123;</span><br><span class="line">            backend.execute(<span class="keyword">this</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">runTask</span><span class="params">(task: <span class="type">Task</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    delayNanos = task.runOnce()</span><br><span class="line">  &#125; </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代码有点长，这里是从<code>runWriter</code>开始跟的几个方法，拿到<code>writerTask</code>实例后，存到<code>TaskQueue</code>的<code>futureTasks列表</code>里，然后到<code>runnable</code>这里可以看到是一个<code>while</code>死循环，不断的从<code>futureTasks</code>中取出<code>Task</code>并执行<code>runTask</code>方法，直到<code>Task</code>为空，循环停止。</p><p>其中涉及到两个新的类：</p><ul><li><code>TaskQueue类</code>主要就是管理消息任务列表，保证按顺序执行</li><li><code>TaskRunner类</code>主要就是做一些任务的具体操作，比如线程池里执行任务，记录消息任务的状态（准备发送的任务队列<code>readyQueues</code>，正在执行的任务队列<code>busyQueues</code>等等）</li></ul><p>而每一个Task最后都是执行到了<code>WriterTask</code>的<code>runOnce</code>方法，也就是<code>writeOneFrame</code>方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeOneFrame</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  synchronized(<span class="keyword">this</span><span class="symbol">@RealWebSocket</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (failed) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// Failed web socket.</span></span><br><span class="line">    &#125;</span><br><span class="line">    writer = <span class="keyword">this</span>.writer</span><br><span class="line">    pong = pongQueue.poll()</span><br><span class="line">    <span class="keyword">if</span> (pong == <span class="literal">null</span>) &#123;</span><br><span class="line">      messageOrClose = messageAndCloseQueue.poll()</span><br><span class="line">      <span class="keyword">if</span> (messageOrClose <span class="keyword">is</span> Close) &#123;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageOrClose == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// The queue is exhausted.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//发送消息逻辑，包括`pong`消息，普通消息，关闭消息</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pong != <span class="literal">null</span>) &#123;</span><br><span class="line">      writer!!.writePong(pong)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageOrClose <span class="keyword">is</span> Message) &#123;</span><br><span class="line">      <span class="keyword">val</span> message = messageOrClose <span class="keyword">as</span> Message</span><br><span class="line">      writer!!.writeMessageFrame(message.formatOpcode, message.<span class="keyword">data</span>)</span><br><span class="line">      synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">        queueSize -= message.<span class="keyword">data</span>.size.toLong()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageOrClose <span class="keyword">is</span> Close) &#123;</span><br><span class="line">      <span class="keyword">val</span> close = messageOrClose <span class="keyword">as</span> Close</span><br><span class="line">      writer!!.writeClose(close.code, close.reason)</span><br><span class="line">      <span class="comment">// We closed the writer: now both reader and writer are closed.</span></span><br><span class="line">      <span class="keyword">if</span> (streamsToClose != <span class="literal">null</span>) &#123;</span><br><span class="line">        listener.onClosed(<span class="keyword">this</span>, receivedCloseCode, receivedCloseReason!!)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    streamsToClose?.closeQuietly()</span><br><span class="line">    readerToClose?.closeQuietly()</span><br><span class="line">    writerToClose?.closeQuietly()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里就会执行发送消息的逻辑了，主要有三种消息情况处理：</p><ul><li><code>pong消息</code>，这个主要是为服务器端准备的，发送给客户端回应心跳包。</li><li><code>普通消息</code>，就会把数据类型<code>Opcode</code>和具体数据发送过去</li><li><code>关闭消息</code>，其实当用户执行<code>close</code>方法关闭<code>WebSocket</code>的时候，也是发送了一条<code>Close控制帧</code>消息给服务器告知这个关闭需求，并带上<code>code状态码</code>和<code>reason关闭原因</code>，然后服务器端就会关闭当前连接。</li></ul><p>好了。最后一步了，就是把这些数据组装成<code>WebSocket</code>数据帧并写入流，分成<code>控制帧</code>数据和<code>普通消息数据帧</code>：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//写入（发送）控制帧</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeControlFrame</span><span class="params">(opcode: <span class="type">Int</span>, payload: <span class="type">ByteString</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (writerClosed) <span class="keyword">throw</span> IOException(<span class="string">&quot;closed&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">val</span> length = payload.size</span><br><span class="line">  require(length &lt;= PAYLOAD_BYTE_MAX) &#123;</span><br><span class="line">    <span class="string">&quot;Payload size must be less than or equal to <span class="variable">$PAYLOAD_BYTE_MAX</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> b0 = B0_FLAG_FIN or opcode</span><br><span class="line">  sinkBuffer.writeByte(b0)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> b1 = length</span><br><span class="line">  <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">    b1 = b1 or B1_FLAG_MASK</span><br><span class="line">    sinkBuffer.writeByte(b1)</span><br><span class="line">    random.nextBytes(maskKey!!)</span><br><span class="line">    sinkBuffer.write(maskKey)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> payloadStart = sinkBuffer.size</span><br><span class="line">      sinkBuffer.write(payload)</span><br><span class="line">      sinkBuffer.readAndWriteUnsafe(maskCursor!!)</span><br><span class="line">      maskCursor.seek(payloadStart)</span><br><span class="line">      toggleMask(maskCursor, maskKey)</span><br><span class="line">      maskCursor.close()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sinkBuffer.writeByte(b1)</span><br><span class="line">    sinkBuffer.write(payload)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sink.flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//写入（发送）普通消息数据帧</span></span><br><span class="line"><span class="meta">@Throws(IOException::class)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">writeMessageFrame</span><span class="params">(formatOpcode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">ByteString</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (writerClosed) <span class="keyword">throw</span> IOException(<span class="string">&quot;closed&quot;</span>)</span><br><span class="line"></span><br><span class="line">  messageBuffer.write(<span class="keyword">data</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> b0 = formatOpcode or B0_FLAG_FIN</span><br><span class="line">  <span class="keyword">val</span> dataSize = messageBuffer.size</span><br><span class="line">  sinkBuffer.writeByte(b0)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> b1 = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">    b1 = b1 or B1_FLAG_MASK</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">when</span> &#123;</span><br><span class="line">    dataSize &lt;= PAYLOAD_BYTE_MAX -&gt; &#123;</span><br><span class="line">      b1 = b1 or dataSize.toInt()</span><br><span class="line">      sinkBuffer.writeByte(b1)</span><br><span class="line">    &#125;</span><br><span class="line">    dataSize &lt;= PAYLOAD_SHORT_MAX -&gt; &#123;</span><br><span class="line">      b1 = b1 or PAYLOAD_SHORT</span><br><span class="line">      sinkBuffer.writeByte(b1)</span><br><span class="line">      sinkBuffer.writeShort(dataSize.toInt())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">      b1 = b1 or PAYLOAD_LONG</span><br><span class="line">      sinkBuffer.writeByte(b1)</span><br><span class="line">      sinkBuffer.writeLong(dataSize)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">    random.nextBytes(maskKey!!)</span><br><span class="line">    sinkBuffer.write(maskKey)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataSize &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">      messageBuffer.readAndWriteUnsafe(maskCursor!!)</span><br><span class="line">      maskCursor.seek(<span class="number">0L</span>)</span><br><span class="line">      toggleMask(maskCursor, maskKey)</span><br><span class="line">      maskCursor.close()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sinkBuffer.write(messageBuffer, dataSize)</span><br><span class="line">  sink.emit()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>大家应该都能看懂了吧，其实就是组装数据帧，包括<code>Opcode，mask，数据长度</code>等等。两个方法的不同就在于普通数据需要判断数据长度的三种情况，再组装数据帧。最后都会通过<code>sinkBuffer</code>写入到输出数据流。</p><p>终于，基本的流程说的差不多了。其中还有很多细节，同学们可以自己花时间看看琢磨琢磨，比如<code>Okio</code>部分。还是那句话，希望大家有空自己也读一读相关源码，这样理解才能深刻，而且你肯定会发现很多我没说到的细节，欢迎大家讨论。我也会继续努力，最后大家给我加个油点个赞吧，感谢感谢。</p><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/13/173476f65e6e3ed4~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.image" alt="OkHttp-WebSocket源码.jpg"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;OkHttp应该算是Android中使用最广泛的网络库了，我们通常会利用它来实现HTTP请求，但是实际上它还可以支持WebSocket，并且使用起来还非常的便捷。那本文就来聊聊，利用OkHttp实现WebSocket的一些细节，包括对WebSocket的介绍，以及在传输如何</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>HTTPS 学习整理</title>
    <link href="http://example.com/2022/05/13/HTTPS-%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86/"/>
    <id>http://example.com/2022/05/13/HTTPS-%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86/</id>
    <published>2022-05-13T00:23:15.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="HTTPS-学习整理"><a href="#HTTPS-学习整理" class="headerlink" title="HTTPS 学习整理"></a>HTTPS 学习整理</h2><h3 id="1-HTTPS-连接及握手过程"><a href="#1-HTTPS-连接及握手过程" class="headerlink" title="1.HTTPS 连接及握手过程"></a>1.HTTPS 连接及握手过程</h3><p><strong>第一步</strong>，客户端发送给服务器Client Hello，叫做Client Hello 其实是一个一字节的数据</p><p><img src="/../images/image-20220513082622256.png" alt="image-20220513082622256"></p><p>发送Client Hello 还会附加一些信息</p><ol><li>可选的TLS版本</li><li>可选的加密套件<ul><li>可选的对称加密算法</li><li>可选的非对称加密算法</li><li>可选的hash算法</li></ul></li><li>客户端随机数（这个随机数随后会用到，等于是第一个随机数客户端和服务器都会使用到）</li></ol><p><img src="/../images/image-20220513082816474.png" alt="image-20220513082816474"></p><p><strong>第二步</strong>，服务端返回Server Hello 也是一个单字节数据，并把Client Hello 附加信息的确认值返回给客户端，同时生成服务端的随机数，返回给客户端</p><p><img src="/../images/image-20220513083321789.png" alt="image-20220513083321789"></p><p><strong>第三步</strong>，服务端下发证书，然后客户端这里会做证书的较验，这里的过程比较麻烦和复杂</p><p><img src="/../images/image-20220513083443606.png" alt="image-20220513083443606"></p><p>如图所示，证书中包含</p><ul><li>服务器公钥</li><li>服务器主机名</li><li>服务器公钥的签名</li><li>证书签发机构的公钥</li><li>证书签发机构的公角的签名</li><li>….</li></ul><p>较验的顺序也是如此，链式去使用签名去较验公钥是否准确，防止公钥被修改，一层层直到找到根证书，根证书一般都安装在pc或者手机里，然后逐层去较验公钥的正确性，最后证明服务器的公钥确实是真的，而不是假的</p><p><img src="/../images/image-20220513134035609.png" alt="image-20220513134035609"></p><p>如图所示，访问hencoder.com 然后证书链中的三级证书，客户端验证服务器证书的真实性，还通过主机名确认对方的身份，确实是我要访问的服务器，而不是其他在ca公签的服务器</p><p><img src="/../images/image-20220513134238446.png" alt="image-20220513134238446"></p><p><strong>第四步</strong>，客户端拿到服务器公钥后，和服务器一起通过公钥生成加密的Pre-master secret ，双方就公同持有了三个东西</p><ul><li>客户端随机数</li><li>服务器随机数</li><li>Pre-master secret</li></ul><p>通过这三个东西会各自独立的生成master secret 所以注意啦，<strong>最终的对称密钥并不是客户端生成后发给服务器的，而是由前面交互的随机数，及加密后的公钥独立生成的</strong></p><p><img src="/../images/image-20220513134634905.png" alt="image-20220513134634905"></p><p><strong>而且，生成的对称加密的密钥并不是简单的一个密码</strong></p><p><img src="/../images/image-20220513134726832.png" alt="image-20220513134726832"></p><p>那么有人可能会有疑问，为什么要很麻烦的生成客户端的加密密钥，服务端的加密密钥？用一个不行么？</p><p><img src="/../images/image-20220513134838968.png" alt="image-20220513134838968"></p><p><strong>第五步，客户端告诉服务器，我将使用加密通信，还有把前面几步合一起加密发给服务器，生送Finished 同样服务器也返回客户端：将使用加密通信，同时Finished握手</strong></p><p><img src="/../images/image-20220513135059793.png" alt="image-20220513135059793"></p><p>服务端返回</p><p><img src="/../images/image-20220513135117684.png" alt="image-20220513135117684"></p><p><img src="/../images/image-20220513135132604.png" alt="image-20220513135132604"></p><h3 id="2-在Android中合理使用HTTPS"><a href="#2-在Android中合理使用HTTPS" class="headerlink" title="2.在Android中合理使用HTTPS"></a>2.在Android中合理使用HTTPS</h3><p>CA公签的就不讨论了，使用很方便，根据所使用的网络框架，可以自行百度，非常简单方便。这里说下如何较验主机名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an HostnameVerifier that hardwires the expected hostname.</span></span><br><span class="line"><span class="comment">// Note that is different than the URL&#x27;s hostname:</span></span><br><span class="line"><span class="comment">// example.com versus example.org</span></span><br><span class="line">HostnameVerifier hostnameVerifier = <span class="keyword">new</span> HostnameVerifier() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(String hostname, SSLSession session)</span> </span>&#123;</span><br><span class="line">        HostnameVerifier hv =</span><br><span class="line">            HttpsURLConnection.getDefaultHostnameVerifier();</span><br><span class="line">        <span class="keyword">return</span> hv.verify(<span class="string">&quot;example.com&quot;</span>, session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the URLConnection to use our HostnameVerifier</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">&quot;https://example.org/&quot;</span>);</span><br><span class="line">HttpsURLConnection urlConnection =</span><br><span class="line">    (HttpsURLConnection)url.openConnection();</span><br><span class="line">urlConnection.setHostnameVerifier(hostnameVerifier);</span><br><span class="line">InputStream in = urlConnection.getInputStream();</span><br><span class="line">copyInputStreamToOutputStream(in, System.out);</span><br></pre></td></tr></table></figure><p>还有一种情况，有一些公司使用自签名证书，或者非知名机构颁发的证书，如果不做处理，会报https的网络异常，那么这时候上网上查的话，很多都是告诉不做较验，放开所有的证书，当然这样可以走的通，但是同时也失去了使用HTTPS的作用，是不认真负责的。</p><p>我们看官网上对这一过程的描述，之所以之前我们记不住，也是因为我们对HTTPS的握手和证书较验过程不够理解，现在看这段话</p><blockquote><p>在这种情况下，由于您的 CA 不受系统信任，将发生 SSLHandshakeException。原因可能是您有一个由 Android 尚不信任的新 CA    颁发的证书，或您的应用在没有 CA 的较旧版本上运行。CA 未知的原因通常是因为它不是公共 CA，而是由政府、公司或教育机构等组织颁发的仅供其自己使用的私有 CA。</p><p>幸运的是，您可以指示 HttpsURLConnection 信任特定的 CA 集。这个过程可能有点复杂，下面的示例展示了这个过程：从 InputStream 获取一个特定的 CA，用该 CA 创建 KeyStore，然后用后者创建和初始化 TrustManager。TrustManager 是系统用于验证来自服务器的证书的工具，可以通过包含一个或多个 CA 的 KeyStore 创建，而创建的 TrustManager 将仅信任这些 CA。</p><p>由于 TrustManager 是新建的，此示例将启动一个新的 SSLContext，它会提供一个 SSLSocketFactory，可用于替换来自 HttpsURLConnection 的默认 SSLSocketFactory。这样一来，连接将使用您的 CA 来验证证书。</p></blockquote><p>这下你知道，为啥Android客户会有一个证书文件了吧</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// Load CAs from an InputStream</span></span><br><span class="line"><span class="comment">// (could be from a resource or ByteArrayInputStream or ...)</span></span><br><span class="line">CertificateFactory cf = CertificateFactory.getInstance(<span class="string">&quot;X.509&quot;</span>);</span><br><span class="line"><span class="comment">// From https://www.washington.edu/itconnect/security/ca/load-der.crt</span></span><br><span class="line">InputStream caInput = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;load-der.crt&quot;</span>));</span><br><span class="line">Certificate ca;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ca = cf.generateCertificate(caInput);</span><br><span class="line">    System.out.println(<span class="string">&quot;ca=&quot;</span> + ((X509Certificate) ca).getSubjectDN());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    caInput.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a KeyStore containing our trusted CAs</span></span><br><span class="line">String keyStoreType = KeyStore.getDefaultType();</span><br><span class="line">KeyStore keyStore = KeyStore.getInstance(keyStoreType);</span><br><span class="line">keyStore.load(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">keyStore.setCertificateEntry(<span class="string">&quot;ca&quot;</span>, ca);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a TrustManager that trusts the CAs in our KeyStore</span></span><br><span class="line">String tmfAlgorithm = TrustManagerFactory.getDefaultAlgorithm();</span><br><span class="line">TrustManagerFactory tmf = TrustManagerFactory.getInstance(tmfAlgorithm);</span><br><span class="line">tmf.init(keyStore);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an SSLContext that uses our TrustManager</span></span><br><span class="line">SSLContext context = SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);</span><br><span class="line">context.init(<span class="keyword">null</span>, tmf.getTrustManagers(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the URLConnection to use a SocketFactory from our SSLContext</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">&quot;https://certs.cac.washington.edu/CAtest/&quot;</span>);</span><br><span class="line">HttpsURLConnection urlConnection =</span><br><span class="line">    (HttpsURLConnection)url.openConnection();</span><br><span class="line">urlConnection.setSSLSocketFactory(context.getSocketFactory());</span><br><span class="line">InputStream in = urlConnection.getInputStream();</span><br><span class="line">copyInputStreamToOutputStream(in, System.out);</span><br></pre></td></tr></table></figure><p>这个SSLContext很关键，由得到的SSLContextFactory是我们很多网络框架可以进行替换和设置，这样就可以通过自签名的ca集来检验较验证书的合法性了。</p><p>之所以说SSLContext很关键，因为不光HTTP可以使用SSL较验，很多上层加密都使用了SSL层的加密特性，比如我们可能会遇到的WSS Websocket的加密协议，怎么处理，一样的道理。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;HTTPS-学习整理&quot;&gt;&lt;a href=&quot;#HTTPS-学习整理&quot; class=&quot;headerlink&quot; title=&quot;HTTPS 学习整理&quot;&gt;&lt;/a&gt;HTTPS 学习整理&lt;/h2&gt;&lt;h3 id=&quot;1-HTTPS-连接及握手过程&quot;&gt;&lt;a href=&quot;#1-HTTP</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Jetpack系列—底部导航路由BottomNavigationView原理</title>
    <link href="http://example.com/2022/05/08/Jetpack%E7%B3%BB%E5%88%97%E2%80%94%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86/"/>
    <id>http://example.com/2022/05/08/Jetpack%E7%B3%BB%E5%88%97%E2%80%94%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E8%B7%AF%E7%94%B1%E5%8E%9F%E7%90%86/</id>
    <published>2022-05-07T22:35:47.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>主要介绍BottomNavigationView及其实现原理</p><span id="more"></span><p>bottom_nav_menu.xml 配置底部item的显示内容和个数</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:id</span>=<span class="string">&quot;@+id/nav_host_fragment_activity_main&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:defaultNavHost</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@id/nav_view&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">app:navGraph</span>=<span class="string">&quot;@navigation/mobile_navigation&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">app:</span>defaultNavHost=<span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>是否和系统的返回键相关联</p><p>如果相关联，如果回退栈中有fragment 那么就会拦截返回键  如果没有的话就执行返回键的默认行为</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">app:</span>navGraph=<span class="string">&quot;@navigation/mobile_navigation&quot;</span></span><br></pre></td></tr></table></figure><p>底部路由结构</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">navigation</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/mobile_navigation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:startDestination</span>=<span class="string">&quot;@+id/navigation_home&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;--节点所配置的fragment --&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/navigation_home&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.steve.ppjoke_android.ui.home.HomeFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/title_home&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_home&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/navigation_dashboard&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.steve.ppjoke_android.ui.dashboard.DashboardFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/title_dashboard&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_dashboard&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/navigation_notifications&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.steve.ppjoke_android.ui.notifications.NotificationsFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/title_notifications&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_notifications&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">app:</span>startDestination=<span class="string">&quot;@+id/navigation_home&quot;</span></span><br></pre></td></tr></table></figure><p>默认要显示的页面是哪一个</p><p>通过可视化界面配置fragment</p><p><img src="/../images/image-20220209110225072.png" alt="image-20220209110225072"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/navigation_home&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.steve.ppjoke_android.ui.home.HomeFragment&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;@string/title_home&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_home&quot;</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 当前fragment跳转到下一页的动作，所以必须指定目标页--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/id_action&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:destination</span>=<span class="string">&quot;@id/navigation_dashboard&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--指的是创建当前fragment时需要传递的参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">argument</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;arg1&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:argType</span>=<span class="string">&quot;integer&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--通过url拉起页面，隐式意图  就是页面路由 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">deepLink</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/deepLink&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:uri</span>=<span class="string">&quot;www.imooc.com&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br></pre></td></tr></table></figure><p>先看承载的Fragment的实现逻辑</p><p>NavHostFragment.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="keyword">final</span> Context context = requireContext();</span><br><span class="line"><span class="comment">//切换fragment的能力委托给NavHostController</span></span><br><span class="line">    mNavController = <span class="keyword">new</span> NavHostController(context);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//添加了两个导航器</span></span><br><span class="line">    onCreateNavController(mNavController);</span><br><span class="line"></span><br><span class="line">    Bundle navState = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        navState = savedInstanceState.getBundle(KEY_NAV_CONTROLLER_STATE);</span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState.getBoolean(KEY_DEFAULT_NAV_HOST, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            mDefaultNavHost = <span class="keyword">true</span>;</span><br><span class="line">            getParentFragmentManager().beginTransaction()</span><br><span class="line">                    .setPrimaryNavigationFragment(<span class="keyword">this</span>)</span><br><span class="line">                    .commit();</span><br><span class="line">        &#125;</span><br><span class="line">        mGraphId = savedInstanceState.getInt(KEY_GRAPH_ID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (navState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Navigation controller state overrides arguments</span></span><br><span class="line">        mNavController.restoreState(navState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mGraphId != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Set from onInflate()</span></span><br><span class="line">        mNavController.setGraph(mGraphId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// See if it was set by NavHostFragment.create()</span></span><br><span class="line">        <span class="keyword">final</span> Bundle args = getArguments();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> graphId = args != <span class="keyword">null</span> ? args.getInt(KEY_GRAPH_ID) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> Bundle startDestinationArgs = args != <span class="keyword">null</span></span><br><span class="line">                ? args.getBundle(KEY_START_DESTINATION_ARGS)</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123;</span><br><span class="line">            mNavController.setGraph(graphId, startDestinationArgs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onCreateNavController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreateNavController</span><span class="params">(<span class="meta">@NonNull</span> NavController navController)</span> </span>&#123;</span><br><span class="line">    navController.getNavigatorProvider().addNavigator(</span><br><span class="line">      <span class="comment">//第一个，给dialogframgent提供跳转，切换的能力</span></span><br><span class="line">            <span class="keyword">new</span> DialogFragmentNavigator(requireContext(), getChildFragmentManager()));</span><br><span class="line">  <span class="comment">//第二个，是给fragment提供跳转</span></span><br><span class="line">    navController.getNavigatorProvider().addNavigator(createFragmentNavigator());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>除此之外，还在NavController的构造函数里添加了两个默认的navigator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NavController</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    <span class="keyword">while</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">            mActivity = (Activity) context;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        context = ((ContextWrapper) context).getBaseContext();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//这个导航器的作用是配置的默认启动的页面，启动后会跳转，唯一被用到的地方</span></span><br><span class="line">    mNavigatorProvider.addNavigator(<span class="keyword">new</span> NavGraphNavigator(mNavigatorProvider));</span><br><span class="line">    <span class="comment">//为activity跳转提供支持</span></span><br><span class="line">    mNavigatorProvider.addNavigator(<span class="keyword">new</span> ActivityNavigator(mContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么把navigator添加到provider里呢？</p><p>privoder本质是一个hashmap，存储导航器的实例</p><p>这4个导航器有什么相同点有什么不同点？</p><p>都继承自Navigator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//泛型必须继承NavDestination 而NavDestination就是dialog activity fragment 之所以这么设计泛型，是需要activity的navigator只能创建activity的navigator 而fragment只能创建fragment的导航器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Navigator</span>&lt;<span class="title">D</span> <span class="keyword">extends</span> <span class="title">NavDestination</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment">//1.每一个navigator的子类都必须标注一个Name的注解，只有这样，才会把它添加到provider里，我们之前说provider是一个hashmap 它的key就是我们标注的name的名字，value是navigator的实例本身</span></span><br><span class="line">  <span class="comment">//2.navigator在创建destination的时候,它会解析navigator上的name，以此来得到导航器的名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> Name &#123;</span><br><span class="line">        <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//创建Destination  看下面Destination的构造</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> D <span class="title">createDestination</span><span class="params">()</span></span>;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">//跳转逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> NavDestination <span class="title">navigate</span><span class="params">(<span class="meta">@NonNull</span> D destination, <span class="meta">@Nullable</span> Bundle args,<span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Extras navigatorExtras)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//是否拦截系统的返回键，实现回退栈的操作</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">popBackStack</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">  <span class="comment">//空接口，实现用来做额外的事情，比如过渡元素，转场动画</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Extras</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入一个navigator</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NavDestination</span><span class="params">(<span class="meta">@NonNull</span> Navigator&lt;? extends NavDestination&gt; navigator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(NavigatorProvider.getNameForNavigator(navigator.getClass()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入一个navigatorName 这个name就是通过标注在navigator上面的name的注解得到的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NavDestination</span><span class="params">(<span class="meta">@NonNull</span> String navigatorName)</span> </span>&#123;</span><br><span class="line">    mNavigatorName = navigatorName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么为什么要传入navigatorName呢？</p><p>NavDestination就是我们跳转的一个个页面，我们通过传入的navigatorName在provider这个hashmap中得到destination实例，就是这么得到我们的跳转的实例的</p><p>我们接着看Navigator中的navigate方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//跳转逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> NavDestination <span class="title">navigate</span><span class="params">(<span class="meta">@NonNull</span> D destination, <span class="meta">@Nullable</span> Bundle args,<span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Extras navigatorExtras)</span></span>;</span><br></pre></td></tr></table></figure><p>由于activity fragment dialog的具体跳转方法都不一样，所以，不会交由父类来实现，所以这里是抽象的，使用了模板方法</p><p>Navigator父类了解后，我们来了了解其子类的实现</p><p>ActivityNavigator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//provider中的key的名字就是activity</span></span><br><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;activity&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityNavigator</span> <span class="keyword">extends</span> <span class="title">Navigator</span>&lt;<span class="title">ActivityNavigator</span>.<span class="title">Destination</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Destination <span class="title">setIntent</span><span class="params">(<span class="meta">@Nullable</span> Intent intent)</span> </span>&#123;</span><br><span class="line">      mIntent = intent;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Destination <span class="title">setTargetPackage</span><span class="params">(<span class="meta">@Nullable</span> String packageName)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (mIntent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">      &#125;</span><br><span class="line">      mIntent.setPackage(packageName);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Destination <span class="title">setData</span><span class="params">()</span></span>&#123; ... &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Destination <span class="title">setComponentName</span><span class="params">()</span></span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上面这些类都是为了构造或传入Intent对象</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">          </span><br><span class="line">    <span class="comment">//核心方法navigate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NavDestination <span class="title">navigate</span><span class="params">(<span class="meta">@NonNull</span> Destination destination, <span class="meta">@Nullable</span> Bundle args,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Navigator.Extras navigatorExtras)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//1.获取跳转Intent</span></span><br><span class="line">        <span class="keyword">if</span> (destination.getIntent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Destination &quot;</span> + destination.getId()</span><br><span class="line">                    + <span class="string">&quot; does not have an Intent set.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(destination.getIntent());</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.putExtras(args);</span><br><span class="line">            String dataPattern = destination.getDataPattern();</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(dataPattern)) &#123;</span><br><span class="line">                <span class="comment">// Fill in the data pattern with the args to build a valid URI</span></span><br><span class="line">                StringBuffer data = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                Pattern fillInPattern = Pattern.compile(<span class="string">&quot;\\&#123;(.+?)\\&#125;&quot;</span>);</span><br><span class="line">                Matcher matcher = fillInPattern.matcher(dataPattern);</span><br><span class="line">                <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">                    String argName = matcher.group(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (args.containsKey(argName)) &#123;</span><br><span class="line">                        matcher.appendReplacement(data, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                        <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">                        data.append(Uri.encode(args.get(argName).toString()));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Could not find &quot;</span> + argName + <span class="string">&quot; in &quot;</span></span><br><span class="line">                                + args + <span class="string">&quot; to fill data pattern &quot;</span> + dataPattern);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                matcher.appendTail(data);</span><br><span class="line">                intent.setData(Uri.parse(data.toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// extra 获取额外的flag</span></span><br><span class="line">        <span class="keyword">if</span> (navigatorExtras <span class="keyword">instanceof</span> Extras) &#123;</span><br><span class="line">            Extras extras = (Extras) navigatorExtras;</span><br><span class="line">            intent.addFlags(extras.getFlags());</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//设置intent的跳转的flag</span></span><br><span class="line">        <span class="keyword">if</span> (!(mContext <span class="keyword">instanceof</span> Activity)) &#123;</span><br><span class="line">            <span class="comment">// If we&#x27;re not launching from an Activity context we have to launch in a new task.</span></span><br><span class="line">            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (navOptions != <span class="keyword">null</span> &amp;&amp; navOptions.shouldLaunchSingleTop()) &#123;</span><br><span class="line">            intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//设置跳转的当前页面的hostid 用来做页面溯源</span></span><br><span class="line">        <span class="keyword">if</span> (mHostActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Intent hostIntent = mHostActivity.getIntent();</span><br><span class="line">            <span class="keyword">if</span> (hostIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> hostCurrentId = hostIntent.getIntExtra(EXTRA_NAV_CURRENT, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (hostCurrentId != <span class="number">0</span>) &#123;</span><br><span class="line">                    intent.putExtra(EXTRA_NAV_SOURCE, hostCurrentId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> destId = destination.getId();</span><br><span class="line">        intent.putExtra(EXTRA_NAV_CURRENT, destId);</span><br><span class="line">      <span class="comment">//设置跳转的动画</span></span><br><span class="line">        <span class="keyword">if</span> (navOptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// For use in applyPopAnimationsToPendingTransition()</span></span><br><span class="line">            intent.putExtra(EXTRA_POP_ENTER_ANIM, navOptions.getPopEnterAnim());</span><br><span class="line">            intent.putExtra(EXTRA_POP_EXIT_ANIM, navOptions.getPopExitAnim());</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//使用context.startActivity来进行真正的跳转</span></span><br><span class="line">        <span class="keyword">if</span> (navigatorExtras <span class="keyword">instanceof</span> Extras) &#123;</span><br><span class="line">            Extras extras = (Extras) navigatorExtras;</span><br><span class="line">            ActivityOptionsCompat activityOptions = extras.getActivityOptions();</span><br><span class="line">            <span class="keyword">if</span> (activityOptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ActivityCompat.startActivity(mContext, intent, activityOptions.toBundle());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mContext.startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mContext.startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (navOptions != <span class="keyword">null</span> &amp;&amp; mHostActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> enterAnim = navOptions.getEnterAnim();</span><br><span class="line">            <span class="keyword">int</span> exitAnim = navOptions.getExitAnim();</span><br><span class="line">            <span class="keyword">if</span> (enterAnim != -<span class="number">1</span> || exitAnim != -<span class="number">1</span>) &#123;</span><br><span class="line">                enterAnim = enterAnim != -<span class="number">1</span> ? enterAnim : <span class="number">0</span>;</span><br><span class="line">                exitAnim = exitAnim != -<span class="number">1</span> ? exitAnim : <span class="number">0</span>;</span><br><span class="line">                mHostActivity.overridePendingTransition(enterAnim, exitAnim);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来DialogFragment</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;dialog&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DialogFragmentNavigator</span> <span class="keyword">extends</span>  <span class="title">Navigator</span>&lt;<span class="title">DialogFragmentNavigator</span>.<span class="title">Destination</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//同样的创建，传入navigator通过navigator来取出它的名字</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Destination <span class="title">createDestination</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Destination(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//设置className</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Destination <span class="title">setClassName</span><span class="params">(<span class="meta">@NonNull</span> String className)</span> </span>&#123;</span><br><span class="line">      mClassName = className;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//核心跳转navigate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NavDestination <span class="title">navigate</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Destination destination, <span class="meta">@Nullable</span> Bundle args,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Navigator.Extras navigatorExtras)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mFragmentManager.isStateSaved()) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Ignoring navigate() call: FragmentManager has already&quot;</span></span><br><span class="line">                    + <span class="string">&quot; saved its state&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String className = destination.getClassName();</span><br><span class="line">      <span class="comment">//1.获取classname 全类名</span></span><br><span class="line">        <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">            className = mContext.getPackageName() + className;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//2.通过classname 反射构造一个fragment的对象  instantiate这个方法</span></span><br><span class="line">        <span class="keyword">final</span> Fragment frag = mFragmentManager.getFragmentFactory().instantiate(</span><br><span class="line">                mContext.getClassLoader(), className);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//3.如果不是dialogfragment的子类，就抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (!DialogFragment.class.isAssignableFrom(frag.getClass())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Dialog destination &quot;</span> + destination.getClassName()</span><br><span class="line">                    + <span class="string">&quot; is not an instance of DialogFragment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//4.强转成DialogFragment</span></span><br><span class="line">        <span class="keyword">final</span> DialogFragment dialogFragment = (DialogFragment) frag;</span><br><span class="line">        dialogFragment.setArguments(args);</span><br><span class="line">        dialogFragment.getLifecycle().addObserver(mObserver);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//5.通过show方法就把dialogfragment展示出来</span></span><br><span class="line">        dialogFragment.show(mFragmentManager, DIALOG_TAG + mDialogCount++);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> destination;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来看FragmentNavigator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;fragment&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentNavigator</span> <span class="keyword">extends</span> <span class="title">Navigator</span>&lt;<span class="title">FragmentNavigator</span>.<span class="title">Destination</span>&gt; </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Destination <span class="title">createDestination</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Destination(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@NavDestination</span>.ClassType(Fragment.class)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Destination</span> <span class="keyword">extends</span> <span class="title">NavDestination</span> </span>&#123;</span><br><span class="line">      <span class="comment">//同上，设置全类名</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Destination <span class="title">setClassName</span><span class="params">(<span class="meta">@NonNull</span> String className)</span> </span>&#123;</span><br><span class="line">            mClassName = className;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> NavDestination <span class="title">navigate</span><span class="params">(<span class="meta">@NonNull</span> Destination destination, <span class="meta">@Nullable</span> Bundle args,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Navigator.Extras navigatorExtras)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mFragmentManager.isStateSaved()) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Ignoring navigate() call: FragmentManager has already&quot;</span></span><br><span class="line">                    + <span class="string">&quot; saved its state&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//1.通过destination获取classname 全类名</span></span><br><span class="line">        String className = destination.getClassName();</span><br><span class="line">        <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">            className = mContext.getPackageName() + className;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//2.实例化一个fragment对象，并设置arguments</span></span><br><span class="line">        <span class="keyword">final</span> Fragment frag = instantiateFragment(mContext, mFragmentManager,</span><br><span class="line">                className, args);</span><br><span class="line">        frag.setArguments(args);</span><br><span class="line">      <span class="comment">//3.得到Transaction对象</span></span><br><span class="line">        <span class="keyword">final</span> FragmentTransaction ft = mFragmentManager.beginTransaction();</span><br><span class="line"><span class="comment">//跳转动画</span></span><br><span class="line">        <span class="keyword">int</span> enterAnim = navOptions != <span class="keyword">null</span> ? navOptions.getEnterAnim() : -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> exitAnim = navOptions != <span class="keyword">null</span> ? navOptions.getExitAnim() : -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> popEnterAnim = navOptions != <span class="keyword">null</span> ? navOptions.getPopEnterAnim() : -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> popExitAnim = navOptions != <span class="keyword">null</span> ? navOptions.getPopExitAnim() : -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (enterAnim != -<span class="number">1</span> || exitAnim != -<span class="number">1</span> || popEnterAnim != -<span class="number">1</span> || popExitAnim != -<span class="number">1</span>) &#123;</span><br><span class="line">            enterAnim = enterAnim != -<span class="number">1</span> ? enterAnim : <span class="number">0</span>;</span><br><span class="line">            exitAnim = exitAnim != -<span class="number">1</span> ? exitAnim : <span class="number">0</span>;</span><br><span class="line">            popEnterAnim = popEnterAnim != -<span class="number">1</span> ? popEnterAnim : <span class="number">0</span>;</span><br><span class="line">            popExitAnim = popExitAnim != -<span class="number">1</span> ? popExitAnim : <span class="number">0</span>;</span><br><span class="line">            ft.setCustomAnimations(enterAnim, exitAnim, popEnterAnim, popExitAnim);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//4.通过replace跳转，这种方式不好，会告诉页面生命周期重启，需要自己再构建一个使用hide和show的FragmentNavigator</span></span><br><span class="line">        ft.replace(mContainerId, frag);</span><br><span class="line">        ft.setPrimaryNavigationFragment(frag);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="meta">@IdRes</span> <span class="keyword">int</span> destId = destination.getId();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> initialNavigation = mBackStack.isEmpty();</span><br><span class="line">        <span class="comment">// TODO Build first class singleTop behavior for fragments</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isSingleTopReplacement = navOptions != <span class="keyword">null</span> &amp;&amp; !initialNavigation</span><br><span class="line">                &amp;&amp; navOptions.shouldLaunchSingleTop()</span><br><span class="line">                &amp;&amp; mBackStack.peekLast() == destId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isAdded;</span><br><span class="line">        <span class="keyword">if</span> (initialNavigation) &#123;</span><br><span class="line">            isAdded = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSingleTopReplacement) &#123;</span><br><span class="line">            <span class="comment">// Single Top means we only want one instance on the back stack</span></span><br><span class="line">            <span class="keyword">if</span> (mBackStack.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// If the Fragment to be replaced is on the FragmentManager&#x27;s</span></span><br><span class="line">                <span class="comment">// back stack, a simple replace() isn&#x27;t enough so we</span></span><br><span class="line">                <span class="comment">// remove it from the back stack and put our replacement</span></span><br><span class="line">                <span class="comment">// on the back stack in its place</span></span><br><span class="line">                mFragmentManager.popBackStack(</span><br><span class="line">                        generateBackStackName(mBackStack.size(), mBackStack.peekLast()),</span><br><span class="line">                        FragmentManager.POP_BACK_STACK_INCLUSIVE);</span><br><span class="line">                ft.addToBackStack(generateBackStackName(mBackStack.size(), destId));</span><br><span class="line">            &#125;</span><br><span class="line">            isAdded = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ft.addToBackStack(generateBackStackName(mBackStack.size() + <span class="number">1</span>, destId));</span><br><span class="line">            isAdded = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (navigatorExtras <span class="keyword">instanceof</span> Extras) &#123;</span><br><span class="line">            Extras extras = (Extras) navigatorExtras;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;View, String&gt; sharedElement : extras.getSharedElements().entrySet()) &#123;</span><br><span class="line">                ft.addSharedElement(sharedElement.getKey(), sharedElement.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ft.setReorderingAllowed(<span class="keyword">true</span>);</span><br><span class="line">        ft.commit();</span><br><span class="line">        <span class="comment">// The commit succeeded, update our view of the world</span></span><br><span class="line">        <span class="keyword">if</span> (isAdded) &#123;</span><br><span class="line">            mBackStack.add(destId);</span><br><span class="line">            <span class="keyword">return</span> destination;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后来看NavGraphNavigator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;navigation&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NavGraphNavigator</span> <span class="keyword">extends</span> <span class="title">Navigator</span>&lt;<span class="title">NavGraph</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//这里没有new Destination对象，而是new了一个NavGraph,传入Navigator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NavGraph <span class="title">createDestination</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NavGraph(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NavGraph.java</p><p>是NavDestination的子类，是特殊的子类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NavGraph</span> <span class="keyword">extends</span> <span class="title">NavDestination</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">NavDestination</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//node数组，这里就是存储了一个个跳转节点的的实例，也就是我们在 mobile_navigation.xml中声明的一个个fragment activity实例，都会被存储到mNodes中</span></span><br><span class="line">    <span class="keyword">final</span> SparseArrayCompat&lt;NavDestination&gt; mNodes = <span class="keyword">new</span> SparseArrayCompat&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//这个就是对应mobile_navigation.xml中指定的app:startDestination=&quot;@+id/navigation_dashboard&quot; 而一旦xml被解析，这里就获取到我们指定的页面id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mStartDestId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么又是在哪里解析的，什么时候解析的呢？</p><p>还记得我们上面的宿主fragment NavHostFragment 我们在oncreate中创建了NavHostController</p><p>我们看下Controller中的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NavController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGraph</span><span class="params">(<span class="meta">@NavigationRes</span> <span class="keyword">int</span> graphResId)</span> </span>&#123;</span><br><span class="line">        setGraph(graphResId, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGraph</span><span class="params">(<span class="meta">@NavigationRes</span> <span class="keyword">int</span> graphResId, <span class="meta">@Nullable</span> Bundle startDestinationArgs)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//调用navinflater的inflate方法来解析xml文件</span></span><br><span class="line">        setGraph(getNavInflater().inflate(graphResId), startDestinationArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个inflate方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> NavGraph <span class="title">inflate</span><span class="params">(<span class="meta">@NavigationRes</span> <span class="keyword">int</span> graphResId)</span> </span>&#123;</span><br><span class="line">    Resources res = mContext.getResources();</span><br><span class="line">  <span class="comment">//1.获取xml parser来解析xml文件</span></span><br><span class="line">    XmlResourceParser parser = res.getXml(graphResId);</span><br><span class="line">  <span class="comment">//2.获取属性</span></span><br><span class="line">    <span class="keyword">final</span> AttributeSet attrs = Xml.asAttributeSet(parser);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            <span class="comment">// Empty loop</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> XmlPullParserException(<span class="string">&quot;No start tag found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String rootElement = parser.getName();</span><br><span class="line">      <span class="comment">//3.实际上是另一个inflate方法来解析构造出的具体的NavDestion对象  这里主要通过parser获取标签名，再通过name 在provider中拿到navigator 再通过navigator来创建各自的navigation</span></span><br><span class="line">        NavDestination destination = inflate(res, parser, attrs, graphResId);</span><br><span class="line">        <span class="keyword">if</span> (!(destination <span class="keyword">instanceof</span> NavGraph)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Root element &lt;&quot;</span> + rootElement + <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">                    + <span class="string">&quot; did not inflate into a NavGraph&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (NavGraph) destination;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="comment">//也就是说我们在编写mobile_navigation.xml中的根节点必须是navigation 否则解析后会抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Exception inflating &quot;</span></span><br><span class="line">                + res.getResourceName(graphResId) + <span class="string">&quot; line &quot;</span></span><br><span class="line">                + parser.getLineNumber(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        parser.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过navigator来创建具体的跳转navigation实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> NavDestination <span class="title">inflate</span><span class="params">(<span class="meta">@NonNull</span> Resources res, <span class="meta">@NonNull</span> XmlResourceParser parser,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> AttributeSet attrs, <span class="keyword">int</span> graphResId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">  <span class="comment">//1.通过provider获取具体的navigator对象 parser.getName 得到的就是标签的名fragment dialog activity</span></span><br><span class="line">    Navigator&lt;?&gt; navigator = mNavigatorProvider.getNavigator(parser.getName());</span><br><span class="line">  <span class="comment">//2.得到navigator后，就通过调用 createDestination方法来得到创建NavDestination 最后也是返回的是这个dest</span></span><br><span class="line">    <span class="keyword">final</span> NavDestination dest = navigator.createDestination();</span><br><span class="line"></span><br><span class="line">    dest.onInflate(mContext, attrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth() + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">int</span> depth;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; ((depth = parser.getDepth()) &gt;= innerDepth</span><br><span class="line">            || type != XmlPullParser.END_TAG)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (depth &gt; innerDepth) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String name = parser.getName();</span><br><span class="line">      <span class="comment">//3.中间解析各个子标签</span></span><br><span class="line">      <span class="comment">//如查是argument标签，就把argument数据inflate到destination中</span></span><br><span class="line">        <span class="keyword">if</span> (TAG_ARGUMENT.equals(name)) &#123;</span><br><span class="line">            inflateArgumentForDestination(res, dest, attrs, graphResId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_DEEP_LINK.equals(name)) &#123;</span><br><span class="line">          <span class="comment">//如果是deeplink 就把信息inflate到destination</span></span><br><span class="line">            inflateDeepLink(res, dest, attrs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_ACTION.equals(name)) &#123;</span><br><span class="line">          <span class="comment">//如果是action就把信息infalte到destinatioin中的actioin中</span></span><br><span class="line">            inflateAction(res, dest, attrs, parser, graphResId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.equals(name) &amp;&amp; dest <span class="keyword">instanceof</span> NavGraph) &#123;</span><br><span class="line">            <span class="keyword">final</span> TypedArray a = res.obtainAttributes(</span><br><span class="line">                    attrs, androidx.navigation.R.styleable.NavInclude);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> id = a.getResourceId(</span><br><span class="line">                    androidx.navigation.R.styleable.NavInclude_graph, <span class="number">0</span>);</span><br><span class="line">            ((NavGraph) dest).addDestination(inflate(id));</span><br><span class="line">            a.recycle();</span><br><span class="line">          <span class="comment">//如查是NavGraph </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dest <span class="keyword">instanceof</span> NavGraph) &#123;</span><br><span class="line">          <span class="comment">//就递归去调用 inflate解析子标签，然后把子标签生成的destinatioin加入到NavGraph的mNodes中去</span></span><br><span class="line">            ((NavGraph) dest).addDestination(inflate(res, parser, attrs, graphResId));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解析完Navgraph后，把graph和controller相关联</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGraph</span><span class="params">(<span class="meta">@NonNull</span> NavGraph graph, <span class="meta">@Nullable</span> Bundle startDestinationArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGraph != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Pop everything from the old graph off the back stack</span></span><br><span class="line">        popBackStackInternal(mGraph.getId(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//把graph 赋值给controller中的mGraph变量</span></span><br><span class="line">    mGraph = graph;</span><br><span class="line">  <span class="comment">//这里就会把默认显示的页面给打开</span></span><br><span class="line">    onGraphCreated(startDestinationArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回头看看NavGraphNavigator.java 的navigate方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> NavDestination <span class="title">navigate</span><span class="params">(<span class="meta">@NonNull</span> NavGraph destination, <span class="meta">@Nullable</span> Bundle args,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Extras navigatorExtras)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//拿到默认展示页面的id</span></span><br><span class="line">    <span class="keyword">int</span> startId = destination.getStartDestination();</span><br><span class="line">    <span class="keyword">if</span> (startId == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;no start destination defined via&quot;</span></span><br><span class="line">                + <span class="string">&quot; app:startDestination for &quot;</span></span><br><span class="line">                + destination.getDisplayName());</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//有这个id后，就能拿到默认展示页面的destination对象</span></span><br><span class="line">    NavDestination startDestination = destination.findNode(startId, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (startDestination == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String dest = destination.getStartDestDisplayName();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;navigation destination &quot;</span> + dest</span><br><span class="line">                + <span class="string">&quot; is not a direct child of this NavGraph&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//然后通过name在provider中拿到navigator 这个navigator可能是fragmentnavigator activitynavigator dialognavigator</span></span><br><span class="line">    Navigator&lt;NavDestination&gt; navigator = mNavigatorProvider.getNavigator(</span><br><span class="line">            startDestination.getNavigatorName());</span><br><span class="line">  <span class="comment">//执行具体的navigator的naigate方法把默认页面启动起来</span></span><br><span class="line">    <span class="keyword">return</span> navigator.navigate(startDestination, startDestination.addInDefaultArgs(args),</span><br><span class="line">            navOptions, navigatorExtras);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Navigation各类之间的关系</p><p><img src="/../images/image-20220209144442113.png" alt="image-20220209144442113"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;主要介绍BottomNavigationView及其实现原理&lt;/p&gt;</summary>
    
    
    
    <category term="Jetpack系列" scheme="http://example.com/categories/Jetpack%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Android" scheme="http://example.com/tags/Android/"/>
    
    <category term="Jetpack" scheme="http://example.com/tags/Jetpack/"/>
    
  </entry>
  
  <entry>
    <title>Gradle基础</title>
    <link href="http://example.com/2022/04/16/Gradle%E5%9F%BA%E7%A1%80/"/>
    <id>http://example.com/2022/04/16/Gradle%E5%9F%BA%E7%A1%80/</id>
    <published>2022-04-15T22:35:47.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>讲解Gradle基础知识，语法及生命周期</p><span id="more"></span><h2 id="Gradle-基础"><a href="#Gradle-基础" class="headerlink" title="Gradle 基础"></a>Gradle 基础</h2><p>使用 .&#x2F;gradlew clean -q 来过滤只显示我们的自己的输出日志</p><h3 id="一-语法"><a href="#一-语法" class="headerlink" title="一 语法"></a>一 语法</h3><h4 id="1-1-基础语法"><a href="#1-1-基础语法" class="headerlink" title="1.1 基础语法"></a>1.1 基础语法</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">10</span></span><br><span class="line"><span class="keyword">def</span> b = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">String str = <span class="string">&quot;Hello,&quot;</span> + <span class="string">&quot;World&quot;</span></span><br><span class="line">String str2 = str.toUpperCase()</span><br><span class="line"></span><br><span class="line"><span class="comment">//列表</span></span><br><span class="line"><span class="keyword">def</span> array = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">array.add(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">array.each&#123;<span class="comment">//闭包特性，只有一个参数默认为it 可以省略 it -&gt; 不写</span></span><br><span class="line">  println(<span class="string">&quot;each item is $it&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//映射表</span></span><br><span class="line"><span class="keyword">def</span> map = [<span class="string">&quot;name&quot;</span>:<span class="string">&quot;mooc&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="string">&quot;100&quot;</span>]</span><br><span class="line">println(<span class="string">&quot;age is $&#123;map[&quot;</span>age<span class="string">&quot;]&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">  println(<span class="string">&quot;i is $i&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数</span></span><br><span class="line"><span class="keyword">def</span> hello(String name)&#123;</span><br><span class="line">  println(<span class="string">&quot;Hello, $name&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-DSL"><a href="#1-2-DSL" class="headerlink" title="1.2 DSL"></a>1.2 DSL</h4><ul><li>Domain Specific Language</li><li>领域专用语言</li></ul><p>只能用于构建，不能干别的，所以说是领域专用语言</p><p>这个是android build.gradle 的DSL</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">30</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;30.0.3&quot;</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.steve.gradle_study&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">21</span></span><br><span class="line">        targetSdkVersion <span class="number">30</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner <span class="string">&quot;androidx.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        jvmTarget = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3-闭包"><a href="#1-3-闭包" class="headerlink" title="1.3 闭包"></a>1.3 闭包</h4><p>DSL的实现是基于groovy中的闭包实现的</p><ul><li>开放匿名的代码块，可以接受参数，具有返回值，也可以被分配给变量</li><li>定义规则:<em>{ [params -&gt; ] statements }</em></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> c = &#123;</span><br><span class="line">    println(<span class="string">&quot;hello closure&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> c2 = &#123; it  -&gt; println (<span class="string">&quot;it is $it&quot;</span>)&#125;</span><br><span class="line">c2(<span class="string">&quot;yt&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> c3 = &#123;  println (<span class="string">&quot;it is $it&quot;</span>)&#125;</span><br><span class="line">c3(<span class="string">&quot;yt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> c4 = &#123; name,age -&gt;</span><br><span class="line">    println (<span class="string">&quot;name is $name&quot;</span>)</span><br><span class="line">    println (<span class="string">&quot;age is $age&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">c4(<span class="string">&quot;wwww&quot;</span>,<span class="number">33</span>)</span><br></pre></td></tr></table></figure><h4 id="1-4-实现自己的DSL"><a href="#1-4-实现自己的DSL" class="headerlink" title="1.4 实现自己的DSL"></a>1.4 实现自己的DSL</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    defaultConfig&#123;</span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用户配置成这样，我们怎么能取到对应的配置的值，使用对象关联起来</p><p>里面的defaultconfig 闭包对应的对象</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefalutConfig</span>&#123;</span></span><br><span class="line">    <span class="keyword">private</span> String versionName</span><br><span class="line">    <span class="keyword">def</span> versionName(String versionName)&#123;</span><br><span class="line">        <span class="built_in">this</span>.versionName = versionName</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>外面的android 闭包对应的对象</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Android</span>&#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> compileSdkVersion</span><br><span class="line">    <span class="keyword">private</span> DefalutConfig defalutConfig</span><br><span class="line"></span><br><span class="line">    Android()&#123;</span><br><span class="line">        <span class="built_in">this</span>.defalutConfig = <span class="keyword">new</span> DefalutConfig()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> compileSdkVersion(<span class="keyword">int</span> compileSdkVersion)&#123;</span><br><span class="line">        <span class="built_in">this</span>.compileSdkVersion =compileSdkVersion</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//传入一个闭包，接收到闭包后跟我们的DefaultConfig成员变量关联起来</span></span><br><span class="line">    <span class="keyword">def</span> defaultConfig(Closure closure)&#123;</span><br><span class="line">      <span class="comment">//关联之后，对象就获到到闭包中对应同名的值了</span></span><br><span class="line">        closure.setDelegate(defalutConfig)</span><br><span class="line">        closure.call()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> myAndroid = &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    defaultConfig&#123;</span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Android a = <span class="keyword">new</span> Android()</span><br><span class="line"><span class="comment">//将闭包与具体对象关联起来，这样在闭包中设置的值就到了对象a中了，我们可以打印a 获取a中的值</span></span><br><span class="line">myAndroid.delegate = a</span><br><span class="line">myAndroid.call()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./graldew clean -q</span><br></pre></td></tr></table></figure><h3 id="二-Gradle构建脚本基础"><a href="#二-Gradle构建脚本基础" class="headerlink" title="二 Gradle构建脚本基础"></a>二 Gradle构建脚本基础</h3><p>几个关键的文件</p><ul><li><strong>settings.gradle</strong>—定义全局参与构建的模块</li><li><strong>build.gradle</strong>—有两类build.gradle文件，一个是全局的定义共用参数，各个单独的定义自己的配置 </li><li><strong>gradle.properties</strong>—定义开关型参数的文件</li></ul><h3 id="三-Gradle构建的生命周期"><a href="#三-Gradle构建的生命周期" class="headerlink" title="三 Gradle构建的生命周期"></a>三 Gradle构建的生命周期</h3><ul><li><strong>初始化阶段</strong>—收集所有要参与构建的子工程，创建一个项目层次结构，并且为每一个项目创建一个project实例，和这个阶段关系最大的就是我们的settings.gradle文件</li><li>配置阶段—执行各个子工程自己的build.gradle，对project进行配置，并且根据配置形成一个任务依赖链，以便在下一个阶段执行阶段，方便执行任务</li><li>执行阶段—执行上一阶段的tasks</li></ul><p>我们在settings.gradle中添加生命周期的监听函数</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加构建的生命周期</span></span><br><span class="line">gradle.addBuildListener(<span class="keyword">new</span> BuildAdapter()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">        <span class="built_in">super</span>.settingsEvaluated(settings)</span><br><span class="line">        println (<span class="string">&quot;[life-cycle] 初始化阶段完成&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line">        <span class="built_in">super</span>.projectsEvaluated(gradle)</span><br><span class="line">        println (<span class="string">&quot;[life-cycle] 配置阶段完成&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> buildFinished(BuildResult result) &#123;</span><br><span class="line">        <span class="built_in">super</span>.buildFinished(result)</span><br><span class="line">        println (<span class="string">&quot;[life-cycle] 构建结束&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>打印结果</p><p><img src="/../images/image-20220209051751641.png" alt="image-20220209051751641"></p><p>几个主要角色</p><ul><li><strong>初始化阶段</strong>-root project</li><li><strong>配置阶段</strong>-project</li><li><strong>执行阶段</strong>-task</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;讲解Gradle基础知识，语法及生命周期&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Jetpack系列—LiveData原理解析</title>
    <link href="http://example.com/2022/03/20/Jetpack%E7%B3%BB%E5%88%97%E2%80%94LiveData/"/>
    <id>http://example.com/2022/03/20/Jetpack%E7%B3%BB%E5%88%97%E2%80%94LiveData/</id>
    <published>2022-03-20T10:43:51.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>什么是<code>LiveData</code></li><li><code>LiveData</code>几种衍生类</li><li><code>LiveData</code>核心方法</li><li><code>LiveData</code>实现原理</li></ul><h2 id="1-什么是LiveData"><a href="#1-什么是LiveData" class="headerlink" title="1.什么是LiveData"></a>1.什么是LiveData</h2><ul><li><code>LiveData</code>组件是<code>Jetpack</code>新推出的基于观察者的消息订阅&#x2F;分发组件，具有宿主(<code>Activity</code>&#x2F;<code>Fragment</code>)生命周期感知能力，这种感知能力可确保<code>LiveData</code>仅分发消息给处于<code>活跃状态</code>的观察者，即只有处于<code>活跃状态</code>的观察者才能收到消息</li><li><code>LiveData</code>的消息分发机制，是以往的<code>Handler</code>，<code>EventBus</code>，<code>RxJavaBus</code>无法比拟的，它们不会顾及当前页面是否可见，一股脑的有消息就转发。导致即便应用在后台，页面不可见，还在做一些无用的绘制，计算(细心的同学可以发现微信消息列表是在可见状态时才会更新列表最新信息的)</li></ul><blockquote><p>活跃状态：<code>Observer</code>所在宿主处于<code>started</code>,<code>resumed</code>状态    </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppcompactActivity</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span></span>&#123;</span><br><span class="line">    <span class="meta">@Ovderride</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span></span>&#123;</span><br><span class="line">      <span class="comment">//无论页面可见不可见，都会去执行页面刷新,IO。更有甚者弹出对话框</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//1.无论当前页面是否可见，这条消息都会被分发。——消耗资源</span></span><br><span class="line">  <span class="comment">//2.无论前宿主是否还存活，这条消息都会被分发。——内存泄漏</span></span><br><span class="line">  handler.sendMessage(msg);</span><br><span class="line"></span><br><span class="line">  liveData.observer(<span class="keyword">this</span>,<span class="keyword">new</span> Observer&lt;User&gt;)&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//1.减少资源占用 —— 页面不可见时不会派发消息</span></span><br><span class="line">  <span class="comment">//2.确保页面始终保持最新状态——页面可见时，会立刻派发新新的一条消息给所有观察者——保证页面最新状态</span></span><br><span class="line">  <span class="comment">//3.不再需要手动处理生命周期——避免NPE</span></span><br><span class="line">  <span class="comment">//4.livedata默认是不能跨页面使用的，但是我们有办法，可以打造一款不用反注册，不会内存泄漏的消息总线——取代eventbus</span></span><br><span class="line">liveData.postValue(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-LiveData的几种用法"><a href="#2-LiveData的几种用法" class="headerlink" title="2.LiveData的几种用法"></a>2.LiveData的几种用法</h2><h3 id="2-1-MutableLiveData"><a href="#2-1-MutableLiveData" class="headerlink" title="2.1 MutableLiveData"></a>2.1 MutableLiveData</h3><p>我们在使用LiveData在做消息分发的时候，需要使用这个子类。之所以这么设计，是考虑到单一开闭原则，只有拿到MutableLiveData对象才可以发送消息，LiveData对象只能接收消息，避免拿到LiveData对象时既能发消息也能收到消息的混乱使用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.postValue(value);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.setValue(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-MediatorLiveData"><a href="#2-2-MediatorLiveData" class="headerlink" title="2.2 MediatorLiveData"></a>2.2 MediatorLiveData</h3><ul><li>可以统一观察多个LiveData的发射的数据进行统一的处理</li><li>同时也可以做为一个LiveData，被其他Observer观察。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建两个长的差不多的LiveData对象</span></span><br><span class="line">LiveData&lt;Integer&gt; liveData1 = <span class="keyword">new</span> MutableLiveData();</span><br><span class="line">LiveData&lt;Integer&gt; liveData2 = <span class="keyword">new</span> MutableLiveData();</span><br><span class="line"></span><br><span class="line"><span class="comment">//再创建一个聚合类MediatorLiveData</span></span><br><span class="line">MediatorLiveData&lt;Integer&gt; liveDataMerger = <span class="keyword">new</span> MediatorLiveData();</span><br><span class="line"><span class="comment">//分别把上面创建的LiveData添加进来</span></span><br><span class="line">liveDataMerger.addSource(liveData1,observer);</span><br><span class="line">liveDataMerger.addSource(liveData2,observer);</span><br><span class="line"></span><br><span class="line">Observer observer = <span class="keyword">new</span> Observer&lt;Integer&gt;&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(<span class="meta">@Nullable</span> Integer s)</span></span>&#123;</span><br><span class="line">    titleTextView.setText(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//一旦liveData1或者liveData2发送了新的数据，observer便能观察到，以便统一处理更新UI</span></span><br></pre></td></tr></table></figure><h3 id="2-3-Transformations-map-操作符"><a href="#2-3-Transformations-map-操作符" class="headerlink" title="2.3 Transformations.map 操作符"></a>2.3 Transformations.map 操作符</h3><p>可以对liveData进行变化，并且返回一个新的livedata对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MutableLiveData&lt;Integer&gt; data = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据转换</span></span><br><span class="line">LiveData&lt;String&gt; transformData = Transformations.map(data,input -&gt; String.valueOf(input));</span><br><span class="line"><span class="comment">//使用转换后生成的transformData去观察数据</span></span><br><span class="line">transformData.observe(<span class="keyword">this</span>,output -&gt; &#123;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用原始的livedata发送数据</span></span><br><span class="line">data.setValue(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h2 id="3-LiveData核心方法"><a href="#3-LiveData核心方法" class="headerlink" title="3.LiveData核心方法"></a>3.LiveData核心方法</h2><table><thead><tr><th>方法名</th><th>作用</th></tr></thead><tbody><tr><td>observe(LifecycleOwner owner,Observer observer)</td><td>注册和宿主生命周期关联的观察者</td></tr><tr><td>observeForever(Observer observer)</td><td>注册观察者，不会反注册，需要自行维护</td></tr><tr><td>setValue(T data)</td><td>发送数据，没有活跃的观察者时不会分发。只能在主线程。</td></tr><tr><td>postValue(T data)</td><td>和setValue一样。不受线程环境限制。</td></tr><tr><td>onActive</td><td>当且仅当有一个活跃的观察者时会触发</td></tr><tr><td>inActive</td><td>不存在活跃的观察者时会触发</td></tr></tbody></table><h2 id="4-LiveData实现原理"><a href="#4-LiveData实现原理" class="headerlink" title="4.LiveData实现原理"></a>4.LiveData实现原理</h2><p><img src="/../images/image-20220514110449881.png" alt="image-20220514110449881"></p><p><img src="/../images/image-20220514111210613.png" alt="image-20220514111210613"></p><p><code>LiveData</code>使用的有很多好处</p><ul><li>确保<code>UI</code>符合数据状态</li><li>不需要手动处理生命周期</li><li>始终保持最新的数据</li><li>事件总线<code>LiveDataBus</code></li></ul><p><strong>确保UI符合数据状态</strong></p><p>因为<code>livedata</code>实现了观察者模式 它里面的数据发生变化的时候，会向注册的<code>Observer</code>观察者发送通知，这时可以在观察者的<code>onChanged</code>里面更改UI 以保持数据的最新化</p><p><strong>不需要手动处理生命周期</strong></p><p>在注册<code>observe</code>的时候，会将当前宿主的生命周期进行绑定，当宿主被销毁时，就自动的进行销毁</p><p><strong>始终保持最新的数据</strong></p><p>可以这么理解，当宿主的生命周期变为非活跃状态的时候，那么它将在再次变为活跃状态的时候，接收到最新的数据，比如<code>activity</code> 从前台返回到后台，再从后台返回前台。再比如<code>actvity</code>和<code>fragment</code>由于配置的更改，而重新创建，也是能够接收到最新可用的数据，来保持最新的数据和UI</p><p>事件总线<code>LiveDataBus</code></p><p>使用<code>livedata</code>来实现消息总线，替代使用<code>eventbus</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//有参数构造 mVersion = 0  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LiveData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    mData = value;</span><br><span class="line">    mVersion = START_VERSION + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//无参数构造，mVersion = -1  mData = NOT_SET</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LiveData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mData = NOT_SET;</span><br><span class="line">    mVersion = START_VERSION;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么为什么<code>livedata</code>需要一个<code>version</code>呢？</p><p>因为<code>livedata</code>通过<code>version</code>来控制数据分发，通过<code>mVersion</code>来进行数据的比对，本次是否需要进行数据的分发，因为不能<code>livedata</code>发送一次数据，而observable能接收到2，3次数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//把宿主和observer进行绑定</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;observe&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//把lifecycle 和 observer包装成了一个LifecycleBoundObserver，也就是一个有边界的的observer</span></span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">  <span class="comment">//包装完后，把wrapper放入一个hashmap里</span></span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//注意这里传入的是包装后的wrapper  lifecycleboundobserver</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过observe可以向livedata注册一个观察者对象</p><p>owner.getLifecycle().addObserver(wrapper) 进入 会进行到实现</p><p>LifecycleRegistry.addObserver(observer)方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>);</span><br><span class="line">  <span class="comment">//判断当前宿主的生命周期状态</span></span><br><span class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">  <span class="comment">//判断完后，会把当前宿主的生命周期和观察者进行包装</span></span><br><span class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">  <span class="comment">//包装完成后也会存储到hashmap里</span></span><br><span class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//为什么要再进行这么包装呢？主要是为了分发当前宿主的生命周期状态给每个observer</span></span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</span><br><span class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// it is null we should be destroyed. Fallback quickly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</span><br><span class="line">    State targetState = calculateTargetState(observer);</span><br><span class="line">    mAddingObserverCounter++;</span><br><span class="line">    <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">        pushParentState(statefulObserver.mState);</span><br><span class="line">        <span class="keyword">final</span> Event event = Event.upFrom(statefulObserver.mState);</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;no event up from &quot;</span> + statefulObserver.mState);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//分发宿主的生命周期状态 给observer</span></span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">        popParentState();</span><br><span class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">        targetState = calculateTargetState(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">    State newState = event.getTargetState();</span><br><span class="line">    mState = min(mState, newState);</span><br><span class="line">  <span class="comment">//这个lifecycleobserver就是我们传递进来的lifecyclebounderobserver</span></span><br><span class="line">    mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">    mState = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个接口是 LifecycleEventObserver的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleEventObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line"><span class="comment">//这个回调的是宿主生命周期的变化  有两个参数，一个是宿主 一个是Event</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source, <span class="meta">@NonNull</span> Lifecycle.Event event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onCreate event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_CREATE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onStart event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_START,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onResume event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_RESUME,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onPause event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_PAUSE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onStop event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_STOP,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constant for onDestroy event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_DESTROY,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An &#123;<span class="doctag">@link</span> Event Event&#125; constant that can be used to match all events.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ON_ANY;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>宿主的每个生命周期的改变都会回调到onStateChanged</p><p>我们看下它的实现 LifecycleBoundObserver 实现了LifecycleEventObserver</p><p>LifecycleBoundObserver.onStateChanged</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    Lifecycle.State currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">  <span class="comment">//如果当前状态是destroyed</span></span><br><span class="line">    <span class="keyword">if</span> (currentState == DESTROYED) &#123;</span><br><span class="line">      <span class="comment">//自行移除，自行反注册这个observer</span></span><br><span class="line">        removeObserver(mObserver);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Lifecycle.State prevState = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (prevState != currentState) &#123;</span><br><span class="line">        prevState = currentState;</span><br><span class="line">      <span class="comment">//否则就执行活跃状态的变更 看shouldBeActive方法</span></span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">        currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里判断了只有宿主的生命周期大于start的时候  才代表宿主是活跃的</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续看activeStateChanged</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    mActive = newActive;</span><br><span class="line">    changeActiveCounter(mActive ? <span class="number">1</span> : -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">        dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">changeActiveCounter</span><span class="params">(<span class="keyword">int</span> change)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> previousActiveCount = mActiveCount;</span><br><span class="line">    mActiveCount += change;</span><br><span class="line">    <span class="keyword">if</span> (mChangingActiveState) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mChangingActiveState = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (previousActiveCount != mActiveCount) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> needToCallActive = previousActiveCount == <span class="number">0</span> &amp;&amp; mActiveCount &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">boolean</span> needToCallInactive = previousActiveCount &gt; <span class="number">0</span> &amp;&amp; mActiveCount == <span class="number">0</span>;</span><br><span class="line">            previousActiveCount = mActiveCount;</span><br><span class="line">            <span class="keyword">if</span> (needToCallActive) &#123;<span class="comment">//首次注册会执行onActive </span></span><br><span class="line">                onActive();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (needToCallInactive) &#123;<span class="comment">//当最后一个观察者被移除时，会执行onInactive</span></span><br><span class="line">                onInactive();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mChangingActiveState = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//可以初始化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//可以反注册，释放资源，清理   paging就利用了这里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看 传入true 执行dispatchingValue 把当前的observer传入进去</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">    dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">//不为空，走到considerNotify 里，见considerNotify</span></span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//如果 observer是不活跃的，也是不进行分发的</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//再判断宿主的生命周期是否大于start状态</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">      <span class="comment">//如果不活跃，就把actvityStateChanged状态转为false</span></span><br><span class="line">        observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//mVersion是在livedata的构造里创建的 只有当observer.mLastVersion 小于mVersion的时候才会进行分发</span></span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//这里是分发后，要把mLastVersion 和mVersion进行同步赋值</span></span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">  <span class="comment">//这里才是真正的分发回调onChaned 把livedata里的泛型数据传入进去</span></span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>livedata中还有一个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(<span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;observeForever&quot;</span>);</span><br><span class="line">    AlwaysActiveObserver wrapper = <span class="keyword">new</span> AlwaysActiveObserver(observer);</span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing <span class="keyword">instanceof</span> LiveData.LifecycleBoundObserver) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    wrapper.activeStateChanged(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果注册了这个方法，在宿主被销毁时，livedata是不会帮我们反注册的，需要我们自行去调用removeObserver</p><p>接着来看postValue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> postTask;</span><br><span class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">        postTask = mPendingData == NOT_SET;</span><br><span class="line">        mPendingData = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果当前在子线程中，则必须调用postvalue 不能调用 setvalue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;setValue&quot;</span>);</span><br><span class="line">  <span class="comment">//新的数据需要进行分发，这里mLastVersion就小于mVersion了，可以进行分发，如果调用了onChanged的，消费了这个事件和数据，mLastVersion就同步了</span></span><br><span class="line">    mVersion++;</span><br><span class="line">    mData = value;</span><br><span class="line">    dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatchingValue 传了null值  这个要区别于上面activeStateChanged中的dispatchingValue </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//这里传了null 所以，走下面的这个逻辑  遍历这个observers </span></span><br><span class="line">          <span class="comment">//这个observers就是我们之前addObserver添加进去的</span></span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">              <span class="comment">//遍历之后，就会调用considerNoity进行数据的分发，调用onChanged</span></span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>livedata 这个方法，判断是否有活跃的观察者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasActiveObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mActiveCount &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看下livedata的子类，实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MutableLiveData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MutableLiveData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.postValue(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个类好像什么都没做，只是复写了postvalue和setvalue并把方法改成了public而已，那么原因是什么？</p><blockquote><p>因为livedata作为数据发送组件，必定是一方发送一方接收，不能既发送又接收，所以MutableLiveData 是为了规避这个问题才存在的，只有拿到的对象是MutableLiveData它才能进行一个数据的发送</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;什么是&lt;code&gt;LiveData&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;LiveData&lt;/code&gt;几种衍生类&lt;/li&gt;
&lt;li&gt;&lt;code&gt;LiveData&lt;/code&gt;核心方法&lt;/li&gt;
&lt;li&gt;&lt;code&gt;LiveData&lt;/code&gt;实现原理&lt;</summary>
      
    
    
    
    <category term="Jetpack系列" scheme="http://example.com/categories/Jetpack%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Android" scheme="http://example.com/tags/Android/"/>
    
    <category term="Jetpack" scheme="http://example.com/tags/Jetpack/"/>
    
  </entry>
  
  <entry>
    <title>提升海量用户极致体验的Hybrid架构设计[转]</title>
    <link href="http://example.com/2022/03/18/[%E8%BD%AC]%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"/>
    <id>http://example.com/2022/03/18/[%E8%BD%AC]%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/</id>
    <published>2022-03-17T20:23:47.000Z</published>
    <updated>2022-05-12T07:29:40.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.infoq.cn/article/5DHTP6xjkMbNmo49Rd2x">原文链接</a></p><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>上一篇原理篇，我们已经详细地阐述了 Hybrid App 的基础原理，了解了 Native 端 和 H5 端 是如何通信的，还有 bridge 的设计和接入。而本篇文章将开始把这些原因进一步实践，用代码真正地去实现一套完整且稳定的 Hybrid 方案。如果对原理还有疑问的小伙伴，请移步提升海量用户极致体验的 Hybrid 架构设计（原理篇），只有在理解了理论的基础上，进一步与实践相结合，才能真正地去深入一项技术。</p><h3 id="摩天大楼"><a href="#摩天大楼" class="headerlink" title="摩天大楼"></a>摩天大楼</h3><p>说了那么一大堆理论知识，可能有小伙伴会说：“ 你是不是吹流弊啊。”那就先来简单介绍下我们已经使用这套方案落地的项目之一。</p><p><img src="https://static001.infoq.cn/resource/image/62/55/62ed934a1336363916dc24cd6cd3c555.jpg" alt="img"></p><p>这是一个完全内置在 App 里的 Hybrid 模块，由 Native 与 H5 深度协作完成，总共有 4 个页面，其中首页和制作页由 H5 制作，而相机页和保存页是复用 Native 页面。</p><p>项目上线一年累积使用次数已经超过 10 亿次。这套方案经受住了考验，并在过程中仍然在不断的优化和拓展。</p><p>使用这套实现方案是基于以下几点考虑：</p><ul><li>整个模块的风格多变，整体 UI 是与妆容所搭配的，而整个模块一直都在持续不断的迭代之中；</li><li>项目逻辑流程的可变性大，需要 H5 强大的热更新能力，及时应对数据的变化，快速的试错和纠正；</li><li>拍摄页与保存页是客户端已经有的模块，可以略微定制后直接复用；</li><li>需要由客户端协助接入多套 SDK，例如使用算法 SDK 进行复杂的图像处理。</li><li>简单看完项目，我们接下来开始 bridge.js 的构建。由于本系列文章主要面向前端童鞋，因此我们主要展开 H5 的部分，即会注入到每个页面头部的 bridge.js 的实现，客户端中的 SDK 部分就不详细解构了，只会提到一些细节。</li></ul><h3 id="搭建地基-—-bridge-js-架构"><a href="#搭建地基-—-bridge-js-架构" class="headerlink" title="搭建地基 — bridge.js 架构"></a>搭建地基 — bridge.js 架构</h3><p>基于上篇文章阐述的结构，我们进一步去完善细节部分，先整理成下面这样的流程结构图，大家先看下图，有个大致的概念：</p><p><img src="https://static001.infoq.cn/resource/image/f5/59/f54a2b8dfe8d21480d5ac35082ed1059.jpg" alt="img"></p><p>接下来我们会细看里面各个部分的代码实现。</p><h4 id="一-业务方使用姿势"><a href="#一-业务方使用姿势" class="headerlink" title="(一) 业务方使用姿势"></a>(一) 业务方使用姿势</h4><p>首先，我们先看下在这套方案中，业务方是如何使用的，下面以获取网络状态为例：</p><p><img src="https://static001.infoq.cn/resource/image/ad/04/adafcb982014f1ad2becf711d66edc04.jpg" alt="img"></p><h4 id="二-H5-–-gt-Native"><a href="#二-H5-–-gt-Native" class="headerlink" title="(二) H5 –&gt; Native"></a>(二) H5 –&gt; Native</h4><p>接下来直接来看 nativeCall 的内部实现：</p><p><img src="https://static001.infoq.cn/resource/image/d8/d9/d8aaff5b8f7901c9c3bb0a5d4c2370d9.jpg" alt="img"></p><p>里面可以解构成下面 4 个步骤:</p><p>1.生成唯一 handler 标识，从 0 开始累加；</p><p>2.将参数按 handler 值的规则存入参数池(_paramsStore)中；</p><p>3.以 handler 注册自定义事件，绑定 callback，并将 callback 也存入 _callbackStore 中，addEvent()，储存的目的主要是为了事件解绑时使用；</p><p>4.以 iframe 的形式发送协议，并携带唯一标识 handler，send()；</p><p><img src="https://static001.infoq.cn/resource/image/34/fb/3451bc822f66561a8634c459bee34bfb.jpg" alt="img"></p><p>Native:</p><ul><li>客户端接收到请求后，会使用 handler 调用 getParam 从参数池中获取对应的参数。</li><li><img src="https://static001.infoq.cn/resource/image/ff/65/ff4c092674a99fcd263c57e9a3099565.jpg" alt="img"></li><li>执行协议对应的功能；</li><li>这样即走通了 H5 –&gt; Native 的这个流程，在客户端完成了对应的功能后，既开始回传执行结果。</li></ul><h4 id="三-Native-–-gt-H5"><a href="#三-Native-–-gt-H5" class="headerlink" title="(三) Native –&gt; H5"></a>(三) Native –&gt; H5</h4><p>Native：</p><p>Native 完成功能后，直接调用 Bridge.postMessage(handler, data)，将 执行结果 和 之前 nativeCall 传过来的 标识 回传给 H5；</p><p><img src="https://static001.infoq.cn/resource/image/0b/ca/0be7c175fc4ab0140a8db81bc2898aca.jpg" alt="img"></p><p>H5：</p><ul><li>H5 在接收到唯一标识后初始化对应的自定义事件，挂载数据后触发，这里涉及的就是 fireEvent 这个函数:</li><li><img src="https://static001.infoq.cn/resource/image/0b/ca/0be7c175fc4ab0140a8db81bc2898aca.jpg" alt="img"></li><li>这样，我们就已经完成了双端之间的双向交互机制了，梳理出了整个 bridge.js 的核心代码了，包含了：</li><li>最重要的开放 API: nativeCall 与 postMessage ；</li><li>客户端获取参数函数: getParam ；</li><li>事件回调系统中的 addEvent 和 fireEvent ；</li><li>用于发送协议的 send。</li></ul><h3 id="安卓兼容性"><a href="#安卓兼容性" class="headerlink" title="安卓兼容性"></a>安卓兼容性</h3><p>如果看过上一篇提升海量用户极致体验的 Hybrid 架构设计（原理篇）的童鞋，这时可能会有个疑问：在 Android 4.4 以下时，使用的 loadUrl 进行 js 函数的调用，而此时是无法获取函数的返回值的，也就是说 4.4- 时，安卓并无法通过 getParam 这个函数来获取到协议的参数，这里需要做兼容性的处理，而我们这里可以使用一个曲线救国的骚操作，使用到的原理就是上一篇文章中有提到的另一种 H5 -&gt; Native 的方案：WebView 中的 prompt 拦截</p><p>方案如下:</p><ul><li>当安卓接受到协议，并拿到 handler 值；</li><li>使用无兼容性问题的 loadUrl 执行 js：Bridge.getParam(handler) ，直接将返回值直接通过 js 中的 prompt 发出：</li><li><img src="https://static001.infoq.cn/resource/image/7d/56/7d4aa27dd4ac6036993d7255a3d25756.jpg" alt="img"></li><li>通过重写 onJsPrompt 这个方法，拦截上一步发出的 prompt 的内容，并解析出相应的参数；</li><li><img src="https://static001.infoq.cn/resource/image/d1/85/d1c4904ff723ce0f0de5d2408d289685.jpg" alt="img"></li></ul><p>通过这样的方式，安卓全平台都可以完成参数的获取，并且方式统一，不需要分平台兼容，这就非常的 skrskr 啦。</p><p>现在看下来，是不是觉得炒鸡简单？。分分钟能写 100 个。没错！其实核心的原理就是这么的简单，但这只是一个最基础的地基而已，而基于地基之上，我们就可以开始一层一层建造我们的大楼了！</p><h3 id="建造大楼-—-协议的定制"><a href="#建造大楼-—-协议的定制" class="headerlink" title="建造大楼 — 协议的定制"></a>建造大楼 — 协议的定制</h3><p>在完成最基础的架构后，我们就可以开始来进一步完成一些上层建筑了，制定一系列真正开放给业务方使用的协议 API，完善整套方案。</p><p>首先我们可以将这些协议分成 功能协议 和 业务协议。</p><h3 id="功能协议"><a href="#功能协议" class="headerlink" title="功能协议"></a>功能协议</h3><p>这类协议是指用于完善整套方案的基础功能的一些通用协议，以 command:&#x2F;&#x2F;作为通用头，封装在 SDK 之中，可以在全线 App、全线 WebView 中使用：</p><h4 id="1-初始化机制"><a href="#1-初始化机制" class="headerlink" title="1.初始化机制"></a>1.初始化机制</h4><p>上篇文章有提到由于 bridge.js 注入的异步性，我们需要由客户端在注入完成后通知 H5。</p><p>这里我们可以约定一个通用的初始化事件，这里我们约定为 <em>init</em>，因此前端就可以进行入口的监听, 类似于我们常用的 DOMContentLoaded:</p><p><img src="https://static001.infoq.cn/resource/image/e6/b5/e61a71943ab3bbbb8d21a0dc27fa09b5.jpg" alt="img"></p><p>大家可以看到，这里用了个标记位用于避免事件被重复触发，这是由于客户端中是通过监听 WebView 的生命周期钩子来触发的，而 iframe 之类的操作会导致这些钩子的多次触发，因此需要双方各做一层防御性措施。</p><p>接下来，我们可以通过该事件，直接初始化传给 H5 一些环境参数和系统信息等，下面是我们使用到的：</p><p><img src="https://static001.infoq.cn/resource/image/cf/1f/cf5b40ef0c8355b766288e53967d9a1f.jpg" alt="img"></p><p>同样的，我们可以约定更多的页面生命周期事件，例如因为 App 很经常性的隐藏到后台，因此在被激活时，我们可以设置个生命周期: <em>resume</em>，可以用于告知 H5 页面被激活。</p><p>Tips:</p><p>这里就能体现出我们通过事件机制来作为回调系统的优势了，我们可以以最习惯的方式进行事件的监听，而客户端可以直接使用 bridge.fireEvent(‘<em>init</em>’, data)触发事件，这样便可以优雅地实现 Native -&gt; H5 的单方向交互。</p><h4 id="2-打包机制"><a href="#2-打包机制" class="headerlink" title="2.打包机制"></a>2.打包机制</h4><p>Hybrid 模块 的其中一种方式是将前端代码打包后内置于 App 本地，以便拥有最快的启动性能和离线访问能力。而这种方式最大的麻烦点，就是代码的更新，我们不可能每次有修改时就手动重新打包给客户端童鞋替换，而且这样也失去了我们的热更新机制。</p><p>因此这里就需要一套新的热更新机制，这套机制需要由客户端&#x2F;前端&#x2F;服务端 三端的童鞋提供对应的资源，共同协作完成整套流程。</p><p>资源：</p><ul><li>H5: 每个代码包都有一个唯一且递增的版本号；</li><li>Native: 提供包下载且解压到对应目录的服务，前端可以由下面这个协议来调用该功能。</li><li><img src="https://static001.infoq.cn/resource/image/b2/24/b2c03548947c032a4ee194a8ddf78424.jpg" alt="img"></li><li>服务端: 提供一个接口，可以获取线上最新代码包的版本号和下载地址。</li><li>流程：</li><li>前端更新代码打包后按版本号上传至指定的服务器上；</li><li>每次打开页面时，H5 请求接口获取线上最新代码包版本号，并与本地包进行版本号比对，当线上的版本号 大于 本地包版本号时，发起包下载协议：</li><li>客户端接受到协议后，直接去线上地址下载最新的代码包，并解压替换到当前目录文件。</li><li>拥有这样的机制后，H5 在开发后，就可以直接打包将包上传到对应的服务器上，这样在 App 中打开页面后，即可以实时的热更新。</li></ul><h4 id="3-环境系统-和-多语言系统"><a href="#3-环境系统-和-多语言系统" class="headerlink" title="3.环境系统 和 多语言系统"></a>3.环境系统 和 多语言系统</h4><p>通常，我们会将项目分成多个不同的环境，相互隔离。而由于 Hybrid 模块是置于 App 中的，因此环境需要与 App 进行匹配，这里就可以直接使用上面第一点提到的，通过 <em>init</em> 中携带的数据 data.env 来匹配：</p><blockquote><p>env: 0 - 正式环境； 1 - 测试环境； 2 - 开发环境；</p><p>同理， 多语言也可以直接使用 e.data.language 直接进行匹配；</p><p>Tips：</p><p>环境机制我们通常主要用于匹配后端的环境，正式环境和测试环境对应不同的接口。而这里还有一点特别的，就是需要注意代码包的更新，上述的包更新条件要包含三个方面: 版本号、环境和 App 版本，在不同环境不同 App 版本下，也应该更新到相应的最新代码包。</p></blockquote><h4 id="4-事件中转站"><a href="#4-事件中转站" class="headerlink" title="4. 事件中转站"></a>4. 事件中转站</h4><p>由于页面是 H5 开发，而 Native 可能需要控制 H5 页面，例如最常用的场景:</p><p>当页面中有弹窗或者 SPA 切换页面时，安卓的返回实体键应该能完成对应的回退，而不是因为 WebView 没有 history 就直接关闭。</p><p>类似于这类需求，这里就可以定制一个事件中心(<em>eventListeners</em> )，用于监听客户端的实体返回键：</p><p><img src="https://static001.infoq.cn/resource/image/74/23/74c741285607493320ac9a37fa8dc423.jpg" alt="img"></p><h4 id="5-数据传递机制"><a href="#5-数据传递机制" class="headerlink" title="5. 数据传递机制"></a>5. 数据传递机制</h4><p>在业务中，很多场景需要做到 Native 与 H5 保持数据的同步，此时就可以使用类似上面的原理，制定一套数据传递协议:</p><p><img src="https://static001.infoq.cn/resource/image/97/0e/97900a687b94670ed17acd2e4bc5070e.jpg" alt="img"></p><p>Tips：</p><p>Hybrid 模块通常需要从对应的入口进入，因此这里有一种可以优化的方式：</p><p>由 App 在启动时先去获取线上数据，在进入 WebView 后直接通过 <em>init</em> 或者触发 getData 直接发送给 H5，这样能减少请求数量，优化用户体验。</p><h4 id="6-代理请求"><a href="#6-代理请求" class="headerlink" title="6. 代理请求"></a>6. 代理请求</h4><p>H5 中最常用的就是请求，通常我们可以直接使用 ajax，但是这里有几个问题比较棘手:</p><ul><li>最常见的请求跨域；</li><li>数据算法加密；</li><li>用户登录校验；</li><li>而客户端的请求便不会出现这些问题，因此我们可以由客户端代理我们发出的请求，可以定制 4 个协议: getProxy，postProxy， getProxyLogined，postProxyLogined，其中带有 Logined 的协议代表着在请求时会自动携带已登录用户的 token 和 uid 等参数，使用在一些需要登录信息的接口上。这样做的好处是：</li><li>H5 方就无需处理繁多的各项复杂信息，不需要进行跨端传输；</li><li>能够对 H5 与 Native 的请求出口进行统一，方便加工处理。</li><li><img src="https://static001.infoq.cn/resource/image/50/4a/50e6a9e84ffb25172b124337555d404a.jpg" alt="img"></li></ul><h4 id="7-更多"><a href="#7-更多" class="headerlink" title="7.更多"></a>7.更多</h4><p>除了这些重要的功能外，我们还可以非常自由地定制很多协议，让 H5 拥有更多更强大的功能，下面是我们所定制的一些功能：</p><ul><li>getNetwork：获取网络状态；</li><li>openApp：唤起其它 App；</li><li>setShareInfo 与 callShare：分享内容到第三方平台；</li><li>link：使用新的 WebView 打开页面；</li><li>closeWebview：关闭 WebView；</li><li>setStorage 与 getStorage：设置与获取缓存数据；</li><li>loading：调用客户端通用 Loading；</li><li>setWebviewTitle：设置 WebView 标题；</li><li>saveImage：保存图片到本地；</li><li>…</li><li>这里可以定义更多的通用性协议，这里有个原则可以遵守，即这部分协议应该是基础性功能，应该是纯净的，适用于所有的业务方。根据上篇文章提到的理念，这部分是当成通用 SDK 进行维护与升级的，因此不应该耦合业务层的任何逻辑。</li><li>而有时我们会遇到需要定制一些业务上的逻辑，例如上面提到的项目中，我们要将用户图片通过算法处理成卡通画。这样的需求就是非常的业务化，不适用于其它项目，因此我们应该定制成业务协议。</li></ul><h3 id="业务协议"><a href="#业务协议" class="headerlink" title="业务协议"></a>业务协议</h3><p>这类协议区别于功能协议，它们会杂合一定程度的业务逻辑，而这些逻辑只是针对于特定的项目。其实对于 H5 的使用上，差别并不大，只是使用对应特殊的协议头用于区分，例如:</p><p><img src="https://static001.infoq.cn/resource/image/25/f1/259b6e0441914c490f268d415f0b6ef1.jpg" alt="img"></p><p>这类协议通常不包含在 SDK 中，因此需要由客户端的童鞋针对项目的 WebView 进行定制，使用 bridge.js 提供的基础功能实现对应的复杂功能。而在其它的项目入口中，就无法使用这些协议。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>看到总结两个字，有没有长舒了一口气。通过这两篇文章，我们终于将 Hybrid 方案的前端部分完全的解构清楚了，是不是有种神清气爽的感觉，完全可以马上开启你们的 Hybrid 之旅了。鼓掌鼓掌！</p><p>但这也远非终点，或者说这永无终点。~大楼建成后，离真正的摩天大楼还是差着一步 — 内部装修，其实接下来我们还需要做很多的优化措施，来解决一些仍然存在的问题，这部分其实我们也一直还在努力的阶段。</p><p>受篇幅所限，有时间会将这部分再写一篇优化篇，主要来与大家探讨下我们所能想到的一些优化方案，非常期待大佬们也能给我们提供更多的建议和解决办法。感恩~~😇</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.infoq.cn/article/5DHTP6xjkMbNmo49Rd2x&quot;&gt;原文链接&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/</summary>
      
    
    
    
    <category term="web" scheme="http://example.com/categories/web/"/>
    
    
    <category term="webview" scheme="http://example.com/tags/webview/"/>
    
    <category term="hybrid" scheme="http://example.com/tags/hybrid/"/>
    
  </entry>
  
  <entry>
    <title>提升海量用户极致体验的Hybrid架构设计（原理篇）[转]</title>
    <link href="http://example.com/2022/03/17/[%E8%BD%AC]%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/"/>
    <id>http://example.com/2022/03/17/[%E8%BD%AC]%E6%8F%90%E5%8D%87%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%9E%81%E8%87%B4%E4%BD%93%E9%AA%8C%E7%9A%84%20Hybrid%20%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/</id>
    <published>2022-03-16T20:23:47.000Z</published>
    <updated>2022-05-12T07:31:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.infoq.cn/article/wC28rP1xA47vI9dlSm3z">原文链接</a></p><h3 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h3><p>随着 Web 技术和移动设备的快速发展，Hybrid 技术已经成为一种最主流最常见的方案。一套好的 Hybrid 架构方案能让 App 既能拥有极致的体验和性能，同时也能拥有 Web 技术灵活的开发模式、跨平台能力以及热更新机制，想想是不是都鸡冻不已…本系列文章是美图公司在这方面实践的一个总结，包含了原理解析、方案选型与实现、实践优化等方面。</p><p>大家可以到 github (<a href="https://github.com/xd-tayde/blog/blob/master/hybrid-1.md)%E4%B8%8A%E5%92%8C%E4%BD%9C%E8%80%85%E8%BF%9B%E8%A1%8C%E8%AE%A8%E8%AE%BA%E5%93%88%EF%BC%81">https://github.com/xd-tayde/blog/blob/master/hybrid-1.md)上和作者进行讨论哈！</a></p><h3 id="二、现有混合方案"><a href="#二、现有混合方案" class="headerlink" title="二、现有混合方案"></a>二、现有混合方案</h3><p>Hybrid App，俗称混合应用，即混合了 Native 技术 与 Web 技术进行开发的移动应用。现在比较流行的混合方案主要有三种，主要是在 UI 渲染机制上的不同：</p><p>1.基于 WebView UI 的基础方案，市面上大部分主流 App 都有采用，例如微信 JS-SDK ，通过 JSBridge 完成 H5 与 Native 的双向通讯，从而赋予 H5 一定程度的原生能力。</p><p>2.基于 Native UI 的方案，例如 React-Native、Weex。在赋予 H5 原生 API 能力的基础上，进一步通过 JSBridge 将 js 解析成的虚拟节点树( Virtual DOM )传递到 Native 并使用原生渲染。</p><p>3.另外还有近期比较流行的小程序方案，也是通过更加定制化的 JSBridge，并使用双 WebView 双线程的模式隔离了 JS 逻辑与 UI 渲染，形成了特殊的开发模式，加强了 H5 与 Native 混合程度，提高了页面性能及开发体验。</p><p>以上的三种方案，其实同样都是基于 JSBridge 完成的通讯层，第二三种方案，其实可以看做是在方案一的基础上，继续通过不同的新技术进一步提高了应用的混合程度。因此，JSBridge 也是整个混合应用最关键的部分，例如我们在设置微信分享时用到的 JS-SDK，wx 对象便是我们最常见的 JSBridge:</p><p><img src="https://static001.infoq.cn/resource/image/8c/2a/8cf4664c3861d72213ed9e1a47f3da2a.jpg" alt="img"></p><h3 id="三、方案选型"><a href="#三、方案选型" class="headerlink" title="三、方案选型"></a>三、方案选型</h3><p>任何技术方案的选型，其实都应该基于使用场景和现有条件。基于公司现有情况的几点考虑，在方案一上进一步优化，更加适合我们的需求。</p><ul><li>需求 Web 技术 快速迭代、灵活开发的特点和线上热更新的机制。</li><li>产品的核心能力是强大的拍照与底层图片处理能力，因此单纯的 H5 技术能做的事非常有限，不能满足需求，通过 Hybrid 技术来强化 H5 ，便是一种必需。</li><li>公司业务上，并没有非常复杂的 UI 渲染需求，而且 App 中的一系列原生 UI 组件 已经非常成熟，因此我们并不强需类似 RN 这样的方案。</li></ul><p>因此，如何既能利用 H5 强大的开发和迭代能力，又能赋予 H5 强大的底层能力和用户体验，同时能复用现有的成熟 Native 组件，便成为了我们最大的需求点 – 一套完整又强大的 Hybrid 技术架构方案。</p><h3 id="四、Hybrid-技术原理"><a href="#四、Hybrid-技术原理" class="headerlink" title="四、Hybrid 技术原理"></a>四、Hybrid 技术原理</h3><p>Hybrid App 的本质，其实是在原生的 App 中，使用 WebView 作为容器直接承载 Web 页面。因此，最核心的点就是 Native 端与 H5 端之间的双向通讯层，其实这里也可以理解为我们需要一套跨语言通讯方案，来完成 Native(Java&#x2F;Objective-c&#x2F;…) 与 JavaScript 的通讯。这个方案就是我们所说的 JSBridge，而实现的关键便是作为容器的 WebView，一切的原理都是基于 WebView 的机制。</p><p><img src="https://static001.infoq.cn/resource/image/d2/65/d241622ca2f60b9c8d28ba1953ddc265.jpg" alt="img"></p><h4 id="4-1-JavaScript-通知-Native"><a href="#4-1-JavaScript-通知-Native" class="headerlink" title="4.1 JavaScript 通知 Native"></a>4.1 JavaScript 通知 Native</h4><p>基于 WebView 的机制和开放的 API , 实现这个功能有三种常见的方案：</p><ul><li>API 注入，原理其实就是 Native 获取 JavaScript 环境上下文，并直接在上面挂载对象或者方法，使 js 可以直接调用，Android 与 IOS 分别拥有对应的挂载方式。</li><li>WebView 中的 prompt&#x2F;console&#x2F;alert 拦截，通常使用 prompt ，因为这个方法在前端中使用频率低，比较不会出现冲突；</li><li>WebView URL Scheme 跳转拦截；</li></ul><p>第二三种机制的原理是类似的，都是通过对 WebView 信息冒泡传递的拦截，从而达到通讯的，接下来我们主要从 原理-定制协议-拦截协议-参数传递-回调机制 5 个方面详细阐述下第三种方案 – URL 拦截方案。</p><h5 id="4-1-1-实现原理"><a href="#4-1-1-实现原理" class="headerlink" title="4.1.1 实现原理"></a>4.1.1 实现原理</h5><p>在 WebView 中发出的网络请求，客户端都能进行监听和捕获</p><h5 id="4-1-2-协议的定制"><a href="#4-1-2-协议的定制" class="headerlink" title="4.1.2 协议的定制"></a>4.1.2 协议的定制</h5><p>我们需要制定一套 URL Scheme 规则，通常我们的请求会带有对应的协议开头，例如常见的 <a href="https://xxx.com/">https://xxx.com</a> 或者 file:&#x2F;&#x2F;1.jpg ，代表着不同的含义。我们这里可以将协议类型的请求定制为:</p><blockquote><p>xxcommand:&#x2F;&#x2F;xxxx?param1&#x3D;1&amp;param2&#x3D;2</p></blockquote><p>这里有几个需要注意点的是:</p><p>(1) xxcommand:&#x2F;&#x2F; 只是一种规则，可以根据业务进行制定，使其具有含义，例如我们定义 xxcommand:&#x2F;&#x2F; 为公司所有 App 系通用，为通用工具协议：</p><blockquote><p>xxcommand:&#x2F;&#x2F;getProxy?h&#x3D;1</p><p>而定义 xxapp:&#x2F;&#x2F; 为每个 App 单独的业务协议。</p><p>xxapp:&#x2F;&#x2F;openCamera?h&#x3D;2</p><p>不同的协议头代表着不同的含义，这样便能清楚知道每个协议的适用范围。</p></blockquote><p>(2) 这里不要使用 location.href 发送，因为其自身机制有个问题是同时并发多次请求会被合并成为一次，导致协议被忽略，而并发协议其实是非常常见的功能。我们会使用创建 iframe 发送请求的方式。</p><p>(3) 通常考虑到安全性，需要在客户端中设置域名白名单或者限制，避免公司内部业务协议被第三方直接调用。</p><h5 id="4-1-3-协议的拦截"><a href="#4-1-3-协议的拦截" class="headerlink" title="4.1.3 协议的拦截"></a>4.1.3 协议的拦截</h5><p>客户端可以通过 API 对 WebView 发出的请求进行拦截：</p><ul><li>IOS 上: shouldStartLoadWithRequest</li><li>Android: shouldOverrideUrlLoading</li></ul><p>当解析到请求 URL 头为制定的协议时，便不发起对应的资源请求，而是解析参数，并进行相关功能或者方法的调用，完成协议功能的映射。</p><h5 id="4-1-4-协议回调"><a href="#4-1-4-协议回调" class="headerlink" title="4.1.4 协议回调"></a>4.1.4 协议回调</h5><p>由于协议的本质其实是发送请求，这属于一个异步的过程，因此我们便需要处理对应的回调机制。这里我们采用的方式是 JS 的事件系统，这里我们会用到 window.addEventListener 和 window.dispatchEvent 这两个基础 API；</p><ul><li>1.发送协议时，通过协议的唯一标识注册自定义事件，并将回调绑定到对应的事件上。</li><li>2.客户端完成对应的功能后，调用 Bridge 的 dispatch API ，直接携带 data 触发该协议的自定义事件。</li><li><img src="https://static001.infoq.cn/resource/image/16/75/160be3b376cb8f959673cb98ecd72375.jpg" alt="img"></li><li>通过事件的机制，会让开发更符合我们前端的习惯，例如当你需要监听客户端的通知时，同样只需要在通过 addEventListener 进行监听即可。</li><li>Tips: 这里有一点需要注意的是，应该避免事件的多次重复绑定，因此当唯一标识重置时，需要 removeEventListener 对应的事件。</li></ul><h5 id="4-1-5-参数传递方式"><a href="#4-1-5-参数传递方式" class="headerlink" title="4.1.5 参数传递方式"></a>4.1.5 参数传递方式</h5><p>由于 WebView 对 URL 会有长度的限制，因此常规的通过 search 参数 进行传递的方式便具有一个问题，既 当需要传递的参数过长时，可能会导致被截断，例如传递 base64 或者传递大量数据时。</p><p>因此我们需要制定新的参数传递规则，我们使用的是函数调用的方式。这里的原理主要是基于:Native 可以直接调用 JS 方法并直接获取函数的返回值。</p><p>我们只需要对每条协议标记一个唯一标识，并把参数存入参数池中，到时客户端再通过该唯一标识从参数池中获取对应的参数即可。</p><h4 id="4-2-Native-通知-Javascript"><a href="#4-2-Native-通知-Javascript" class="headerlink" title="4.2 Native 通知 Javascript"></a>4.2 Native 通知 Javascript</h4><p>由于 Native 可以算作 H5 的宿主，因此拥有更大的权限，上面也提到了 Native 可以通过 WebView API 直接执行 Js 代码。这样的权限也就让这个方向的通讯变得十分的便捷。</p><ul><li>IOS: stringByEvaluatingJavaScriptFromString</li><li><img src="https://static001.infoq.cn/resource/image/30/ae/3082eaf8243d968b859843d1bddc67ae.jpg" alt="img"></li><li>Android: loadUrl (4.4-)</li><li><img src="https://static001.infoq.cn/resource/image/aa/d4/aa57c6161123ab1bf5a719d856864ad4.jpg" alt="img"></li><li>Tips: 当系统低于 4.4 时，evaluateJavascript 是无法使用的，因此单纯的使用 loadUrl 无法获取 JS 返回值，这时我们需要使用前面提到的 prompt 的方法进行兼容，让 H5 端 通过 prompt 进行数据的发送，客户端进行拦截并获取数据。</li><li>Android: evaluateJavascript (4.4+)</li><li><img src="https://static001.infoq.cn/resource/image/e2/41/e2f1f329be5db895309621d4e3770a41.jpg" alt="img"></li><li>基于上面的原理，我们已经明白 JSBridge 最基础的原理，并且能实现 Native &lt;&#x3D;&gt; H5 的双向通讯机制了。</li><li><img src="https://static001.infoq.cn/resource/image/47/b6/479d60fe2cb3fab82279f1d2135b48b6.jpg" alt="img"></li></ul><h4 id="4-3-JSBridge-的接入"><a href="#4-3-JSBridge-的接入" class="headerlink" title="4.3 JSBridge 的接入"></a>4.3 JSBridge 的接入</h4><p>接下来，我们来理下代码上需要的资源。实现这套方案，从上图可以看出，其实可以分为两个部分:</p><ul><li>JS 部分(bridge): 在 JS 环境中注入 bridge 的实现代码，包含了协议的拼装&#x2F;发送&#x2F;参数池&#x2F;回调池等一些基础功能。</li><li>Native 部分(SDK): 在客户端中 bridge 的功能映射代码，实现了 URL 拦截与解析&#x2F;环境信息的注入&#x2F;通用功能映射等功能。</li></ul><p>我们这里的做法是，将这两部分一起封装成一个 Native SDK，由客户端统一引入。客户端在初始化一个 WebView 打开页面时，如果页面地址在白名单中，会直接在 HTML 的头部注入对应的 bridge.js。这样的做法有以下的好处：</p><ul><li>双方的代码统一维护，避免出现版本分裂的情况。有更新时，只要由客户端更新 SDK 即可，不会出现版本兼容的问题；</li><li>App 的接入十分方便，只需要按文档接入最新版本的 SDK ，即可直接运行整套 Hybrid 方案，便于在多个 App 中快速的落地；</li><li>H5 端无需关注，这样有利于将 bridge 开放给第三方页面使用。</li></ul><p>这里有一点需要注意的是，协议的调用，一定是需要确保执行在 bridge.js 成功注入后。由于客户端的注入行为属于一个附加的异步行为，从 H5 方很难去捕捉准确的完成时机，因此这里需要通过客户端监听页面完成后，基于上面的事件回调机制通知 H5 端，页面中即可通过 window.addEventListener(‘bridgeReady’, e &#x3D;&gt; {})进行初始化。</p><h4 id="4-4-App-中-H5-的接入方式"><a href="#4-4-App-中-H5-的接入方式" class="headerlink" title="4.4 App 中 H5 的接入方式"></a>4.4 App 中 H5 的接入方式</h4><p>将 H5 接入 App 中通常有两种方式：在线 H5 和内置包 H5。</p><p>(1) 在线 H5，这是最常见的一种方式。我们只需要将 H5 代码部署到服务器上，只要把对应的 URL 地址 给到客户端，用 WebView 打开该 URL，即可嵌入。该方式的好处在于:</p><ul><li>独立性强，有非常独立的开发&#x2F;调试&#x2F;更新&#x2F;上线能力；</li><li>资源放在服务器上，完全不会影响客户端的包体积；</li><li>接入成本很低，完全的热更新机制。</li></ul><p>但相对的，这种方式也有对应的缺点:</p><ul><li>完全的网络依赖，在离线的情况下无法打开页面；</li><li>首屏加载速度依赖于网络，网络较慢时，首屏加载也较慢；</li></ul><p>通常，这种方式更适用在一些比较轻量级的页面上，例如一些帮助页、提示页、使用攻略等页面。这些页面的特点是功能性不强，不太需要复杂的功能协议，且不需要离线使用。在一些第三方页面接入上，也会使用这种方式，例如我们的页面调用微信 JS-SDK 。</p><p>(2) 内置包 H5，这是一种本地化的嵌入方式，我们需要将代码进行打包后下发到客户端，并由客户端直接解压到本地储存中。通常我们运用在一些比较大和比较重要的模块上。其优点是:</p><ul><li>由于其本地化，首屏加载速度快，用户体验更为接近原生；</li><li>可以不依赖网络，离线运行；</li></ul><p>但同时，它的劣势也十分明显:</p><ul><li>开发流程&#x2F;更新机制复杂化，需要客户端，甚至服务端的共同协作；</li><li>会相应的增加 App 包体积；</li></ul><p>这两种接入方式均有自己的优缺点，应该根据不同场景进行选择。</p><h3 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h3><p>本文主要解析了现在 Hybrid App 的发展现状和其基础原理，包含了</p><ul><li>JavaScript 通知 Native</li><li>Native 通知 Javascript</li><li>JSBridge 的接入</li><li>H5 的接入</li></ul><p>只有在了解了其最本质的实现原理后，才能对这套方案进行实现以及进一步的优化。接下来，我们将基于上面的理论，继续探讨如何把这套方案的真正代码实现以及方案优化方案，欢迎大家一起讨论！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.infoq.cn/article/wC28rP1xA47vI9dlSm3z&quot;&gt;原文链接&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;一、引言&quot;&gt;&lt;a href=&quot;#一、引言&quot; class=&quot;headerlink&quot; title=&quot;一、引言&quot;&gt;&lt;/</summary>
      
    
    
    
    <category term="web" scheme="http://example.com/categories/web/"/>
    
    
    <category term="webview" scheme="http://example.com/tags/webview/"/>
    
    <category term="hybrid" scheme="http://example.com/tags/hybrid/"/>
    
  </entry>
  
  <entry>
    <title>Android 实现水印背景效果[转]</title>
    <link href="http://example.com/2022/03/15/Android%20%E5%AE%9E%E7%8E%B0%E6%B0%B4%E5%8D%B0%E8%83%8C%E6%99%AF%E6%95%88%E6%9E%9C/"/>
    <id>http://example.com/2022/03/15/Android%20%E5%AE%9E%E7%8E%B0%E6%B0%B4%E5%8D%B0%E8%83%8C%E6%99%AF%E6%95%88%E6%9E%9C/</id>
    <published>2022-03-14T20:23:47.000Z</published>
    <updated>2022-05-13T00:19:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="转-Android-实现水印背景效果"><a href="#转-Android-实现水印背景效果" class="headerlink" title="[转]Android 实现水印背景效果"></a>[转]Android 实现水印背景效果</h1><p>项目中有需要加水印的需求，实现完效果图是这样的</p><p><img src="https://img-blog.csdnimg.cn/2020112014501365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NoYW95ZXpoYW5nbGl3ZWk=,size_16,color_FFFFFF,t_70" alt="img"></p><p>什么看不清…<img src="https://img-blog.csdnimg.cn/20201120145255473.jpg" alt="img"></p><p><img src="https://img-blog.csdnimg.cn/20201120145321286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NoYW95ZXpoYW5nbGl3ZWk=,size_16,color_FFFFFF,t_70" alt="img"></p><p>为了让大家看清效果，字体改了一下，正常应该是文章最上面那个的效果。话不多说，直接上代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.TypedArray;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Typeface;</span><br><span class="line"><span class="keyword">import</span> android.text.TextPaint;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.view.MotionEvent;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.hkdc.commonlib.R;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SEPARATOR = <span class="string">&quot;///&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> TextPaint mTextPaint = <span class="keyword">new</span> TextPaint();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String[] mText;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDegrees;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextSize=<span class="number">35</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mTextBold;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDx;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDy;</span><br><span class="line">    <span class="keyword">private</span> Paint.Align mAlign;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mSync;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textWidth, textHeight;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMarkView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMarkView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        TypedArray typedArray = context.obtainStyledAttributes(attrs, R.styleable.WaterMarkView);</span><br><span class="line">        mDegrees = typedArray.getInt(R.styleable.WaterMarkView_water_mark_degree, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getDegrees() : -<span class="number">30</span>);</span><br><span class="line">        String text = typedArray.getString(R.styleable.WaterMarkView_water_mark_text);</span><br><span class="line">        <span class="keyword">if</span> (text != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mText = text.split(DEFAULT_SEPARATOR);</span><br><span class="line">        &#125;</span><br><span class="line">        mTextColor = typedArray.getColor(R.styleable.WaterMarkView_water_mark_textColor, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getTextColor() : Color.parseColor(<span class="string">&quot;#33000000&quot;</span>));</span><br><span class="line">        mTextSize = typedArray.getDimensionPixelSize(R.styleable.WaterMarkView_water_mark_textSize, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getTextSize() : <span class="number">42</span>);</span><br><span class="line">        mTextBold = typedArray.getBoolean(R.styleable.WaterMarkView_water_mark_textBold, WaterMarkManager.INFO != <span class="keyword">null</span> &amp;&amp; WaterMarkManager.INFO.isTextBold());</span><br><span class="line">        mDx = typedArray.getDimensionPixelSize(R.styleable.WaterMarkView_water_mark_dx, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getDx() : <span class="number">100</span>);</span><br><span class="line">        mDy = typedArray.getDimensionPixelSize(R.styleable.WaterMarkView_water_mark_dy, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getDy() : <span class="number">240</span>);</span><br><span class="line">        <span class="keyword">int</span> align = typedArray.getInt(R.styleable.WaterMarkView_water_mark_align, WaterMarkManager.INFO != <span class="keyword">null</span> ? WaterMarkManager.INFO.getAlignInt() : <span class="number">1</span>);</span><br><span class="line">        mAlign = align == <span class="number">0</span> ? Paint.Align.LEFT : align == <span class="number">2</span> ? Paint.Align.RIGHT : Paint.Align.CENTER;</span><br><span class="line">        mSync = typedArray.getBoolean(R.styleable.WaterMarkView_water_mark_sync, <span class="keyword">true</span>);</span><br><span class="line">        typedArray.recycle();</span><br><span class="line"> </span><br><span class="line">        setBackgroundColor(Color.TRANSPARENT);</span><br><span class="line">        mTextPaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">        mTextPaint.setFlags(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        mTextPaint.setColor(mTextColor);</span><br><span class="line">        mTextPaint.setTextSize(mTextSize);</span><br><span class="line">        mTextPaint.setTypeface(mTextBold ? Typeface.DEFAULT_BOLD : Typeface.DEFAULT);</span><br><span class="line">        mTextPaint.setTextAlign(mAlign);</span><br><span class="line"> </span><br><span class="line">        mText = mText == <span class="keyword">null</span> &amp;&amp; mSync ? WaterMarkManager.CONTENT : mText;</span><br><span class="line"> </span><br><span class="line">        textWidth = <span class="number">0</span>;</span><br><span class="line">        textHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mText != <span class="keyword">null</span> &amp;&amp; mText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String s : mText) &#123;</span><br><span class="line">                Rect tvRect = <span class="keyword">new</span> Rect();</span><br><span class="line">                mTextPaint.getTextBounds(s, <span class="number">0</span>, s.length(), tvRect);</span><br><span class="line">                textWidth = textWidth &gt; tvRect.width() ? textWidth : tvRect.width();</span><br><span class="line">                textHeight += (tvRect.height() + <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            WaterMarkManager.LIST.add(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (mText != <span class="keyword">null</span> &amp;&amp; mText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> measuredWidth = getMeasuredWidth();</span><br><span class="line">            <span class="keyword">int</span> measuredHeight = getMeasuredHeight();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (measuredWidth == <span class="number">0</span> || measuredHeight == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">int</span> canvasLength = measuredWidth &gt; measuredHeight ? measuredWidth : measuredHeight;</span><br><span class="line"> </span><br><span class="line">            canvas.save();</span><br><span class="line">            canvas.rotate(mDegrees, measuredWidth / <span class="number">2</span>, measuredHeight / <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">            canvas.save();</span><br><span class="line">            <span class="keyword">int</span> y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">boolean</span> odd = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (y &lt; canvasLength + textHeight) &#123;</span><br><span class="line">                <span class="keyword">int</span> x = odd ? <span class="number">0</span> : -(textWidth + mDx) / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">while</span> (x &lt; canvasLength + textWidth) &#123;</span><br><span class="line">                    drawTexts(mText, mTextPaint, canvas, x, y);</span><br><span class="line">                    x = x + textWidth + mDx;</span><br><span class="line">                &#125;</span><br><span class="line">                y = y + textHeight + mDy;</span><br><span class="line">                odd = !odd;</span><br><span class="line">            &#125;</span><br><span class="line">            canvas.restore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawTexts</span><span class="params">(String[] ss, Paint paint, Canvas canvas, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        Paint.FontMetrics fontMetrics = paint.getFontMetrics();</span><br><span class="line">        <span class="keyword">float</span> top = fontMetrics.top;</span><br><span class="line">        <span class="keyword">float</span> bottom = fontMetrics.bottom;</span><br><span class="line">        <span class="keyword">int</span> length = ss.length;</span><br><span class="line">        <span class="keyword">float</span> total = (length - <span class="number">1</span>) * (bottom - top) + (fontMetrics.descent - fontMetrics.ascent);</span><br><span class="line">        <span class="keyword">float</span> offset = total / <span class="number">2</span> - bottom;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">float</span> yAxis = -(length - i - <span class="number">1</span>) * (bottom - top) + offset;</span><br><span class="line">            canvas.drawText(ss[i], x, y + yAxis + <span class="number">10</span>, paint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印文字内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text 文字内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String... text)</span> </span>&#123;</span><br><span class="line">        mText = text;</span><br><span class="line"> </span><br><span class="line">        textWidth = <span class="number">0</span>;</span><br><span class="line">        textHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mText != <span class="keyword">null</span> &amp;&amp; mText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String s : mText) &#123;</span><br><span class="line">                Rect tvRect = <span class="keyword">new</span> Rect();</span><br><span class="line">                mTextPaint.getTextBounds(s, <span class="number">0</span>, s.length(), tvRect);</span><br><span class="line">                textWidth = textWidth &gt; tvRect.width() ? textWidth : tvRect.width();</span><br><span class="line">                textHeight += (tvRect.height() + <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印文字内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text 文字内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncText</span><span class="params">(String... text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setText(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印倾斜角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degrees 倾斜角度(默认:-30)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        mDegrees = degrees;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印倾斜角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degrees 倾斜角度(默认:-30)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setDegrees(degrees);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印字体颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textColor 字体颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        mTextColor = textColor;</span><br><span class="line">        mTextPaint.setColor(mTextColor);</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印字体颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textColor 字体颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setTextColor(textColor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印字体大小（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textSize 字体大小(默认:42px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        mTextSize = textSize;</span><br><span class="line">        mTextPaint.setTextSize(<span class="number">30</span>);</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印字体大小（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textSize 字体大小(默认:42px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setTextSize(<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印字体是否粗体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textBold 是否粗体(默认:false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        mTextBold = textBold;</span><br><span class="line">        mTextPaint.setTypeface(mTextBold ? Typeface.DEFAULT_BOLD : Typeface.DEFAULT);</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印字体是否粗体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textBold 是否粗体(默认:false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setTextBold(textBold);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印X轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dx X轴偏移量(默认:100px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mDx = dx;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印X轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dx X轴偏移量(默认:100px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSyncDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setDx(dx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印Y轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dy Y轴偏移量(默认:240px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mDy = dy;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印Y轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dy Y轴偏移量(默认:240px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSignDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setDy(dy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印对齐方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mAlign = align;</span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置水印对齐方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSignAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            setAlign(align);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 销毁相关页面时调用（切记）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSync) &#123;</span><br><span class="line">            WaterMarkManager.LIST.remove(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@SuppressLint(&quot;ClickableViewAccessibility&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">&quot;WaterMarkView&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_degree&quot;</span> <span class="attr">format</span>=<span class="string">&quot;integer|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_text&quot;</span> <span class="attr">format</span>=<span class="string">&quot;string|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_textColor&quot;</span> <span class="attr">format</span>=<span class="string">&quot;color|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_textSize&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_textBold&quot;</span> <span class="attr">format</span>=<span class="string">&quot;boolean&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_dx&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_dy&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension|reference&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_align&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;LEFT&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;CENTER&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;RIGHT&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">attr</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;water_mark_sync&quot;</span> <span class="attr">format</span>=<span class="string">&quot;boolean&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hkdc.commonlib.warkmark;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.hkdc.commonlib.R;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Leon (wshk729@163.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/24</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkManager</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> WaterMarkInfo INFO = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> String[] CONTENT = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> List&lt;WaterMarkView&gt; LIST = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置水印全局配置信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> info 配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setInfo</span><span class="params">(WaterMarkInfo info)</span> </span>&#123;</span><br><span class="line">        INFO = info;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取一个满屏水印View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> activity activity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;InflateParams&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WaterMarkView <span class="title">getView</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (WaterMarkView) LayoutInflater.from(activity).inflate(R.layout.view_water_mark, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WaterMarkInfo初始化判断</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assertInitialized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INFO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            INFO = WaterMarkInfo.create().generate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印文字信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 文字信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String... content)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        CONTENT = content;</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncText(content);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印倾斜角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degrees 倾斜角度(默认:-30)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setDegrees(degrees);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncDegrees(degrees);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印字体颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textColor 字体颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setTextColor(textColor);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncTextColor(textColor);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印字体大小（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textSize 字体大小(默认:42px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setTextSize(textSize);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncTextSize(textSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印字体是否粗体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> textBold 是否粗体(默认:false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setTextBold(textBold);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncTextBold(textBold);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印X轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dx X轴偏移量(默认:100px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setDx(dx);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSyncDx(dx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印Y轴偏移量（单位：px）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dy Y轴偏移量(默认:240px)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setDy(dy);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSignDy(dy);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步设置全部水印对齐方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        assertInitialized();</span><br><span class="line">        INFO.setAlign(align);</span><br><span class="line">        <span class="keyword">if</span> (LIST.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WaterMarkView view : LIST) &#123;</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    view.setSignAlign(align);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>view_water_mark.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">com.commonlib.WaterMarkView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Leon (wshk729@163.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/24</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkInfo</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDegrees;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mTextBold;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDx;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDy;</span><br><span class="line">    <span class="keyword">private</span> Paint.Align mAlign;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WaterMarkInfo</span><span class="params">(<span class="keyword">int</span> degrees, <span class="keyword">int</span> textColor, <span class="keyword">int</span> textSize, <span class="keyword">boolean</span> textBold, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, Paint.Align align)</span> </span>&#123;</span><br><span class="line">        mDegrees = degrees;</span><br><span class="line">        mTextColor = textColor;</span><br><span class="line">        mTextSize = textSize;</span><br><span class="line">        mTextBold = textBold;</span><br><span class="line">        mDx = dx;</span><br><span class="line">        mDy = dy;</span><br><span class="line">        mAlign = align;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDegrees</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDegrees;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTextColor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextColor;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTextSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDx;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDy;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> Paint.<span class="function">Align <span class="title">getAlign</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAlign;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAlignInt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (mAlign) &#123;</span><br><span class="line">            <span class="keyword">case</span> LEFT:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> RIGHT:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTextBold</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextBold;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">        mDegrees = degrees;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">        mTextColor = textColor;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">        mTextSize = textSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">        mTextBold = textBold;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">        mDx = dx;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">        mDy = dy;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mAlign = align;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Builder();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mDegrees;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mTextSize;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mTextBold;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mDx;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mDy;</span><br><span class="line">        <span class="keyword">private</span> Paint.Align mAlign;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mDegrees = -<span class="number">30</span>;</span><br><span class="line">            mTextColor = Color.parseColor(<span class="string">&quot;#33000000&quot;</span>);</span><br><span class="line">            mTextSize = <span class="number">35</span>;</span><br><span class="line">            mTextBold = <span class="keyword">false</span>;</span><br><span class="line">            mDx = <span class="number">100</span>;</span><br><span class="line">            mDy = <span class="number">240</span>;</span><br><span class="line">            mAlign = Paint.Align.CENTER;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字倾斜度</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> degrees 文字倾斜度(默认:-30)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setDegrees</span><span class="params">(<span class="keyword">int</span> degrees)</span> </span>&#123;</span><br><span class="line">            mDegrees = degrees;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字颜色</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> textColor 文字颜色(默认:#33000000)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> textColor)</span> </span>&#123;</span><br><span class="line">            mTextColor = textColor;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字大小（单位：px）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> textSize 文字大小(默认:42px)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">            mTextSize = textSize;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字是否加粗</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> textBold 文字加粗(默认:false)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setTextBold</span><span class="params">(<span class="keyword">boolean</span> textBold)</span> </span>&#123;</span><br><span class="line">            mTextBold = textBold;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字X轴间距（单位：px）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> dx 文字X轴间距(默认:100px)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setDx</span><span class="params">(<span class="keyword">int</span> dx)</span> </span>&#123;</span><br><span class="line">            mDx = dx;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字Y轴间距（单位：px）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> dy 文字Y轴间距(默认:240px)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setDy</span><span class="params">(<span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">            mDy = dy;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置水印文字对齐方式</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> align 对齐方式(默认:Center)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> Builder</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setAlign</span><span class="params">(Paint.Align align)</span> </span>&#123;</span><br><span class="line">            mAlign = align;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 生成水印全局配置信息</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 配置信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> WaterMarkInfo <span class="title">generate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WaterMarkInfo(mDegrees, mTextColor, mTextSize, mTextBold, mDx, mDy, mAlign);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.ColorFilter;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.PixelFormat;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.IntRange;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterMarkBg</span> <span class="keyword">extends</span> <span class="title">Drawable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Paint paint = <span class="keyword">new</span> Paint();</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; labels;</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> degress;<span class="comment">//角度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fontSize;<span class="comment">//字体大小 单位sp</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化构造</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> labels 水印文字列表 多行显示支持</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degress 水印角度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fontSize 水印文字大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaterMarkBg</span><span class="params">(Context context, List&lt;String&gt; labels, <span class="keyword">int</span> degress, <span class="keyword">int</span> fontSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.labels = labels;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        <span class="keyword">this</span>.degress = degress;</span><br><span class="line">        <span class="keyword">this</span>.fontSize = fontSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="meta">@NonNull</span> Canvas canvas)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">int</span> width = getBounds().right;</span><br><span class="line">        <span class="keyword">int</span> height = getBounds().bottom;</span><br><span class="line"> </span><br><span class="line">        canvas.drawColor(Color.parseColor(<span class="string">&quot;#40F3F5F9&quot;</span>));</span><br><span class="line">        paint.setColor(Color.parseColor(<span class="string">&quot;#50AEAEAE&quot;</span>));</span><br><span class="line"> </span><br><span class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">        paint.setTextSize(sp2px(context,fontSize));</span><br><span class="line">        canvas.save();</span><br><span class="line">        canvas.rotate(degress);</span><br><span class="line">        <span class="keyword">float</span> textWidth = paint.measureText(labels.get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> positionY = height / <span class="number">10</span>; positionY &lt;= height; positionY += height / <span class="number">10</span>+<span class="number">80</span>) &#123;</span><br><span class="line">            <span class="keyword">float</span> fromX = -width + (index++ % <span class="number">2</span>) * textWidth;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">float</span> positionX = fromX; positionX &lt; width; positionX += textWidth * <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> spacing  = <span class="number">0</span>;<span class="comment">//间距</span></span><br><span class="line">                <span class="keyword">for</span>(String label:labels)&#123;</span><br><span class="line">                    canvas.drawText(label, positionX, positionY+spacing, paint);</span><br><span class="line">                    spacing = spacing+<span class="number">50</span>;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="meta">@IntRange(from = 0, to = 255)</span> <span class="keyword">int</span> alpha)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColorFilter</span><span class="params">(<span class="meta">@Nullable</span> ColorFilter colorFilter)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOpacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PixelFormat.UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sp2px</span><span class="params">(Context context, <span class="keyword">float</span> spValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> fontScale = context.getResources().getDisplayMetrics().scaledDensity;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (spValue * fontScale + <span class="number">0.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xml中 引用</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.commonlib.WaterMarkView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:singleLine</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/wm&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_align</span>=<span class="string">&quot;CENTER&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_degree</span>=<span class="string">&quot;-30&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_dx</span>=<span class="string">&quot;100px&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_dy</span>=<span class="string">&quot;240px&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_sync</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_text</span>=<span class="string">&quot;再见孙悟空&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_textBold</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_textColor</span>=<span class="string">&quot;@color/black&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:water_mark_textSize</span>=<span class="string">&quot;30px&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>activity中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> WaterMarkView wm;</span><br><span class="line"> </span><br><span class="line">wm = (WaterMarkView) findViewById(R.id.wm);</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">water</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SharedPreferences jobcede = getSharedPreferences(<span class="string">&quot;jobcede&quot;</span>, MODE_PRIVATE);</span><br><span class="line">    String userName = jobcede.getString(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    String name = jobcede.getString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    wm.setText(name,userName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>————————————————<br>版权声明：本文为CSDN博主「再见孙悟空_」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href="https://blog.csdn.net/shaoyezhangliwei/article/details/109849305">https://blog.csdn.net/shaoyezhangliwei/article/details/109849305</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;转-Android-实现水印背景效果&quot;&gt;&lt;a href=&quot;#转-Android-实现水印背景效果&quot; class=&quot;headerlink&quot; title=&quot;[转]Android 实现水印背景效果&quot;&gt;&lt;/a&gt;[转]Android 实现水印背景效果&lt;/h1&gt;&lt;p&gt;项目中有</summary>
      
    
    
    
    <category term="UI" scheme="http://example.com/categories/UI/"/>
    
    
    <category term="Android" scheme="http://example.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Jetpack系列—paging框架使用和原理(基于paging-runtime-2.1.0版本)</title>
    <link href="http://example.com/2022/02/25/Jetpack%E7%B3%BB%E5%88%97%E2%80%94paging%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86/"/>
    <id>http://example.com/2022/02/25/Jetpack%E7%B3%BB%E5%88%97%E2%80%94paging%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86/</id>
    <published>2022-02-24T20:23:47.000Z</published>
    <updated>2022-06-18T11:39:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>Jetpack系列—paging框架使用和原理(基于paging-runtime-2.1.0版本)</p><p>基于paging-runtime-2.1.0版本</p><p>先看下pageing的基本使用</p><p>1.构造一个pageData对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LiveData&lt;PagedList&lt;T&gt;&gt; pageData = <span class="keyword">new</span> LivePagedListBuilder(factory, config)</span><br><span class="line">  <span class="comment">//加载初始化数据时需要传递的参数，首页就给传个0就行了，如果是多个参数，需要把多个参数组装成一个javabean对象</span></span><br><span class="line">        .setInitialLoadKey(<span class="number">0</span>)</span><br><span class="line">        <span class="comment">//.setFetchExecutor()</span></span><br><span class="line">  <span class="comment">//这个callback可以知道pagelist加载数据的状态，可以判定界面上有没有数据等异常的状态,看名字就知道，是边界情况回调，但 不是每一次分页 都会回调这里</span></span><br><span class="line">        .setBoundaryCallback(callback)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p>2.先看更新数据接收和更新的地方</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//触发页面初始化数据加载的逻辑</span></span><br><span class="line">mViewModel.getPageData().observe(<span class="keyword">this</span>, pagedList -&gt; submitList(pagedList));</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听分页时有无更多数据,以决定是否关闭上拉加载的动画</span></span><br><span class="line">mViewModel.getBoundaryPageData().observe(<span class="keyword">this</span>, hasData -&gt; finishRefresh(hasData));</span><br></pre></td></tr></table></figure><p>本质通过这个pageData去observe进行数据的分发事件通知，进而刷新页面数据，本质上是使用了livedata的能力。</p><p>3.看具体构造pageData对象时还需要一个factory config  callback这些都是什么</p><p>config</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PagedList.Config config = <span class="keyword">new</span> PagedList.Config.Builder()</span><br><span class="line">        <span class="comment">//一页加载多少条数据</span></span><br><span class="line">        .setPageSize(<span class="number">10</span>)</span><br><span class="line">        <span class="comment">//设置默认加载多少条数据</span></span><br><span class="line">        .setInitialLoadSizeHint(<span class="number">12</span>)</span><br><span class="line">        <span class="comment">//知道列表一共多少条数据</span></span><br><span class="line">        <span class="comment">//.setMaxSize(100)</span></span><br><span class="line">        <span class="comment">//还有多少条的时候的预加载，默认是pageSize 如果不想有这个功能，就让setInitialLoadSizeHint 大于pageSize</span></span><br><span class="line">        <span class="comment">//要不一开始它加载了10条，它马上就执行loadMore了</span></span><br><span class="line">        <span class="comment">//.setPrefetchDistance(4)</span></span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p>factory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataSource.Factory factory = <span class="keyword">new</span> DataSource.Factory() &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span> || dataSource.isInvalid()) &#123;</span><br><span class="line">            dataSource = createDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>callback 边界</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PagedList.BoundaryCallback&lt;T&gt; callback = <span class="keyword">new</span> PagedList.BoundaryCallback&lt;T&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onZeroItemsLoaded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//新提交的PagedList中没有数据</span></span><br><span class="line">        boundaryPageData.postValue(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemAtFrontLoaded</span><span class="params">(<span class="meta">@NonNull</span> T itemAtFront)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//新提交的PagedList中第一条数据被加载到列表上</span></span><br><span class="line">        boundaryPageData.postValue(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemAtEndLoaded</span><span class="params">(<span class="meta">@NonNull</span> T itemAtEnd)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//新提交的PagedList中最后一条数据被加载到列表上</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>看到了吧，在第一次时没有数据，在onZeroItemsLoaded会发送一条boundaryPageData.postValue(false) 这也是livedata.postValue 所以触发第一次加载时页面更新，后续加载更多</p><p>那么具体的实现逻辑，看下原代码 基于paging-runtime-2.1.0版本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LiveData&lt;PagedList&lt;Value&gt;&gt; build() &#123;</span><br><span class="line">    <span class="keyword">return</span> create(mInitialLoadKey, mConfig, mBoundaryCallback, mDataSourceFactory,</span><br><span class="line">            ArchTaskExecutor.getMainThreadExecutor(), mFetchExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mInitialLoadKey——第一次加载数据时的入参</p><p>mConfig——配置了maxsize pagesize  PrefetchDistance 等等参数</p><p>mBoundaryCallback——数据加载边界的回调</p><p>mDataSourceFactory——提供数据源</p><p>ArchTaskExecutor.getMainThreadExecutor()——主线程</p><p>mFetchExecutor——异步线程</p><p> 静态方法create</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;Key, Value&gt; LiveData&lt;PagedList&lt;Value&gt;&gt; create(</span><br><span class="line">        <span class="meta">@Nullable</span> <span class="keyword">final</span> Key initialLoadKey,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> PagedList.Config config,</span><br><span class="line">        <span class="meta">@Nullable</span> <span class="keyword">final</span> PagedList.BoundaryCallback boundaryCallback,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> DataSource.Factory&lt;Key, Value&gt; dataSourceFactory,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> Executor notifyExecutor,</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="keyword">final</span> Executor fetchExecutor) &#123;</span><br><span class="line">  <span class="comment">//实际上return的是ComputableLiveData.getLiveData</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ComputableLiveData&lt;PagedList&lt;Value&gt;&gt;(fetchExecutor) &#123;</span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> PagedList&lt;Value&gt; mList;</span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> DataSource&lt;Key, Value&gt; mDataSource;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DataSource.InvalidatedCallback mCallback =</span><br><span class="line">                <span class="keyword">new</span> DataSource.InvalidatedCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        invalidate();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="comment">// for casting getLastKey to Key</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> PagedList&lt;Value&gt; <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="meta">@Nullable</span> Key initializeKey = initialLoadKey;</span><br><span class="line">            <span class="keyword">if</span> (mList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                initializeKey = (Key) mList.getLastKey();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mDataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mDataSource.removeInvalidatedCallback(mCallback);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mDataSource = dataSourceFactory.create();</span><br><span class="line">                mDataSource.addInvalidatedCallback(mCallback);</span><br><span class="line"></span><br><span class="line">                mList = <span class="keyword">new</span> PagedList.Builder&lt;&gt;(mDataSource, config)</span><br><span class="line">                        .setNotifyExecutor(notifyExecutor)</span><br><span class="line">                        .setFetchExecutor(fetchExecutor)</span><br><span class="line">                        .setBoundaryCallback(boundaryCallback)</span><br><span class="line">                        .setInitialKey(initializeKey)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125; <span class="keyword">while</span> (mList.isDetached());</span><br><span class="line">            <span class="keyword">return</span> mList;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.getLiveData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看ComputableLiveData里都做了啥</p><p>构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ComputableLiveData</span><span class="params">(<span class="meta">@NonNull</span> Executor executor)</span> </span>&#123;</span><br><span class="line">    mExecutor = executor;</span><br><span class="line">  <span class="comment">//new了livedata 并且复写了onActive方法</span></span><br><span class="line">    mLiveData = <span class="keyword">new</span> LiveData&lt;T&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">//onActive方法执行时机？当且仅当第一个活跃的observer被注册到livedata里的时候就会触发activie</span></span><br><span class="line">            mExecutor.execute(mRefreshRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是说，只要用调用了pageData.observe(Observer) 就会立马触发 ComputableLiveData里的livedata的onActive的回调</p><p>看下mRefreshRunnable 里做了什么，刷新了数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> computed;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            computed = <span class="keyword">false</span>;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">if</span> (mComputing.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// as long as it is invalid, keep computing.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    T value = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> (mInvalid.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                        computed = <span class="keyword">true</span>;</span><br><span class="line">                        value = compute();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (computed) &#123;</span><br><span class="line">                        mLiveData.postValue(value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// release compute lock</span></span><br><span class="line">                    mComputing.set(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (computed &amp;&amp; mInvalid.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function">T <span class="title">compute</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>是一个抽象，具体实现在ComputeLiveData的匿名实现里</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PagedList&lt;Value&gt; <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Key initializeKey = initialLoadKey;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        initializeKey = <span class="keyword">this</span>.mList.getLastKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.mDataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mDataSource.removeInvalidatedCallback(<span class="keyword">this</span>.mCallback);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//通过create方法，生成了一个datasource对象 是一个抽象方法，由用户在上层实现</span></span><br><span class="line">        <span class="keyword">this</span>.mDataSource = dataSourceFactory.create();</span><br><span class="line">        <span class="keyword">this</span>.mDataSource.addInvalidatedCallback(<span class="keyword">this</span>.mCallback);</span><br><span class="line">        <span class="keyword">this</span>.mList = (<span class="keyword">new</span> androidx.paging.PagedList.Builder(<span class="keyword">this</span>.mDataSource, config)).setNotifyExecutor(notifyExecutor).setFetchExecutor(fetchExecutor).setBoundaryCallback(boundaryCallback).setInitialKey(initializeKey).build();</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="keyword">this</span>.mList.isDetached());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.mList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由用户在上层实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> DataSource&lt;Key, Value&gt; <span class="title">create</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>我们在viewmodel中的实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataSource.Factory factory = <span class="keyword">new</span> DataSource.Factory() &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span> || dataSource.isInvalid()) &#123;</span><br><span class="line">            dataSource = createDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>进而由每个具体的viewmodel中的new的datasource对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedDataSource</span> <span class="keyword">extends</span> <span class="title">ItemKeyedDataSource</span>&lt;<span class="title">Integer</span>, <span class="title">Feed</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInitial</span><span class="params">(<span class="meta">@NonNull</span> LoadInitialParams&lt;Integer&gt; params, <span class="meta">@NonNull</span> LoadInitialCallback&lt;Feed&gt; callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//加载初始化数据的</span></span><br><span class="line">        Log.e(<span class="string">&quot;homeviewmodel&quot;</span>, <span class="string">&quot;loadInitial: &quot;</span>);</span><br><span class="line">        loadData(<span class="number">0</span>, params.requestedLoadSize, callback);</span><br><span class="line">        witchCache = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAfter</span><span class="params">(<span class="meta">@NonNull</span> LoadParams&lt;Integer&gt; params, <span class="meta">@NonNull</span> LoadCallback&lt;Feed&gt; callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//向后加载分页数据的</span></span><br><span class="line">        Log.e(<span class="string">&quot;homeviewmodel&quot;</span>, <span class="string">&quot;loadAfter: &quot;</span>);</span><br><span class="line">        loadData(params.key, params.requestedLoadSize, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBefore</span><span class="params">(<span class="meta">@NonNull</span> LoadParams&lt;Integer&gt; params, <span class="meta">@NonNull</span> LoadCallback&lt;Feed&gt; callback)</span> </span>&#123;</span><br><span class="line">        callback.onResult(Collections.emptyList());</span><br><span class="line">        <span class="comment">//能够向前加载数据的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getKey</span><span class="params">(<span class="meta">@NonNull</span> Feed item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> item.id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着往下看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.mDataSource.addInvalidatedCallback(<span class="keyword">this</span>.mCallback);</span><br></pre></td></tr></table></figure><p>为什么要给datasource注册一个callback呢？先往下看，这个callback干了什么</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//通过原子的方式，把mInvalide标志位设为true</span></span><br><span class="line">    <span class="keyword">if</span> (mInvalid.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (InvalidatedCallback callback : mOnInvalidatedCallbacks) &#123;</span><br><span class="line">            callback.onInvalidated();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这就会走到</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> InvalidatedCallback mCallback = <span class="keyword">new</span> InvalidatedCallback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>走到 ComputableLivedata.invalidate()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ArchTaskExecutor.getInstance().executeOnMainThread(mInvalidationRunnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mInvalidationRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isActive = mLiveData.hasActiveObservers();</span><br><span class="line">        <span class="keyword">if</span> (mInvalid.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isActive) &#123;</span><br><span class="line">                mExecutor.execute(mRefreshRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个mRefreshRunnable同样在onActive方法中被执行过</p><p>如何通过下拉刷新去触发 执行mRefreshRunnable呢？</p><p>上层执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mViewModel.getDataSource().invalidate();</span><br></pre></td></tr></table></figure><p>就会再次触发我们创建的ComputableLiveData中的mCallback中的onInvalidated方法进而实现invalidate的调用，并执行里面的mRefreshRunnable去刷新数据，所以</p><p>我们第一次创建时会刷新一次，后面就可以通这个注册的callback 上层调用 去主动刷新数据</p><p>再看mRefreshRunnable的后面</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> computed;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            computed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// compute can happen only in 1 thread but no reason to lock others.</span></span><br><span class="line">            <span class="keyword">if</span> (mComputing.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// as long as it is invalid, keep computing.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    T value = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> (mInvalid.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                        computed = <span class="keyword">true</span>;</span><br><span class="line">                      <span class="comment">//拿到value pagedlist</span></span><br><span class="line">                        value = compute();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (computed) &#123;</span><br><span class="line">                      <span class="comment">//通过livedata发送pagelist分发数据，这样注册的地方就可以接收到数据了</span></span><br><span class="line">                        mLiveData.postValue(value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// release compute lock</span></span><br><span class="line">                    mComputing.set(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (computed &amp;&amp; mInvalid.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Jetpack系列—paging框架使用和原理(基于paging-runtime-2.1.0版本)&lt;/p&gt;
&lt;p&gt;基于paging-runtime-2.1.0版本&lt;/p&gt;
&lt;p&gt;先看下pageing的基本使用&lt;/p&gt;
&lt;p&gt;1.构造一个pageData对象&lt;/p&gt;
&lt;fig</summary>
      
    
    
    
    <category term="Jetpack系列" scheme="http://example.com/categories/Jetpack%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Android" scheme="http://example.com/tags/Android/"/>
    
    <category term="Jetpack" scheme="http://example.com/tags/Jetpack/"/>
    
  </entry>
  
  <entry>
    <title>Android - 在Fragment中观察LiveData时，为什么要使用viewLifecycleOwner[转]</title>
    <link href="http://example.com/2022/02/16/Android%20-%20%E5%9C%A8Fragment%E4%B8%AD%E8%A7%82%E5%AF%9FLiveData%E6%97%B6%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8viewLifecycleOwner/"/>
    <id>http://example.com/2022/02/16/Android%20-%20%E5%9C%A8Fragment%E4%B8%AD%E8%A7%82%E5%AF%9FLiveData%E6%97%B6%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8viewLifecycleOwner/</id>
    <published>2022-02-16T02:37:54.000Z</published>
    <updated>2022-05-12T07:32:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>使用LiveData 在调用observe时传入this会报提醒，要求使用viewLifecycleOwner原因是什么？</p><span id="more"></span><p><a href="https://www.jianshu.com/p/7073ec569f7f">原文链接</a></p><h1 id="Android-在Fragment中观察LiveData时，为什么要使用viewLifecycleOwner"><a href="#Android-在Fragment中观察LiveData时，为什么要使用viewLifecycleOwner" class="headerlink" title="Android - 在Fragment中观察LiveData时，为什么要使用viewLifecycleOwner"></a>Android - 在Fragment中观察LiveData时，为什么要使用viewLifecycleOwner</h1><p>官网建议使用viewLifecycleOwner<br> 在Fragment中对LiveData对象调用Observe方法的时候，如果传递的LifecycleOwner参数为this，也就是Fragment的时候，会受到AndroidStudio的提醒，要求使用viewLifecycleOwner：</p><p><img src="https://upload-images.jianshu.io/upload_images/26005601-7b7f5e71aad256c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><p>fragment.png</p><p>从类型上来说，Fragment与viewLifecycleOwner的类型FragmentViewLifecycle两者都继承了LifecycleOwner，像之前那样直接this，大部分情况下运行也是正常的，那么这里的Lint提醒是什么呢？</p><p>通过在官网寻找androidx.fragment:fragment的文档，可以看到1.2.0版本更新的内容有一条：</p><p><img src="https://upload-images.jianshu.io/upload_images/26005601-68a5cd8a1a63cf92.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><p>26005601-ff3b75c18a8b2c79.png</p><p>可以知道，这肯定是有他的道理。我们来一起分析一下原因：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">viewLifecycleOwner相关生命周期</span><br><span class="line">找到viewLifecycleOwner相关代码( 只看关键点 )：</span><br><span class="line"></span><br><span class="line"><span class="comment">//Fragment.java中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">mChildFragmentManager.noteStateNotSaved();</span><br><span class="line">    mPerformedCreateView =<span class="keyword">true</span>;</span><br><span class="line">    mViewLifecycleOwner =<span class="keyword">new</span> FragmentViewLifecycleOwner(); <span class="comment">//此处创建了FragmentViewLifecycleOwner</span></span><br><span class="line">    mView = onCreateView(inflater, container, savedInstanceState); <span class="comment">//创建完成之后，调用了onCreateView()方法</span></span><br><span class="line">    ... <span class="comment">//省略无关代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//FragmentManager.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyFragmentView</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    fragment.performDestroyView(); <span class="comment">//此方法中执行了onDestroyView()方法</span></span><br><span class="line">    fragment.mViewLifecycleOwner =<span class="keyword">null</span>; <span class="comment">//在执行完onDestroyView()方法之后，将viewLifecycleOwner置空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Fragment.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performDestroyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    onDestroyView(); <span class="comment">// fragment.performDestroyView()方法调用中，执行了onDestroyView()方法</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">可以发现mViewLifecycleOwner的赋值在onCreateView()之前，置空在onDestroyView()之后，</span><br><span class="line">mViewLifecycleOwner的注释也说明了这点：</span><br><span class="line">    <span class="comment">// 这在performCreateView中初始化，在外部不可用</span></span><br><span class="line">    <span class="comment">// This is initialized in performCreateView and unavailable outside of the</span></span><br><span class="line">    <span class="comment">// onCreateView/onDestroyView生命周期</span></span><br><span class="line">    <span class="comment">// onCreateView/onDestroyView lifecycle</span></span><br><span class="line">    <span class="meta">@Nullable</span> FragmentViewLifecycleOwner mViewLifecycleOwner;</span><br></pre></td></tr></table></figure><p>正如类名所示，这个FragmentViewLifecycle代表的是Fragment中View的LifecycleOwner，Fragment中View的生命周期与Fragment本身并不相同。<br> 看到这里，想必有些同学对Fragment的生命周期也半知半解，顺便温习一下：</p><p><img src="https://upload-images.jianshu.io/upload_images/26005601-c27d3b6f0b2afead.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/317/format/webp" alt="img"></p><p>Fragment.png</p><p>Fragment入back stack的过程会执行onDestroyView但不执行之后的onDestroy与onDetach，而出back stack是从onCreateView开始执行，而没有之前的onAttach与onCreate。</p><h2 id="LiveData的observe过程"><a href="#LiveData的observe过程" class="headerlink" title="LiveData的observe过程"></a>LiveData的observe过程</h2><p>温习了相关生命周期后，下面来看一下LiveData的observe过程。</p><p>我们知道在LiveData的observe方法内，会将参数owner与observer包装起来，使得observer的回调受owner的生命周期的影响，只有在owner处于活跃状态才回调observer，而活跃状态指的是当前owner的生命周期至少为STARTED，即如下（1）处，owner与observer的包装类中否活跃的判断方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">final</span> LifecycleOwner mOwner;</span><br><span class="line">    LifecycleBoundObserver(<span class="meta">@NonNull</span> LifecycleOwner owner, Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">super</span>(observer);</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">    &#125;<span class="comment">//(1)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">            removeObserver(mObserver);<span class="comment">//(2)</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可是，Fragment与Fragment中的View在活跃的生命周期状态是一致的，这里的owner使用fragment还是viewLifecycleOwner并无不同，二者只有在onCreateView到onDestroyView之外有区别。</p><p>包装类中的onStateChanged方法会执行observer的适时移除工作，而（2）处的移除observer正是在owner处于DESTROYED时发生的。对于Fragment，状态会在onDestroyView执行前夕，变为DESTROYED，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Fragment.java 也对应了上边的内容</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">performDestroyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mChildFragmentManager.dispatchDestroyView();</span><br><span class="line">        <span class="keyword">if</span> (mView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mViewLifecycleOwner.handleLifecycleEvent(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">        &#125;</span><br><span class="line">        mState = CREATED;</span><br><span class="line">        onDestroyView();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>此时，一切都解释得通了，在Fragment中对LiveData对象调用observe方法时，使用viewLifecycleOwner代替this的原因是：Fragment与Fragment中的View的生命周期并不一致，需要让observer感知Fragment中的View的生命周期而非Fragment，因此Android专门构造了Fragment中的View的LifecycleOwner，即viewLifecycleOwner。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;使用LiveData 在调用observe时传入this会报提醒，要求使用viewLifecycleOwner原因是什么？&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
</feed>
